#!/bin/sh

set -e

case "$1" in
    configure)

	# Make modifications to the target of the ssl.conf symlink (/etc/apache2/mods-available/ssl.conf)
	FILE="/etc/apache2/mods-available/ssl.conf"
	if [ -f $FILE ]; then
		# Ubuntu 12.04
		if grep "^SSLProtocol all -SSLv2$" $FILE >/dev/null 2>&1; then
			if sed -i 's|SSLProtocol all -SSLv2|SSLProtocol all -SSLv2 -SSLv3|g' $FILE; then 
				echo "* Apache config has been updated to disable SSLv3."
				echo "* Please restart Apache using the following command:"
				echo "  sudo service apache2 restart"
			else
				echo "* Error updating $FILE to disable SSLv3."
				echo "* Please disable SSLv3 manually."
			fi
		fi
		# Ubuntu 14.04
		if grep "SSLProtocol all$" $FILE >/dev/null 2>&1; then
			if sed -i 's|SSLProtocol all|SSLProtocol all -SSLv3|g' $FILE; then 
				echo "* Apache config has been updated to disable SSLv3."
			else
				echo "* Error updating $FILE to disable SSLv3."
				echo "* Please disable SSLv3 manually."
			fi
		fi
	fi

	# Check for local queries and migrate if necessary
	OLDFILE="/var/www/elsa/local.php"
	OLDFILEDEFAULT="/var/www/elsa/local.php.empty"
	FILE="/var/www/so/elsa/local.php"
	if [ -f $OLDFILE ] && [ -f $OLDFILEDEFAULT ] ; then
		# Old file exists
		# if it's identical to the default file, we don't want to move it
		# if instead the user has modified the default file, we do want to move it
		if ! diff $OLDFILE $OLDFILEDEFAULT >/dev/null 2>&1; then
			if [ -f $FILE ] ; then
				cp $FILE $FILE.bak || echo "Error backing up $FILE."
			fi
			mv $OLDFILE $FILE || echo "Error moving $OLDFILE to $FILE."
		fi
	fi

	# Add ELSA local queries if not already present
	if [ -f $FILE ]; then
		echo "* $FILE already exists, not overwriting."
	else
		echo "* $FILE doesn't already exist."
		echo "* Copying $FILE.empty to $FILE."
		cp $FILE.empty $FILE || echo "Error copying $FILE.empty to $FILE."
	fi

	# Disable default-ssl site
	FILE="/etc/apache2/sites-enabled/default-ssl"
	if [ -f $FILE ] ; then 
		a2dissite default-ssl || echo "Error disabling default-ssl site in Apache."
		if [ -f $FILE ] ; then 
			rm -f $FILE || echo "Error removing $FILE."
		fi
	fi
	FILE="/etc/apache2/sites-enabled/default-ssl.conf"
	if [ -f $FILE ] ; then 
		a2dissite default-ssl || echo "Error disabling default-ssl site in Apache."
		if [ -f $FILE ] ; then 
			rm -f $FILE || echo "Error removing $FILE."
		fi
	fi

	# Disable Snorby site
	FILE="/etc/apache2/sites-enabled/snorby"
	if [ -f $FILE ] ; then 
		a2dissite snorby || echo "Error disabling snorby site in Apache."
		if [ -f $FILE ] ; then 
			rm -f $FILE || echo "Error removing $FILE."
		fi
	fi

	# Disable passenger module
	FILE="/etc/apache2/mods-enabled/passenger.conf"
	if [ -f $FILE ] ; then 
		a2dismod passenger || echo "Error disabling snorby passenger module in Apache."
		if [ -f $FILE ] ; then 
			rm -f $FILE || echo "Error removing $FILE."
		fi
	fi

	# Enable Apache proxy modules
	a2enmod proxy proxy_http || echo "Error enabling Apache proxy modules."

	# Enable securityonion site
	a2ensite securityonion || echo "Error enabling securityonion site in Apache."

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;


    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
