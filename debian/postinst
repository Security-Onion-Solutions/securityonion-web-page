#!/bin/sh

set -e

case "$1" in
    configure)

	# Make modifications to the target of the ssl.conf symlink (/etc/apache2/mods-available/ssl.conf)
	FILE="/etc/apache2/mods-available/ssl.conf"
	if [ -f $FILE ]; then
		# Ubuntu 12.04
		if grep "^SSLProtocol all -SSLv2$" $FILE >/dev/null 2>&1; then
			if sed -i 's|SSLProtocol all -SSLv2|SSLProtocol all -SSLv2 -SSLv3|g' $FILE; then 
				echo "* Apache config has been updated to disable SSLv3."
				echo "* Please restart Apache using the following command:"
				echo "  sudo service apache2 restart"
			else
				echo "* Error updating $FILE to disable SSLv3."
				echo "* Please disable SSLv3 manually."
			fi
		fi
		# Ubuntu 14.04
		if grep "SSLProtocol all$" $FILE >/dev/null 2>&1; then
			if sed -i 's|SSLProtocol all|SSLProtocol all -SSLv3|g' $FILE; then 
				echo "* Apache config has been updated to disable SSLv3."
			else
				echo "* Error updating $FILE to disable SSLv3."
				echo "* Please disable SSLv3 manually."
			fi
		fi
	fi

	# Disable default-ssl site
	FILE="/etc/apache2/sites-enabled/default-ssl"
	if [ -f $FILE ] ; then 
		a2dissite default-ssl || echo "Error disabling default-ssl site in Apache."
		if [ -f $FILE ] ; then 
			rm -f $FILE || echo "Error removing $FILE."
		fi
	fi
	FILE="/etc/apache2/sites-enabled/default-ssl.conf"
	if [ -f $FILE ] ; then 
		a2dissite default-ssl || echo "Error disabling default-ssl site in Apache."
		if [ -f $FILE ] ; then 
			rm -f $FILE || echo "Error removing $FILE."
		fi
	fi

	# Disable Snorby site
	FILE="/etc/apache2/sites-enabled/snorby"
	if [ -f $FILE ] ; then 
		a2dissite snorby || echo "Error disabling snorby site in Apache."
		if [ -f $FILE ] ; then 
			rm -f $FILE || echo "Error removing $FILE."
		fi
	fi

	# Disable passenger module
	FILE="/etc/apache2/mods-enabled/passenger.conf"
	if [ -f $FILE ] ; then 
		a2dismod passenger || echo "Error disabling snorby passenger module in Apache."
		if [ -f $FILE ] ; then 
			rm -f $FILE || echo "Error removing $FILE."
		fi
	fi

	# Enable Apache proxy modules
	a2enmod proxy proxy_http || echo "Error enabling Apache proxy modules."

	# Enable Apache headers modules
	a2enmod headers || echo "Error enabling Apache headers module."

	# Enable securityonion site
	a2ensite securityonion || echo "Error enabling securityonion site in Apache."

	# If Apache is currently running, restart it
	if /usr/bin/pgrep apache2 >/dev/null ; then
		/usr/sbin/apache2ctl restart || echo "Error restarting Apache."
	fi

    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;


    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
