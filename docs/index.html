

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Security Onion 16.04.6.1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/_static/css/theme.css" type="text/css" />
    <link rel="author" title="About these documents" href="index.html#document-about" />
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="https://securityonion.readthedocs.io/en/latest/" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'index'
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html#document-index" class="icon icon-home"> Security Onion
          

          
          </a>

          
            
            
            
              <div class="version">
                latest
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
            
              <!-- Local TOC -->
              <div class="local-toc"><p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-about">About</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#security-onion">Security Onion</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#security-onion-solutions-llc">Security Onion Solutions, LLC</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#documentation">Documentation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-introduction">Introduction</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#core-components">Core Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#analysis-tools">Analysis Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#deployment-scenarios">Deployment Scenarios</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#conclusion">Conclusion</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-getting-started">Getting Started</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-use-cases">Use Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-architecture">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-hardware">Hardware Requirements</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-hwe">HWE</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-download">Download</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-vmware">VMWare</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-virtualbox">VirtualBox</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-trouble-booting">Booting Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-installation">Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-release-notes">ISO Release Notes</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-quick-iso-image">Quick Evaluation using Security Onion ISO image</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-installing-on-ubuntu">Quick Evaluation on Ubuntu</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-production-deployment">Production Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-post-installation">After Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-secure-boot">Secure Boot</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-analyst">Analyst Tools</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-kibana">Kibana</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-capme">CapME</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-cyberchef">CyberChef</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-squert">Squert</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-sguil">Sguil</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-networkminer">NetworkMiner</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-wireshark">Wireshark</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-network">Network Visibility</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-nids">NIDS</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-snort">Snort</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-suricata">Suricata</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-bro">Bro</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-netsniff-ng">netsniff-ng</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-host">Host Visibility</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-beats">Beats</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-wazuh">Wazuh</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-sysmon">Sysmon</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-autoruns">Autoruns</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-syslog">Syslog</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-elastic">Elastic Stack</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-elasticsearch">Elasticsearch</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-logstash">Logstash</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-kibana">Kibana</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-elastalert">ElastAlert</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-curator">Curator</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-freqserver">FreqServer</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-domainstats">DomainStats</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-docker">Docker</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-redis">Redis</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-data-fields">Data Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-alert-data-fields">Alert Data Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-bro-fields">Bro Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-elastalert-fields">Elastalert Fields</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-re‐indexing">Re-Indexing</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-updating">Updating</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-upgrade">Updating</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-mysql-upgrade-errors">MySQL Upgrade Errors</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-eol">End Of Life</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-customizing">Customizing for Your Environment</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-network-configuration">Network Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-proxy">Proxy Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-firewall">Firewall</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-email">Email Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-ip">Changing IP Addresses</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-ntp">NTP</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-tuning">Tuning</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-bpf">BPF</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rules">Managing Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-local-rules">Adding Local Rules</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-alerts">Managing Alerts</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-pf-ring">PF-RING</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-af-packet">AF-PACKET</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-performance">High Performance Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-mysql">MySQL Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-trimpcap">Trimming PCAPs</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-disabling">Disabling Processes</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-tricks">Tricks and Tips</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-airgap">Airgapped Networks</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-analyst-vm">Analyst VM</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-best-practices">Best Practices</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-cloud-client">Cloud Client</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-connecting-to-sguil">Connecting to Sguild</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-desktop">Disabling Desktop</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-dns-anomaly-detection">DNS Anomaly Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-icmp-anomaly-detection">ICMP Anomaly Detection</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-metapackages">MetaPackages</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-new-disk">Adding a new disk</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-pcaps">PCAPs for Testing</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-removing-a-sensor">Removing a Sensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-salt">Salt</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-sensor-stops-seeing-traffic">Sensor Stops Seeing Traffic</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-ssh">SSH</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-timezones">UTC and Time Zones</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-services">Services</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#all-services">All services</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#server-services">Server services</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#sensor-services">Sensor services</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#elastic-services">Elastic services</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-utilities">Utilities</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-jq">jq</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-setup">Setup</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-so-allow">so-allow</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-so-import-pcap">so-import-pcap</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-help">Help</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-faq">FAQ</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-directory">Directory Structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-tools">Tools</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-passwords">Passwords</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-support">Support</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-mailing-lists">Mailing Lists</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-help-wanted">Help Wanted</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-integrations">Integrations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-alienvault-otx">AlienVault-OTX</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-etherpad">Etherpad</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-fir">FIR</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-grr">GRR</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-hive">TheHive</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-misp">MISP</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-ntopng">NtopNG</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-rita">RITA</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-strelka">Strelka</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-syslog-output">Syslog Output</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-security">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-appendix">Appendix</a><ul>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-elsa-to-elastic">ELSA to Elastic</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#document-upgrading-from-14.04-to-16.04">Upgrading from 14.04 to 16.04</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="index.html#document-cheat-sheet">Cheat Sheet</a></li>
</ul>
</div>
            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html#document-index">Security Onion</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html#document-index">Docs</a> &raquo;</li>
        
      <li>Security Onion 16.04.6.1 documentation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/Security-Onion-Solutions/securityonion-docs/blob/master/index.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="security-onion-documentation">
<h1>Security Onion Documentation<a class="headerlink" href="#security-onion-documentation" title="Permalink to this headline">¶</a></h1>
<div class="toctree-wrapper compound" id="tableofcontents">
<span id="document-about"></span><div class="section" id="about">
<h2>About<a class="headerlink" href="#about" title="Permalink to this headline">¶</a></h2>
<div class="section" id="security-onion">
<h3>Security Onion<a class="headerlink" href="#security-onion" title="Permalink to this headline">¶</a></h3>
<p>Security Onion is a free and open source Linux distribution for intrusion detection, enterprise security monitoring, and log management. It includes Elasticsearch, Logstash, Kibana, Snort, Suricata, Bro, Wazuh, Sguil, Squert, CyberChef, NetworkMiner, and many other security tools. The easy-to-use Setup wizard allows you to build an army of distributed sensors for your enterprise in minutes!</p>
<p>For more information about Security Onion not contained in this Documentation, please see our community site at <a class="reference external" href="https://securityonion.net">https://securityonion.net</a>.</p>
</div>
<div class="section" id="security-onion-solutions-llc">
<h3>Security Onion Solutions, LLC<a class="headerlink" href="#security-onion-solutions-llc" title="Permalink to this headline">¶</a></h3>
<p>Doug Burks started Security Onion as a free and open source project in 2008 and then founded Security Onion Solutions, LLC in 2014.</p>
<p>Security Onion Solutions, LLC is the only official provider of training, professional services, and hardware appliances for Security Onion.</p>
<p>For more information about these products and services, please see our corporate site at <a class="reference external" href="https://securityonionsolutions.com">https://securityonionsolutions.com</a>.</p>
</div>
<div class="section" id="documentation">
<h3>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="formats">
<h4>Formats<a class="headerlink" href="#formats" title="Permalink to this headline">¶</a></h4>
<p>This documentation is published online at <a class="reference external" href="https://securityonion.net/docs">https://securityonion.net/docs</a>.  If you are viewing an offline version of this documentation but have Internet access, you might want to switch to the online version at <a class="reference external" href="https://securityonion.net/docs">https://securityonion.net/docs</a> to see the latest version.</p>
<div class="line-block">
<div class="line">This documentation is also available in PDF format:</div>
<div class="line"><a class="reference external" href="https://readthedocs.org/projects/securityonion/downloads/pdf/latest/">https://readthedocs.org/projects/securityonion/downloads/pdf/latest/</a></div>
</div>
</div>
<div class="section" id="authors">
<h4>Authors<a class="headerlink" href="#authors" title="Permalink to this headline">¶</a></h4>
<p>Security Onion Solutions is the primary author and maintainer of this documentation.  Some content has been contributed by members of our community.  Thanks to all the folks who have contributed to this documentation over the years!</p>
</div>
<div class="section" id="contributing">
<h4>Contributing<a class="headerlink" href="#contributing" title="Permalink to this headline">¶</a></h4>
<p>We welcome your contributions to our documentation!  We will review any suggestions and apply them if appropriate.</p>
<p>If you are accessing the online version of the documentation and notice that a particular page has incorrect information, you can submit corrections by clicking the <code class="docutils literal notranslate"><span class="pre">Edit</span> <span class="pre">on</span> <span class="pre">GitHub</span></code> button in the upper right corner of each page.</p>
<div class="line-block">
<div class="line">To submit a new page, you can submit a pull request (PR) to the following repo:</div>
<div class="line"><a class="reference external" href="https://github.com/Security-Onion-Solutions/securityonion-docs">https://github.com/Security-Onion-Solutions/securityonion-docs</a></div>
</div>
</div>
<div class="section" id="naming-convention">
<h4>Naming Convention<a class="headerlink" href="#naming-convention" title="Permalink to this headline">¶</a></h4>
<p>Our goal is to allow you to easily guess and type the URL of the documentation you want to go to.</p>
<div class="line-block">
<div class="line">For example, if you want to read more about Suricata, you can type the following into your browser:</div>
<div class="line"><a class="reference external" href="https://securityonion.net/docs/suricata">https://securityonion.net/docs/suricata</a></div>
</div>
<p>To achieve this goal, new documentation pages should use the following naming convention:</p>
<ul class="simple">
<li>all lowercase</li>
<li><code class="docutils literal notranslate"><span class="pre">.rst</span></code> file extension</li>
<li>ideally, the name of the page should be one simple word (for example: <code class="docutils literal notranslate"><span class="pre">suricata.rst</span></code>)</li>
<li>try to avoid symbols if possible</li>
<li>if symbols are required, use hyphens (NOT underscores)</li>
</ul>
</div>
</div>
</div>
<span id="document-introduction"></span><div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>Network Security Monitoring (NSM) is, put simply, monitoring your network for security related events. It might be proactive, when used to identify vulnerabilities or expiring SSL certificates, or it might be reactive, such as in incident response and network forensics. Whether you’re tracking an adversary or trying to keep malware at bay, NSM provides context, intelligence and situational awareness of your network. Enterprise Security Monitoring (ESM) takes NSM to the next level and includes endpoint visibility and other telemetry from your enterprise. There are some commercial solutions that get close to what Security Onion provides, but very few contain the vast capabilities of Security Onion in one package.</p>
<p>Many assume NSM is a solution they can buy to fill a gap; purchase and deploy solution XYZ and problem solved. The belief that you can buy an NSM denies the fact that the most important word in the NSM acronym is “M” for Monitoring. Data can be collected and analyzed, but not all malicious activity looks malicious at first glance. While automation and correlation can enhance intelligence and assist in the process of sorting through false positives and malicious indicators, there is no replacement for human intelligence and awareness. I don’t want to disillusion you. Security Onion isn’t a silver bullet that you can setup, walk away from and feel safe. Nothing is and if that’s what you’re looking for you’ll never find it. Security Onion will provide visibility into your network traffic and context around alerts and anomalous events, but it requires a commitment from you the administrator or analyst to review alerts, monitor the network activity, and most importantly, have a willingness, passion and desire to learn.</p>
<div class="section" id="core-components">
<h3>Core Components<a class="headerlink" href="#core-components" title="Permalink to this headline">¶</a></h3>
<p>Security Onion seamlessly weaves together three core functions:</p>
<ul class="simple">
<li>full packet capture;</li>
<li>network-based and host-based intrusion detection systems (NIDS and HIDS, respectively);</li>
<li>and powerful analysis tools.</li>
</ul>
<p><em>Full-packet capture</em> is accomplished via <a class="reference external" href="netsniff-ng">netsniff-ng</a>, “the packet sniffing beast”. netsniff-ng captures all the network traffic your Security Onion sensors see and stores as much of it as your storage solution will hold (Security Onion has a built-in mechanism to purge old data before your disks fill to capacity). Full packet capture is like a video camera for your network, but better because not only can it tell us who came and went, but also exactly where they went and what they brought or took with them (exploit payloads, phishing emails, file exfiltration). It’s a crime scene recorder that can tell us a lot about the victim and the white chalk outline of a compromised host on the ground. There is certainly valuable evidence to be found on the victim’s body, but evidence at the host can be destroyed or manipulated; the camera doesn’t lie, is hard to deceive, and can capture a bullet in transit.</p>
<p><em>Network-based and host-based intrusion detection systems</em> (IDS) analyze network traffic or host systems, respectively, and provide log and alert data for detected events and activity. Security Onion provides multiple IDS options:</p>
<p>NIDS:</p>
<ul class="simple">
<li>Rule-driven NIDS. For rule-driven network intrusion detection, Security Onion offers the choice of <a class="reference external" href="Snort">Snort</a> or <a class="reference external" href="Suricata">Suricata</a>. Rule-based systems look at network traffic for fingerprints and identifiers that match known malicious, anomalous or otherwise suspicious traffic. You might say that they’re akin to antivirus signatures for the network, but they’re a bit deeper and more flexible than that.</li>
<li>Analysis-driven NIDS. For analysis-driven network intrusion detection, Security Onion offers <a class="reference external" href="Bro">Bro</a> (Zeek).  Unlike rule-based systems that look for needles in the haystack of data, Bro says, “Here’s all your data and this is what I’ve seen. Do with it what you will and here’s a framework so you can.” Bro monitors network activity and logs any connections, DNS requests, detected network services and software, SSL certificates, and HTTP, FTP, IRC SMTP, SSH, SSL, and Syslog activity that it sees, providing a real depth and visibility into the context of data and events on your network. Additionally, Bro includes analyzers for many common protocols and by default has the capacity to check MD5 sums for HTTP file downloads against Team Cymru’s Malware Hash Registry project. Beyond logging activity and traffic analyzers, the Bro framework provides a very extensible way to analyze network data in real time. The input framework allows you to feed data into Bro, which can be scripted, for example, to read a comma delimited file of C-level employee usernames and correlate that against other activity, such as when they download an executable file from the Internet. The file analysis framework provides protocol independent file analysis, allowing you to capture files as they pass through your network and automatically pass them to a sandbox or a file share for antivirus scanning. The flexibility of Bro makes it an incredibly powerful ally in your defense.</li>
</ul>
<p>HIDS:</p>
<ul class="simple">
<li>For host-based intrusion detection, Security Onion offers <a class="reference external" href="Wazuh">Wazuh</a>, a free, open source HIDS for Windows, Linux and Mac OS X. When you add the Wazuh agent to endpoints on your network, you gain invaluable visibility from endpoint to your network’s exit point. Wazuh performs log analysis, file integrity checking, policy monitoring, rootkit detection, real-time alerting and active response. As an analyst, being able to correlate host-based events with network-based events can be the difference in identifying a successful attack.</li>
</ul>
<p>In addition to the above, Security Onion can collect data via syslog or other agent transport.</p>
</div>
<div class="section" id="analysis-tools">
<h3>Analysis Tools<a class="headerlink" href="#analysis-tools" title="Permalink to this headline">¶</a></h3>
<p>With full packet capture, IDS logs and Bro data, there is a daunting amount of data available at the analyst’s fingertips. Fortunately, Security Onion integrates the following tools to help make sense of this data:</p>
<ul class="simple">
<li><a class="reference external" href="Sguil">Sguil</a>, created by Bamm Visscher, is “The Analyst Console for Network Security Monitoring.” It is the analyst’s right hand, providing visibility into the event data being collected and the context to validate the detection. Sguil provides a single GUI in which to view Snort, Suricata, and Wazuh alerts. More importantly, Sguil allows you to pivot directly from an alert into a packet capture (via <a class="reference external" href="wireshark">Wireshark</a> or <a class="reference external" href="networkminer">NetworkMiner</a>) or a transcript of the full session that triggered the alert. So, instead of seeing only an individual packet associated with an alert and being left with the unanswerable question, “What now?” or “What happened next?,” you can view all of the associated traffic and actually answer that question. Sguil differs from other alert interfaces in that it allows collaboration among analysts by allowing alerts to be commented on and escalated to more senior analysts who can take action on the alerts.</li>
<li><a class="reference external" href="Squert">Squert</a>, originally developed by Paul Halliday, is a web application interface to the Sguil database. Although it is neither meant to be a real-time (or near real-time) interface nor a replacement for Sguil, it allows querying of the Sguil database and provides several visualization options for the data such as “time series representations, weighted and logically grouped result sets” and geo-IP mapping.  Squert can pivot to full packet capture via <a class="reference external" href="CapMe">CapMe</a>.</li>
<li><a class="reference external" href="Kibana">Kibana</a>, created by the team at Elastic, allows us to quickly analyze and pivot between all of the different data types generated by Security Onion through a “single pane of glass”.  This includes not only NIDS/HIDS alerts, but also Bro logs and system logs collected via syslog or other agent transport.  Kibana can pivot to full packet capture via <a class="reference external" href="CapMe">CapMe</a>.</li>
<li><a class="reference external" href="CapMe">CapMe</a>, originally developed by Paul Halliday, allows you to view PCAP transcripts and download full PCAP files.  Squert and Kibana are pre-configured to pivot to CapMe to retrieve full packet capture.</li>
</ul>
</div>
<div class="section" id="deployment-scenarios">
<h3>Deployment Scenarios<a class="headerlink" href="#deployment-scenarios" title="Permalink to this headline">¶</a></h3>
<p>Analysts around the world are using Security Onion today for many different <a class="reference external" href="Use-Cases">use cases</a> and <a class="reference external" href="Elastic-Architecture.html#deployment-types">architectures</a>.  The Security Onion Setup wizard allows you to easily configure the best installation scenario to suit your needs.</p>
</div>
<div class="section" id="conclusion">
<h3>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">¶</a></h3>
<p>So we have full packet capture, <a class="reference external" href="Snort">Snort</a> or <a class="reference external" href="Suricata">Suricata</a> rule-driven intrusion detection, <a class="reference external" href="Bro">Bro</a> event-driven intrusion detection and <a class="reference external" href="Wazuh">Wazuh</a> host-based intrusion detection, all running out of the box once you run Security Onion setup. These disparate systems with various dependencies and complexities all run seamlessly together and would otherwise take hours, days or weeks to assemble and integrate on their own. What was once a seemingly impossible task is now as easy as answering a few questions.</p>
</div>
</div>
<span id="document-getting-started"></span><div class="section" id="getting-started">
<h2>Getting Started<a class="headerlink" href="#getting-started" title="Permalink to this headline">¶</a></h2>
<p>This section will give you an overview of different use cases for Security Onion and how you might install and configure Security Onion to handle those use cases.</p>
<div class="toctree-wrapper compound">
<span id="document-use-cases"></span><div class="section" id="use-cases">
<h3>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h3>
<p>Security Onion is designed for many different use cases! When you run Setup, it will ask you if you want <code class="docutils literal notranslate"><span class="pre">Evaluation</span> <span class="pre">Mode</span></code> or <code class="docutils literal notranslate"><span class="pre">Production</span> <span class="pre">Mode</span></code>.  Each of these modes presents different options that may be applicable to different use cases.  Here are just a few examples.</p>
<div class="section" id="classroom">
<h4>Classroom<a class="headerlink" href="#classroom" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Evaluation</span> <span class="pre">Mode</span></code> is ideal for classroom or small lab environments.</p>
<p>Install Security Onion. Run Setup and configure network interfaces. Reboot, run Setup again, and then choose <code class="docutils literal notranslate"><span class="pre">Evaluation</span> <span class="pre">Mode</span></code>.</p>
<p>For more information, please see the <a class="reference external" href="QuickISOImage">Quick Evaluation</a> section.</p>
</div>
<div class="section" id="pcap-forensics">
<h4>Pcap Forensics<a class="headerlink" href="#pcap-forensics" title="Permalink to this headline">¶</a></h4>
<p>Need to review a pcap with original timestamps preserved? Install Security Onion in <code class="docutils literal notranslate"><span class="pre">Evaluation</span> <span class="pre">Mode</span></code> as described above and then run <a class="reference external" href="so-import-pcap">so-import-pcap</a>.</p>
</div>
<div class="section" id="production-server-standalone">
<h4>Production Server - Standalone<a class="headerlink" href="#production-server-standalone" title="Permalink to this headline">¶</a></h4>
<p>Install Security Onion. Run Setup and configure network interfaces.  Reboot, run Setup again, choose <code class="docutils literal notranslate"><span class="pre">Production</span> <span class="pre">Mode</span></code>, choose <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">Deployment</span></code>, and enable network sensor services.</p>
<p>For more information, please see the <a class="reference external" href="ProductionDeployment">Production Deployment</a> section.</p>
</div>
<div class="section" id="production-server-distributed-deployment">
<h4>Production Server - Distributed Deployment<a class="headerlink" href="#production-server-distributed-deployment" title="Permalink to this headline">¶</a></h4>
<p>Install Security Onion on the master server box. Run Setup and configure network interfaces. Reboot, run Setup again, choose <code class="docutils literal notranslate"><span class="pre">Production</span> <span class="pre">Mode</span></code>, and then choose <code class="docutils literal notranslate"><span class="pre">New</span> <span class="pre">Deployment</span></code>.</p>
<p>Install Security Onion on one or more nodes and then on each one: run Setup, configure network interfaces, reboot, run Setup again, choose <code class="docutils literal notranslate"><span class="pre">Production</span> <span class="pre">Mode</span></code>, and then choose <code class="docutils literal notranslate"><span class="pre">Existing</span> <span class="pre">Deployment</span></code> to join to master.</p>
<p>For more information, please see the <a class="reference external" href="ProductionDeployment">Production Deployment</a> section.</p>
</div>
<div class="section" id="analyst-vm">
<h4>Analyst VM<a class="headerlink" href="#analyst-vm" title="Permalink to this headline">¶</a></h4>
<p>If you’ve built a Production Server as described above, you may want to connect to it using an <a class="reference external" href="Analyst-VM">Analyst VM</a>.  Install Security Onion in a VM on your local desktop or laptop. You do NOT need to run Setup in the Analyst VM since this VM won’t be running any services, only applications such as <a class="reference external" href="Sguil">Sguil</a>, <a class="reference external" href="wireshark">Wireshark</a>, <a class="reference external" href="networkminer">NetworkMiner</a>, and a web browser.</p>
<p>For more information, please see the <a class="reference external" href="Analyst-VM">Analyst-VM</a> section.</p>
</div>
<div class="section" id="sending-logs-to-separate-siem">
<h4>Sending Logs to Separate SIEM<a class="headerlink" href="#sending-logs-to-separate-siem" title="Permalink to this headline">¶</a></h4>
<p>You can install Security Onion and then configure it to send logs to a separate SIEM.</p>
<p>For more information, please see the <a class="reference external" href="syslog-output">Syslog Output</a> section.</p>
</div>
</div>
<span id="document-architecture"></span><div class="section" id="architecture">
<h3>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h3>
<p>Below are several diagrams to represent the current architecture and deployment scenarios for Security Onion and the Elastic Stack.</p>
<div class="section" id="high-level-architecture-diagram">
<h4>High-Level Architecture Diagram<a class="headerlink" href="#high-level-architecture-diagram" title="Permalink to this headline">¶</a></h4>
<a class="reference external image-reference" href="https://github.com/Security-Onion-Solutions/securityonion-docs/raw/master/images/elastic-architecture/elastic-architecture.png"><img alt="_images/elastic-architecture.png" src="_images/elastic-architecture.png" /></a>
</div>
<div class="section" id="core-components">
<h4>Core Components<a class="headerlink" href="#core-components" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt><a class="reference external" href="Logstash">Logstash</a></dt>
<dd><ul class="first last simple">
<li>Parse and format logs.</li>
</ul>
</dd>
<dt><a class="reference external" href="Elasticsearch">Elasticsearch</a></dt>
<dd><ul class="first last simple">
<li>Ingest and index logs.</li>
</ul>
</dd>
<dt><a class="reference external" href="Kibana">Kibana</a></dt>
<dd><ul class="first last simple">
<li>Visualize ingested log data.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="auxilliary-components">
<h4>Auxilliary Components<a class="headerlink" href="#auxilliary-components" title="Permalink to this headline">¶</a></h4>
<dl class="docutils">
<dt><a class="reference external" href="Curator">Curator</a></dt>
<dd><ul class="first last simple">
<li>Manage indices through scheduled maintenance.</li>
</ul>
</dd>
<dt><a class="reference external" href="ElastAlert">ElastAlert</a></dt>
<dd><ul class="first last simple">
<li>Query Elasticsearch and alert on user-defined anomalous behavior or other interesting bits of information.</li>
</ul>
</dd>
<dt><a class="reference external" href="FreqServer">FreqServer</a></dt>
<dd>-Detect DGAs and find random file names, script names, process names, service names, workstation names, TLS certificate subjects and issuer subjects, etc.</dd>
<dt><a class="reference external" href="DomainStats">DomainStats</a></dt>
<dd><ul class="first last simple">
<li>Get additional info about a domain by providing additional context, such as creation time, age, reputation, etc.</li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="detailed-data-flow-diagram">
<h4>Detailed Data Flow Diagram<a class="headerlink" href="#detailed-data-flow-diagram" title="Permalink to this headline">¶</a></h4>
<a class="reference external image-reference" href="https://github.com/Security-Onion-Solutions/securityonion-docs/raw/master/images/elastic-architecture/data-flow.png"><img alt="_images/data-flow.png" src="_images/data-flow.png" /></a>
<p>If you’re viewing the online version of this documentation, you can click the image to zoom in.</p>
</div>
<div class="section" id="deployment-types">
<h4>Deployment Types<a class="headerlink" href="#deployment-types" title="Permalink to this headline">¶</a></h4>
<p>Security Onion is built on a modified distributed client-server model. In the past, Security Onion relied solely on the use of a “sensor” (the client) and a Security Onion “server” (the server). With the inclusion of the Elastic Stack, the distributed architecture has since changed, and now includes the use of Elastic components and separate nodes for processing and storing Elastic stack data.</p>
<p>This means that a standard distributed deployment is now comprised of the <strong>master server</strong>, one or more <strong>forward nodes</strong> (previously called a sensor – runs sensor components), and one or more <strong>storage nodes</strong> (runs Elastic components). This architecture is ideal; while it may cost more upfront, this architecture provides for greater scalability and performance down the line, as one can simply “snap in” new storage nodes to handle more traffic or log sources.</p>
<p>There is the option to utilize only two node types – the <strong>master server</strong> and one or more <strong>heavy nodes</strong>, however, this is not recommended due to performance reasons, and should only be used for testing purposes or in low-throughput environments.</p>
<p>Last, similar to before, users can run a <strong>standalone</strong>, which combines the functions of a <strong>master server</strong>, <strong>forward node</strong>, and <strong>storage node</strong>. The same caveats with performance apply here. This type of deployment is typically used for testing, labs, POCs, or <strong>very</strong> low-throughput environments.</p>
<p>More detail about each deployment and node type can be found below.</p>
<div class="section" id="distributed">
<h5>Distributed<a class="headerlink" href="#distributed" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Recommended deployment type</li>
<li>Consists of a master server, one or more forward nodes, and one or more storage nodes.</li>
</ul>
<a class="reference external image-reference" href="https://github.com/Security-Onion-Solutions/securityonion-docs/raw/master/images/elastic-architecture/distributed.png"><img alt="_images/distributed.png" src="_images/distributed.png" /></a>
</div>
<div class="section" id="heavy-distributed">
<h5>Heavy Distributed<a class="headerlink" href="#heavy-distributed" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Recommended only if a standard distributed deployment is not possible.</li>
<li>Consists of a master server, and one or more heavy nodes.</li>
</ul>
<a class="reference external image-reference" href="https://github.com/Security-Onion-Solutions/securityonion-docs/raw/master/images/elastic-architecture/heavy-distributed.png"><img alt="_images/heavy-distributed.png" src="_images/heavy-distributed.png" /></a>
</div>
<div class="section" id="standalone">
<h5>Standalone<a class="headerlink" href="#standalone" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Not recommended for monitoring high-throughput links</li>
<li>Consists of a single server running master server components, sensor, and Elastic stack components.</li>
</ul>
<a class="reference external image-reference" href="https://github.com/Security-Onion-Solutions/securityonion-docs/raw/master/images/elastic-architecture/standalone.png"><img alt="_images/standalone.png" src="_images/standalone.png" /></a>
</div>
</div>
<div class="section" id="node-types">
<h4>Node Types<a class="headerlink" href="#node-types" title="Permalink to this headline">¶</a></h4>
<div class="section" id="master">
<h5>Master<a class="headerlink" href="#master" title="Permalink to this headline">¶</a></h5>
<p>The <code class="docutils literal notranslate"><span class="pre">master</span> <span class="pre">server</span></code> runs it’s own local copy of Elasticsearch, which manages cross-cluster search configuration for the deployment. This includes configuration for <code class="docutils literal notranslate"><span class="pre">heavy</span> <span class="pre">nodes</span></code> and <code class="docutils literal notranslate"><span class="pre">storage</span> <span class="pre">nodes</span></code> (where applicable), but not <code class="docutils literal notranslate"><span class="pre">forward</span> <span class="pre">nodes</span></code>, as they do not run Elastic Stack components. An analyst connects to the server from a client workstation (typically a Security Onion virtual machine installation) to execute queries and retrieve data.</p>
<p>The Master Server runs the following components (Production Mode w/ Best Practices):</p>
<ul class="simple">
<li>Elasticsearch</li>
<li>Logstash</li>
<li>Kibana</li>
<li>Curator</li>
<li>Elastalert</li>
<li>Redis (Only if configured to output to a storage node)</li>
<li>OSSEC</li>
<li>Sguild</li>
</ul>
</div>
<div class="section" id="forward-node">
<h5>Forward Node<a class="headerlink" href="#forward-node" title="Permalink to this headline">¶</a></h5>
<p>When using a <code class="docutils literal notranslate"><span class="pre">forward</span> <span class="pre">node</span></code>, Elastic Stack components are not installed. Syslog-NG forwards all logs to Logstash on the master server via an autossh tunnel, where they are stored in Elasticsearch on the master server, or forwarded to storage node’s Elasticsearch instance (if the master server has been configured to use a storage node). From there, the data can be queried through the use of cross-cluster search.</p>
<p>Forward Nodes run the following components (Production Mode w/ Best Practices):</p>
<ul class="simple">
<li>Bro</li>
<li>Snort/Suricata</li>
<li>Netsniff-NG</li>
<li>OSSEC</li>
<li>Syslog-NG</li>
</ul>
</div>
<div class="section" id="heavy-node">
<h5>Heavy Node<a class="headerlink" href="#heavy-node" title="Permalink to this headline">¶</a></h5>
<p>When using a <code class="docutils literal notranslate"><span class="pre">heavy</span> <span class="pre">node</span></code>, Security Onion implements distributed deployments using Elasticsearch’s <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html">cross cluster search</a>. When you run Setup and choose <code class="docutils literal notranslate"><span class="pre">Heavy</span> <span class="pre">Node</span></code>, it will create a local Elasticsearch instance and then configure the master server to query that instance (similar to ELSA distributed deployments). This is done by constructing an autossh tunnel from the heavy node to the master server, configuring reverse port forwarding to allow the master server to connect to the local Elasticsearch instance, and updating _cluster/settings on the master server so that it will query the local Elasticsearch instance.</p>
<ul class="simple">
<li>Elasticsearch</li>
<li>Logstash</li>
<li>Curator</li>
<li>Bro</li>
<li>Snort/Suricata</li>
<li>Netsniff-NG</li>
<li>OSSEC</li>
<li>Syslog-NG (forwards logs locally to Logstash)</li>
</ul>
</div>
<div class="section" id="storage-node">
<h5>Storage Node<a class="headerlink" href="#storage-node" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">Storage</span> <span class="pre">nodes</span></code> extend the storage and processing capabilities of the master server. Just like heavy nodes, storage nodes are added to the master’s cluster search configuration, so the data that resides on the nodes can be queried from the master.</p>
<p>Storage Nodes run the following components (Production Mode w/ Best Practices):</p>
<ul class="simple">
<li>Elasticsearch</li>
<li>Logstash</li>
<li>Curator</li>
<li>OSSEC</li>
</ul>
</div>
</div>
</div>
<span id="document-hardware"></span><div class="section" id="hardware-requirements">
<h3>Hardware Requirements<a class="headerlink" href="#hardware-requirements" title="Permalink to this headline">¶</a></h3>
<div class="section" id="bit-vs-64-bit">
<h4>32-bit vs 64-bit<a class="headerlink" href="#bit-vs-64-bit" title="Permalink to this headline">¶</a></h4>
<p>Security Onion only supports 64-bit hardware.</p>
</div>
<div class="section" id="uefi">
<h4>UEFI<a class="headerlink" href="#uefi" title="Permalink to this headline">¶</a></h4>
<p>If your hardware has UEFI, please see <a class="reference external" href="https://help.ubuntu.com/community/UEFI">https://help.ubuntu.com/community/UEFI</a>.</p>
</div>
<div class="section" id="uefi-secure-boot">
<h4>UEFI Secure Boot<a class="headerlink" href="#uefi-secure-boot" title="Permalink to this headline">¶</a></h4>
<p>If your hardware has UEFI Secure Boot enabled, please see the <a class="reference external" href="Secure-Boot">Secure Boot</a> section.</p>
</div>
<div class="section" id="ups">
<h4>UPS<a class="headerlink" href="#ups" title="Permalink to this headline">¶</a></h4>
<p>Like most IT systems, Security Onion has databases and those databases don’t like power outages or other ungraceful shutdowns. To avoid power outages and having to manually repair databases, please consider a UPS.</p>
</div>
<div class="section" id="elastic-stack">
<h4>Elastic Stack<a class="headerlink" href="#elastic-stack" title="Permalink to this headline">¶</a></h4>
<p>If you’re going to enable the Elastic Stack, please note that the MINIMUM requirements are 4 CPU cores and 8GB RAM. These requirements increase as you monitor more traffic and consume more logs.</p>
<p>Please refer to our <a class="reference external" href="Elastic-Architecture">Architecture Page</a> for detailed deployment scenarios.</p>
<p><strong>We recommend placing all Elastic storage on SSD or fast spinning disk in a RAID 10 configuration.</strong> This includes <code class="docutils literal notranslate"><span class="pre">/nsm/elasticsearch</span></code> and <code class="docutils literal notranslate"><span class="pre">/nsm/logstash</span></code>.</p>
</div>
<div class="section" id="standalone-deployments">
<h4>Standalone Deployments<a class="headerlink" href="#standalone-deployments" title="Permalink to this headline">¶</a></h4>
<p>In a standalone deployment, the master server components and the sensor components all run on a single box, therefore, your hardware requirements will reflect that. This deployment type is recommended for evaluation purposes, POCs (proof-of-concept) and small to medium size single sensor deployments. Although you can deploy Security Onion in this manner, it is recommended that you separate the backend components and sensor components.</p>
<ul class="simple">
<li>CPU: Used to parse incoming events, index incoming events, search metatadata, capture PCAP, analyze packets, and run the frontend components. As data and event consumption increases, a greater amount of CPU will be required.</li>
<li>RAM: Used for Logstash, Elasticsearch, disk cache for Lucene, Snort/Suricata, Bro, Sguil, etc. The amount of available RAM will directly impact search speeds and reliability, as well as ability to process and capture traffic.</li>
<li>Disk: Used for storage of indexed metadata. A larger amount of storage allows for a longer retention period. It is typically recommended to retain no more than 30 days of hot ES indices.</li>
</ul>
<p>Please refer to our <a class="reference external" href="Elastic-Architecture">Architecture Page</a> for detailed deployment scenarios.</p>
</div>
<div class="section" id="master-server-with-local-log-storage">
<h4>Master server with local log storage<a class="headerlink" href="#master-server-with-local-log-storage" title="Permalink to this headline">¶</a></h4>
<p>In an enterprise distributed deployment, a master server will store logs from itself and forward nodes. It can also act as a syslog destination for other log sources to be indexed into Elasticsearch. An enterprise master server should have 8 CPU cores at a minimum, 16-128GB RAM, and enough disk space (multiple terabytes recommended) to meet your retention requirements.</p>
<ul class="simple">
<li>CPU: Used to parse incoming events, index incoming events, search metadata. As consumption of data and events increases, more CPU will be required.</li>
<li>RAM: Used for Logstash, Elasticsearch, and disk cache for Lucene. The amount of available RAM will directly impact search speeds and reliability.</li>
<li>Disk: Used for storage of indexed metadata. A larger amount of storage allows for a longer retention period. It is typically recommended to retain no more than 30 days of hot ES indices.</li>
</ul>
<p>Please refer to our <a class="reference external" href="Elastic-Architecture">Architecture Page</a> for detailed deployment scenarios.</p>
</div>
<div class="section" id="master-server-with-storage-nodes">
<h4>Master server with storage nodes<a class="headerlink" href="#master-server-with-storage-nodes" title="Permalink to this headline">¶</a></h4>
<p>This deployment type utilizes storage nodes to parse and index of events. As a result, the hardware requirements of the master are reduced. An enterprise master server should have 4-8 CPU cores, 8-16GB RAM, and 100GB to 1TB of disk space. Many folks choose to host their master server in their VM farm since it has lower hardware requirements than sensors but needs higher reliability and availability.</p>
<ul class="simple">
<li>CPU: Used to receive incoming events and place them into Redis. Used to run all the front end web comp onents and aggregate search results from the storage nodes.</li>
<li>RAM: Used for Logstash and Redis. The amount of available RAM directly impacts the size of the Redis queue.</li>
<li>Disk: Used for general purposes, as well as storing dashboards and Sguil components.</li>
</ul>
<p>Please refer to our <a class="reference external" href="Elastic-Architecture">Architecture Page</a> for detailed deployment scenarios.</p>
</div>
<div class="section" id="storage-node">
<h4>Storage Node<a class="headerlink" href="#storage-node" title="Permalink to this headline">¶</a></h4>
<p>Storage nodes increase search and retention capacity with regard to Elasticsearch. These nodes parse and index events, and provide the ability to scale horizontally as overall data intake increases.</p>
<ul class="simple">
<li>CPU: Used to parse incoming events and index incoming events. As consumption of data and events increases, more CPU will be required.</li>
<li>RAM: Used for Logstash, Elasticsearch, and disk cache for Lucene. The amount of available RAM will directly impact search speeds and reliability.</li>
<li>Disk: Used for storage of indexed metadata. A larger amount of storage allows for a longer retention period. It is typically recommended to retain no more than 30 days of hot ES indices.</li>
</ul>
<p>Please refer to our <a class="reference external" href="Elastic-Architecture">Architecture Page</a> for detailed deployment scenarios.</p>
</div>
<div class="section" id="forward-node-sensor">
<h4>Forward Node (Sensor)<a class="headerlink" href="#forward-node-sensor" title="Permalink to this headline">¶</a></h4>
<p>A forward node runs sensor components only, and forwards metadata to the master server. All PCAP stays local to the sensor, and is accessed through use of an agent.</p>
<ul class="simple">
<li>CPU: Used for analyzing and storing network traffic. As monitored bandwidth increases, a greater amount of CPU will be required. See below.</li>
<li>RAM: Used for write cache and processing traffic.</li>
<li>Disk: Used for storage of PCAP and metadata . A larger amount of storage allows for a longer retention period.</li>
</ul>
<p>Please refer to our <a class="reference external" href="Elastic-Architecture">Architecture Page</a> for detailed deployment scenarios.</p>
</div>
<div class="section" id="heavy-node-sensor-with-es-components">
<h4>Heavy Node (Sensor with ES components)<a class="headerlink" href="#heavy-node-sensor-with-es-components" title="Permalink to this headline">¶</a></h4>
<p>A heavy node Runs all the sensor components AND Elastic components locally. This dramatically increases the hardware requirements. In this case, all indexed metadata and PCAP are retained locally. When a search is performed through Kibana, the master server queries this node’s Elasticsearch instance.</p>
<ul class="simple">
<li>CPU: Used to parse incoming events, index incoming events, search metadata . As monitored bandwidth (and the amount of overall data/events) increases, a greater amount of CPU will be required.</li>
<li>RAM: Used for Logstash , Elasticsearch, and disk cache for Lucene. The amount of available RAM will directly impact search speeds and reliability.</li>
<li>Disk: Used for storage of indexed metadata. A larger amount of storage allows for a longer retention period. It is typically recommended to retain no more than 30 days of hot ES indices.</li>
</ul>
<p>Please refer to our <a class="reference external" href="Elastic-Architecture">Architecture Page</a> for detailed deployment scenarios.</p>
</div>
<div class="section" id="sensor-hardware-considerations">
<h4>Sensor Hardware Considerations<a class="headerlink" href="#sensor-hardware-considerations" title="Permalink to this headline">¶</a></h4>
<p>The following hardware considerations apply to sensors. If you are using a heavy node or standalone deployment type, please note that it will dramatically increase CPU/RAM/Storage requirements.</p>
<div class="section" id="virtualization">
<h5>Virtualization<a class="headerlink" href="#virtualization" title="Permalink to this headline">¶</a></h5>
<p>We recommend dedicated physical hardware (especially if you’re monitoring lots of traffic) to avoid competing for resources. Sensors can be virtualized, but you’ll have to ensure that they are allocated sufficient resources.</p>
</div>
<div class="section" id="cpu">
<h5>CPU<a class="headerlink" href="#cpu" title="Permalink to this headline">¶</a></h5>
<p>Snort, Suricata, and Bro are very CPU intensive. The more traffic you are monitoring, the more CPU cores you’ll need. A very rough ballpark estimate would be 200Mbps per Snort instance, Suricata worker, or Bro worker. So if you have a fully saturated 1Gbps link and are running Snort and Bro, then you’ll want at least 5 Snort instances and 5 Bro workers, which means you’ll need at least 10 CPU cores for Snort and Bro with additional CPU cores for netsniff-ng and/or other services.</p>
</div>
<div class="section" id="ram">
<h5>RAM<a class="headerlink" href="#ram" title="Permalink to this headline">¶</a></h5>
<p>RAM usage is highly dependent on several variables:</p>
<ul class="simple">
<li>the services that you enable</li>
<li>the <strong>kinds</strong> of traffic you’re monitoring</li>
<li>the <strong>actual amount of traffic</strong> you’re monitoring (example: you may be monitoring a 1Gbps link but it’s only using 200Mbps most of the time)</li>
<li>the amount of packet loss that is “acceptable” to your organization</li>
</ul>
<p>For best performance, over provision RAM so that you can fully disable swap.</p>
<p>The following RAM estimates are a rough guideline and assume that you’re going to be running Snort/Suricata, Bro, and netsniff-ng (full packet capture) and want to minimize/eliminate packet loss. Your mileage may vary!</p>
<p>If you just want to quickly evaluate Security Onion in a VM, the bare minimum amount of RAM needed is 8GB. More is obviously better!</p>
<p>If you’re deploying Security Onion in production on a small network (50Mbps or less), you should plan on 8GB RAM or more. Again, more is obviously better!</p>
<p>If you’re deploying Security Onion in production to a medium network (50Mbps - 500Mbps), you should plan on 16GB - 128GB RAM or more.</p>
<p>If you’re deploying Security Onion in production to a large network (500Mbps - 1000Mbps), you should plan on 128GB - 256GB RAM or more.</p>
<p>If you’re buying a new server, go ahead and max out the RAM (it’s cheap!). As always, more is obviously better!</p>
</div>
<div class="section" id="storage">
<h5>Storage<a class="headerlink" href="#storage" title="Permalink to this headline">¶</a></h5>
<p>Sensors that have full packet capture enabled need LOTS of storage. For example, suppose you are monitoring a link that averages 50Mbps, here are some quick calculations: 50Mb/s = 6.25 MB/s = 375 MB/minute = 22,500 MB/hour = 540,000 MB/day. So you’re going to need about 540GB for one day’s worth of pcaps (multiply this by the number of days you want to keep on disk for investigative/forensic purposes). The more disk space you have, the more PCAP retention you’ll have for doing investigations after the fact. Disk is cheap, get all you can!</p>
<p>We highly recommend using local storage whenever possible! SAN/iSCSI/FibreChannel/NFS can be made to work, but they increase complexity, points of failure and have serious performance implications. By using local storage, you keep everything self-contained and you don’t have to worry about competing for resources. Local storage is most times the most cost efficient solution as well.</p>
</div>
<div class="section" id="nic">
<h5>NIC<a class="headerlink" href="#nic" title="Permalink to this headline">¶</a></h5>
<p>You’ll need at least two wired network interfaces: one for management (preferably connected to a dedicated management network) and then one or more for sniffing (connected to tap or span). Make sure you get good quality network card, especially for sniffing. Most users report good experiences with Intel cards.</p>
</div>
<div class="section" id="packets">
<h5>Packets<a class="headerlink" href="#packets" title="Permalink to this headline">¶</a></h5>
<p>You need some way of getting packets into your sensor interface(s). If you’re just evaluating Security Onion, you can replay <a class="reference external" href="Pcaps">pcaps</a>. For a production deployment, you’ll need a tap or SPAN/monitor port. Here are some inexpensive tap/span solutions:</p>
<div class="line-block">
<div class="line">Sheer Simplicity and Portability (USB-powered):</div>
<div class="line"><a class="reference external" href="http://www.dual-comm.com/port-mirroring-LAN_switch.htm">http://www.dual-comm.com/port-mirroring-LAN_switch.htm</a></div>
</div>
<div class="line-block">
<div class="line">Dirt Cheap and Versatile:</div>
<div class="line"><a class="reference external" href="https://mikrotik.com/product/RB260GS">https://mikrotik.com/product/RB260GS</a></div>
</div>
<div class="line-block">
<div class="line">Netgear GS105E (requires Windows app for config):</div>
<div class="line"><a class="reference external" href="https://www.netgear.com/support/product/GS105E.aspx">https://www.netgear.com/support/product/GS105E.aspx</a></div>
</div>
<div class="line-block">
<div class="line">Netgear GS105E v2 (includes built-in web server for config):</div>
<div class="line"><a class="reference external" href="https://www.netgear.com/support/product/GS105Ev2">https://www.netgear.com/support/product/GS105Ev2</a></div>
</div>
<div class="line-block">
<div class="line">low cost TAP that uses USB or Ethernet port:</div>
<div class="line"><a class="reference external" href="http://www.midbittech.com">http://www.midbittech.com</a></div>
</div>
<div class="line-block">
<div class="line">More exhaustive list of enterprise switches with port mirroring:</div>
<div class="line"><a class="reference external" href="http://www.miarec.com/knowledge/switches-port-mirroring">http://www.miarec.com/knowledge/switches-port-mirroring</a></div>
</div>
<p>Enterprise Tap Solutions:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.ixiacom.com/network-visibility-products">Net Optics /
Ixia</a></li>
<li><a class="reference external" href="http://www.arista.com/en/solutions/tap-aggregation">Arista Tap Aggregation Feature
Set</a></li>
<li><a class="reference external" href="http://gigamon.com">Gigamon</a></li>
<li><a class="reference external" href="http://cpacket.com">cPacket</a></li>
<li><a class="reference external" href="http://www.bigswitch.com/products/big-monitoring-fabric">Bigswitch Monitoring
Fabric</a></li>
<li><a class="reference external" href="https://www.garlandtechnology.com/products">Garland Technologies
Taps</a></li>
<li><a class="reference external" href="https://www.apcon.com/products">APCON</a></li>
<li><a class="reference external" href="https://www.profitap.com">Profitap</a></li>
</ul>
</div>
<div class="section" id="further-reading">
<h5>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h5>
<p>For large networks and/or deployments, please also see <a class="reference external" href="https://github.com/pevma/SEPTun">https://github.com/pevma/SEPTun</a>.</p>
</div>
</div>
</div>
<span id="document-hwe"></span><div class="section" id="hwe">
<h3>HWE<a class="headerlink" href="#hwe" title="Permalink to this headline">¶</a></h3>
<p>HWE stands for Hardware Enablement and is Ubuntu’s term for kernel and graphics driver support.</p>
<div class="section" id="security-onion-iso-image">
<h4>Security Onion ISO Image<a class="headerlink" href="#security-onion-iso-image" title="Permalink to this headline">¶</a></h4>
<p>In order to provide the latest hardware support, our Security Onion 16.04 ISO image includes the HWE stack, which is the kernel and graphics support from Ubuntu 18.04 (Linux kernel 4.15).</p>
</div>
<div class="section" id="building-from-ubuntu">
<h4>Building from Ubuntu<a class="headerlink" href="#building-from-ubuntu" title="Permalink to this headline">¶</a></h4>
<p>If you choose to use an Ubuntu image instead the Security Onion image and want the latest hardware support, you’ll want to choose an image that includes the HWE stack.  Some Ubuntu images (like Ubuntu Server), provide a boot menu option to enable the HWE stack.</p>
</div>
<div class="section" id="more-information">
<h4>More information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information, please see <a class="reference external" href="https://wiki.ubuntu.com/Kernel/LTSEnablementStack">https://wiki.ubuntu.com/Kernel/LTSEnablementStack</a>.</p>
</div>
</div>
<span id="document-download"></span><div class="section" id="download">
<h3>Download<a class="headerlink" href="#download" title="Permalink to this headline">¶</a></h3>
<p>To install Security Onion, you can either download our Security Onion ISO image <strong>or</strong> download a standard Ubuntu 16.04 ISO image and then add our Security Onion PPA and packages. <strong>Please keep in mind that our PPA and packages are only compatible with Ubuntu 16.04</strong>.</p>
<p><strong>ALWAYS verify the checksum of ANY downloaded ISO image!</strong> Regardless of whether you’re downloading our Security Onion ISO image or whether you’re starting with an Ubuntu 16.04 ISO image, you should ALWAYS verify the downloaded ISO image.</p>
<ul class="simple">
<li>If downloading our Security Onion 16.04 ISO image, please verify using these instructions:
<a class="reference external" href="https://github.com/Security-Onion-Solutions/security-onion/blob/master/Verify_ISO.md">https://github.com/Security-Onion-Solutions/security-onion/blob/master/Verify_ISO.md</a></li>
<li>If downloading an Ubuntu 16.04 ISO image, please verify using these instructions:
<a class="reference external" href="https://help.ubuntu.com/community/VerifyIsoHowto">https://help.ubuntu.com/community/VerifyIsoHowto</a></li>
</ul>
</div>
<span id="document-vmware"></span><div class="section" id="vmware">
<h3>VMWare<a class="headerlink" href="#vmware" title="Permalink to this headline">¶</a></h3>
<div class="section" id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h4>
<p>In this section, we’ll cover creating a virtual machine (VM) for Security Onion 16.04 in VMWare Workstation Pro 12 (although this should be similar for most VMWare installations).</p>
<p>If you don’t have VMWare Workstation, you could also use VMWare Player, found here:</p>
<p><a class="reference external" href="http://www.vmware.com/products/player/playerpro-evaluation.html">http://www.vmware.com/products/player/playerpro-evaluation.html</a></p>
</div>
<div class="section" id="creating-vm">
<h4>Creating VM<a class="headerlink" href="#creating-vm" title="Permalink to this headline">¶</a></h4>
<p>Follow the steps below to install our Security Onion ISO image in VMware:</p>
<ol class="arabic simple">
<li>From VMWare, select File &gt;&gt; New Virtual Machine.</li>
<li>Select Typical installation &gt;&gt; Click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</li>
<li>Installer disc image file &gt;&gt; SO ISO file path &gt;&gt; Click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</li>
<li>Choose Linux, Ubuntu 64-Bit and click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</li>
<li>Specify virtual machine name and click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</li>
<li>Specify disk size (min 40GB), store as single file, click <code class="docutils literal notranslate"><span class="pre">Next</span></code>.</li>
<li>Customize hardware:</li>
<li>Memory – 8GB or more</li>
<li>Processors – 4 CPU cores or more</li>
<li>Network Adapter (NAT or Bridged – if you want to be able to access
your Security Onion machine from other devices in the network, then
choose Bridged, otherwise choose NAT to leave it behind the host) –
in this tutorial, this will be the management interface.</li>
<li>Add &gt;&gt; Network Adapter (Bridged) - this will be the sniffing (monitor) interface.</li>
<li>Click <code class="docutils literal notranslate"><span class="pre">Close</span></code>.</li>
<li>Click <code class="docutils literal notranslate"><span class="pre">Finish</span></code>.</li>
<li>Power on the virtual machine.</li>
</ol>
</div>
<div class="section" id="sniffing">
<h4>Sniffing<a class="headerlink" href="#sniffing" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>With the sniffing interface in “bridged” mode, you will be able to
see all traffic to/from the host machine’s physical NIC. If you would
like to see <strong>ALL</strong> the traffic on your network, you will need a
method of forwarding that traffic to the interface to which the
virtual adapter is bridged. This can be achieved by switch port
mirroring (SPAN), or through the use of a
<a class="reference external" href="Hardware#enterprise-tap-solutions">tap</a>.</li>
</ul>
</div>
</div>
<span id="document-virtualbox"></span><div class="section" id="virtualbox">
<h3>VirtualBox<a class="headerlink" href="#virtualbox" title="Permalink to this headline">¶</a></h3>
<p>In this section, we’ll cover installing Security Onion on VirtualBox.  You’ll need a computer with at least 16GB of
RAM (so that we can dedicate at least 8GB RAM to the VM) for best results. You can download a copy of VirtualBox for Windows, Mac OS X or Linux at <a class="reference external" href="http://www.virtualbox.org">http://www.virtualbox.org</a>.</p>
<div class="section" id="creating-vm">
<h4>Creating VM<a class="headerlink" href="#creating-vm" title="Permalink to this headline">¶</a></h4>
<p>Launch VirtualBox and click the “New” button. First we’ll provide a name for our virtual machine (“Security
Onion” for example) and specify the type (“Linux”) and
version (“Ubuntu” or “Ubuntu 64 bit”), then click “Continue.” We’ll next
define how much memory we want to make available to our virtual machine.
You should dedicate at least 8GB RAM to the Security Onion VM.</p>
<p>Next we’ll create a virtual hard drive. Specify “Create a
virtual hard drive now” then click “Create” to choose the hard drive
file type “VDI (VirtualBox Disk Image)” and “Continue.” For storage, we
have the options of “Dynamically allocated” or “Fixed size.” For a
client virtual machine, “Dynamically allocated” is the best choice as it
will grow the hard disk up to whatever we define as the maximum size on
an as needed basis until full, at which point Security Onion’s disk
cleanup routines will work to keep disk space available. If you happen
to be running a dedicated sensor in a virtual machine, I would suggest
using “Fixed size,” which will allocate all of the disk space you define
up front and save you some disk performance early on. Once you’ve
settled on the storage allocation, click “Continue” and provide a name
from your hard disk image file and specify the location where you want
the disk file to be created if other than the default location. For disk
size, you’ll want enough disk capacity for retrieving/testing packet
captures and downloading system updates. At a minimum for a client, I
would designate at least 40GB. Click “Create” and your Security Onion VM will be created.</p>
<p>At this point, you can click “Settings” for your new virtual machine so
we can get it configured. You might want to increase your display
virtual memory to 128MB of RAM, but most other settings should be fine.
We do, however, need to do a couple of things. First, mount the Security
Onion 16.04 ISO file so our VM can boot
from it to install Linux. Click the “Storage” icon, then under
“Controller: IDE” select the “Empty” CD icon. To the right, you’ll see
“CD/DVD Drive” with “IDE Secondary” specified with another CD icon.
Click the icon, then select “Choose a virtual CD/DVD disk file” and
browse to where you downloaded the Security Onion 16.04 ISO file,
select it then choose “Open.” Next click “Network” then “Adapter 2.”
You’ll need to click the checkbox to enable it then attach it to
“Internal Network.” Under the “Advanced” options, set “Promiscuous Mode”
to “Allow All.” Click “Ok” and we are ready to install the operating
system.</p>
<p>Hit the “Start” button with your new virtual machine selected and after
a few seconds the boot menu will load.</p>
</div>
<div class="section" id="virtualbox-guest-additions">
<h4>VirtualBox Guest Additions<a class="headerlink" href="#virtualbox-guest-additions" title="Permalink to this headline">¶</a></h4>
<p>At the top of your virtual machine window you’ll notice menu items for
VirtualBox. Click on your virtual machine window, then on the menu click
“Devices” then “Install Guest Additions…” Doing so will mount the
VirtualBox guest additions CD on your virtual machine and it will open
the folder showing you the files now available. Click on your terminal
window and type “cd /media/VBOX” then press the Tab key key to autofill
the folder name and press Enter to change to that directory. To install
the Guest Additions type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">./</span><span class="n">VBoxLinuxAdditions</span><span class="o">.</span><span class="n">run</span>
</pre></div>
</div>
<p>The installation will launch and after a few minutes you’ll return to the command prompt when it’s complete.</p>
</div>
<div class="section" id="snapshots">
<h4>Snapshots<a class="headerlink" href="#snapshots" title="Permalink to this headline">¶</a></h4>
<p>You’ll notice two icons on the top right in VirtualBox Manager when you select your virtual machine: Details and Snapshots. Click “Snapshots” then click the camera icon and give your snapshot a name and description. Once we have a snapshot, we’ll be able to make changes to the system and revert those changes back to the state we are preserving.</p>
</div>
</div>
<span id="document-trouble-booting"></span><div class="section" id="booting-issues">
<h3>Booting Issues<a class="headerlink" href="#booting-issues" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">Did you verify the downloaded ISO image as described on the
<a class="reference external" href="Installation">Installation</a> page?</p>
</li>
<li><p class="first">Does your machine support 64-bit? (If you’re trying to run a 64-bit
VM, then your 64-bit processor must support virtualization and
virtualization must be enabled in the BIOS.) If not, then you’ll need
to obtain a 64-bit machine to use our 64-bit ISO image (recommended).</p>
</li>
<li><p class="first">If you think your machine does support 64-bit, but you’re still
having problems with our 64-bit ISO image, try downloading the Ubuntu
16.04 64-bit ISO image and seeing if it runs. If it doesn’t, then you
should verify your 64-bit compatibility.</p>
</li>
<li><p class="first">If the ISO image boots, but it does not get past the splash screen,
try pressing the “Esc” key to see the current status.</p>
</li>
<li><div class="first line-block">
<div class="line">If the ISO image boots, but the Live Desktop doesn’t appear properly, it may be a video card/driver issue. Try changing <code class="docutils literal notranslate"><span class="pre">modeset</span></code> options:</div>
<div class="line"><a class="reference external" href="https://groups.google.com/d/topic/security-onion/FTEecyn4uJ4/discussion">https://groups.google.com/d/topic/security-onion/FTEecyn4uJ4/discussion</a></div>
<div class="line"><a class="reference external" href="https://groups.google.com/d/topic/security-onion/UKE5-dqybQ4/discussion">https://groups.google.com/d/topic/security-onion/UKE5-dqybQ4/discussion</a></div>
<div class="line"><a class="reference external" href="https://groups.google.com/d/topic/security-onion/51JZWXZfBho/discussion">https://groups.google.com/d/topic/security-onion/51JZWXZfBho/discussion</a></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">If all else fails but standard Ubuntu 16.04 installs normally, then you can always install our packages and Docker images on top of your Ubuntu 16.04 installation as described on the following pages:</div>
<div class="line"><a class="reference external" href="InstallingOnUbuntu">InstallingOnUbuntu</a></div>
<div class="line"><a class="reference external" href="ProductionDeployment">ProductionDeployment</a></div>
</div>
</li>
</ul>
</div>
<span id="document-installation"></span><div class="section" id="installation">
<h3>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="language">
<h4>Language<a class="headerlink" href="#language" title="Permalink to this headline">¶</a></h4>
<p>Please note that we only support the English language at this time.</p>
</div>
<div class="section" id="choose-your-installation-guide">
<h4>Choose your Installation Guide<a class="headerlink" href="#choose-your-installation-guide" title="Permalink to this headline">¶</a></h4>
<p>We have different Installation Guides to cover various use cases. Please choose the appropriate Installation Guide for your use case.</p>
<div class="section" id="quickly-evaluating-security-onion">
<h5>Quickly Evaluating Security Onion<a class="headerlink" href="#quickly-evaluating-security-onion" title="Permalink to this headline">¶</a></h5>
<p>If you just want to <strong>quickly evaluate</strong> Security Onion, choose one of the following two options. If you’re a first time user, we recommend the first option.</p>
<ul class="simple">
<li>To quickly evaluate using <strong>our Security Onion ISO image</strong>, please see the <a class="reference external" href="QuickISOImage">QuickISOImage</a> section.</li>
</ul>
<p>OR</p>
<ul class="simple">
<li>To quickly evaluate using <strong>your preferred flavor of Ubuntu 16.04</strong>, please see the <a class="reference external" href="InstallingOnUbuntu">InstallingOnUbuntu</a> section.</li>
</ul>
</div>
<div class="section" id="production-deployment">
<h5>Production Deployment<a class="headerlink" href="#production-deployment" title="Permalink to this headline">¶</a></h5>
<p>If you’re deploying Security Onion in <strong>production</strong>, please see the <a class="reference external" href="ProductionDeployment">Production Deployment</a> section.</p>
</div>
</div>
</div>
<span id="document-release-notes"></span><div class="section" id="iso-release-notes">
<h3>ISO Release Notes<a class="headerlink" href="#iso-release-notes" title="Permalink to this headline">¶</a></h3>
<ul>
<li><div class="first line-block">
<div class="line">As always, make sure you verify the downloaded ISO image:</div>
<div class="line"><a class="reference external" href="https://github.com/Security-Onion-Solutions/security-onion/blob/master/Verify_ISO.md">https://github.com/Security-Onion-Solutions/security-onion/blob/master/Verify_ISO.md</a></div>
</div>
</li>
<li><p class="first">When the ISO boots, choose the default boot menu option.</p>
</li>
<li><p class="first">Once the live desktop appears, double-click the <code class="docutils literal notranslate"><span class="pre">Install</span> <span class="pre">SecurityOnion</span></code> icon.</p>
</li>
<li><p class="first">On the “Installation type” screen, you may want to select the <code class="docutils literal notranslate"><span class="pre">Use</span> <span class="pre">LVM</span></code> option, as this will automatically create a <code class="docutils literal notranslate"><span class="pre">/boot</span></code> partition at the beginning of the drive and will give you more flexibility later. Check to see if the installer allocates a large amount of space to <code class="docutils literal notranslate"><span class="pre">/home</span></code>. If this is the case, you may want to shrink <code class="docutils literal notranslate"><span class="pre">/home</span></code> to give more space to <code class="docutils literal notranslate"><span class="pre">/</span></code>.</p>
</li>
<li><p class="first">If prompted with an encrypt home folder or encrypt partition option, DO NOT enable this feature.</p>
</li>
<li><p class="first">If asked about automatic updates, DO NOT enable automatic updates.</p>
</li>
<li><p class="first">The Keyboard Layout screen may be larger than your screen resolution and so the Continue button may be off the screen to the right as shown at <a class="reference external" href="https://launchpadlibrarian.net/207213663/Screenshot_wilyi386deskmanual_2015-05-22_13%3A05%3A41.png">https://launchpadlibrarian.net/207213663/Screenshot_wilyi386deskmanual_2015-05-22_13%3A05%3A41.png</a>.  You can simply slide the window over until you see the Continue button. For more information, please see <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/ubiquity/+bug/1458039">https://bugs.launchpad.net/ubuntu/+source/ubiquity/+bug/1458039</a>.</p>
</li>
<li><p class="first">Once the installer completes, it should prompt to remove installation media and press ENTER. If instead it appears to hang, simply press the ENTER key to reboot. If that doesn’t work, you may forcibly restart the machine.</p>
</li>
<li><p class="first">Once you’ve logged into your newly installed Security Onion, you’ll notice that there is only a Setup icon on the desktop. Other icons will be created when you complete both phases of Setup. So you’ll run Setup, configure your network interfaces, reboot, run Setup again to configure services, and then you’ll see desktop icons for user interfaces.</p>
</li>
<li><p class="first">Setup now defaults to enabling the Elastic Stack. We recommend a BARE MINIMUM of 4 CPU cores and 8GB RAM.</p>
</li>
<li><p class="first">When choosing Evaluation Mode, the following services are enabled by default: <a class="reference external" href="Snort">Snort</a>, <a class="reference external" href="Bro">Bro</a>, <a class="reference external" href="netsniff-ng">netsniff-ng</a>, pcap_agent, snort_agent, barnyard2.</p>
</li>
<li><p class="first">When choosing Production Mode, you then have the option of Best Practices or Custom. Best Practices asks a smaller number of questions and chooses the services that most folks want (<a class="reference external" href="Snort">Snort</a> or <a class="reference external" href="Suricata">Suricata</a>, <a class="reference external" href="Bro">Bro</a>, <a class="reference external" href="netsniff-ng">netsniff-ng</a>, pcap_agent, snort_agent, barnyard2, <a class="reference external" href="salt">salt</a>). Custom gives you more control over your system but requires more in-depth knowledge about services and their functions.</p>
</li>
<li><p class="first">Once you’ve completed both phases of Setup, you should see new icons on your Desktop.</p>
</li>
<li><p class="first">For more information, please refer to the full <a class="reference external" href="Installation">Installation</a> guide and other documentation.</p>
</li>
</ul>
</div>
<span id="document-quick-iso-image"></span><div class="section" id="quick-evaluation-using-security-onion-iso-image">
<h3>Quick Evaluation using Security Onion ISO image<a class="headerlink" href="#quick-evaluation-using-security-onion-iso-image" title="Permalink to this headline">¶</a></h3>
<p>If you just want to quickly evaluate Security Onion using our ISO image:</p>
<ol class="arabic simple">
<li>Review the <a class="reference external" href="Hardware">Hardware Requirements</a> and <a class="reference external" href="Release-Notes">Release Notes</a> pages.</li>
<li><a class="reference external" href="https://github.com/Security-Onion-Solutions/security-onion/blob/master/Verify_ISO.md">Download and verify our Security Onion ISO image</a>.</li>
<li>Boot the ISO image and choose the default boot menu option.</li>
<li>Once the live desktop appears, double-click the <code class="docutils literal notranslate"><span class="pre">Install</span> <span class="pre">SecurityOnion</span></code> icon.</li>
<li>Follow the prompts in the installer. If prompted with an <code class="docutils literal notranslate"><span class="pre">encrypt</span> <span class="pre">home</span> <span class="pre">folder</span></code> or <code class="docutils literal notranslate"><span class="pre">encrypt</span> <span class="pre">partition</span></code> option, <strong>DO NOT</strong> enable this feature. If asked about automatic updates, <strong>DO NOT</strong> enable automatic updates.</li>
<li>Once the installer completes, rebooot into your new installation and login using the username and password you specified during installation.</li>
<li>Double-click the Setup icon. The Setup wizard will walk you through configuring <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> and will then reboot.</li>
<li>After rebooting, log back in and start the Setup wizard again. It will detect that you have already configured <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> and will walk you through the rest of the configuration. When prompted for <code class="docutils literal notranslate"><span class="pre">Evaluation</span> <span class="pre">Mode</span></code> or <code class="docutils literal notranslate"><span class="pre">Production</span> <span class="pre">Mode</span></code>, choose <code class="docutils literal notranslate"><span class="pre">Evaluation</span> <span class="pre">Mode</span></code>.</li>
<li>Once you’ve completed the Setup wizard, use the Desktop icons to login to <a class="reference external" href="Sguil">Sguil</a>, <a class="reference external" href="Squert">Squert</a>, or <a class="reference external" href="Kibana">Kibana</a>.</li>
<li>Finally, review the <a class="reference external" href="PostInstallation">Post Installation</a> page.</li>
</ol>
</div>
<span id="document-installing-on-ubuntu"></span><div class="section" id="quick-evaluation-on-ubuntu">
<h3>Quick Evaluation on Ubuntu<a class="headerlink" href="#quick-evaluation-on-ubuntu" title="Permalink to this headline">¶</a></h3>
<p>If you want to quickly evaluate Security Onion on your preferred flavor of Ubuntu 16.04 64-bit (not using our ISO image), follow these steps:</p>
<ul>
<li><p class="first">Review the <a class="reference external" href="Hardware">Hardware Requirements</a> page.</p>
</li>
<li><p class="first">Download the ISO image for your preferred flavor of Ubuntu 16.04 64-bit, verify the ISO image, and boot from it.</p>
</li>
<li><p class="first">Follow the prompts in the installer. If prompted to <code class="docutils literal notranslate"><span class="pre">encrypt</span> <span class="pre">home</span> <span class="pre">folder</span></code> or <code class="docutils literal notranslate"><span class="pre">encrypt</span> <span class="pre">partition</span></code>, <strong>DO NOT</strong> enable either of these. When asked about automatic updates, <strong>DO NOT</strong> enable automatic updates.</p>
</li>
<li><p class="first">Reboot into your new installation.</p>
</li>
<li><p class="first">Login using the username and password you specified during installation.</p>
</li>
<li><p class="first">Verify that you have Internet connectivity. If necessary, configure your <a class="reference external" href="Proxy">proxy</a> settings.</p>
</li>
<li><p class="first">Log back in (using <code class="docutils literal notranslate"><span class="pre">ssh</span> <span class="pre">-X</span></code> if you’re installing on Ubuntu Server or a headless distro).</p>
</li>
<li><p class="first">Configure <code class="docutils literal notranslate"><span class="pre">MySQL</span></code> not to prompt for root password (Setup will generate a random password later):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;debconf debconf/frontend select noninteractive&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">debconf</span><span class="o">-</span><span class="nb">set</span><span class="o">-</span><span class="n">selections</span>
</pre></div>
</div>
</li>
<li><p class="first">Clean apt list repository:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rm</span> <span class="o">-</span><span class="n">rf</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">lists</span><span class="o">/*</span>
</pre></div>
</div>
</li>
<li><p class="first">Update package list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
</pre></div>
</div>
</li>
<li><p class="first">Install software-properties-common if necessary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span>
</pre></div>
</div>
</li>
<li><p class="first">Add the Security Onion stable repository:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="o">-</span><span class="n">y</span> <span class="n">ppa</span><span class="p">:</span><span class="n">securityonion</span><span class="o">/</span><span class="n">stable</span>
</pre></div>
</div>
</li>
<li><p class="first">Update package list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
</pre></div>
</div>
</li>
<li><p class="first">Install the securityonion-all metapackage:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="nb">all</span> <span class="n">syslog</span><span class="o">-</span><span class="n">ng</span><span class="o">-</span><span class="n">core</span>
</pre></div>
</div>
</li>
<li><p class="first">Run the Setup wizard (if you’re using Ubuntu Server with no GUI and are doing this over SSH, you will need to forward X for this to work):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sosetup</span>
</pre></div>
</div>
</li>
<li><p class="first">Follow the prompts in the Setup wizard.</p>
</li>
<li><p class="first">Once Setup is complete, review alerts and logs using <a class="reference external" href="Sguil">Sguil</a>, <a class="reference external" href="Squert">Squert</a>, and <a class="reference external" href="Kibana">Kibana</a>.</p>
</li>
<li><p class="first">Review the <a class="reference external" href="PostInstallation">PostInstallation</a> page.</p>
</li>
</ul>
</div>
<span id="document-production-deployment"></span><div class="section" id="production-deployment">
<h3>Production Deployment<a class="headerlink" href="#production-deployment" title="Permalink to this headline">¶</a></h3>
<p>If you’re going to be deploying Security Onion in production, please use the following steps.</p>
<div class="section" id="hardware-requirements">
<h4>Hardware Requirements<a class="headerlink" href="#hardware-requirements" title="Permalink to this headline">¶</a></h4>
<p>First, check the <a class="reference external" href="Hardware">Hardware Requirements</a> page.</p>
</div>
<div class="section" id="download-and-verify">
<h4>Download and Verify<a class="headerlink" href="#download-and-verify" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><a class="reference external" href="https://github.com/Security-Onion-Solutions/security-onion/blob/master/Verify_ISO.md">Download and verify the Security Onion ISO image</a></div>
<div class="line">OR</div>
<div class="line">download and verify the ISO image for your preferred flavor of Ubuntu 16.04 64-bit.</div>
</div>
</div>
<div class="section" id="distributed-deployments">
<h4>Distributed Deployments<a class="headerlink" href="#distributed-deployments" title="Permalink to this headline">¶</a></h4>
<p>If deploying a <a class="reference external" href="Elastic-Architecture#distributed">distributed</a> environment, you’ll need to perform the remaining steps on the server, as well as all forward and storage nodes, but make sure you install and configure the master server first. For best performance, the master server should be dedicated to just being a server for the other nodes (the master server should have no sniffing interfaces of its own). Please note that <a class="reference external" href="Elastic-Architecture#forward-node">forward</a> and <a class="reference external" href="Elastic-Architecture#heavy-node">heavy</a> nodes need to connect to the <a class="reference external" href="Elastic-Architecture#master">master server</a> on ports <code class="docutils literal notranslate"><span class="pre">22</span></code> and <code class="docutils literal notranslate"><span class="pre">7736</span></code>. If you choose to enable salt for node management, nodes will need to be able to connect to the master server on ports <code class="docutils literal notranslate"><span class="pre">4505</span></code> and <code class="docutils literal notranslate"><span class="pre">4506</span></code>.</p>
</div>
<div class="section" id="install">
<h4>Install<a class="headerlink" href="#install" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Using the downloaded ISO, install the operating system. If the boot menu has a <code class="docutils literal notranslate"><span class="pre">Boot</span> <span class="pre">and</span> <span class="pre">Install</span> <span class="pre">with</span> <span class="pre">the</span> <span class="pre">HWE</span> <span class="pre">kernel</span></code> option, select this option.  If prompted with an <code class="docutils literal notranslate"><span class="pre">encrypt</span> <span class="pre">home</span> <span class="pre">folder</span></code> option, DO NOT enable this feature. If asked about <code class="docutils literal notranslate"><span class="pre">automatic</span> <span class="pre">updates</span></code>, DO NOT enable automatic updates. If prompted to install any additional packages, leave <code class="docutils literal notranslate"><span class="pre">standard</span> <span class="pre">system</span> <span class="pre">utilities</span></code> selected and also select <code class="docutils literal notranslate"><span class="pre">OpenSSH</span> <span class="pre">Server</span></code> (openssh-server). Do NOT choose <code class="docutils literal notranslate"><span class="pre">MySQL</span></code> at this point. All other required dependencies will be installed automatically.</li>
<li>When asked about partitioning, there are a few things to keep in mind:<ul>
<li>If you have more than 2TB of disk space, you will probably want to create a dedicated <code class="docutils literal notranslate"><span class="pre">/boot</span></code> partition at the beginning of the disk to ensure that you don’t have any Grub booting issues. Choosing the <code class="docutils literal notranslate"><span class="pre">LVM</span></code> option should do this automatically.</li>
<li>Check to see if the installer allocates a large amount of space to <code class="docutils literal notranslate"><span class="pre">/home</span></code>. If this is the case, you may want to shrink <code class="docutils literal notranslate"><span class="pre">/home</span></code> to give more space to <code class="docutils literal notranslate"><span class="pre">/</span></code>.</li>
<li>The Sguil database on the server (doesn’t exist on other node types) can grow fairly large (100GB or more for decent-size networks). It’s stored at <code class="docutils literal notranslate"><span class="pre">/var/lib/mysql/</span></code>, so you may want to put <code class="docutils literal notranslate"><span class="pre">/var</span></code> on a dedicated partition or disk and assign a good amount of disk space to it. Also see the <code class="docutils literal notranslate"><span class="pre">DAYSTOKEEP</span></code> instructions on the <a class="reference external" href="PostInstallation">Post-Installation page</a>.</li>
<li>Forward, Heavy, and Standalone nodes store full packet captures at <code class="docutils literal notranslate"><span class="pre">/nsm/sensor_data/</span></code>, so you may want to put <code class="docutils literal notranslate"><span class="pre">/nsm</span></code> on a dedicated partition/disk and assign as much disk space as possible (1TB or more). For larger volumes you might also consider using XFS for the <code class="docutils literal notranslate"><span class="pre">/nsm</span></code> partition.</li>
<li>For Heavy, Standalone, and Storage Nodes, it is highly recommended to place <code class="docutils literal notranslate"><span class="pre">/nsm/elasticsearch</span></code> and <code class="docutils literal notranslate"><span class="pre">/nsm/logstash</span></code> on SSD or fast spinning disk in a RAID 10 configuration. See <a class="reference external" href="Hardware#elastic-stack">Hardware Requirements</a> for more details.</li>
</ul>
</li>
<li>When installation completes, reboot into your new installation and login with the credentials you specified during installation.</li>
<li>If you’re running a VM, now would be a good time to snapshot it so you can revert later if you need to.</li>
</ol>
</div>
<div class="section" id="update">
<h4>Update<a class="headerlink" href="#update" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">If this box is going to be a node (forward, heavy, or storage), make sure that your master server and all other nodes in your deployment are fully updated with <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">soup</span></code> before adding a new node.</p>
</li>
<li><p class="first">Verify that you have Internet connectivity. If necessary, configure your <a class="reference external" href="Proxy">proxy</a> settings.</p>
</li>
<li><p class="first">If you installed from the Security Onion 16.04 ISO image, run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">soup</span></code> and reboot if prompted, then skip to the Setup section below (if you get any errors relating to MySQL, please see the <a class="reference external" href="MySQL-Upgrade-Errors">MySQL-Upgrade-Errors</a> section). Otherwise, if you’re installing on Ubuntu, continue to the next step.</p>
</li>
<li><p class="first">Install all Ubuntu updates and reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">apt</span> <span class="n">dist</span><span class="o">-</span><span class="n">upgrade</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
</li>
<li><p class="first">Log back in and configure MySQL not to prompt for root password (Setup will generate a random password later):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;debconf debconf/frontend select noninteractive&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">debconf</span><span class="o">-</span><span class="nb">set</span><span class="o">-</span><span class="n">selections</span>
</pre></div>
</div>
</li>
<li><p class="first">Install software-properties-common if it’s not already installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">software</span><span class="o">-</span><span class="n">properties</span><span class="o">-</span><span class="n">common</span>
</pre></div>
</div>
</li>
<li><p class="first">Add the Security Onion stable repository:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="o">-</span><span class="n">y</span> <span class="n">ppa</span><span class="p">:</span><span class="n">securityonion</span><span class="o">/</span><span class="n">stable</span>
</pre></div>
</div>
</li>
<li><p class="first">Update:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
</pre></div>
</div>
</li>
<li><p class="first">Install the <code class="docutils literal notranslate"><span class="pre">securityonion-all</span></code> metapackage (or one of the more focused <a class="reference external" href="MetaPackages">metapackages</a>). This could take 15 minutes or more depending on the speed of your CPU and Internet connection.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="nb">all</span> <span class="n">syslog</span><span class="o">-</span><span class="n">ng</span><span class="o">-</span><span class="n">core</span>
</pre></div>
</div>
</li>
<li><p class="first">OPTIONAL: If you want to use <a class="reference external" href="Salt">Salt</a> to manage your deployment, also install <code class="docutils literal notranslate"><span class="pre">securityonion-onionsalt</span></code>. You can do this before or after Setup, but it’s much easier if you do it before Setup.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">onionsalt</span>
</pre></div>
</div>
</li>
<li><p class="first">Update all packages:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">soup</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="setup">
<h4>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Run the Setup wizard. If you are locally on the box, you can run the GUI by double-clicking the Desktop shortcut or running the following from a terminal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sosetup</span>
</pre></div>
</div>
<p>Otherwise, if you are remote and logged in over ssh, you can run CLI-only Setup using <code class="docutils literal notranslate"><span class="pre">sosetup.conf</span></code>. For more information, please see <code class="docutils literal notranslate"><span class="pre">/usr/share/securityonion/sosetup.conf</span></code>.</p>
</li>
<li><p class="first">The Setup wizard will walk you through configuring <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> and will then reboot.</p>
</li>
<li><p class="first">When prompted whether you would like to configure <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> now, choose <code class="docutils literal notranslate"><span class="pre">Yes,</span> <span class="pre">configure</span>
<span class="pre">/etc/network/interfaces!</span></code>.</p>
</li>
<li><p class="first">If you have more than one network interface, you’ll be asked to specify which one should be the management interface.</p>
</li>
<li><p class="first">You’ll then be asked to choose DHCP or static addressing for the management interface. It is highly recommended you choose static.</p>
</li>
<li><p class="first">Choosing static, you’ll be prompted to enter a static IP address for your management interface, the network’s subnet mask, gateway IP address, DNS server IP addresses (separated by spaces), and your local domain.</p>
</li>
<li><p class="first">You’ll then be prompted to select any additional interfaces that will be used for sniffing/monitoring network traffic.</p>
</li>
<li><p class="first">When prompted, choose <code class="docutils literal notranslate"><span class="pre">Yes,</span> <span class="pre">make</span> <span class="pre">changes!</span></code>.</p>
</li>
<li><p class="first">If you need to adjust any network settings manually (e.g. <code class="docutils literal notranslate"><span class="pre">MTU</span></code>), you may edit <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> before rebooting.</p>
</li>
<li><p class="first">When ready to reboot, click <code class="docutils literal notranslate"><span class="pre">Yes,</span> <span class="pre">reboot!</span></code>.</p>
</li>
<li><p class="first">After rebooting, log back in and start the Setup wizard again (GUI if local, <code class="docutils literal notranslate"><span class="pre">sosetup.conf</span></code> CLI if remote). It will detect that you have already configured <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> and will walk you through the rest of the configuration.</p>
</li>
<li><p class="first">Select <code class="docutils literal notranslate"><span class="pre">Production</span> <span class="pre">Mode</span></code>.</p>
</li>
<li><p class="first">Select <code class="docutils literal notranslate"><span class="pre">New</span></code> or <code class="docutils literal notranslate"><span class="pre">Existing</span></code> (<code class="docutils literal notranslate"><span class="pre">New</span></code> if this is a master or standalone, and <code class="docutils literal notranslate"><span class="pre">Existing</span></code> for forward, heavy, and storage nodes).</p>
</li>
</ol>
<ul>
<li><p class="first">New (Master Server or Standalone)</p>
<ol class="arabic simple">
<li>Provide a username and password for the analyst user.</li>
<li>Select <code class="docutils literal notranslate"><span class="pre">Best</span> <span class="pre">Practices</span></code>.</li>
<li>Choose your IDS ruleset.</li>
<li>Choose your IDS engine (<a class="reference external" href="Snort">Snort</a> or <a class="reference external" href="Suricata">Suricata</a>).</li>
<li>Choose whether or not to enable sensor services.  If this is going to be a standalone box with no other nodes connected, you can enable sensor services. Otherwise, if this going to be a distributed deployment with multiple nodes connected, we recommend disabling sensor services on this master server.</li>
<li>Choose whether or not to use storage nodes for log storage.  Please note that, if you choose to use storage nodes, then until a storage node is configured and Logstash has intialized on the storage node, you will not be able to review log data for configured forward nodes.</li>
<li>Select <code class="docutils literal notranslate"><span class="pre">Yes</span></code> to proceed with your changes.</li>
</ol>
</li>
<li><p class="first">Existing (Forward Node, Heavy Node, or Storage Node)</p>
<ol class="arabic">
<li><p class="first">Provide the hostname or IP address of the master server (some folks may want to specify the IP/hostname of the master server in <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code> and use the specified hostname during setup – this may help in the event the master server IP changes.)</p>
</li>
<li><p class="first">Provide a username to SSH to the master for the node (should have already been created on the master and added to the <code class="docutils literal notranslate"><span class="pre">sudo</span></code> group). Please make sure that your server has been set up and you have network connectivity and no firewall rules that would block this traffic. Additionally, consider creating a separate SSH account on the master server for each node so that if a node is ever compromised, its individual account can be disabled without affecting the other nodes.  If you need to create a user account on the Master, you can do something like the following (where <code class="docutils literal notranslate"><span class="pre">$nodeuser</span></code> is your specified user): <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">adduser</span> <span class="pre">$nodeuser</span> <span class="pre">&amp;&amp;</span> <span class="pre">sudo</span> <span class="pre">adduser</span> <span class="pre">$nodeuser</span> <span class="pre">sudo</span></code>  The new account must have a full home directory. If you do not create it when you create the account, copy <code class="docutils literal notranslate"><span class="pre">/etc/skel</span></code> to <code class="docutils literal notranslate"><span class="pre">/home/$nodeuser</span></code> and do <code class="docutils literal notranslate"><span class="pre">chown</span> <span class="pre">-R</span> <span class="pre">$nodeuser:$nodeuser</span> <span class="pre">/home/$nodeuser</span></code>. This is needed so the .ssh directory may be created to manage the connection. <em>NOTE: This user should be removed from the sudo group on the master server after setup</em>.</p>
</li>
<li><p class="first">Select Node Type:</p>
<ul class="simple">
<li>Forward Node<ul>
<li>Select <code class="docutils literal notranslate"><span class="pre">Best</span> <span class="pre">Practices</span></code>.</li>
<li>Keep the default for <a class="reference external" href="PF-RING">PF-RING</a> <code class="docutils literal notranslate"><span class="pre">min_num_slots</span></code>, unless you would like to change it.</li>
<li>Modify the selected sniffing interfaces if necessary – otherwise, continue.</li>
<li>Modify <code class="docutils literal notranslate"><span class="pre">HOME_NET</span></code> as desired.</li>
<li>Select <code class="docutils literal notranslate"><span class="pre">Yes</span></code> to proceed with your changes.</li>
<li><em>Please note: If you chose to use one or more storage nodes with your master server, you will be able to receive IDS alerts and pull PCAPs from the forward node once setup completes, however, you will not be able to review other logs (i.e. Bro logs in Kibana) from the node until a storage node has been configured for the master server and Logstash on the storage node has initialized.</em></li>
</ul>
</li>
<li>Heavy Node<ul>
<li>Select <code class="docutils literal notranslate"><span class="pre">Best</span> <span class="pre">Practices</span></code>.</li>
<li>Keep the default for <a class="reference external" href="PF-RING">PF-RING</a> <code class="docutils literal notranslate"><span class="pre">min_num_slots</span></code>, unless you would like to change it.</li>
<li>Modify the selected sniffing interfaces if necessary – otherwise, continue.</li>
<li>Modify <code class="docutils literal notranslate"><span class="pre">HOME_NET</span></code> as desired.</li>
<li>Provide amount of disk space to be used for Elasticsearch to store logs (default is half of available disk space).</li>
<li>Select <code class="docutils literal notranslate"><span class="pre">Yes</span></code> to proceed with your changes.</li>
</ul>
</li>
<li>Storage Node<ul>
<li>Provide amount of disk space to be used for Elasticsearch to store logs (default is half of available disk space).</li>
<li>Select <code class="docutils literal notranslate"><span class="pre">Yes</span></code> to proceed with your changes.</li>
</ul>
</li>
</ul>
</li>
<li><p class="first">Remove <code class="docutils literal notranslate"><span class="pre">$nodeuser</span></code> from the <code class="docutils literal notranslate"><span class="pre">sudo</span></code> group on the master server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo deluser $nodeuser sudo
</pre></div>
</div>
</li>
</ol>
</li>
</ul>
<p>Proceed to <a class="reference external" href="PostInstallation">PostInstallation</a>.</p>
</div>
</div>
<span id="document-post-installation"></span><div class="section" id="after-installation">
<h3>After Installation<a class="headerlink" href="#after-installation" title="Permalink to this headline">¶</a></h3>
<div class="section" id="resolution">
<h4>Resolution<a class="headerlink" href="#resolution" title="Permalink to this headline">¶</a></h4>
<p>If you need to change the screen resolution of your Security Onion installation:</p>
<ul class="simple">
<li>click the <code class="docutils literal notranslate"><span class="pre">Applications</span></code> menu in the upper left corner</li>
<li>click <code class="docutils literal notranslate"><span class="pre">System</span> <span class="pre">Tools</span></code></li>
<li>click <code class="docutils literal notranslate"><span class="pre">Setttings</span></code></li>
<li>click <code class="docutils literal notranslate"><span class="pre">Displays</span></code></li>
<li>select your display</li>
<li>choose your desired resolution</li>
<li>click <code class="docutils literal notranslate"><span class="pre">Apply</span></code></li>
</ul>
<p>If you prefer a CLI method for changing screen resolution, you can use <cite>xrandr</cite>. For a list of available screen resolutions, simply execute <code class="docutils literal notranslate"><span class="pre">xrandr</span></code>. To set the screen resolution (replace <code class="docutils literal notranslate"><span class="pre">W</span></code> and <code class="docutils literal notranslate"><span class="pre">H</span></code> with the actual Width and Height desired):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">xrandr</span> <span class="o">-</span><span class="n">s</span> <span class="n">WxH</span>
</pre></div>
</div>
<p>If you have limited screen resolution options and are in a virtualized environment, you may need to install the Virtual Tools for your virtualization solution. For example, this can happen if you’re running VirtualBox and you can install the VirtualBox Extensions to get more resolution options.</p>
</div>
<div class="section" id="services">
<h4>Services<a class="headerlink" href="#services" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Verify services are running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">status</span>
</pre></div>
</div>
</li>
<li><p class="first">If any services are not running, try starting them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</li>
<li><p class="first">If you have problems with Snort/Suricata/Bro/PF-RING and have UEFI Secure Boot enabled, please see the <a class="reference external" href="Secure-Boot">Secure Boot</a> section.</p>
</li>
<li><p class="first">Log into <a class="reference external" href="Sguil">Sguil</a>, <a class="reference external" href="Squert">Squert</a>, and <a class="reference external" href="Kibana">Kibana</a> and verify that you have events in the interfaces.  If you don’t have any IDS alerts, you can try to generate one by typing the following at a terminal (only works if you have Internet access):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">testmyids</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="other">
<h4>Other<a class="headerlink" href="#other" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Full-time analysts may want to connect using a separate <a class="reference external" href="Analyst-VM">Analyst VM</a>.</p>
</li>
<li><p class="first">Setup defaults to only opening port 22 in the <a class="reference external" href="Firewall">firewall</a>. If you want to connect analyst VMs, <a class="reference external" href="Wazuh">Wazuh</a> agents, or syslog devices, you can run the <a class="reference external" href="so-allow">so-allow</a> utility which will walk you through creating firewall rules to allow these devices to connect.</p>
</li>
<li><p class="first">Run the following to see how your sensor is coping with the load. You should check this on a daily basis to make sure your sensor is not dropping packets. Consider adding it to a cronjob and having it emailed to you (see the “configure email” link below).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sostat</span> <span class="o">|</span> <span class="n">less</span>
</pre></div>
</div>
</li>
<li><p class="first">Any IDS/NSM system needs to be tuned for the network it’s monitoring. Please see the <a class="reference external" href="tuning">tuning</a> section.</p>
</li>
<li><p class="first">Review and categorize alerts in <a class="reference external" href="Sguil">Sguil</a>  or <a class="reference external" href="Squert">Squert</a> on a daily basis.  Categorizing alerts and tuning rules should be an iterative process with the goal being to categorize <em>all</em> events every day.  You should only run the IDS rules you really care about.</p>
</li>
</ul>
</div>
<div class="section" id="optional">
<h4>Optional<a class="headerlink" href="#optional" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Exclude unnecessary traffic from your monitoring using <a class="reference external" href="BPF">BPF</a>.</p>
</li>
<li><p class="first">Configure Ubuntu to use your preferred <a class="reference external" href="NTP">NTP</a> server.</p>
</li>
<li><p class="first">Add new Sguil user accounts with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">add</span>
</pre></div>
</div>
</li>
<li><p class="first">On the server running the Sguil database, set the <code class="docutils literal notranslate"><span class="pre">DAYSTOKEEP</span></code> variable in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code> to however many days you want to keep in your archive. The default is 30, but you may need to adjust it based on your organization’s detection/response policy and your available disk space.</p>
</li>
<li><p class="first">If you’re monitoring IP address ranges other than private RFC1918 address space (192.168.0.0/16, 10.0.0.0/8, 172.16.0.0/12), you may need to update your sensor configuration with the correct IP ranges. Modern versions of Setup should automatically ask you for <code class="docutils literal notranslate"><span class="pre">HOME_NET</span></code> and configure these for you, but if you need to update it later, you would do the following. Sensor configuration files can be found in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/$HOSTNAME-$INTERFACE/</span></code>. Modify either <code class="docutils literal notranslate"><span class="pre">snort.conf</span></code> or <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> (depending on which IDS engine you chose during <code class="docutils literal notranslate"><span class="pre">sosetup</span></code>) and update the <code class="docutils literal notranslate"><span class="pre">HOME_NET</span></code> variable. You may also want to consider updating the <code class="docutils literal notranslate"><span class="pre">EXTERNAL_NET</span></code> variable. Then update Bro’s network configuration in <code class="docutils literal notranslate"><span class="pre">/opt/bro/etc/networks.cfg</span></code>. Finally, restart the sensor processes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure <a class="reference external" href="Email">Email</a> for alerting and reporting.</p>
</li>
<li><p class="first">Place <code class="docutils literal notranslate"><span class="pre">/etc</span></code> under version control. If your organization doesn’t already have a standard version control tool, you can use <a class="reference external" href="https://help.ubuntu.com/12.04/serverguide/bazaar.html">bazaar</a>, <a class="reference external" href="http://git-scm.com/">git</a>, etckeeper:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">etckeeper</span>
</pre></div>
</div>
</li>
<li><p class="first">Need “remote desktop” access to your Security Onion sensor or server? One option is SSH X-Forwarding, but if you want something more rdp-like, you can install xrdp:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">xrdp</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="learn-more">
<h4>Learn More<a class="headerlink" href="#learn-more" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Read more about the tools contained in Security Onion:
<a class="reference external" href="Tools">Tools</a></li>
</ul>
</div>
</div>
<span id="document-secure-boot"></span><div class="section" id="secure-boot">
<h3>Secure Boot<a class="headerlink" href="#secure-boot" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Modern Linux kernels prevent the loading of unsigned third party modules (like <a class="reference external" href="PF-RING">PF-RING</a>) if UEFI Secure Boot is enabled. An example of this can be found here:</div>
<div class="line"><a class="reference external" href="https://groups.google.com/d/msg/security-onion/r64yl58KGJ4/uRedkKTBCAAJ">https://groups.google.com/d/msg/security-onion/r64yl58KGJ4/uRedkKTBCAAJ</a></div>
<div class="line"><br /></div>
<div class="line">To avoid issues like this, modern versions of our Setup wizard now default to <a class="reference external" href="AF-PACKET">AF-PACKET</a> instead of <a class="reference external" href="PF-RING">PF-RING</a> for both <a class="reference external" href="Bro">Bro</a> and <a class="reference external" href="Suricata">Suricata</a>:</div>
<div class="line"><a class="reference external" href="https://blog.securityonion.net/2019/02/new-setup-and-nsm-packages-now.html">https://blog.securityonion.net/2019/02/new-setup-and-nsm-packages-now.html</a></div>
<div class="line"><br /></div>
<div class="line">However, if you choose <a class="reference external" href="Snort">Snort</a> as your NIDS engine, it will fall back to <a class="reference external" href="PF-RING">PF-RING</a> (at least until Snort 3.0 is released). If you have problems with <a class="reference external" href="Snort">Snort</a> / <a class="reference external" href="PF-RING">PF-RING</a> and Secure Boot, then you can either switch from <a class="reference external" href="Snort">Snort</a> to <a class="reference external" href="Suricata">Suricata</a> OR if you need to keep Snort you can disable Secure Boot:</div>
<div class="line"><a class="reference external" href="https://wiki.ubuntu.com/UEFI/SecureBoot/DKMS">https://wiki.ubuntu.com/UEFI/SecureBoot/DKMS</a></div>
<div class="line"><a class="reference external" href="http://askubuntu.com/questions/762254/why-do-i-get-required-key-not-available-when-install-3rd-party-kernel-modules">http://askubuntu.com/questions/762254/why-do-i-get-required-key-not-available-when-install-3rd-party-kernel-modules</a></div>
</div>
</div>
</div>
</div>
<span id="document-analyst"></span><div class="section" id="analyst-tools">
<h2>Analyst Tools<a class="headerlink" href="#analyst-tools" title="Permalink to this headline">¶</a></h2>
<p>In this section, we’ll look at different analyst tools that can be used for slicing and dicing data coming from your network and endpoints.</p>
<div class="toctree-wrapper compound">
<span id="document-kibana"></span><div class="section" id="kibana">
<h3>Kibana<a class="headerlink" href="#kibana" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://www.elastic.co/products/kibana">https://www.elastic.co/products/kibana</a> :</p>
<blockquote>
<div>Kibana lets you visualize your Elasticsearch data and navigate the
Elastic Stack, so you can do anything from learning why you’re
getting paged at 2:00 a.m. to understanding the impact rain might
have on your quarterly numbers.</div></blockquote>
<div class="section" id="screenshot">
<h4>Screenshot<a class="headerlink" href="#screenshot" title="Permalink to this headline">¶</a></h4>
<img alt="_images/kibana.png" src="_images/kibana.png" />
</div>
<div class="section" id="authentication">
<h4>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h4>
<p>If prompted for username and password, simply enter your normal Sguil/Squert/Kibana username and password.</p>
</div>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Configuration files for Kibana can be found in <code class="docutils literal notranslate"><span class="pre">/etc/kibana/</span></code>.</li>
<li>Other configuration options for Kibana can be found in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code>.</li>
<li>Kibana logs can be found in <code class="docutils literal notranslate"><span class="pre">/var/log/kibana/</span></code>.</li>
</ul>
</div>
<div class="section" id="pivoting">
<h4>Pivoting<a class="headerlink" href="#pivoting" title="Permalink to this headline">¶</a></h4>
<p>Kibana uses multiple hyperlinked fields to accelerate investigations and decision-making:</p>
<div class="section" id="transcript">
<h5>Transcript<a class="headerlink" href="#transcript" title="Permalink to this headline">¶</a></h5>
<p>When present, clicking the <code class="docutils literal notranslate"><span class="pre">_id</span></code> field allows an analyst to pivot to transcript via <a class="reference external" href="CapMe">CapMe</a>.</p>
</div>
<div class="section" id="indicator-dashboard">
<h5>Indicator Dashboard<a class="headerlink" href="#indicator-dashboard" title="Permalink to this headline">¶</a></h5>
<p>When present, clicking these fields allows an analyst to pivot to the Indicator dashboard, where a variety of information is presented relative to the term:value.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">uid</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">source_ip</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">source_port</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">destination_ip</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">destination_port</span></code></div>
</div>
</div>
</div>
<div class="section" id="search-results">
<h4>Search Results<a class="headerlink" href="#search-results" title="Permalink to this headline">¶</a></h4>
<p>Search results in the dashboards and through Discover are limited to the first <code class="docutils literal notranslate"><span class="pre">10</span></code> results for a particular query. If you don’t feel like this is adequate after narrowing your search, you can adjust the value for <code class="docutils literal notranslate"><span class="pre">discover:sampleSize</span></code> in Kibana by navigating to <code class="docutils literal notranslate"><span class="pre">Management</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Advanced</span> <span class="pre">Settings</span></code> and changing the value. It may be best to change this value incrementally to see how it affects performance.</p>
</div>
<div class="section" id="search-request-timeout">
<h4>Search Request Timeout<a class="headerlink" href="#search-request-timeout" title="Permalink to this headline">¶</a></h4>
<p>Sometimes searches can timeout in Kibana. To increase the timeout value to wait longer for results from Elasticsearch, we can adjust the value for <code class="docutils literal notranslate"><span class="pre">elasticsearch.requestTimeout</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/kibana/kibana.yml</span></code> and restart Kibana.</p>
<p>For example to increase the timeout from the default of <code class="docutils literal notranslate"><span class="pre">30</span></code> seconds to <code class="docutils literal notranslate"><span class="pre">90</span></code> seconds:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">kibana</span><span class="o">/</span><span class="n">kibana</span><span class="o">.</span><span class="n">yml</span>
</pre></div>
</div>
<p>Add the following line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">elasticsearch</span><span class="o">.</span><span class="n">requestTimeout</span><span class="p">:</span> <span class="mi">90000</span>
</pre></div>
</div>
<p>Finally, restart Kibana:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">kibana</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="timestamps">
<h4>Timestamps<a class="headerlink" href="#timestamps" title="Permalink to this headline">¶</a></h4>
<p>By default, Kibana will display timestamps in the timezone of your local browser. If you would prefer timestamps in UTC, you can go to <code class="docutils literal notranslate"><span class="pre">Management</span></code> –&gt; <code class="docutils literal notranslate"><span class="pre">Advanced</span> <span class="pre">Settings</span></code> and set <code class="docutils literal notranslate"><span class="pre">dateFormat:tz</span></code> to <code class="docutils literal notranslate"><span class="pre">UTC</span></code>.</p>
</div>
<div class="section" id="plugins">
<h4>Plugins<a class="headerlink" href="#plugins" title="Permalink to this headline">¶</a></h4>
<p>Please note that we do not officially support installing plugins.  Do so at your own risk!</p>
<p>To add a plugin to Kibana, you can expose the plugins directory to the host filesystem and then copy your plugins to that directory. For example, to load the <a class="reference external" href="https://github.com/dlumbrer/kbn_network">kbn_network</a> plugin you can do something like the following.</p>
<p>Create a new directory in the host filesystem called <code class="docutils literal notranslate"><span class="pre">/nsm/kibana/plugins</span></code> to store plugins:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">kibana</span><span class="o">/</span><span class="n">plugins</span>
</pre></div>
</div>
<p>Download your desired plugin and decompress it to <code class="docutils literal notranslate"><span class="pre">/nsm/kibana/plugins</span></code>.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">qO</span><span class="o">-</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">dlumbrer</span><span class="o">/</span><span class="n">kbn_network</span><span class="o">/</span><span class="n">releases</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="mf">6.5</span><span class="o">.</span><span class="n">X</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="n">network_vis</span><span class="o">-</span><span class="mi">6</span><span class="o">-</span><span class="mf">5.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tar</span> <span class="n">zxv</span> <span class="o">-</span><span class="n">C</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">kibana</span><span class="o">/</span><span class="n">plugins</span>
</pre></div>
</div>
<p>Kibana now requires <code class="docutils literal notranslate"><span class="pre">jquery.flot.log</span></code> when re-optimizing, so let’s create that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">touch</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">kibana</span><span class="o">/</span><span class="n">jquery</span><span class="o">.</span><span class="n">flot</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Modify <code class="docutils literal notranslate"><span class="pre">KIBANA_OPTIONS</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code> to mount <code class="docutils literal notranslate"><span class="pre">/nsm/kibana/plugins</span></code> directory and <code class="docutils literal notranslate"><span class="pre">jquery.flot.log</span></code> into the container:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|^KIBANA_OPTIONS.*$|KIBANA_OPTIONS=&quot;--volume /nsm/kibana/plugins:/usr/share/kibana/plugins:ro --volume /nsm/kibana/jquery.flot.log:/usr/share/kibana/src/ui/public/flot-charts/jquery.flot.log&quot;|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">securityonion</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Restart Kibana:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">kibana</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>Monitor Kibana log file for errors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">kibana</span><span class="o">/</span><span class="n">kibana</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>Kibana may take a few minutes to re-optimize.  Once that’s complete, you should be able to log into Kibana and test your new plugin.</p>
</div>
</div>
<span id="document-capme"></span><div class="section" id="capme">
<h3>CapME<a class="headerlink" href="#capme" title="Permalink to this headline">¶</a></h3>
<p>CapME is a web interface that allows you to:</p>
<ul class="simple">
<li>view a pcap transcript rendered with tcpflow</li>
<li>view a pcap transcript rendered with <a class="reference external" href="Bro">Bro</a> (especially helpful for dealing with gzip encoding)</li>
<li>download a pcap</li>
</ul>
<div class="section" id="screenshot">
<h4>Screenshot<a class="headerlink" href="#screenshot" title="Permalink to this headline">¶</a></h4>
<img alt="_images/capme.png" src="_images/capme.png" />
</div>
<div class="section" id="accessing">
<h4>Accessing<a class="headerlink" href="#accessing" title="Permalink to this headline">¶</a></h4>
<p>You can pivot to CapME from a NIDS alert in <a class="reference external" href="Squert">Squert</a> or from any log in <a class="reference external" href="Kibana">Kibana</a> that has timestamp, source IP, source port, destination IP, and destination port.</p>
</div>
<div class="section" id="authentication">
<h4>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h4>
<p>If prompted for username and password, simply enter your normal Sguil/Squert/Kibana username and password.</p>
</div>
</div>
<span id="document-cyberchef"></span><div class="section" id="cyberchef">
<h3>CyberChef<a class="headerlink" href="#cyberchef" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://github.com/gchq/CyberChef">https://github.com/gchq/CyberChef</a> :</p>
<blockquote>
<div><div class="line-block">
<div class="line">The Cyber Swiss Army Knife</div>
<div class="line">CyberChef is a simple, intuitive web app for carrying out all manner of “cyber” operations within a web browser. These operations include simple encoding like XOR or Base64, more complex encryption like AES, DES and Blowfish, creating binary and hexdumps, compression and decompression of data, calculating hashes and checksums, IPv6 and X.509 parsing, changing character encodings, and much more.</div>
</div>
<p>The tool is designed to enable both technical and non-technical analysts to manipulate data in complex ways without having to deal with complex tools or algorithms. It was conceived, designed, built and incrementally improved by an analyst in their 10% innovation time over several years. Every effort has been made to structure the code in a readable and extendable format, however it should be noted that the analyst is not a professional developer.</p>
</div></blockquote>
<div class="section" id="screenshot">
<h4>Screenshot<a class="headerlink" href="#screenshot" title="Permalink to this headline">¶</a></h4>
<img alt="_images/cyberchef.png" src="_images/cyberchef.png" />
</div>
<div class="section" id="accessing">
<h4>Accessing<a class="headerlink" href="#accessing" title="Permalink to this headline">¶</a></h4>
<p>To access CyberChef:</p>
<ul>
<li><p class="first">go to the main web page of your Security Onion master server and click the CyberChef hyperlink</p>
<p>OR</p>
</li>
<li><p class="first">go directly to the following URL (replacing <code class="docutils literal notranslate"><span class="pre">SecurityOnion</span></code> with the actual hostname or IP address of your Security Onion master server): <a class="reference external" href="https://SecurityOnion/cyberchef/cyberchef.htm">https://SecurityOnion/cyberchef/cyberchef.htm</a></p>
</li>
</ul>
</div>
</div>
<span id="document-squert"></span><div class="section" id="squert">
<h3>Squert<a class="headerlink" href="#squert" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="http://www.squertproject.org/">http://www.squertproject.org/</a>:</p>
<blockquote>
<div>Squert is a web application that is used to query and view event
data stored in a Sguil database (typically IDS alert data). Squert
is a visual tool that attempts to provide additional context to
events through the use of metadata, time series representations and
weighted and logically grouped result sets. The hope is that these
views will prompt questions that otherwise may not have been asked.</div></blockquote>
<div class="line-block">
<div class="line">Squert was originally developed by Paul Halliday:</div>
<div class="line"><a class="reference external" href="http://www.squertproject.org/">http://www.squertproject.org/</a></div>
<div class="line"><br /></div>
<div class="line">Security Onion maintains its own fork of Squert:</div>
<div class="line"><a class="reference external" href="https://blog.securityonion.net/2016/09/squert-development.html">https://blog.securityonion.net/2016/09/squert-development.html</a></div>
<div class="line"><br /></div>
<div class="line">Squert is a PHP web interface to the <a class="reference external" href="Sguil">Sguil</a> database and works best with Chromium/Chrome browsers.</div>
</div>
<div class="section" id="screenshot">
<h4>Screenshot<a class="headerlink" href="#screenshot" title="Permalink to this headline">¶</a></h4>
<img alt="_images/squert.png" src="_images/squert.png" />
</div>
<div class="section" id="authentication">
<h4>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h4>
<p>If prompted for username and password, simply enter your normal Sguil/Squert/Kibana username and password.</p>
</div>
<div class="section" id="data-types">
<h4>Data Types<a class="headerlink" href="#data-types" title="Permalink to this headline">¶</a></h4>
<p>Squert gives you access to the following data types:</p>
<ul class="simple">
<li><a class="reference external" href="NIDS">NIDS</a> alerts</li>
<li><a class="reference external" href="Wazuh">HIDS</a> alerts</li>
</ul>
</div>
<div class="section" id="time-interval">
<h4>Time Interval<a class="headerlink" href="#time-interval" title="Permalink to this headline">¶</a></h4>
<p>The default view shows alerts from today. To show older alerts, click <code class="docutils literal notranslate"><span class="pre">INTERVAL</span></code>, then click the 2 right arrows, set your custom date, and click Squert’s refresh button (two circular arrows).</p>
</div>
<div class="section" id="time-zone">
<h4>Time Zone<a class="headerlink" href="#time-zone" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>click the time interval (labeled <code class="docutils literal notranslate"><span class="pre">INTERVAL</span></code>)</li>
<li>on the right side, click the two arrows pointing right</li>
<li>de-select <code class="docutils literal notranslate"><span class="pre">UTC</span></code></li>
<li>set your timezone offset (labeled <code class="docutils literal notranslate"><span class="pre">TZ</span> <span class="pre">OFFSET</span></code>)</li>
<li>click the <code class="docutils literal notranslate"><span class="pre">save</span> <span class="pre">TZ</span></code> button</li>
</ul>
</div>
<div class="section" id="timeplot">
<h4>Timeplot<a class="headerlink" href="#timeplot" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">The timeplot at the top of the <code class="docutils literal notranslate"><span class="pre">EVENTS</span></code> page, represents events as they occur each day.</div>
<div class="line">In summary, the timeplot:</div>
</div>
<ul class="simple">
<li>plots the raw number of events on a per minute basis.</li>
<li>uses the X-axis as the hour of the day and the Y-axis is the number of events minute.</li>
<li>treats each region equivalent to one hour.</li>
<li>plots and underlines the number of events in each region for that hour.</li>
</ul>
</div>
<div class="section" id="toggle-options">
<h4>Toggle Options<a class="headerlink" href="#toggle-options" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">queue</span> <span class="pre">only</span></code></div>
<div class="line">Default is <code class="docutils literal notranslate"><span class="pre">on</span></code>.</div>
</div>
<p>This option refers to only showing events that are of a status of <code class="docutils literal notranslate"><span class="pre">0</span></code>, or uncategorized and still residing in the active queue. If you would like to see all events, change it to <code class="docutils literal notranslate"><span class="pre">off</span></code>.</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">grouping</span></code></div>
<div class="line">Default is <code class="docutils literal notranslate"><span class="pre">on</span></code>.</div>
</div>
<p>This option refers to the grouping of the same type of event within a particular timeframe. If you would like to see the events as un-grouped, change this option to <code class="docutils literal notranslate"><span class="pre">off</span></code>.</p>
</div>
<div class="section" id="alerts">
<h4>Alerts<a class="headerlink" href="#alerts" title="Permalink to this headline">¶</a></h4>
<p>The alert pane consists of several columns, explained below:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">QUEUE</span></code> - refers to the number of grouped events in the queue</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SC</span></code> - number of distinct source IPs for the given alert</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">DC</span></code> - number of distinct destination IPs for the given alert</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ACTIVITY</span></code> - number of events for a given alert on a per hour basis</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">LAST</span> <span class="pre">EVENT</span></code> - time event last occurred</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">SIGNATURE</span></code> - event IDS signature</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ID</span></code> - event signature ID</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">PROTO</span></code> - protocol relative/recognized within/in regard to event</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">%</span> <span class="pre">TOTAL</span></code> - percentage of event grouping vs. entire event count</div>
</div>
</div>
<div class="section" id="pivoting-to-full-packet-capture">
<h4>Pivoting to Full Packet Capture<a class="headerlink" href="#pivoting-to-full-packet-capture" title="Permalink to this headline">¶</a></h4>
<p>Squert can pivot to <a class="reference external" href="CapMe">CapMe</a> for full packet capture. To do this, drill into an event and click on the Event ID.</p>
</div>
<div class="section" id="pivoting-to-kibana">
<h4>Pivoting to Kibana<a class="headerlink" href="#pivoting-to-kibana" title="Permalink to this headline">¶</a></h4>
<p>Squert can pivot to <a class="reference external" href="Kibana">Kibana</a> to query Bro logs, Wazuh logs, syslog, etc. To do this, click an IP address, port, or signature, and then click <code class="docutils literal notranslate"><span class="pre">Kibana</span></code>.</p>
</div>
<div class="section" id="adding-your-own-pivots">
<h4>Adding your own pivots<a class="headerlink" href="#adding-your-own-pivots" title="Permalink to this headline">¶</a></h4>
<p>You can also add your own pivots as follows:</p>
<ul class="simple">
<li>In the upper right corner of Squert, click the Filters button.</li>
<li>Set the type to URL.</li>
<li>Click the + button.</li>
<li>Click your New entry.</li>
<li>Fill out the alias, name, notes, and URL fields as applicable.</li>
<li>Click the Update button.</li>
<li>Close the Filters and URLs window.</li>
<li>To test, drill into an event and click an IP address. A context menu will appear and display your new link. Click the new link and verify that it opens a new browser tab going to the site you specified and passing the IP address that you clicked on.</li>
</ul>
</div>
<div class="section" id="prepared-statements">
<h4>Prepared Statements<a class="headerlink" href="#prepared-statements" title="Permalink to this headline">¶</a></h4>
<p>Squert uses prepared statements.  If you start seeing <code class="docutils literal notranslate"><span class="pre">Prepared</span> <span class="pre">statement</span> <span class="pre">needs</span> <span class="pre">to</span> <span class="pre">be</span> <span class="pre">re-prepared</span></code> in <code class="docutils literal notranslate"><span class="pre">/var/log/apache2/error.log</span></code>, please see the <a class="reference external" href="MySQLTuning#table_definition_cache">MySQLTuning#table_definition_cache</a> section.</p>
</div>
</div>
<span id="document-sguil"></span><div class="section" id="sguil">
<h3>Sguil<a class="headerlink" href="#sguil" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="http://sguil.net">http://sguil.net</a>:</p>
<blockquote>
<div>Sguil (pronounced sgweel) is built by network security analysts for
network security analysts. Sguil’s main component is an intuitive
GUI that provides access to realtime events, session data, and raw
packet captures. Sguil facilitates the practice of Network Security
Monitoring and event driven analysis.</div></blockquote>
<ul>
<li><div class="first line-block">
<div class="line">Developed by Bamm Visscher:</div>
<div class="line"><a class="reference external" href="http://sguil.net">http://sguil.net</a></div>
<div class="line"><a class="reference external" href="http://nsmwiki.org/Sguil">http://nsmwiki.org/Sguil</a></div>
<div class="line"><a class="reference external" href="http://nsmwiki.org/Sguil_Client">http://nsmwiki.org/Sguil_Client</a></div>
</div>
</li>
<li><p class="first">tcl/tk (not web-based)</p>
</li>
<li><p class="first">Single central MySQL database</p>
</li>
</ul>
<div class="section" id="screenshot">
<h4>Screenshot<a class="headerlink" href="#screenshot" title="Permalink to this headline">¶</a></h4>
<img alt="_images/sguil.png" src="_images/sguil.png" />
</div>
<div class="section" id="authentication">
<h4>Authentication<a class="headerlink" href="#authentication" title="Permalink to this headline">¶</a></h4>
<p>For login information, please see the <a class="reference external" href="Passwords#sguil">Passwords</a> section.</p>
<p>For information on ways to connect to Sguil/sguild, please see the <a class="reference external" href="ConnectingtoSguil">ConnectingtoSguil</a> section.</p>
</div>
<div class="section" id="data-types">
<h4>Data Types<a class="headerlink" href="#data-types" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>NIDS alerts from Snort/Suricata (if snort_agent is enabled)</li>
<li>HIDS alerts from OSSEC (if ossec_agent is enabled)</li>
</ul>
</div>
<div class="section" id="pivot">
<h4>Pivot<a class="headerlink" href="#pivot" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>pivot to transcript/Wireshark/NetworkMiner by right-clicking the Alert ID.</li>
<li>automatically pivot to ASCII transcript by middle-clicking the Alert ID.</li>
<li>pivot to Kibana by right-clicking an IP address and choosing <code class="docutils literal notranslate"><span class="pre">Kibana</span> <span class="pre">IP</span> <span class="pre">Lookup</span></code>.</li>
</ul>
</div>
<div class="section" id="agents">
<h4>Agents<a class="headerlink" href="#agents" title="Permalink to this headline">¶</a></h4>
<p>Sguil can only utilize <code class="docutils literal notranslate"><span class="pre">1024</span></code> sockets for receiving communication from various sensor agents (such as ossec_agent, pcap_agent, and snort_agent). Due to this restriction, you will want to keep in mind the number of sensors and sniffing interfaces you have connected to the master server/accessed by Sguil.</p>
<p>For more information, please see <a class="reference external" href="https://groups.google.com/d/msg/security-onion/DJ5NTLEu5MY/-tDQi_1eDQAJ">https://groups.google.com/d/msg/security-onion/DJ5NTLEu5MY/-tDQi_1eDQAJ</a>.</p>
</div>
<div class="section" id="management">
<h4>Management<a class="headerlink" href="#management" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>It is important to ensure events displayed in Sguil are regularly classified, or else it could cause problems with the Sguil database. Consider creating an <a class="reference external" href="ManagingAlerts#autocategorize-events">autocat rule</a> to assist with this.</li>
<li><a class="reference external" href="Email#how-do-i-configure-sguil-to-send-alerts-via-email">Configure Sguil alert email notification(s)</a></li>
<li><a class="reference external" href="ManagingAlerts#sguil-days-to-keep">Configure retention for Sguil alerts</a></li>
</ul>
</div>
<div class="section" id="customize">
<h4>Customize<a class="headerlink" href="#customize" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">resize columns by right-clicking on the column heading in the Sguil client.</p>
</li>
<li><p class="first">change fonts by clicking <code class="docutils literal notranslate"><span class="pre">File</span></code> –&gt; <code class="docutils literal notranslate"><span class="pre">Change</span> <span class="pre">Font</span></code> from within the Sguil client.</p>
</li>
<li><p class="first">Sguil client settings are stored in <code class="docutils literal notranslate"><span class="pre">/etc/sguil/sguil.conf</span></code>:</p>
</li>
<li><div class="first line-block">
<div class="line">You can enable “Show Rule”, “Show Packet Data”, and “Display
Detail” (respectively) by setting the following (also see
<a class="reference external" href="https://groups.google.com/d/topic/security-onion/MJaAlxgpMvU/discussion">https://groups.google.com/d/topic/security-onion/MJaAlxgpMvU/discussion</a>):</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">SHOWRULE</span> <span class="pre">1</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">PACKETINFO</span> <span class="pre">1</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">DISPLAY_GENERIC</span> <span class="pre">1</span></code></div>
</div>
</li>
<li><p class="first">You can separate realtime alerts into separate panes, based on
severity level, by editing <code class="docutils literal notranslate"><span class="pre">/etc/sguil/sguil.conf</span></code> as follows:</p>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#Number of RealTime Event Panes</span>
<span class="c1">#set RTPANES 1</span>
<span class="nb">set</span> <span class="n">RTPANES</span> <span class="mi">3</span>

<span class="c1"># Specify which priority events go into what pane</span>
<span class="c1"># According to the latest classification.config from snort,</span>
<span class="c1"># there are only 4 priorities. The sguil spp_portscan mod</span>
<span class="c1"># uses a priority of 5.</span>
<span class="c1">#set RTPANE_PRIORITY(0) &quot;1 2 3 4 5&quot;</span>
<span class="nb">set</span> <span class="n">RTPANE_PRIORITY</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="s2">&quot;1&quot;</span>
<span class="nb">set</span> <span class="n">RTPANE_PRIORITY</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="s2">&quot;2 3&quot;</span>
<span class="nb">set</span> <span class="n">RTPANE_PRIORITY</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="s2">&quot;4 5&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="dns-lookups">
<h4>DNS Lookups<a class="headerlink" href="#dns-lookups" title="Permalink to this headline">¶</a></h4>
<p>Previously, when pivoting to transcript, the Sguil server would perform DNS lookups on the source and destination IP addresses.  That default has since been changed to increase performance and avoid unnecessary information leakage.  If you would like to re-enable DNS lookups, you can set the following in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion/sguild.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">TRANSCRIPT_DNS_LOOKUP</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
</div>
<span id="document-networkminer"></span><div class="section" id="networkminer">
<h3>NetworkMiner<a class="headerlink" href="#networkminer" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://www.netresec.com/?page=networkminer">https://www.netresec.com/?page=networkminer</a>:</p>
<blockquote>
<div><p>NetworkMiner is an open source Network Forensic Analysis Tool (NFAT) for Windows (but also works in Linux / Mac OS X / FreeBSD). NetworkMiner can be used as a passive network sniffer/packet capturing tool in order to detect operating systems, sessions, hostnames, open ports etc. without putting any traffic on the network. NetworkMiner can also parse PCAP files for off-line analysis and to regenerate/reassemble transmitted files and certificates from PCAP files.</p>
<p>NetworkMiner makes it easy to perform advanced Network Traffic Analysis (NTA) by providing extracted artifacts in an intuitive user interface. The way data is presented not only makes the analysis simpler, it also saves valuable time for the analyst or forensic investigator.</p>
</div></blockquote>
<div class="section" id="screenshot">
<h4>Screenshot<a class="headerlink" href="#screenshot" title="Permalink to this headline">¶</a></h4>
<img alt="_images/networkminer.png" src="_images/networkminer.png" />
</div>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>You can launch NetworkMiner from the Applications menu and then open a pcap.</p>
<p>Alternatively, if you’re using the Sguil client, you can pivot directly from an event in Sguil and send the pcap directly to NetworkMiner.</p>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information about NetworkMiner, please see <a class="reference external" href="https://www.netresec.com/?page=networkminer">https://www.netresec.com/?page=networkminer</a>.</p>
</div>
</div>
<span id="document-wireshark"></span><div class="section" id="wireshark">
<h3>Wireshark<a class="headerlink" href="#wireshark" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://www.wireshark.org/">https://www.wireshark.org/</a>:</p>
<blockquote>
<div>Wireshark is the world’s foremost and widely-used network protocol analyzer. It lets you see what’s happening on your network at a microscopic level and is the de facto (and often de jure) standard across many commercial and non-profit enterprises, government agencies, and educational institutions. Wireshark development thrives thanks to the volunteer contributions of networking experts around the globe and is the continuation of a project started by Gerald Combs in 1998.</div></blockquote>
<div class="section" id="screenshot">
<h4>Screenshot<a class="headerlink" href="#screenshot" title="Permalink to this headline">¶</a></h4>
<img alt="_images/wireshark.png" src="_images/wireshark.png" />
</div>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>You can launch Wireshark from the Applications menu and then open a pcap.</p>
<p>Alternatively, if you’re using the Sguil client, you can pivot directly from an event in Sguil and send the pcap directly to Wireshark.</p>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information about Wireshark, please see <a class="reference external" href="https://www.wireshark.org/">https://www.wireshark.org/</a>.</p>
</div>
</div>
</div>
</div>
<span id="document-network"></span><div class="section" id="network-visibility">
<h2>Network Visibility<a class="headerlink" href="#network-visibility" title="Permalink to this headline">¶</a></h2>
<p>This section covers the various processes that Security Onion uses to analyze and log network traffic.</p>
<div class="toctree-wrapper compound">
<span id="document-nids"></span><div class="section" id="nids">
<h3>NIDS<a class="headerlink" href="#nids" title="Permalink to this headline">¶</a></h3>
<p>NIDS stands for Network Intrusion Detection System. It is a means of monitoring network traffic, looking for specific activity, and generating alerts.</p>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>Security Onion can run either <a class="reference external" href="Snort">Snort</a> or <a class="reference external" href="Suricata">Suricata</a> as its Network Intrusion Detection System (NIDS). When you run Setup and choose Evaluation Mode, it will automatically default to Snort. If you choose Production Mode, you will be asked to choose whether you want to run <a class="reference external" href="Snort">Snort</a> or <a class="reference external" href="Suricata">Suricata</a>.</p>
</div>
<div class="section" id="performance">
<h4>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h4>
<p>In Security Onion, we compile both <a class="reference external" href="Snort">Snort</a> and <a class="reference external" href="Suricata">Suricata</a> to support <a class="reference external" href="PF-RING">PF-RING</a> for higher performance.  Suricata also supports <a class="reference external" href="AF-PACKET">AF-PACKET</a> as an alternative.  Modern versions of Setup default to running <a class="reference external" href="Suricata">Suricata</a> in <a class="reference external" href="AF-PACKET">AF-PACKET</a> mode.</p>
</div>
<div class="section" id="analysis">
<h4>Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline">¶</a></h4>
<p>You can analyze NIDS alerts from Snort/Suricata via:</p>
<ul class="simple">
<li><a class="reference external" href="Squert">Squert</a></li>
<li><a class="reference external" href="Kibana">Kibana</a></li>
<li><a class="reference external" href="Sguil">Sguil</a></li>
</ul>
</div>
<div class="section" id="switching-from-snort-to-suricata">
<h4>Switching from Snort to Suricata<a class="headerlink" href="#switching-from-snort-to-suricata" title="Permalink to this headline">¶</a></h4>
<p>Please note that, if you’re running the Snort Talos ruleset, Snort Shared Object rules will not load in Suricata. Most folks who choose the Suricata engine choose to run the Emerging Threats ruleset.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">stop</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|ENGINE=snort|ENGINE=suricata|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">securityonion</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="switching-from-suricata-to-snort">
<h4>Switching from Suricata to Snort<a class="headerlink" href="#switching-from-suricata-to-snort" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">stop</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|ENGINE=suricata|ENGINE=snort|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">securityonion</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="nips">
<h4>NIPS<a class="headerlink" href="#nips" title="Permalink to this headline">¶</a></h4>
<p>Security Onion is designed to be passive and so Snort and Suricata run in NIDS mode rather than NIPS (inline) mode.  Running in NIPS mode would require manual configuration and we do not recommend or support it.</p>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>For more information about Snort, please see the <a class="reference external" href="Snort">Snort</a> section.</li>
<li>For more information about Suricata, please see the <a class="reference external" href="Suricata">Suricata</a> section.</li>
</ul>
</div>
</div>
<span id="document-snort"></span><div class="section" id="snort">
<h3>Snort<a class="headerlink" href="#snort" title="Permalink to this headline">¶</a></h3>
<p>Snort is a Network Intrusion Detection System (<a class="reference external" href="NIDS">NIDS</a>). It sniffs network traffic and generates IDS alerts.</p>
<div class="section" id="performance">
<h4>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h4>
<p>In Security Onion, we compile Snort with <a class="reference external" href="PF-RING">PF-RING</a> to allow you to spin up multiple instances to handle more traffic.</p>
</div>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<p>You can configure Snort via <code class="docutils literal notranslate"><span class="pre">/etc/nsm/HOSTNAME-INTERFACE/snort.conf</span></code> (where HOSTNAME is your actual hostname and INTERFACE is your actual sniffing interface).</p>
<p>If you would like to configure/manage IDS rules, please see the <a class="reference external" href="Rules">Rules</a> and <a class="reference external" href="ManagingAlerts">ManagingAlerts</a> sections.</p>
</div>
<div class="section" id="logging">
<h4>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h4>
<p>If you need to troubleshoot Snort, check the Snort log file(s) <code class="docutils literal notranslate"><span class="pre">/var/log/nsm/HOSTNAME-INTERFACE/snortu-X.log</span></code> (where <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> is your actual hostname, <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code> is your actual sniffing interface, and <code class="docutils literal notranslate"><span class="pre">X</span></code> represents the number of PF-RING instances).</p>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information about Snort, please see <a class="reference external" href="https://snort.org">https://snort.org</a>.</p>
</div>
</div>
<span id="document-suricata"></span><div class="section" id="suricata">
<h3>Suricata<a class="headerlink" href="#suricata" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://suricata-ids.org">https://suricata-ids.org</a>:</p>
<blockquote>
<div>Suricata is a free and open source, mature, fast and robust network
threat detection engine. Suricata inspects the network traffic using
a powerful and extensive rules and signature language, and has
powerful Lua scripting support for detection of complex threats.</div></blockquote>
<div class="section" id="performance">
<h4>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h4>
<p>We compile Suricata to support both <a class="reference external" href="PF-RING">PF-RING</a> and <a class="reference external" href="AF-PACKET">AF-PACKET</a> to allow you to spin up multiple workers to handle more traffic.  Modern versions of Setup default to <a class="reference external" href="AF-PACKET">AF-PACKET</a>.</p>
<div class="line-block">
<div class="line">For high traffic levels, you may want to pin Suricata to specific CPU cores using the affinity settings in <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code>:</div>
<div class="line"><a class="reference external" href="https://suricata.readthedocs.io/en/latest/configuration/suricata-yaml.html#threading">https://suricata.readthedocs.io/en/latest/configuration/suricata-yaml.html#threading</a></div>
</div>
</div>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<p>You can configure Suricata via <code class="docutils literal notranslate"><span class="pre">/etc/nsm/HOSTNAME-INTERFACE/suricata.yaml</span></code> (where <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> is your actual hostname and <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code> is your actual sniffing interface).</p>
<p>If you would like to configure/manage IDS rules, please see the <a class="reference external" href="Rules">Rules</a> and <a class="reference external" href="ManagingAlerts">ManagingAlerts</a> sections.</p>
</div>
<div class="section" id="logging">
<h4>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h4>
<p>If you need to troubleshoot Suricata, check <code class="docutils literal notranslate"><span class="pre">/var/log/nsm/HOSTNAME-INTERFACE/suricata.log</span></code> (where <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> is your actual hostname and <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code> is your actual sniffing interface).</p>
</div>
<div class="section" id="stats">
<h4>Stats<a class="headerlink" href="#stats" title="Permalink to this headline">¶</a></h4>
<p>For detailed Suricata statistics, check <code class="docutils literal notranslate"><span class="pre">/nsm/sensor_data/HOSTNAME-INTERFACE/stats.log</span></code> (where <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> is your actual hostname and <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code> is your actual sniffing interface).</p>
<p>If you want <code class="docutils literal notranslate"><span class="pre">stats.log</span></code> to show per-thread stats (for example, to verify that load balancing is working properly), you can set <code class="docutils literal notranslate"><span class="pre">threads:</span> <span class="pre">yes</span></code> under the <code class="docutils literal notranslate"><span class="pre">outputs:</span> <span class="pre">-</span> <span class="pre">stats:</span></code> section in <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> and then restart Suricata.</p>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information about Suricata, please see <a class="reference external" href="https://suricata-ids.org">https://suricata-ids.org</a>.</p>
</div>
</div>
<span id="document-bro"></span><div class="section" id="bro">
<h3>Bro<a class="headerlink" href="#bro" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://www.zeek.org/">https://www.zeek.org/</a>:</p>
<blockquote>
<div>Zeek is a powerful network analysis framework that is much different from the typical IDS you may know. (Zeek is the new name for the long-established Bro system. Note that parts of the system retain the “Bro” name, and it also often appears in the documentation and distributions.)</div></blockquote>
<div class="section" id="logs">
<h4>Logs<a class="headerlink" href="#logs" title="Permalink to this headline">¶</a></h4>
<p>Bro logs are stored in <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs</span></code>. They are consumed by <a class="reference external" href="syslog">syslog-ng</a>, parsed and augmented by <a class="reference external" href="Logstash">Logstash</a>, stored in <a class="reference external" href="Elasticsearch">Elasticsearch</a>, and viewable in <a class="reference external" href="Kibana">Kibana</a>.</p>
<div class="section" id="json">
<h5>JSON<a class="headerlink" href="#json" title="Permalink to this headline">¶</a></h5>
<p>By default, we configure Bro to output in JSON for higher performance and better parsing. We recommend that most folks leave Bro configured for JSON output.  If you need to parse those JSON logs from the command line, you can use <a class="reference external" href="jq">jq</a>.</p>
</div>
<div class="section" id="tsv">
<h5>TSV<a class="headerlink" href="#tsv" title="Permalink to this headline">¶</a></h5>
<p>If you really need the traditional Bro TSV (Tab Separated Values) format, you can disable JSON:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|@load json-logs|#@load json-logs|g&#39;</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">site</span><span class="o">/</span><span class="n">local</span><span class="o">.</span><span class="n">bro</span>
</pre></div>
</div>
<p>and then restart Bro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>Bro monitors your network traffic and creates logs, such as:</p>
</div>
<div class="section" id="conn-log">
<h5>conn.log<a class="headerlink" href="#conn-log" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>TCP/UDP/ICMP connections</li>
<li>For more information, see:</li>
</ul>
<p><a class="reference external" href="https://docs.zeek.org/en/latest/scripts/base/protocols/conn/main.bro.html#type-Conn::Info">https://docs.zeek.org/en/latest/scripts/base/protocols/conn/main.bro.html#type-Conn::Info</a></p>
</div>
<div class="section" id="dns-log">
<h5>dns.log<a class="headerlink" href="#dns-log" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>DNS activity</li>
<li>For more information ,see:</li>
</ul>
<p><a class="reference external" href="https://docs.zeek.org/en/latest/scripts/base/protocols/dns/main.bro.html#type-DNS::Info">https://docs.zeek.org/en/latest/scripts/base/protocols/dns/main.bro.html#type-DNS::Info</a></p>
</div>
<div class="section" id="ftp-log">
<h5>ftp.log<a class="headerlink" href="#ftp-log" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>FTP activity</li>
<li>For more information, see:</li>
</ul>
<p><a class="reference external" href="https://docs.zeek.org/en/latest/scripts/base/protocols/ftp/info.bro.html#type-FTP::Info">https://docs.zeek.org/en/latest/scripts/base/protocols/ftp/info.bro.html#type-FTP::Info</a></p>
</div>
<div class="section" id="http-log">
<h5>http.log<a class="headerlink" href="#http-log" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>HTTP requests and replies</li>
<li>For more information, see:</li>
</ul>
<p><a class="reference external" href="https://docs.zeek.org/en/latest/scripts/base/protocols/http/main.bro.html#type-HTTP::Info">https://docs.zeek.org/en/latest/scripts/base/protocols/http/main.bro.html#type-HTTP::Info</a></p>
</div>
<div class="section" id="ssl-log">
<h5>ssl.log<a class="headerlink" href="#ssl-log" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>SSL/TLS handshake info</li>
<li>For more information, see:</li>
</ul>
<p><a class="reference external" href="https://docs.zeek.org/en/latest/scripts/base/protocols/ssl/main.bro.html#type-SSL::Info">https://docs.zeek.org/en/latest/scripts/base/protocols/ssl/main.bro.html#type-SSL::Info</a></p>
</div>
<div class="section" id="notice-log">
<h5>notice.log<a class="headerlink" href="#notice-log" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Bro notices</li>
<li>For more information, see:</li>
</ul>
<p><a class="reference external" href="https://docs.zeek.org/en/latest/scripts/base/frameworks/notice/main.bro.html#type-Notice::Info">https://docs.zeek.org/en/latest/scripts/base/frameworks/notice/main.bro.html#type-Notice::Info</a></p>
<div class="line-block">
<div class="line">…and others, which can be researched here:</div>
<div class="line"><a class="reference external" href="https://docs.zeek.org/en/latest/script-reference/log-files.html">https://docs.zeek.org/en/latest/script-reference/log-files.html</a></div>
</div>
<p>As you can see, Bro log data can provide a wealth of information to the analyst, all easily accessible through <a class="reference external" href="Kibana">Kibana</a>.</p>
</div>
</div>
<div class="section" id="email">
<h4>Email<a class="headerlink" href="#email" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">/opt/bro/etc/broctl.cfg</span></code></p>
<ul class="simple">
<li>To configure email notifications, please see the <a class="reference external" href="email#bro">email</a> section.</li>
</ul>
</div>
<div class="section" id="syslog">
<h4>Syslog<a class="headerlink" href="#syslog" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">/etc/syslog-ng/syslog-ng.conf</span></code></p>
<ul class="simple">
<li>To forward Bro logs to an external syslog collector, please see the <a class="reference external" href="syslog-output">syslog-output</a> section.</li>
</ul>
</div>
<div class="section" id="intel">
<h4>Intel<a class="headerlink" href="#intel" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">You can add your own Intel to <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/intel/intel.dat</span></code>.</p>
<ul class="simple">
<li>When editing <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/intel/intel.dat</span></code>, ensure there are no leading/trailing spaces or lines, and that only (single) tabs are used as field delimiters.</li>
<li>If you experience an error, or do not notice <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs/current/intel.log</span></code> being generated, try having a look in <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs/current/reporter.log</span></code> for clues.</li>
<li>You may also want to restart Bro after making changes, by running the following command:
<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">so-bro-restart</span></code>.</li>
</ul>
</li>
<li><p class="first">For more information, please see:</p>
<div class="line-block">
<div class="line"><a class="reference external" href="https://www.bro.org/sphinx-git/frameworks/intel.html">https://www.bro.org/sphinx-git/frameworks/intel.html</a></div>
<div class="line"><a class="reference external" href="http://blog.bro.org/2014/01/intelligence-data-and-bro_4980.html">http://blog.bro.org/2014/01/intelligence-data-and-bro_4980.html</a></div>
<div class="line"><a class="reference external" href="https://github.com/weslambert/securityonion-misp">https://github.com/weslambert/securityonion-misp</a></div>
</div>
</li>
<li><p class="first">To install and configure an Alienvault OTX Connector, please see the <a class="reference external" href="Alienvault-OTX">Alienvault-OTX</a> section.</p>
</li>
</ul>
</div>
<div class="section" id="bro-n">
<h4>Bro * n<a class="headerlink" href="#bro-n" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">/opt/bro/etc/node.cfg</span></code></p>
<p>We compile Bro to support both <a class="reference external" href="PF-RING">PF-RING</a> and <a class="reference external" href="AF-PACKET">AF-PACKET</a> so that you can spin up multiple Bro workers to handle more traffic.  Modern versions of Setup now default to <a class="reference external" href="AF-PACKET">AF-PACKET</a>.</p>
<p>If you are monitoring high traffic levels, you may need to use the <code class="docutils literal notranslate"><span class="pre">pin_cpus</span></code> setting.  For more information, please see <a class="reference external" href="https://docs.zeek.org/en/stable/configuration/#using-pf-ring">https://docs.zeek.org/en/stable/configuration/#using-pf-ring</a>.</p>
</div>
<div class="section" id="custom-scripts">
<h4>Custom Scripts<a class="headerlink" href="#custom-scripts" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/site/local.bro</span></code></p>
<ul class="simple">
<li>You can add custom scripts in <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/policy/</span></code> and then reference the scripts in <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/site/local.bro</span></code>.</li>
</ul>
<p>Below is an example how to do so:</p>
<ul>
<li><p class="first">Create a new directory under <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/policy/</span></code>.
<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">mkdir</span> <span class="pre">/opt/bro/share/bro/policy/custom-scripts</span></code></p>
</li>
<li><p class="first">Add your custom script(s) and <code class="docutils literal notranslate"><span class="pre">__load__.bro</span></code> to this directory.</p>
</li>
<li><p class="first">Modify <code class="docutils literal notranslate"><span class="pre">__load__.bro</span></code> to reference the scripts in the
<code class="docutils literal notranslate"><span class="pre">custom-scripts</span></code> directory:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;load</span> <span class="pre">./script1.bro</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">&#64;load</span> <span class="pre">./script2.bro</span></code></div>
</div>
</li>
<li><p class="first">Edit <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/site/local.bro</span></code> so that it will load the
new scripts in <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/policy/custom-scripts</span></code>, by
adding <code class="docutils literal notranslate"><span class="pre">&#64;load</span> <span class="pre">custom-scripts</span></code> at the bottom of the file and saving
the file.</p>
</li>
<li><p class="first">Restart Bro.
<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">so-bro-restart</span></code></p>
</li>
<li><p class="first">Check <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs/current/loaded_scripts.log</span></code> to see if your
custom script(s) has/have been loaded.</p>
</li>
<li><p class="first">Check <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs/current/reporter.log</span></code> for clues if your custom
script(s) is/are not working as desired.</p>
</li>
</ul>
<p>To check and see if a Bro script has fired a Notice, go to Kibana and check our <code class="docutils literal notranslate"><span class="pre">Bro</span> <span class="pre">Notices</span></code> dashboard. Alternatively, you can check for entries in <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs/current/notice.log</span></code>.</p>
<p><strong>PLEASE NOTE</strong>: In a distributed deployment, all custom scripts created
under <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/policy/</span></code> on a master server will be
replicated to sensors via Salt, however, they will not be enabled, as
<code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/site/local.bro</span></code> is not replicated. Therefore, you
will either need to manually add a reference to the scripts in
<code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/site/local.bro</span></code>, or add additional configuration
in <code class="docutils literal notranslate"><span class="pre">/opt/onionsalt/salt/sensor/init.sls</span></code> for Salt to replicate this
information.</p>
<ul class="simple">
<li>Make a symlink to <code class="docutils literal notranslate"><span class="pre">local.bro</span></code>:</li>
</ul>
<p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">ln</span> <span class="pre">-s</span> <span class="pre">/opt/bro/share/bro/site/local.bro</span> <span class="pre">/opt/onionsalt/salt/sensor/bro/local.bro</span></code></p>
<p>Then add the following to <code class="docutils literal notranslate"><span class="pre">/opt/onionsalt/salt/sensor/init.sls</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">localbro</span><span class="p">:</span>
<span class="n">file</span><span class="o">.</span><span class="n">managed</span><span class="p">:</span>
   <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">site</span><span class="o">/</span><span class="n">local</span><span class="o">.</span><span class="n">bro</span>
   <span class="o">-</span> <span class="n">source</span><span class="p">:</span> <span class="n">salt</span><span class="p">:</span><span class="o">//</span><span class="n">sensor</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">local</span><span class="o">.</span><span class="n">bro</span>
</pre></div>
</div>
<p>Then test, using:</p>
<p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">salt</span> <span class="pre">&quot;SENSOR&quot;</span> <span class="pre">state.highstate</span></code></p>
<p>You can then have Bro automatically restart upon a detected change in <code class="docutils literal notranslate"><span class="pre">local.bro</span></code> from the master by modifying <code class="docutils literal notranslate"><span class="pre">init.sls</span></code> similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">restart</span><span class="o">-</span><span class="n">bro</span>
<span class="n">cmd</span><span class="o">.</span><span class="n">wait</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">nsm_sensor_ps</span><span class="o">-</span><span class="n">restart</span> <span class="o">--</span><span class="n">only</span><span class="o">-</span><span class="n">bro</span>
  <span class="o">-</span> <span class="n">cwd</span><span class="p">:</span> <span class="o">/</span>
  <span class="o">-</span> <span class="n">watch</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">file</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">site</span><span class="o">/</span><span class="n">local</span><span class="o">.</span><span class="n">bro</span>
</pre></div>
</div>
</div>
<div class="section" id="top-for-bro">
<h4>Top for Bro<a class="headerlink" href="#top-for-bro" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>To view “top-like” information for Bro logs, consider using BroTop.</li>
<li>“Brotop lets you stream your bro logs to the browser for easy
debugging and a real-time glimpse into whats being processed”.</li>
<li>Written in Go, BroTop is a dependency-free binary that can be
downloaded and run immediately, auto-detecting Bro log paths.</li>
<li>For more information about BroTop, please see <a class="reference external" href="https://github.com/criticalstack/brotop">https://github.com/criticalstack/brotop</a>.</li>
</ul>
</div>
<div class="section" id="nsm-bro-spool-tmp">
<h4>/nsm/bro/spool/tmp<a class="headerlink" href="#nsm-bro-spool-tmp" title="Permalink to this headline">¶</a></h4>
<p>If you find that /nsm/bro/spool/tmp contains lots of old crash files,
you can clean them up with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">su</span> <span class="n">sguil</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;/opt/bro/bin/broctl cleanup --all&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information about Bro, please see <a class="reference external" href="https://www.zeek.org/">https://www.zeek.org/</a>.</p>
</div>
</div>
<span id="document-netsniff-ng"></span><div class="section" id="netsniff-ng">
<h3>netsniff-ng<a class="headerlink" href="#netsniff-ng" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="http://netsniff-ng.org">http://netsniff-ng.org</a>:</p>
<blockquote>
<div>netsniff-ng is a free Linux networking toolkit, a Swiss army knife
for your daily Linux network plumbing if you will. Its gain of
performance is reached by zero-copy mechanisms, so that on packet
reception and transmission the kernel does not need to copy packets
from kernel space to user space and vice versa.</div></blockquote>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>Security Onion uses netsniff-ng to collect full packet capture in the form of pcap files.</p>
</div>
<div class="section" id="output">
<h4>Output<a class="headerlink" href="#output" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">netsniff-ng writes full packet capture in the form of pcap files to:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/nsm/sensor_data/HOSTNAME-INTERFACE/dailylogs/YYYY-MM-DD/</span></code></div>
<div class="line">where:</div>
</div>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> is your actual hostname</li>
<li><code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code> is your actual sniffing interface</li>
<li><code class="docutils literal notranslate"><span class="pre">YYYY-MM-DD</span></code> is the year, month, and date the pcap was recorded</li>
</ul>
</div>
<div class="section" id="analysis">
<h4>Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline">¶</a></h4>
<p>Besides accessing the pcaps in the directory shown above, you can also pivot to full packet capture from <a class="reference external" href="Sguil">Sguil</a> and <a class="reference external" href="CapMe">CapMe</a>.</p>
</div>
<div class="section" id="troubleshooting">
<h4>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h4>
<p>Check the netsniff-ng.log file in <code class="docutils literal notranslate"><span class="pre">/var/log/nsm/HOSTNAME-INTERFACE/netsniff-ng.log</span></code> (where <code class="docutils literal notranslate"><span class="pre">HOSTNAME</span></code> is your actual hostname and <code class="docutils literal notranslate"><span class="pre">INTERFACE</span></code> is your actual sniffing interface).</p>
</div>
<div class="section" id="tuning">
<h4>Tuning<a class="headerlink" href="#tuning" title="Permalink to this headline">¶</a></h4>
<p>If sostat report packet loss in netsniff-ng, you may want to consider one or more of the following options in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/HOSTNAME-INTERFACE/sensor.conf</span></code>:</p>
<ul class="simple">
<li>increase <code class="docutils literal notranslate"><span class="pre">PCAP_RING_SIZE</span></code></li>
<li>set <code class="docutils literal notranslate"><span class="pre">PCAP_OPTIONS</span></code> to <code class="docutils literal notranslate"><span class="pre">--mmap</span></code> to enable memory-mapped IO</li>
</ul>
<p>Please note that both of these options will cause netsniff-ng to consume more RAM.</p>
</div>
<div class="section" id="reducing-storage">
<h4>Reducing Storage<a class="headerlink" href="#reducing-storage" title="Permalink to this headline">¶</a></h4>
<p>Full packet capture obviously requires lots of disk space. Trimming your pcaps can allow you to store pcap for longer periods of time. For more information, please see the <a class="reference external" href="Trimming-PCAPs">Trimming PCAPs</a> section.</p>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information about netsniff-ng, please see <a class="reference external" href="http://netsniff-ng.org/">http://netsniff-ng.org/</a>.</p>
</div>
</div>
</div>
</div>
<span id="document-host"></span><div class="section" id="host-visibility">
<h2>Host Visibility<a class="headerlink" href="#host-visibility" title="Permalink to this headline">¶</a></h2>
<p>In this section, we’ll review different ways that Security Onion can collect logs from endpoints.</p>
<div class="toctree-wrapper compound">
<span id="document-beats"></span><div class="section" id="beats">
<h3>Beats<a class="headerlink" href="#beats" title="Permalink to this headline">¶</a></h3>
<p>We can use Elastic Beats to facilitate the shipping of endpoint logs to Security Onion’s Elastic Stack. Currently, testing has only been performed with Filebeat (multiple log types) and Winlogbeat (Windows Event logs).</p>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>To install a Beat, follow the instructions provided for the respective Beat, with the exception of loading the index template, as Security Onion uses its own template file to manage Beats fields.</p>
<p>Filebeat</p>
<p><a class="reference external" href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation.html">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-installation.html</a></p>
<p>Winlogbeat</p>
<p><a class="reference external" href="https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation.html">https://www.elastic.co/guide/en/beats/winlogbeat/current/winlogbeat-installation.html</a></p>
<p><a href="#id1"><span class="problematic" id="id2">*</span></a>If installing Filebeat on a Linux distribution, you will want to ensure that the service is started after a reboot.  We can ensure this by running the following commands after install:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">rc</span><span class="o">.</span><span class="n">d</span> <span class="n">filebeat</span> <span class="n">defaults</span>

<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">rc</span><span class="o">.</span><span class="n">d</span> <span class="n">filebeat</span> <span class="n">enable</span>
</pre></div>
</div>
</div>
<div class="section" id="firewall">
<h4>Firewall<a class="headerlink" href="#firewall" title="Permalink to this headline">¶</a></h4>
<p>To ensure a Beat is allowed to talk to Logstash on the Security Onion box, we need to run <a class="reference external" href="so-allow">so-allow</a>, and choose the <code class="docutils literal notranslate"><span class="pre">b</span></code> option for <code class="docutils literal notranslate"><span class="pre">Beats</span></code>. After choosing this option, simply provide the IP address of the machine on which the Beat is installed and press <code class="docutils literal notranslate"><span class="pre">ENTER</span></code> to confirm.</p>
</div>
<div class="section" id="log-files">
<h4>Log files<a class="headerlink" href="#log-files" title="Permalink to this headline">¶</a></h4>
<div class="section" id="filebeat">
<h5>Filebeat<a class="headerlink" href="#filebeat" title="Permalink to this headline">¶</a></h5>
<p>Windows: <code class="docutils literal notranslate"><span class="pre">C:\\Program</span> <span class="pre">Files\Filebeat\filebeat.log</span></code></p>
<p>Linux: <code class="docutils literal notranslate"><span class="pre">/var/log/filebeat/filebeat</span></code></p>
</div>
<div class="section" id="winlogbeat">
<h5>Winlogbeat<a class="headerlink" href="#winlogbeat" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">C:\\Program</span> <span class="pre">Files\Winlogbeat\winlogbeat.log</span></code></p>
<p>Default fields:
<a class="reference external" href="https://www.elastic.co/guide/en/beats/winlogbeat/master/exported-fields-eventlog.html">https://www.elastic.co/guide/en/beats/winlogbeat/master/exported-fields-eventlog.html</a></p>
</div>
</div>
<div class="section" id="data">
<h4>Data<a class="headerlink" href="#data" title="Permalink to this headline">¶</a></h4>
<p>Beats data can be viewed via the <code class="docutils literal notranslate"><span class="pre">Beats</span></code> dashboard, (or through the selection of the <code class="docutils literal notranslate"><span class="pre">*:logstash-beats-*</span></code> index pattern in <code class="docutils literal notranslate"><span class="pre">Discover</span></code>) in Kibana.</p>
<p>If you access the Beats dashboard and see logs but the visualizations have errors, you may need to refresh the <code class="docutils literal notranslate"><span class="pre">logstash-beats-*</span></code> field list as follows:</p>
<ul class="simple">
<li>On the sidebar on the left, click <code class="docutils literal notranslate"><span class="pre">Management</span></code>.</li>
<li>Click <code class="docutils literal notranslate"><span class="pre">Index</span> <span class="pre">Patterns</span></code>.</li>
<li>Click <code class="docutils literal notranslate"><span class="pre">logstash-beats-*</span></code>.</li>
<li>Click the circular arrows in the upper right to refresh the field list.</li>
</ul>
</div>
<div class="section" id="encryption">
<h4>Encryption<a class="headerlink" href="#encryption" title="Permalink to this headline">¶</a></h4>
<p>Beats communication with Elasticsearch/Logstash is <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">encrypted</span></code> by default. If you require encryption, please consult the appropriate Elastic documentation to configure the use of TLS.</p>
</div>
</div>
<span id="document-wazuh"></span><div class="section" id="wazuh">
<h3>Wazuh<a class="headerlink" href="#wazuh" title="Permalink to this headline">¶</a></h3>
<div class="section" id="description">
<h4>Description<a class="headerlink" href="#description" title="Permalink to this headline">¶</a></h4>
<p>From <a class="reference external" href="https://wazuh.com/">https://wazuh.com/</a>:</p>
<blockquote>
<div>Wazuh is a free, open source and enterprise-ready security monitoring solution for threat detection, integrity monitoring, incident response and compliance.</div></blockquote>
</div>
<div class="section" id="security-onion-usage">
<h4>Security Onion Usage<a class="headerlink" href="#security-onion-usage" title="Permalink to this headline">¶</a></h4>
<p>Security Onion uses Wazuh as a Host Intrusion Detection System (HIDS). Wazuh is monitoring and defending Security Onion itself and you can add Wazuh agents to monitor other hosts on your network as well.</p>
<div class="line-block">
<div class="line">Wazuh replaced OSSEC:</div>
<div class="line"><a class="reference external" href="https://blog.securityonion.net/2018/10/wazuh-361-elastic-641-and-associated.html">https://blog.securityonion.net/2018/10/wazuh-361-elastic-641-and-associated.html</a></div>
</div>
</div>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<p>The main configuration file for Wazuh is <code class="docutils literal notranslate"><span class="pre">/var/ossec/etc/ossec.conf</span></code>.</p>
</div>
<div class="section" id="email">
<h4>Email<a class="headerlink" href="#email" title="Permalink to this headline">¶</a></h4>
<p>If you want to configure Wazuh to send email, please see the <a class="reference external" href="Email">Email</a> section.</p>
</div>
<div class="section" id="syslog">
<h4>Syslog<a class="headerlink" href="#syslog" title="Permalink to this headline">¶</a></h4>
<p>If you want to send Wazuh logs to an external syslog collector, please see the <a class="reference external" href="syslog-output">syslog-output</a> section.</p>
</div>
<div class="section" id="active-response">
<h4>Active Response<a class="headerlink" href="#active-response" title="Permalink to this headline">¶</a></h4>
<p>Sometimes, Wazuh may recognize legitimate activity as potentially malicious, and engage in Active Response to block a connection. This may result in unintended consequences and/or blacklisting of trusted IPs.  To prevent this from occurring,  you can whitelist your IP address and change other settings in <code class="docutils literal notranslate"><span class="pre">/var/ossec/etc/ossec.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="k">global</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">white_list</span><span class="o">&gt;</span><span class="n">desired_ip</span><span class="o">&lt;/</span><span class="n">white_list</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="k">global</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="tuning-rules">
<h4>Tuning Rules<a class="headerlink" href="#tuning-rules" title="Permalink to this headline">¶</a></h4>
<p>You can add new rules and modify existing rules in <code class="docutils literal notranslate"><span class="pre">/var/ossec/rules/local_rules.xml</span></code>.</p>
<p>Wazuh alerts of a level of <code class="docutils literal notranslate"><span class="pre">5</span></code> or greater will be populated in the Sguil database, and viewable via Sguil and/or Squert. If you would like to change the level for which alerts are sent to sguild, you can modify the value for <code class="docutils literal notranslate"><span class="pre">OSSEC_AGENT_LEVEL</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code> and restart NSM services.</p>
</div>
<div class="section" id="adding-agents">
<h4>Adding Agents<a class="headerlink" href="#adding-agents" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">The Wazuh agent is cross platform and you can download agents for Windows/Unix/Linux/FreeBSD from the Wazuh website:</div>
<div class="line"><a class="reference external" href="https://documentation.wazuh.com/3.8/installation-guide/packages-list/index.html">https://documentation.wazuh.com/3.8/installation-guide/packages-list/index.html</a></div>
</div>
<p>Please note! It is important to ensure that you download the agent that matches the version of your Wazuh server. For example, if your Wazuh server is version 3.8.2, then you will want to deploy Wazuh agent version 3.8.2.</p>
<div class="line-block">
<div class="line">Once you’ve installed the Wazuh agent on the host(s) to be monitored, then perform the steps defined here:</div>
<div class="line"><a class="reference external" href="http://ossec-docs.readthedocs.org/en/latest/manual/agent/agent-management.html#managing-agents">http://ossec-docs.readthedocs.org/en/latest/manual/agent/agent-management.html#managing-agents</a></div>
</div>
<p>You may need to run <a class="reference external" href="so-allow">so-allow</a> to allow traffic from the IP address of your Wazuh agent(s).</p>
</div>
<div class="section" id="maximum-number-of-agents">
<h4>Maximum Number of Agents<a class="headerlink" href="#maximum-number-of-agents" title="Permalink to this headline">¶</a></h4>
<p>Security Onion is configured to support a maximum number of <code class="docutils literal notranslate"><span class="pre">14000</span></code> Wazuh agents reporting to a single Wazuh manager.</p>
</div>
<div class="section" id="automated-deployment">
<h4>Automated Deployment<a class="headerlink" href="#automated-deployment" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">If you would like to automate the deployment of Wazuh agents, the Wazuh server includes <code class="docutils literal notranslate"><span class="pre">ossec-authd</span></code>:</div>
<div class="line"><a class="reference external" href="https://documentation.wazuh.com/3.8/user-manual/reference/daemons/ossec-authd.html">https://documentation.wazuh.com/3.8/user-manual/reference/daemons/ossec-authd.html</a></div>
</div>
</div>
<div class="section" id="downloads">
<h4>Downloads<a class="headerlink" href="#downloads" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">You can download Wazuh agents here:</div>
<div class="line"><a class="reference external" href="https://documentation.wazuh.com/3.8/installation-guide/packages-list/index.html">https://documentation.wazuh.com/3.8/installation-guide/packages-list/index.html</a></div>
</div>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information about Wazuh, please see <a class="reference external" href="https://documentation.wazuh.com/3.8/">https://documentation.wazuh.com/3.8/</a>.</p>
</div>
</div>
<span id="document-sysmon"></span><div class="section" id="sysmon">
<h3>Sysmon<a class="headerlink" href="#sysmon" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/sysmon">https://technet.microsoft.com/en-us/sysinternals/sysmon</a>:</p>
<blockquote>
<div>System Monitor (Sysmon) is a Windows system service and device
driver that, once installed on a system, remains resident across
system reboots to monitor and log system activity to the Windows
event log. It provides detailed information about process creations,
network connections, and changes to file creation time. By
collecting the events it generates using Windows Event Collection or
SIEM agents and subsequently analyzing them, you can identify
malicious or anomalous activity and understand how intruders and
malware operate on your network.</div></blockquote>
<div class="section" id="integration">
<h4>Integration<a class="headerlink" href="#integration" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Josh Brower wrote a great paper on integrating sysmon into Security
Onion:</div>
<div class="line"><a class="reference external" href="https://digital-forensics.sans.org/community/papers/gcfa/sysmon-enrich-security-onions-host-level-capabilities_10612">https://digital-forensics.sans.org/community/papers/gcfa/sysmon-enrich-security-onions-host-level-capabilities_10612</a></div>
</div>
</div>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">SwiftOnSecurity has a great sysmon config file to use as a starting
point:</div>
<div class="line"><a class="reference external" href="https://github.com/SwiftOnSecurity/sysmon-config">https://github.com/SwiftOnSecurity/sysmon-config</a></div>
</div>
</div>
<div class="section" id="downloads">
<h4>Downloads<a class="headerlink" href="#downloads" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Download sysmon here:</div>
<div class="line"><a class="reference external" href="https://download.sysinternals.com/files/Sysmon.zip">https://download.sysinternals.com/files/Sysmon.zip</a></div>
</div>
<div class="line-block">
<div class="line">Download SwiftOnSecurity’s example sysmon config here:</div>
<div class="line"><a class="reference external" href="https://github.com/SwiftOnSecurity/sysmon-config/raw/master/sysmonconfig-export.xml">https://github.com/SwiftOnSecurity/sysmon-config/raw/master/sysmonconfig-export.xml</a></div>
</div>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information about sysmon, please see <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/sysmon">https://technet.microsoft.com/en-us/sysinternals/sysmon</a>.</p>
<div class="line-block">
<div class="line">Also see “How to Go from Responding to Hunting with Sysinternals Sysmon”:</div>
<div class="line"><a class="reference external" href="https://onedrive.live.com/view.aspx?resid=D026B4699190F1E6!2843&amp;ithint=file%2cpptx">https://onedrive.live.com/view.aspx?resid=D026B4699190F1E6!2843&amp;ithint=file%2cpptx</a></div>
</div>
</div>
</div>
<span id="document-autoruns"></span><div class="section" id="autoruns">
<h3>Autoruns<a class="headerlink" href="#autoruns" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/bb963902.aspx">https://technet.microsoft.com/en-us/sysinternals/bb963902.aspx</a>:</p>
<blockquote>
<div>This utility, which has the most comprehensive knowledge of
auto-starting locations of any startup monitor, shows you what
programs are configured to run during system bootup or login, and
when you start various built-in Windows applications like Internet
Explorer, Explorer and media players. These programs and drivers
include ones in your startup folder, Run, RunOnce, and other
Registry keys. Autoruns reports Explorer shell extensions, toolbars,
browser helper objects, Winlogon notifications, auto-start services,
and much more. Autoruns goes way beyond other autostart utilities.</div></blockquote>
<div class="section" id="integration">
<h4>Integration<a class="headerlink" href="#integration" title="Permalink to this headline">¶</a></h4>
<div class="section" id="wazuh">
<h5>Wazuh<a class="headerlink" href="#wazuh" title="Permalink to this headline">¶</a></h5>
<p>Currently, our Autoruns dashboard in Kibana works only with Autoruns logs shipped via Wazuh. If you are trying to ship Autoruns logs via Winlogbeat, you can create a custom dashboard and visualizations that reference the <code class="docutils literal notranslate"><span class="pre">logstash-beats-*</span></code> indices, or view Autoruns logs via the <code class="docutils literal notranslate"><span class="pre">Beats</span></code> dashboard.</p>
</div>
<div class="section" id="pertinax">
<h5>Pertinax<a class="headerlink" href="#pertinax" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">Josh Brower developed a great project called Pertinax to normalize autoruns data and integrate it into Security Onion:</div>
<div class="line"><a class="reference external" href="https://github.com/defensivedepth/Pertinax/wiki/Introduction">https://github.com/defensivedepth/Pertinax/wiki/Introduction</a></div>
<div class="line"><br /></div>
<div class="line">Execute autoruns and ar-normalize.ps1 as shown here:</div>
<div class="line"><a class="reference external" href="https://github.com/defensivedepth/Pertinax/wiki/Reference%20Architecture">https://github.com/defensivedepth/Pertinax/wiki/Reference%20Architecture</a></div>
</div>
</div>
<div class="section" id="autorunstowineventlog">
<h5>AutorunsToWinEventLog<a class="headerlink" href="#autorunstowineventlog" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">Another method for integrating Autoruns into your logging infrastructure is AutorunsToWinEventLog:</div>
<div class="line"><a class="reference external" href="https://github.com/palantir/windows-event-forwarding/tree/master/AutorunsToWinEventLog">https://github.com/palantir/windows-event-forwarding/tree/master/AutorunsToWinEventLog</a></div>
</div>
</div>
</div>
<div class="section" id="downloads">
<h4>Downloads<a class="headerlink" href="#downloads" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Download Autoruns here:</div>
<div class="line"><a class="reference external" href="https://download.sysinternals.com/files/Autoruns.zip">https://download.sysinternals.com/files/Autoruns.zip</a></div>
<div class="line"><br /></div>
<div class="line">Download ar-normalize.ps1 here:</div>
<div class="line"><a class="reference external" href="https://raw.githubusercontent.com/defensivedepth/Pertinax/master/normalize/ar-normalize.ps1">https://raw.githubusercontent.com/defensivedepth/Pertinax/master/normalize/ar-normalize.ps1</a></div>
</div>
</div>
</div>
<span id="document-syslog"></span><div class="section" id="syslog">
<h3>Syslog<a class="headerlink" href="#syslog" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://www.syslog-ng.com/products/open-source-log-management/">https://www.syslog-ng.com/products/open-source-log-management/</a>:</p>
<blockquote>
<div>With syslog-ng, you can collect logs from any source, process them in real time and deliver them to a wide variety of destinations. syslog-ng allows you to flexibly collect, parse, classify, rewrite and correlate logs from across your infrastructure and store or route them to log analysis tools.</div></blockquote>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>Security Onion uses syslog-ng as its primary syslog collector and to send logs to <a class="reference external" href="Logstash">Logstash</a> where they are parsed and augmented before being written to <a class="reference external" href="Elasticsearch">Elasticsearch</a>.</p>
</div>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<p>syslog-ng’s configuration file is located at <code class="docutils literal notranslate"><span class="pre">/etc/syslog-ng/syslog-ng.conf</span></code>.</p>
</div>
<div class="section" id="forwarding">
<h4>Forwarding<a class="headerlink" href="#forwarding" title="Permalink to this headline">¶</a></h4>
<p>You can configure syslog-ng to <a class="reference external" href="syslog-output">forward</a> Bro / Wazuh / IDS logs to external systems.</p>
</div>
<div class="section" id="collection">
<h4>Collection<a class="headerlink" href="#collection" title="Permalink to this headline">¶</a></h4>
<p>syslog-ng listens on port 514 (TCP and UDP) for incoming syslog from other devices.  You may need to run <a class="reference external" href="so-allow">so-allow</a> to allow traffic from the IP address of your syslog sender.</p>
</div>
<div class="section" id="analysis">
<h4>Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline">¶</a></h4>
<p>If you’d like to analyze logs collected from other devices, another option is to configure Wazuh to receive syslog directly on a port other than the syslog-ng port of 514.  For more information, please see <a class="reference external" href="http://ossec-docs.readthedocs.org/en/latest/syntax/head_ossec_config.remote.html">http://ossec-docs.readthedocs.org/en/latest/syntax/head_ossec_config.remote.html</a>.</p>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information about syslog-ng, please see <a class="reference external" href="https://www.syslog-ng.com/products/open-source-log-management/">https://www.syslog-ng.com/products/open-source-log-management/</a>.</p>
</div>
</div>
</div>
</div>
<span id="document-elastic"></span><div class="section" id="elastic-stack">
<h2>Elastic Stack<a class="headerlink" href="#elastic-stack" title="Permalink to this headline">¶</a></h2>
<p>Security Onion includes the Elastic Stack:</p>
<div class="line-block">
<div class="line"><a class="reference external" href="Elasticsearch">Elasticsearch</a></div>
<div class="line"><a class="reference external" href="Logstash">Logstash</a></div>
<div class="line"><a class="reference external" href="Kibana">Kibana</a></div>
</div>
<p>In addition, we’ve added the following:</p>
<div class="line-block">
<div class="line"><a class="reference external" href="Curator">Curator</a></div>
<div class="line"><a class="reference external" href="DomainStats">DomainStats</a></div>
<div class="line"><a class="reference external" href="ElastAlert">ElastAlert</a></div>
<div class="line"><a class="reference external" href="FreqServer">FreqServer</a></div>
</div>
<p>Each of the components above has its own <a class="reference external" href="Docker">Docker</a> image.</p>
<p>You can get an idea of what this whole integration looks like at a high-level by viewing our <a class="reference external" href="Elastic-Architecture">architecture
diagram</a>.</p>
<div class="toctree-wrapper compound">
<span id="document-elasticsearch"></span><div class="section" id="elasticsearch">
<h3>Elasticsearch<a class="headerlink" href="#elasticsearch" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://www.elastic.co/products/elasticsearch">https://www.elastic.co/products/elasticsearch</a>:</p>
<blockquote>
<div>Elasticsearch is a distributed, RESTful search and analytics engine
capable of solving a growing number of use cases. As the heart of
the Elastic Stack, it centrally stores your data so you can discover
the expected and uncover the unexpected.</div></blockquote>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<div class="section" id="shards">
<h5>Shards<a class="headerlink" href="#shards" title="Permalink to this headline">¶</a></h5>
<p>Here are a few tips from
<a class="reference external" href="https://www.elastic.co/blog/how-many-shards-should-i-have-in-my-elasticsearch-cluster">https://www.elastic.co/blog/how-many-shards-should-i-have-in-my-elasticsearch-cluster</a>:</p>
<blockquote>
<div><p>TIP: Avoid having very large shards as this can negatively affect
the cluster’s ability to recover from failure. There is no fixed
limit on how large shards can be, but a shard size of 50GB is often
quoted as a limit that has been seen to work for a variety of
use-cases.</p>
<p>TIP: Small shards result in small segments, which increases
overhead. Aim to keep the average shard size between a few GB and a
few tens of GB. For use-cases with time-based data, it is common to
see shards between 20GB and 40GB in size.</p>
<p>TIP: The number of shards you can hold on a node will be
proportional to the amount of heap you have available, but there is
no fixed limit enforced by Elasticsearch. A good rule-of-thumb is to
ensure you keep the number of shards per node below 20 to 25 per GB
heap it has configured. A node with a 30GB heap should therefore
have a maximum of 600-750 shards, but the further below this limit
you can keep it the better. This will generally help the cluster
stay in good health.</p>
</div></blockquote>
<p>To see your existing shards:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cat</span><span class="o">/</span><span class="n">indices</span>
</pre></div>
</div>
<p>The number of shards will be shown in the fifth column.</p>
<p>If you want to view the detail for each of those shards:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cat</span><span class="o">/</span><span class="n">shards</span>
</pre></div>
</div>
<p>Given the sizing tips above, if any of your indices are averaging more than 50GB per shard, then you should probably increase the shard count until you get below that recommended maximum of 50GB per shard.</p>
<p>The number of shards for an index is defined in the template file for that index.  By default, there are three template files in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/</span></code>:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">beats-template.json</span></code> applies to <code class="docutils literal notranslate"><span class="pre">logstash-beats</span></code> indices</li>
<li><code class="docutils literal notranslate"><span class="pre">logstash-ossec-template.json</span></code> applies to <code class="docutils literal notranslate"><span class="pre">logstash-ossec</span></code> indices</li>
<li><code class="docutils literal notranslate"><span class="pre">logstash-template.json</span></code> applies to <code class="docutils literal notranslate"><span class="pre">logstash-ids</span></code>, <code class="docutils literal notranslate"><span class="pre">logstash-firewall</span></code>, <code class="docutils literal notranslate"><span class="pre">logstash-syslog</span></code>, <code class="docutils literal notranslate"><span class="pre">logstash-bro</span></code>, <code class="docutils literal notranslate"><span class="pre">logstash-import</span></code>, and <code class="docutils literal notranslate"><span class="pre">logstash-beats</span></code>.</li>
</ul>
<p>Depending on which index you want to increase shards for, you have a few options.</p>
<p>If you want to increase shards for <code class="docutils literal notranslate"><span class="pre">logstash-beats</span></code> or <code class="docutils literal notranslate"><span class="pre">logstash-ossec</span></code>:</p>
<ul>
<li><p class="first">First, copy the template to <code class="docutils literal notranslate"><span class="pre">/etc/logstash/custom/</span></code>.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">logstash</span><span class="o">-</span><span class="n">ossec</span><span class="o">-</span><span class="n">template</span><span class="o">.</span><span class="n">json</span> <span class="n">to</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">custom</span><span class="o">/</span>
</pre></div>
</div>
</li>
<li><p class="first">Then, update your new template in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/custom/</span></code>.</p>
</li>
<li><p class="first">Finally, restart Logstash to push the new template to Elasticsearch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">logstash</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</li>
</ul>
<p>If you want to increase shards for all indices defined in <code class="docutils literal notranslate"><span class="pre">logstash-template.json</span></code>, then you can follow a process similar to what was shown above.  However, if you want to increase shard count for only one index type (example: bro), you can update the template as follows:</p>
<ul>
<li><p class="first">First, copy <code class="docutils literal notranslate"><span class="pre">/etc/logstash/logstash-template.json</span></code> and give it a name based on the index (example: <code class="docutils literal notranslate"><span class="pre">logstash-bro-template.json</span></code>).</p>
</li>
<li><p class="first">Then, update your new template, changing the <code class="docutils literal notranslate"><span class="pre">index_patterns</span></code> line to only apply to the index you care about, increasing the value of the <code class="docutils literal notranslate"><span class="pre">order</span></code> field from <code class="docutils literal notranslate"><span class="pre">0</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code>, and setting your <code class="docutils literal notranslate"><span class="pre">number_of_shards</span></code>.</p>
</li>
<li><p class="first">Next, we need to tell Logstash to use this new template, so update the proper output file in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/</span></code> and update the template value.</p>
</li>
<li><p class="first">Then, we need to configure the Logstash container to be able to access the template by updating <code class="docutils literal notranslate"><span class="pre">LOGSTASH_OPTIONS</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code> similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LOGSTASH_OPTIONS</span><span class="o">=</span><span class="s2">&quot;--volume /etc/logstash/logstash-bro-template.json:/logstash-bro-template.json:ro&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Finally, restart Logstash to push the new template to Elasticsearch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">logstash</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</li>
</ul>
<p>Please keep in mind that old indices will retain previous shard settings and the above settings will only be applied to newly created indices.</p>
</div>
<div class="section" id="files">
<h5>Files<a class="headerlink" href="#files" title="Permalink to this headline">¶</a></h5>
<ul class="simple">
<li>Configuration files for Elasticsearch can be found in <code class="docutils literal notranslate"><span class="pre">/etc/elasticsearch/</span></code>.</li>
<li>Other configuration options for Elasticsearch can be found in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code>.</li>
<li>By default, if total available memory is 8GB or greater, the heap size in <code class="docutils literal notranslate"><span class="pre">/etc/elasticsearch/jvm.options</span></code> is configured (during Setup) to equal 25% of available memory, but no greater than 25GB.</li>
</ul>
<div class="line-block">
<div class="line">For more information, please see:</div>
<div class="line"><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/guide/current/heap-sizing.html#compressed_oops">https://www.elastic.co/guide/en/elasticsearch/guide/current/heap-sizing.html#compressed_oops</a></div>
<div class="line"><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html">https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</a></div>
</div>
<p>You may need to adjust the value for heap size depending on your system’s performance (running <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">so-elastic-restart</span></code> after).</p>
</div>
<div class="section" id="field-limit">
<h5>Field limit<a class="headerlink" href="#field-limit" title="Permalink to this headline">¶</a></h5>
<p>Security Onion currently utilizes the default field limit for Elasticsearch indices (<code class="docutils literal notranslate"><span class="pre">1000</span></code>). If you receive error messages from Logstash, or you would simply like to increase this, you can do so with one of the following options.</p>
</div>
<div class="section" id="temporary">
<h5>Temporary<a class="headerlink" href="#temporary" title="Permalink to this headline">¶</a></h5>
<p>If you only need to increase the field limit temporarily, you can do something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">XPUT</span> <span class="o">-</span><span class="n">H</span><span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">logstash</span><span class="o">-</span><span class="n">syslog</span><span class="o">-*/</span><span class="n">_settings</span> <span class="o">-</span><span class="n">d</span><span class="s1">&#39;{ &quot;index.mapping.total_fields.limit&quot;: 2000 }&#39;</span>
</pre></div>
</div>
<p>The above command would increase the field limit for the <code class="docutils literal notranslate"><span class="pre">logstash-syslog-*</span></code> indice(s) to <code class="docutils literal notranslate"><span class="pre">2000</span></code>. Keep in mind, this setting only applies to the current index, so when the index rolls over and a new one is created, your new settings will not apply.</p>
</div>
<div class="section" id="persistent">
<h5>Persistent<a class="headerlink" href="#persistent" title="Permalink to this headline">¶</a></h5>
<p>If you need this change to be persistent, you can modify the <code class="docutils literal notranslate"><span class="pre">settings</span></code> stanza for the matched indices in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/logstash-template.json</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;settings&quot;</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;number_of_replicas&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;number_of_shards&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;index.refresh_interval&quot;</span> <span class="p">:</span> <span class="s2">&quot;5s&quot;</span><span class="p">,</span>
    <span class="s2">&quot;index.mapping.total_fields.limit&quot;</span><span class="p">:</span> <span class="mi">2000</span>
<span class="p">},</span>
</pre></div>
</div>
<p>Then restart Logstash:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">logstash</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>Please note that the change to the field limit will not occur immediately – only upon index creation. Therefore, it is recommended to run the previously mentioned temporary command and modify the template file.</p>
</div>
<div class="section" id="additional-options">
<h5>Additional options<a class="headerlink" href="#additional-options" title="Permalink to this headline">¶</a></h5>
<p>If you need to make additional directories accessible to Elasticsearch, or would like to specify additional options when starting Elasticsearch, you can do so by adding these items to <code class="docutils literal notranslate"><span class="pre">ELASTICSEARCH_OPTIONS</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code></p>
</div>
</div>
<div class="section" id="logs">
<h4>Logs<a class="headerlink" href="#logs" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Elasticsearch logs can be found in <code class="docutils literal notranslate"><span class="pre">/var/log/elasticsearch/</span></code>.</li>
<li>Logging configuration can be found in
<code class="docutils literal notranslate"><span class="pre">/etc/elasticsearch/log4j2.properties</span></code>.</li>
</ul>
</div>
<div class="section" id="distributed">
<h4>Distributed<a class="headerlink" href="#distributed" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="master">
<h4>Master<a class="headerlink" href="#master" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">master</span> <span class="pre">server</span></code> runs it’s own local copy of Elasticsearch, which manages cross-cluster search configuration for the deployment. This includes configuration for <code class="docutils literal notranslate"><span class="pre">heavy</span> <span class="pre">nodes</span></code> and <code class="docutils literal notranslate"><span class="pre">storage</span> <span class="pre">nodes</span></code> (where applicable), but not <code class="docutils literal notranslate"><span class="pre">forward</span> <span class="pre">nodes</span></code>, as they do not run Elastic Stack components.</p>
</div>
<div class="section" id="forward-nodes">
<h4>Forward Nodes<a class="headerlink" href="#forward-nodes" title="Permalink to this headline">¶</a></h4>
<p>When using a <code class="docutils literal notranslate"><span class="pre">forward</span> <span class="pre">node</span></code>, Elastic Stack components are not enabled. Syslog-NG forwards all logs to Logstash on the master server via an autossh tunnel, where they are stored in Elasticsearch on the master server or a storage node (if the master server has been configured to use storage nodes). From there, the data can be queried through the use of cross-cluster search.</p>
</div>
<div class="section" id="heavy-nodes">
<h4>Heavy Nodes<a class="headerlink" href="#heavy-nodes" title="Permalink to this headline">¶</a></h4>
<p>When using a <code class="docutils literal notranslate"><span class="pre">heavy</span> <span class="pre">node</span></code>, Security Onion implements distributed deployments using Elasticsearch’s <a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-cross-cluster-search.html">cross cluster search</a>. When you run Setup and choose <code class="docutils literal notranslate"><span class="pre">Heavy</span> <span class="pre">Node</span></code>, it will create a local Elasticsearch instance and then configure the master server to query that instance (similar to ELSA distributed deployments). This is done by constructing an autossh tunnel from the heavy node to the master server, configuring reverse port forwarding to allow the master server to connect to the local Elasticsearch instance, and updating _cluster/settings on the master server so that it will query the local Elasticsearch instance.</p>
</div>
<div class="section" id="storage-nodes">
<h4>Storage Nodes<a class="headerlink" href="#storage-nodes" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">Storage</span> <span class="pre">nodes</span></code> extend the storage and processing capabilities of the master server, and run Elasticsearch, Logstash, and Curator. Just like heavy nodes, storage nodes are added to the master’s cluster search configuration, so the data that resides on the nodes can be queried from the master.</p>
</div>
<div class="section" id="removing-a-node-from-the-master">
<h4>Removing a node from the master<a class="headerlink" href="#removing-a-node-from-the-master" title="Permalink to this headline">¶</a></h4>
<p>If you need to remove a node (such as a <code class="docutils literal notranslate"><span class="pre">heavy</span> <span class="pre">node</span></code> or a <code class="docutils literal notranslate"><span class="pre">storage</span> <span class="pre">node</span></code>) from your cross cluster search configuration, send the following to Elasticsearch on your master server (replacing “node1” with the actual node you’d like to remove and noting that null must be in square brackets):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PUT</span> <span class="n">_cluster</span><span class="o">/</span><span class="n">settings</span>
<span class="p">{</span>
<span class="s2">&quot;persistent&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="s2">&quot;search&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="s2">&quot;node1&quot;</span><span class="p">:</span> <span class="p">{</span>
<span class="s2">&quot;seeds&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">}}}}}</span>
</pre></div>
</div>
<p>You can simply copy/paste the above code (modifying as necessary) into the Console, under “Dev Tools” in Kibana, and click the green triangle. Alternatively, you could submit it to Elasticsearch via a cURL command.</p>
</div>
<div class="section" id="storage">
<h4>Storage<a class="headerlink" href="#storage" title="Permalink to this headline">¶</a></h4>
<p>All of the data Elasticsearch collects is stored under <code class="docutils literal notranslate"><span class="pre">/nsm/elasticsearch/</span></code>.</p>
</div>
<div class="section" id="snapshots">
<h4>Snapshots<a class="headerlink" href="#snapshots" title="Permalink to this headline">¶</a></h4>
<p>Snapshots of the current indices can be taken and stored in a designated repository for archival purposes. Currently, you’ll need to add something like the following to <code class="docutils literal notranslate"><span class="pre">/etc/elasticsearch/elasticsearch.yml</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">path</span><span class="o">.</span><span class="n">repo</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">your</span> <span class="n">file</span> <span class="n">path</span> <span class="n">here</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>keeping in mind that the above file path is relative to the container’s view of the filesystem.</p>
<p>So, if you decided to add a <code class="docutils literal notranslate"><span class="pre">path.repo</span></code> value of <code class="docutils literal notranslate"><span class="pre">/backups</span></code>, Elasticsearch would be looking for the file path <code class="docutils literal notranslate"><span class="pre">/backups</span></code> inside of the container. To achieve parity with what is present on the host’s filesystem and make that directory accessible to the Elasticsearch Docker container, you’ll want to add something like the following to ELASTICSEARCH_OPTIONS in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ELASTICSEARCH_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-v /backups:/backups&quot;</span>
</pre></div>
</div>
<p>(where <code class="docutils literal notranslate"><span class="pre">/backups</span></code> exists on the host file system and is writable by the Elasticsearch user – a directory named <code class="docutils literal notranslate"><span class="pre">/backups</span></code> will be created inside the container, and the container will be able to read/write from that location).</p>
<p>To automate the snapshotting process, you can use <a class="reference external" href="Curator">Curator</a>, in conjunction with a cron job, much like what is done today with the close and delete jobs.</p>
</div>
</div>
<span id="document-logstash"></span><div class="section" id="logstash">
<h3>Logstash<a class="headerlink" href="#logstash" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://www.elastic.co/products/logstash">https://www.elastic.co/products/logstash</a> :</p>
<blockquote>
<div>Logstash is an open source, server-side data processing pipeline
that ingests data from a multitude of sources simultaneously,
transforms it, and then sends it to your favorite “stash”.</div></blockquote>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<div class="section" id="pipeline-workers">
<h5>pipeline.workers<a class="headerlink" href="#pipeline-workers" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>The number of workers that will, in parallel, execute the filter and
output stages of the pipeline. If you find that events are backing
up, or that the CPU is not saturated, consider increasing this
number to better utilize machine processing power.</div></blockquote>
<p><a class="reference external" href="https://www.elastic.co/guide/en/logstash/current/logstash-settings-file.html">https://www.elastic.co/guide/en/logstash/current/logstash-settings-file.html</a></p>
<p>This setting can be adjusted in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/logstash.yml</span></code>.</p>
</div>
<div class="section" id="logstash-heap">
<h5>Logstash Heap<a class="headerlink" href="#logstash-heap" title="Permalink to this headline">¶</a></h5>
<p>By default, if total available memory is 8GB or greater, the Logstash heap size in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/jvm.options</span></code> is configured (during setup) to equal 25% of available memory, but no greater than 4GB.</p>
<p>See
<a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/guide/current/heap-sizing.html#compressed_oops">https://www.elastic.co/guide/en/elasticsearch/guide/current/heap-sizing.html#compressed_oops</a>
for more details.</p>
<p>You may need to adjust the value depending on your system’s performance (running <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">so-logstash-restart</span></code> after).</p>
</div>
</div>
<div class="section" id="adding-new-logs-or-modifying-existing-parsing">
<h4>Adding New Logs or Modifying Existing Parsing<a class="headerlink" href="#adding-new-logs-or-modifying-existing-parsing" title="Permalink to this headline">¶</a></h4>
<div class="section" id="syslog-ng">
<h5>Syslog-NG<a class="headerlink" href="#syslog-ng" title="Permalink to this headline">¶</a></h5>
<p>If you are parsing local log files, you may need to add these files to the Syslog-NG configuration in <code class="docutils literal notranslate"><span class="pre">/etc/syslog-ng/syslog-ng.conf</span></code> and restart the service.</p>
</div>
<div class="section" id="parsing">
<h5>Parsing<a class="headerlink" href="#parsing" title="Permalink to this headline">¶</a></h5>
<p>Configuration files for custom parsing can be placed in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/custom</span></code>. These will automatically get copied over to <code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d</span></code> during the starting of Logstash.</p>
<p>After adding your custom configuration file(s), restart Logstash and check the log(s) for errors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">logstash</span><span class="o">-</span><span class="n">restart</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">logstash</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
</div>
<div class="section" id="mapping-templates">
<h5>Mapping Templates<a class="headerlink" href="#mapping-templates" title="Permalink to this headline">¶</a></h5>
<p>Logstash loads default mapping templates for Elasticsearch to use from <code class="docutils literal notranslate"><span class="pre">/etc/logstash</span></code>.</p>
<p>The three templates currently being used include:</p>
<p><code class="docutils literal notranslate"><span class="pre">logstash-template.json</span></code> - applies to <code class="docutils literal notranslate"><span class="pre">logstash-*</span></code> indices</p>
<p><code class="docutils literal notranslate"><span class="pre">logstash-ossec-template.json</span></code> - applies to <code class="docutils literal notranslate"><span class="pre">logstash-ossec-*</span></code> indices</p>
<p><code class="docutils literal notranslate"><span class="pre">beats-template.json</span></code> - applies to <code class="docutils literal notranslate"><span class="pre">logstash-beats-*</span></code> indices</p>
<p>Currently, new fields that do not match the template are stored in Elasticsearch, however, they are not indexed, unless provided in a mapping template.</p>
<p>If sending in custom logs to Security Onion that may not match existing fields for existing indices, it is recommended to create a dedicated index for the log source, as well as define a mapping template and output file for the custom log source.</p>
<p>To make sure Logstash can read the custom template:</p>
<ol class="arabic simple">
<li>Place the template in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/custom</span></code>.</li>
<li>Make sure the template is added to <code class="docutils literal notranslate"><span class="pre">LOGSTASH_OPTIONS</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code>:
<code class="docutils literal notranslate"><span class="pre">LOGSTASH_OPTIONS=&quot;--volume</span> <span class="pre">/etc/logstash/testme-template.json:/testme-template.json:ro&quot;</span></code></li>
<li>Make sure the custom template is referenced in the appropriate output file (place the output file in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/custom</span></code>, then modify it.).</li>
<li>Restart Logstash.</li>
</ol>
<p>You can check to see if templates are loaded by typing something like the following at a command prompt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">template</span><span class="o">-</span><span class="nb">list</span>
</pre></div>
</div>
<p>You can also test the template before restarting Logstash, by using the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">template</span><span class="o">-</span><span class="n">add</span>
</pre></div>
</div>
<p>If mappings defined in the template are different than in existing indices, you will receive mapping conflicts in Kibana.</p>
<p>To avoid this, either remove the existing indices, wiping all data, or <a class="reference external" href="re‐indexing.html">re-index</a>.</p>
</div>
<div class="section" id="logging">
<h5>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h5>
<p>Log file settings can be adjusted in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/log4j2.properties</span></code>. Currently, logs are set to rollover daily, and configured to be deleted after 7 days.</p>
</div>
<div class="section" id="options">
<h5>Options<a class="headerlink" href="#options" title="Permalink to this headline">¶</a></h5>
<p>You can specify your own custom options to be appended to the Logstash startup command, by editing <code class="docutils literal notranslate"><span class="pre">LOGSTASH_OPTIONS</span></code> in
<code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code>.</p>
</div>
</div>
<div class="section" id="queue">
<h4>Queue<a class="headerlink" href="#queue" title="Permalink to this headline">¶</a></h4>
<div class="section" id="memory-backed">
<h5>Memory-backed<a class="headerlink" href="#memory-backed" title="Permalink to this headline">¶</a></h5>
<p>From:
<a class="reference external" href="https://www.elastic.co/guide/en/logstash/current/persistent-queues.html">https://www.elastic.co/guide/en/logstash/current/persistent-queues.html</a></p>
<blockquote>
<div>By default, Logstash uses in-memory bounded queues between pipeline
stages (inputs → pipeline workers) to buffer events. The size of
these in-memory queues is fixed and not configurable.</div></blockquote>
</div>
<div class="section" id="persistent">
<h5>Persistent<a class="headerlink" href="#persistent" title="Permalink to this headline">¶</a></h5>
<p>From:
<a class="reference external" href="https://www.elastic.co/guide/en/logstash/current/persistent-queues.html">https://www.elastic.co/guide/en/logstash/current/persistent-queues.html</a></p>
<blockquote>
<div>In order to protect against data loss during abnormal termination,
Logstash has a persistent queue feature which will store the
message queue on disk. Persistent queues provide durability of data
within Logstash.</div></blockquote>
<p>If you experience adverse effects using the default memory-backed queue, you can configure a disk-based persistent queue by un-commenting the following lines in <code class="docutils literal notranslate"><span class="pre">/etc/logstash/logstash.yaml</span></code> and  modifying the values as appropriate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#queue.type: persisted</span>
<span class="c1">#queue.max_bytes: 1gb</span>
</pre></div>
</div>
<p>Then restart Logstash:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">logstash</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">More information:</div>
<div class="line"><a class="reference external" href="https://www.elastic.co/guide/en/logstash/current/persistent-queues.html">https://www.elastic.co/guide/en/logstash/current/persistent-queues.html</a></div>
</div>
</div>
<div class="section" id="queue-max-bytes">
<h5>Queue Max Bytes<a class="headerlink" href="#queue-max-bytes" title="Permalink to this headline">¶</a></h5>
<blockquote>
<div>The total capacity of the queue in number of bytes. Make sure the
capacity of your disk drive is greater than the value &gt;you specify
here. If both queue.max_events and queue.max_bytes are specified,
Logstash uses whichever criteria is reached &gt;first.</div></blockquote>
</div>
<div class="section" id="dead-letter-queue">
<h5>Dead Letter Queue<a class="headerlink" href="#dead-letter-queue" title="Permalink to this headline">¶</a></h5>
<p>If you want to check for dropped events, you can enable the dead letter queue. This will write all records that are not able to make it into Elasticsearch into a sequentially-numbered file (for each start/restart of Logstash).</p>
<p>This can be achieved by adding the following to <code class="docutils literal notranslate"><span class="pre">/etc/logstash/logstash.yml</span></code>:</p>
<p>dead_letter_queue.enable: true</p>
<p>and restarting Logstash:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">logstash</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>The dead letter queue files are located in <code class="docutils literal notranslate"><span class="pre">/nsm/logstash/dead_letter_queue/main/</span></code>.</p>
<div class="line-block">
<div class="line">More information:</div>
<div class="line"><a class="reference external" href="https://www.elastic.co/guide/en/logstash/current/dead-letter-queues.html">https://www.elastic.co/guide/en/logstash/current/dead-letter-queues.html</a></div>
</div>
</div>
<div class="section" id="redis">
<h5>Redis<a class="headerlink" href="#redis" title="Permalink to this headline">¶</a></h5>
<p>When using storage nodes, Logstash on the master server outputs to <a class="reference external" href="Redis">Redis</a> (on the master server). Redis queues events from the Logstash output (on the master) and the Logstash input on the storage node(s) pull(s) from Redis. If you notice new events aren’t making it into Kibana, you may want to first check Logstash on the master, then the redis <a class="reference external" href="Redis#queue">queue</a>.</p>
</div>
</div>
<div class="section" id="data-fields">
<h4>Data Fields<a class="headerlink" href="#data-fields" title="Permalink to this headline">¶</a></h4>
<p>Logstash process Bro logs, syslog, IDS alerts, etc., formatting said data into many different data fields, as described in the <a class="reference external" href="Data-Fields">Data Fields</a> section.</p>
</div>
<div class="section" id="log">
<h4>Log<a class="headerlink" href="#log" title="Permalink to this headline">¶</a></h4>
<p>The Logstash log is located at <code class="docutils literal notranslate"><span class="pre">/var/log/logstash/logstash.log</span></code>.</p>
</div>
<div class="section" id="errors">
<h4>Errors<a class="headerlink" href="#errors" title="Permalink to this headline">¶</a></h4>
<div class="section" id="read-only">
<h5>Read-Only<a class="headerlink" href="#read-only" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">INFO</span> <span class="p">][</span><span class="n">logstash</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">elasticsearch</span><span class="p">]</span> <span class="n">retrying</span> <span class="n">failed</span> <span class="n">action</span> <span class="k">with</span> <span class="n">response</span> <span class="n">code</span><span class="p">:</span> <span class="mi">403</span> <span class="p">({</span><span class="s2">&quot;type&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;cluster_block_exception&quot;</span><span class="p">,</span> <span class="s2">&quot;reason&quot;</span><span class="o">=&gt;</span><span class="s2">&quot;blocked by: [FORBIDDEN/12/index read-only / allow delete (api)];&quot;</span><span class="p">})</span>
</pre></div>
</div>
<p>This error is usually caused by the <code class="docutils literal notranslate"><span class="pre">cluster.routing.allocation.disk.watermark</span></code> (<code class="docutils literal notranslate"><span class="pre">low</span></code>,<code class="docutils literal notranslate"><span class="pre">high</span></code>) being exceeded.</p>
<p>You may want to check <code class="docutils literal notranslate"><span class="pre">/var/log/elasticsearch/&lt;hostname&gt;.log</span></code> to see specifically which indices have been marked as read-only.</p>
<p>Additionally, you can run the following command to allow writing to the affected indices:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">XPUT</span> <span class="o">-</span><span class="n">H</span> <span class="s1">&#39;Content-Type: application/json&#39;</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">9200</span><span class="o">/&lt;</span><span class="n">your_index</span><span class="o">&gt;/</span><span class="n">_settings</span> <span class="o">-</span><span class="n">d</span><span class="s1">&#39;{ &quot;index.blocks.read_only&quot;: false }&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-elastalert"></span><div class="section" id="elastalert">
<h3>ElastAlert<a class="headerlink" href="#elastalert" title="Permalink to this headline">¶</a></h3>
<p>From
<a class="reference external" href="http://elastalert.readthedocs.io/en/latest/elastalert.html#overview">http://elastalert.readthedocs.io/en/latest/elastalert.html#overview</a>:</p>
<blockquote>
<div><p>ElastAlert is a simple framework for alerting on anomalies, spikes,
or other patterns of interest from data in Elasticsearch.</p>
<p>At Yelp, we use Elasticsearch, Logstash and Kibana for managing our
ever increasing amount of data and logs. Kibana is great for
visualizing and querying data, but we quickly realized that it
needed a companion tool for alerting on inconsistencies in our data.
Out of this need, ElastAlert was created. If you have data being
when that data matches certain patterns, ElastAlert is the tool for
you.</p>
</div></blockquote>
<p>ElastAlert runs as a Docker container within Security Onion, queries ElasticSearch, and provides an alerting mechanism with multiple output types, such as Slack, Email, JIRA, OpsGenie, and many more.</p>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<p>ElastAlert rules are stored in <code class="docutils literal notranslate"><span class="pre">/etc/elastalert/rules/</span></code>.</p>
<p>Security Onion’s default ElastAlert rules are configured with an output type of “debug”, which simply outputs all matches queries to a log file, found in <code class="docutils literal notranslate"><span class="pre">/var/log/elastalert/elastalert_stderr.log</span></code>.</p>
<div class="section" id="slack">
<h5>Slack<a class="headerlink" href="#slack" title="Permalink to this headline">¶</a></h5>
<p>To have ElastAlert send alerts to something like Slack, we can simply change the alert type and details for a rule like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span><span class="p">:</span>
<span class="o">-</span> <span class="s2">&quot;slack&quot;</span><span class="p">:</span>
    <span class="n">slack_webhook_url</span><span class="p">:</span> <span class="s2">&quot;https://hooks.slack.com/services/YOUR_WEBHOOK_URI&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="email-internal">
<h5>Email - Internal<a class="headerlink" href="#email-internal" title="Permalink to this headline">¶</a></h5>
<p>To have ElastAlert send to email, we could do something like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span><span class="p">:</span>
<span class="o">-</span> <span class="s2">&quot;email&quot;</span>
<span class="n">email</span><span class="p">:</span>
<span class="o">-</span> <span class="s2">&quot;youremail@yourcompany.com&quot;</span>
<span class="n">smtp_host</span><span class="p">:</span> <span class="s2">&quot;your_company_smtp_server&quot;</span>
<span class="n">smtp_port</span><span class="p">:</span> <span class="mi">25</span>
<span class="n">from_addr</span><span class="p">:</span> <span class="s2">&quot;elastalert@yourcompany.com&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="email-external">
<h5>Email - External<a class="headerlink" href="#email-external" title="Permalink to this headline">¶</a></h5>
<p>If we need to use an external email provider like Gmail, we can add something like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span><span class="p">:</span>
<span class="o">-</span> <span class="s2">&quot;email&quot;</span>
<span class="n">email</span><span class="p">:</span>
<span class="o">-</span> <span class="s2">&quot;youremail@gmail.com&quot;</span>
<span class="n">smtp_host</span><span class="p">:</span> <span class="s2">&quot;smtp.gmail.com&quot;</span>
<span class="n">smtp_port</span><span class="p">:</span> <span class="mi">465</span>
<span class="n">smtp_ssl</span><span class="p">:</span> <span class="n">true</span>
<span class="n">from_addr</span><span class="p">:</span> <span class="s2">&quot;youremail@gmail.com&quot;</span>
<span class="n">smtp_auth_file</span><span class="p">:</span> <span class="s1">&#39;/etc/elastalert/rules/smtp_auth_file.txt&#39;</span>
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">smtp_auth_file.txt</span></code>, add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user</span><span class="p">:</span> <span class="n">youremail</span><span class="nd">@gmail</span><span class="o">.</span><span class="n">com</span>
<span class="n">password</span><span class="p">:</span> <span class="n">yourpassword</span>
</pre></div>
</div>
</div>
<div class="section" id="misp">
<h5>MISP<a class="headerlink" href="#misp" title="Permalink to this headline">¶</a></h5>
<p>See <a class="reference external" href="MISP">MISP</a></p>
</div>
<div class="section" id="thehive">
<h5>TheHive<a class="headerlink" href="#thehive" title="Permalink to this headline">¶</a></h5>
<p>See <a class="reference external" href="hive">TheHive</a></p>
</div>
<div class="section" id="so-elastalert-create">
<h5>so-elastalert-create<a class="headerlink" href="#so-elastalert-create" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">so-elastalert-create</span></code> is a tool created by <a class="reference external" href="https://github.com/bryant-treacle/so-elastalert-create">Bryant Treacle</a> that can be used to help ease the pain of ensuring correct syntax and creating Elastalert rules from scratch. It will walk you through various questions, and eventually output an Elastalert rule file that you can deploy in your environment to start alerting quickly and easily.</p>
</div>
<div class="section" id="so-elastalert-test">
<h5>so-elastalert-test<a class="headerlink" href="#so-elastalert-test" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">so-elastalert-test</span></code> is a wrapper script originally written by Bryant Treacle for ElastAlert’s <code class="docutils literal notranslate"><span class="pre">elastalert-test-rule</span></code> tool.  The script allows you to test an ElastAlert rule and get results immediately. Simply run <code class="docutils literal notranslate"><span class="pre">so-elastalert-test</span></code>, and follow the prompt(s).</p>
<p>Please note, all options available to <code class="docutils literal notranslate"><span class="pre">elastalert-test-rule</span></code> are not yet included with <code class="docutils literal notranslate"><span class="pre">so-elastalert-test</span></code>.</p>
</div>
<div class="section" id="defaults">
<h5>Defaults<a class="headerlink" href="#defaults" title="Permalink to this headline">¶</a></h5>
<p>With Security Onion’s example rules, Elastalert is configured by default to only count the number of hits for a particular match, and will not return the actual log entry for which an alert was generated.</p>
<p>This is governed by the use of <code class="docutils literal notranslate"><span class="pre">use_count_query:</span> <span class="pre">true</span></code> in each rule file.</p>
<p>If you would like to view the data for the match, you can simply remark this line in the rule file(s). Keep in mind, this may impact performance negatively, so testing the change in a single file at a time may be the best approach.</p>
</div>
<div class="section" id="timeframe">
<h5>Timeframe<a class="headerlink" href="#timeframe" title="Permalink to this headline">¶</a></h5>
<p>Keep in mind, for queries that span greater than a minute back in time, you may want to add the following fields to your rule to ensure searching occurs as planned (for example, for 10 minutes):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">buffer_time</span><span class="p">:</span>
    <span class="n">minutes</span><span class="p">:</span> <span class="mi">10</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">allow_buffer_time_overlap:</span> <span class="pre">true</span></code></p>
<div class="line-block">
<div class="line"><a class="reference external" href="https://elastalert.readthedocs.io/en/latest/ruletypes.html#buffer-time">https://elastalert.readthedocs.io/en/latest/ruletypes.html#buffer-time</a></div>
<div class="line"><a class="reference external" href="https://github.com/Yelp/elastalert/issues/805">https://github.com/Yelp/elastalert/issues/805</a></div>
</div>
</div>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">You can learn more about ElastAlert and its output types here:</div>
<div class="line"><a class="reference external" href="http://elastalert.readthedocs.io/en/latest/">http://elastalert.readthedocs.io/en/latest/</a></div>
</div>
</div>
</div>
<span id="document-curator"></span><div class="section" id="curator">
<h3>Curator<a class="headerlink" href="#curator" title="Permalink to this headline">¶</a></h3>
<p>From:
<a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/about.html#about">https://www.elastic.co/guide/en/elasticsearch/client/curator/current/about.html#about</a></p>
<blockquote>
<div><p>Elasticsearch Curator helps you curate, or manage, your
Elasticsearch indices and snapshots by:</p>
<ol class="arabic simple">
<li>Obtaining the full list of indices (or snapshots) from the
cluster, as the actionable list</li>
<li>Iterate through a list of user-defined filters to progressively
remove indices (or snapshots) from this actionable list
as needed.</li>
<li>Perform various actions on the items which remain in the
actionable list.</li>
</ol>
</div></blockquote>
<p>Curator runs as a Docker container within Security Onion. It runs every
minute and is controlled by cron jobs defined in <code class="docutils literal notranslate"><span class="pre">/etc/cron.d/</span></code>. When
Curator completes an action, it logs such activity in a log file found
in <code class="docutils literal notranslate"><span class="pre">/var/log/curator/curator.log</span></code>.</p>
<p>Curator defaults to closing indices older than 30 days. To modify this,
change <code class="docutils literal notranslate"><span class="pre">CURATOR_CLOSE_DAYS</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code>.</p>
<p>As your disk reaches capacity, Curator starts deleting old indices to
prevent your disk from filling up. To change the limit, modify
<code class="docutils literal notranslate"><span class="pre">LOG_SIZE_LIMIT</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code>.</p>
<div class="section" id="actions">
<h4>Actions<a class="headerlink" href="#actions" title="Permalink to this headline">¶</a></h4>
<p>Curator <code class="docutils literal notranslate"><span class="pre">actions</span></code> are stored in <code class="docutils literal notranslate"><span class="pre">/etc/curator/actions</span></code>. These
actions are run every minute from the cron jobs located in
<code class="docutils literal notranslate"><span class="pre">/etc/cron.d/curator-*</span></code>.</p>
<p>If you would like to add a new action, you can certainly do so, and add
another cron job in <code class="docutils literal notranslate"><span class="pre">/etc/cron.d</span></code> to automate the process.</p>
<p>For example, a new process for snapshotting would require a new action
file, Elasticsearch configuration, and a cron job to automate it all:</p>
<ul class="simple">
<li><a class="reference external" href="Elasticsearch#snapshots">Elasticsearch#snapshots</a></li>
<li><a class="reference external" href="https://www.elastic.co/guide/en/elasticsearch/client/curator/current/snapshot.html">https://www.elastic.co/guide/en/elasticsearch/client/curator/current/snapshot.html</a></li>
</ul>
</div>
</div>
<span id="document-freqserver"></span><div class="section" id="freqserver">
<h3>FreqServer<a class="headerlink" href="#freqserver" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">FreqServer is based on freq.py and freq_server.py (originally created
by Mark Baggett).</div>
<div class="line">Thanks to Justin Henderson for all his work with the FreqServer docker
image!</div>
</div>
<p>From <a class="reference external" href="https://github.com/sans-blue-team/freq.py">https://github.com/sans-blue-team/freq.py</a>:</p>
<blockquote>
<div>Mark Baggett’s (&#64;MarkBaggett - GSE #15, SANS SEC573 Author)
Awesome-Sauce tool for detecting randomness using NLP techniques
rather than pure entropy calculations. Uses character pair frequency
analysis to determine the likelihood of tested strings of characters
occurring based upon the chosen frequency tables (some prebuilt
English text freq tables provided). Extremely useful for detecting
high entropy where it shouldn’t be. Especially powerful for
discovering DNS based DGAs commonly used for malware C2 and
exfiltration. Think bigger than DGAs though. Random file names,
script names, process names, service names, workstation names, TLS
certificate subjects and issuer subjects, etc.</div></blockquote>
<p>From
<a class="reference external" href="https://isc.sans.edu/forums/diary/Continuous+Monitoring+for+Random+Strings/20451/">https://isc.sans.edu/forums/diary/Continuous+Monitoring+for+Random+Strings/20451/</a></p>
<blockquote>
<div>Freq_server.py is a multithreaded web based API that will allow you
to quickly query your frequency tables. The server isn’t intended to
replace freq.py. Instead, after building a frequency table of normal
strings in your environment with freq.py, you start a server up to
allow services to measure various strings against that table. You
can run multiple servers to provide access to different frequency
tables.</div></blockquote>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">For information how to modify configuration for FreqServer, consult
the following:</div>
<div class="line"><a class="reference external" href="https://github.com/SMAPPER/docker_freq_server">https://github.com/SMAPPER/docker_freq_server</a></div>
</div>
<div class="line-block">
<div class="line">FreqServer is disabled by default when running <code class="docutils literal notranslate"><span class="pre">Production</span> <span class="pre">Mode</span></code>
with <code class="docutils literal notranslate"><span class="pre">Best</span> <span class="pre">Practices</span></code>.</div>
<div class="line">You can enable it by doing the following:</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s/FREQ_SERVER_ENABLED=&quot;no&quot;/FREQ_SERVER_ENABLED=&quot;yes&quot;/&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">securityonion</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">start</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">logstash</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>FreqServer’s logs can be found in <code class="docutils literal notranslate"><span class="pre">/var/log/freq_server/</span></code>.</p>
</div>
<div class="section" id="kibana">
<h4>Kibana<a class="headerlink" href="#kibana" title="Permalink to this headline">¶</a></h4>
<p>You can find FreqServer data on the Frequency Analysis dashboard.</p>
</div>
<div class="section" id="dns-highest-registered-domain-frequency-analysis">
<h4>DNS Highest Registered Domain Frequency Analysis<a class="headerlink" href="#dns-highest-registered-domain-frequency-analysis" title="Permalink to this headline">¶</a></h4>
<p><img alt="freq1-dns" src="https://user-images.githubusercontent.com/1659467/30856300-e60be17a-a285-11e7-87fc-acc27665cd7e.PNG" /></p>
</div>
<div class="section" id="dns-parent-domain-frequency-analysis">
<h4>DNS Parent Domain Frequency Analysis<a class="headerlink" href="#dns-parent-domain-frequency-analysis" title="Permalink to this headline">¶</a></h4>
<p><img alt="freq2-dns" src="https://user-images.githubusercontent.com/1659467/30856292-e5d0b186-a285-11e7-875e-7e55c4684507.PNG" /></p>
</div>
<div class="section" id="http-frequency-analysis">
<h4>HTTP Frequency Analysis<a class="headerlink" href="#http-frequency-analysis" title="Permalink to this headline">¶</a></h4>
<p><img alt="freq3-http" src="https://user-images.githubusercontent.com/1659467/30856293-e5d0d47c-a285-11e7-8c91-af45cab8276e.PNG" /></p>
</div>
<div class="section" id="ssl-certificate-common-name-frequency-analysis">
<h4>SSL Certificate Common Name Frequency Analysis<a class="headerlink" href="#ssl-certificate-common-name-frequency-analysis" title="Permalink to this headline">¶</a></h4>
<p><img alt="freq4-ssl" src="https://user-images.githubusercontent.com/1659467/30856295-e5d1014a-a285-11e7-9dd4-19a2844dc824.PNG" /></p>
</div>
<div class="section" id="ssl-certificate-server-name-frequency-analysis">
<h4>SSL Certificate Server Name Frequency Analysis<a class="headerlink" href="#ssl-certificate-server-name-frequency-analysis" title="Permalink to this headline">¶</a></h4>
<p><img alt="freq5-ssl" src="https://user-images.githubusercontent.com/1659467/30856296-e5d1f320-a285-11e7-8892-86f6a0f599f1.PNG" /></p>
</div>
<div class="section" id="ssl-certificate-issuer-name-frequency-analysis">
<h4>SSL Certificate Issuer Name Frequency Analysis<a class="headerlink" href="#ssl-certificate-issuer-name-frequency-analysis" title="Permalink to this headline">¶</a></h4>
<p><img alt="freq6-ssl" src="https://user-images.githubusercontent.com/1659467/30856294-e5d0dd0a-a285-11e7-8186-179e52c49383.PNG" /></p>
</div>
<div class="section" id="x-509-certificate-common-name-frequency-analysis">
<h4>X.509 Certificate Common Name Frequency Analysis<a class="headerlink" href="#x-509-certificate-common-name-frequency-analysis" title="Permalink to this headline">¶</a></h4>
<p><img alt="freq7-x509" src="https://user-images.githubusercontent.com/1659467/30856297-e5e2bbc4-a285-11e7-9cc4-87781d3d7768.PNG" /></p>
</div>
<div class="section" id="x-509-certificate-issuer-organization-frequency-analysis">
<h4>X.509 Certificate Issuer Organization Frequency Analysis<a class="headerlink" href="#x-509-certificate-issuer-organization-frequency-analysis" title="Permalink to this headline">¶</a></h4>
<p><img alt="freq8-x509" src="https://user-images.githubusercontent.com/1659467/30856299-e5e41500-a285-11e7-937b-dda97690c386.PNG" /></p>
</div>
<div class="section" id="x-509-certificate-issuer-frequency-analysis">
<h4>X.509 Certificate Issuer Frequency Analysis<a class="headerlink" href="#x-509-certificate-issuer-frequency-analysis" title="Permalink to this headline">¶</a></h4>
<p><img alt="freq9-x509" src="https://user-images.githubusercontent.com/1659467/30856298-e5e2f9f4-a285-11e7-9c95-b24f44199701.PNG" /></p>
</div>
</div>
<span id="document-domainstats"></span><div class="section" id="domainstats">
<h3>DomainStats<a class="headerlink" href="#domainstats" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">DomainStats is based on Mark Baggett’s domain_stats.py, found at
<a class="reference external" href="https://github.com/MarkBaggett/domain_stats">https://github.com/MarkBaggett/domain_stats</a>.</div>
<div class="line">Thanks to Justin Henderson for all his work with the DomainStats
docker image!</div>
</div>
<p>From <a class="reference external" href="https://github.com/SMAPPER/docker_domain_stats">https://github.com/SMAPPER/docker_domain_stats</a>:</p>
<blockquote>
<div><p>This docker image runs domain_stats.py. This is a python service
that is designed to perform mass domain analysis. It can do things
such as find the creation_date of a domain and identify if a domain
is a member of the Alexa/Cisco Umbrella top 1 million sites.</p>
<p>It was developed to be used in conjunction with a SIEM and is in
production environments. Specifically, it has been used in
conjunction with the Elastic Stack, such as queried by Logstash,
with large success.</p>
</div></blockquote>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<div class="section" id="internet-access">
<h5>Internet Access<a class="headerlink" href="#internet-access" title="Permalink to this headline">¶</a></h5>
<p>DomainStats does whois lookups so it needs to connect outbound on port
43 to whois servers on the Internet. If this traffic is not allowed
through your firewall, then whois lookups will hang causing DomainStats
to hang. This results in the logstash pipeline backing up and Kibana
showing no data. In the current release, Setup will automatically
disable DomainStats if whois lookups fail.</p>
</div>
<div class="section" id="enabling-domainstats">
<h5>Enabling DomainStats<a class="headerlink" href="#enabling-domainstats" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">DomainStats is disabled by default when running <code class="docutils literal notranslate"><span class="pre">Production</span> <span class="pre">Mode</span></code>
with <code class="docutils literal notranslate"><span class="pre">Best</span> <span class="pre">Practices</span></code>.</div>
<div class="line">You can enable it by doing the following:</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s/DOMAIN_STATS_ENABLED=&quot;no&quot;/DOMAIN_STATS_ENABLED=&quot;yes&quot;/&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">securityonion</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">start</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">logstash</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="updating-top-1m-file">
<h5>Updating Top-1m file<a class="headerlink" href="#updating-top-1m-file" title="Permalink to this headline">¶</a></h5>
<p>From <a class="reference external" href="https://github.com/SMAPPER/docker_domain_stats#updating-top-1m-file">https://github.com/SMAPPER/docker_domain_stats#updating-top-1m-file</a>:</p>
<blockquote>
<div>The docker image does not currently automatically update the
top-1m.csv. The below example shows how to download a new top 1
million site list and have a domain_stats container use it. This
could be scheduled as a cron job on your host to keep a current
Alexa/Cisco Umbrella top-1m.csv in use.</div></blockquote>
<p>(Slightly modified for Security Onion)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#/etc/cron.d/domainstats</span>
<span class="c1">#</span>
<span class="c1">#crontab entry to grab new Top 1m CSV for DomainStats Docker image</span>
<span class="n">SHELL</span><span class="o">=/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span>
<span class="n">PATH</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">localbin</span><span class="p">:</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span>
<span class="mi">1</span> <span class="mi">07</span> <span class="o">*</span> <span class="o">*</span> <span class="o">*</span>   <span class="n">root</span> <span class="p">(</span> <span class="n">wget</span> <span class="o">-</span><span class="n">q</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">s3</span><span class="o">.</span><span class="n">amazonaws</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">alexa</span><span class="o">-</span><span class="n">static</span><span class="o">/</span><span class="n">top</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">zip</span> <span class="o">-</span><span class="n">O</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">top</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">zip</span> <span class="o">&amp;&amp;</span> <span class="n">unzip</span> <span class="o">-</span><span class="n">o</span>
<span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">top</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">csv</span><span class="o">.</span><span class="n">zip</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">tmp</span> <span class="o">&amp;&amp;</span> <span class="n">docker</span> <span class="n">cp</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">top</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">csv</span> <span class="n">so</span><span class="o">-</span><span class="n">domainstats</span><span class="p">:</span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">domain_stats</span><span class="o">/</span><span class="n">top</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">csv</span> <span class="o">&amp;&amp;</span> <span class="n">docker</span> <span class="n">restart</span>
<span class="n">so</span><span class="o">-</span><span class="n">domainstats</span> <span class="o">&amp;&amp;</span> <span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">top</span><span class="o">-</span><span class="mi">1</span><span class="n">m</span><span class="o">.</span><span class="n">csv</span><span class="o">*</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">For information how to modify configuration for DomainStats, consult the following:</div>
<div class="line"><a class="reference external" href="https://github.com/SMAPPER/docker_domain_stats">https://github.com/SMAPPER/docker_domain_stats</a></div>
</div>
<p>DomainStats logs can be found in <code class="docutils literal notranslate"><span class="pre">/var/log/domain_stats/</span></code>.</p>
</div>
</div>
<div class="section" id="kibana">
<h4>Kibana<a class="headerlink" href="#kibana" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">You can find DomainStats data by going to the Domain Stats dashboard in Kibana:</div>
<div class="line"><img alt="domain1-dns" src="https://user-images.githubusercontent.com/1659467/30856291-e5c2d8e0-a285-11e7-9230-36c190329be7.PNG" /></div>
</div>
</div>
</div>
<span id="document-docker"></span><div class="section" id="docker">
<h3>Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://www.docker.com/what-docker">https://www.docker.com/what-docker</a>:</p>
<blockquote>
<div>Docker is the world’s leading software container platform.
Developers use Docker to eliminate “works on my machine” problems
when collaborating on code with co-workers. Operators use Docker to
run and manage apps side-by-side in isolated containers to get
better compute density. Enterprises use Docker to build agile
software delivery pipelines to ship new features faster, more
securely and with confidence for both Linux, Windows Server, and
Linux-on-mainframe apps.</div></blockquote>
<div class="section" id="images">
<h4>Images<a class="headerlink" href="#images" title="Permalink to this headline">¶</a></h4>
<p>To maintain a high level of stability, reliability, and support, our Elastic Docker images are based on the Docker images provided by Elastic.co. Their Docker images are built on CentOS 7:
<a class="reference external" href="https://www.elastic.co/blog/docker-base-centos7">https://www.elastic.co/blog/docker-base-centos7</a></p>
<p>To leverage a common core OS layer, all of our Docker images are then built on CentOS 7.</p>
</div>
<div class="section" id="registry">
<h4>Registry<a class="headerlink" href="#registry" title="Permalink to this headline">¶</a></h4>
<p>From <a class="reference external" href="https://docs.docker.com/registry/recipes/mirror/">https://docs.docker.com/registry/recipes/mirror/</a>:</p>
<blockquote>
<div>If you have multiple instances of Docker running in your environment
(e.g., multiple physical or virtual machines, all running the Docker
daemon), each time one of them requires an image that it doesn’t
have it will go out to the internet and fetch it from the public
Docker registry. By running a local registry mirror, you can keep
most of the redundant image fetch traffic on your local network.</div></blockquote>
<p>We can leverage the Docker registry (as a <a class="reference external" href="https://docs.docker.com/registry/recipes/mirror/">pull-through cache</a>) with our Security Onion Docker images. As mentioned above, this will allow us to cut down on external requests and bandwidth, cache the images on a local server, and only pull new images when they are available.</p>
<p>We can easily configure our Security Onion master server and sensor by running the following script on each machine (watch out for line-wrapping) :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">weslambert</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">registry</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">so</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">registry</span>
<span class="n">sudo</span> <span class="n">bash</span> <span class="n">so</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">registry</span>
</pre></div>
</div>
<p>The above script:</p>
<ul class="simple">
<li>Sets up a Docker container named <code class="docutils literal notranslate"><span class="pre">docker-registry</span></code> on the master server - this container exposes port 5000 for 127.0.0.1 (only locally).</li>
<li>Configures the master server to use the <code class="docutils literal notranslate"><span class="pre">docker-registry</span></code> container as its proxy to pull images (<code class="docutils literal notranslate"><span class="pre">registry-mirror</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/default/docker</span></code>).</li>
<li>Configures a sensor to use to <code class="docutils literal notranslate"><span class="pre">docker-registry</span></code> on the master server as a proxy to pull images – this is done through the addition of a local port forward (5000) through the existing autossh tunnel (<code class="docutils literal notranslate"><span class="pre">/root/.ssh/securityonion_ssh.conf</span></code>), and setting the <code class="docutils literal notranslate"><span class="pre">registry-mirror</span></code> value for the docker client on the sensor (<code class="docutils literal notranslate"><span class="pre">/etc/default/docker</span></code>)</li>
<li>Restarts Security Onion Docker containers so the latest images are cached on the master and pulled to the sensor.</li>
</ul>
<p>After the script has completed (after running on both machines), the newest images from the <code class="docutils literal notranslate"><span class="pre">securityonionsolutions</span></code> repo should be locally cached on the master, and already pulled to the sensor.</p>
<p>We can check this by running the following from the master (or sensor):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">localhost</span><span class="p">:</span><span class="mi">5000</span><span class="o">/</span><span class="n">v2</span><span class="o">/</span><span class="n">_catalog</span>
</pre></div>
</div>
<p>From here on, whenever <code class="docutils literal notranslate"><span class="pre">soup</span></code> checks for new images, it will pull them from the master server instead of Docker Hub.</p>
</div>
<div class="section" id="sneakernet-updates">
<h4>Sneakernet Updates<a class="headerlink" href="#sneakernet-updates" title="Permalink to this headline">¶</a></h4>
<p>If we need to perform offline updates of Docker images, we can do so by cloning the <code class="docutils literal notranslate"><span class="pre">security-onion-docker-airgap</span></code> script(s) at <a class="reference external" href="https://github.com/weslambert/securityonion-docker-airgap">https://github.com/weslambert/securityonion-docker-airgap</a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">weslambert</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">airgap</span>
<span class="n">cd</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">airgap</span>
</pre></div>
</div>
<p>The script(s) should be run first on a machine with internet access – Docker images will be downloaded and saved to a single <code class="docutils literal notranslate"><span class="pre">images.tar</span></code> file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">./</span><span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">airgap</span>
</pre></div>
</div>
<p>Choose the <code class="docutils literal notranslate"><span class="pre">Save</span></code> option.</p>
<p>From there, the <code class="docutils literal notranslate"><span class="pre">securityonion-docker-airgap</span></code> directory (including the <code class="docutils literal notranslate"><span class="pre">images.tar</span></code> file) should be copied to the destination machine.</p>
<p>Once there, change into the <code class="docutils literal notranslate"><span class="pre">securityonion-docker-airgap</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">docker</span><span class="o">-</span><span class="n">airgap</span>
</pre></div>
</div>
<p>Run the <code class="docutils literal notranslate"><span class="pre">so-elastic-airgap</span></code> script, and choose the <code class="docutils literal notranslate"><span class="pre">Load</span></code> option.</p>
<p>The Docker images should now be loaded. We can verify this by running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">docker</span> <span class="n">images</span>
</pre></div>
</div>
</div>
<div class="section" id="networking">
<h4>Networking<a class="headerlink" href="#networking" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="bridge">
<h4>Bridge<a class="headerlink" href="#bridge" title="Permalink to this headline">¶</a></h4>
<p>By default, Docker configures it’s bridge with an IP of <code class="docutils literal notranslate"><span class="pre">172.17.0.1</span></code>.</p>
<p><a class="reference external" href="https://docs.docker.com/engine/userguide/networking/#default-networks">https://docs.docker.com/engine/userguide/networking/#default-networks</a></p>
<p>For many folks this is fine, but what if we actually use the the <code class="docutils literal notranslate"><span class="pre">172.17.0.0/16</span></code> range within our internal network(s)?  This results in a <strong>conflict</strong> when trying to assign IP addresses to interfaces and trying to route outside of the host.</p>
<p>A simple solution to this is to do the following:</p>
<div class="line-block">
<div class="line">Create the following file - <code class="docutils literal notranslate"><span class="pre">/etc/docker/daemon.json</span></code>.</div>
<div class="line">Inside of the file, place the following:</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;bip&quot;</span><span class="p">:</span> <span class="s2">&quot;your_docker_bridge_ip/netmask&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Restart Docker:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">docker</span> <span class="n">restart</span>
</pre></div>
</div>
<p>Running <code class="docutils literal notranslate"><span class="pre">netstat</span> <span class="pre">-rn</span></code> should show that the range for the <code class="docutils literal notranslate"><span class="pre">docker0</span></code> bridge has changed.</p>
<div class="line-block">
<div class="line">For more information/options, see:</div>
<div class="line"><a class="reference external" href="https://docs.docker.com/engine/userguide/networking/default_network/custom-docker0/">https://docs.docker.com/engine/userguide/networking/default_network/custom-docker0/</a></div>
</div>
</div>
<div class="section" id="containers">
<h4>Containers<a class="headerlink" href="#containers" title="Permalink to this headline">¶</a></h4>
<p>Our Docker containers all belong to a common Docker bridge network, called <code class="docutils literal notranslate"><span class="pre">so-elastic-net</span></code>. Each container is also aliased, so that communication can occur between the different docker containers using said alias. For example, communication to the <code class="docutils literal notranslate"><span class="pre">so-elasticsearch</span></code> container would occur through an alias of <code class="docutils literal notranslate"><span class="pre">elasticsearch</span></code>.</p>
<p>You may come across interfaces in <code class="docutils literal notranslate"><span class="pre">ifconfig</span></code> with the format <code class="docutils literal notranslate"><span class="pre">veth*</span></code>. These are the external interfaces for each of the Docker containers. These interfaces correspond to internal Docker container interfaces (within the Docker container itself).</p>
<p>To identify which external interface belongs to which container, we can do something like the following:</p>
<p>From the host, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">docker</span> <span class="n">exec</span> <span class="n">so</span><span class="o">-</span><span class="n">elasticsearch</span> <span class="n">cat</span> <span class="o">/</span><span class="n">sys</span><span class="o">/</span><span class="n">class</span><span class="o">/</span><span class="n">net</span><span class="o">/</span><span class="n">eth0</span><span class="o">/</span><span class="n">iflink</span>
</pre></div>
</div>
<p>This should provide you with a value with which you can grep the host <code class="docutils literal notranslate"><span class="pre">net</span></code> class <code class="docutils literal notranslate"><span class="pre">ifindex(es)</span></code>:</p>
<div class="line-block">
<div class="line"><strong>Example:</strong></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">grep</span> <span class="pre">25</span> <span class="pre">/sys/class/net/veth*/ifindex</span> <span class="pre">|</span> <span class="pre">cut</span> <span class="pre">-d'/'</span> <span class="pre">-f5</span></code></div>
</div>
<p>You should then receive some output similar to the following:</p>
<p><code class="docutils literal notranslate"><span class="pre">vethc5ff027</span></code></p>
<p>where <code class="docutils literal notranslate"><span class="pre">vethc5ff027</span></code> is the external interface of <code class="docutils literal notranslate"><span class="pre">eth0</span></code> within the <code class="docutils literal notranslate"><span class="pre">so-elasticsearch</span></code> container.</p>
</div>
<div class="section" id="download">
<h4>Download<a class="headerlink" href="#download" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Our Docker images are stored on Docker Hub:</div>
<div class="line"><a class="reference external" href="https://hub.docker.com/u/securityonionsolutions/">https://hub.docker.com/u/securityonionsolutions/</a></div>
</div>
<p>If you download our Security Onion ISO image, the Docker engine and these Docker images are baked right into the ISO image.</p>
<p>If you instead use another ISO image, you will install the securityonion-elastic package and will then run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">so-elastic-download</span></code> which will install the Docker engine and then download the Docker images from Docker Hub.</p>
</div>
<div class="section" id="update">
<h4>Update<a class="headerlink" href="#update" title="Permalink to this headline">¶</a></h4>
<p>Our <code class="docutils literal notranslate"><span class="pre">soup</span></code> utility for installing updates now includes support for updating Docker images.</p>
</div>
<div class="section" id="security">
<h4>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">To prevent tampering, our Docker images are signed using Docker Notary:</div>
<div class="line"><a class="reference external" href="https://docs.docker.com/notary/getting_started/">https://docs.docker.com/notary/getting_started/</a></div>
</div>
<p>Any time we push an image to Docker Hub, we explicitly set <code class="docutils literal notranslate"><span class="pre">--disable-content-trust=false</span></code> to sign the image using Docker Notary.</p>
<p>Any time we download an image from Docker Hub, we also explicitly set <code class="docutils literal notranslate"><span class="pre">--disable-content-trust=false</span></code> to verify that signature using Docker Notary.</p>
</div>
<div class="section" id="vmware-tools">
<h4>VMware Tools<a class="headerlink" href="#vmware-tools" title="Permalink to this headline">¶</a></h4>
<p>If you have VMware Tools installed and you suspend and then resume, the Docker interfaces will no longer have IP addresses and the Elastic stack will no longer be able to communicate. One workaround is to remove <code class="docutils literal notranslate"><span class="pre">/etc/vmware-tools/scripts/vmware/network</span></code> to prevent VMware suspend/resume from modifying your network configuration.</p>
</div>
</div>
<span id="document-redis"></span><div class="section" id="redis">
<h3>Redis<a class="headerlink" href="#redis" title="Permalink to this headline">¶</a></h3>
<p>From: <a class="reference external" href="https://redis.io/">https://redis.io/</a></p>
<blockquote>
<div>Redis is an open source (BSD licensed), in-memory data structure
store, used as a database, cache and message broker. It supports
data structures such as strings, hashes, lists, sets, sorted sets
with range queries, bitmaps, hyperloglogs and geospatial indexes
with radius queries. Redis has built-in replication, Lua scripting,
LRU eviction, transactions and different levels of on-disk
persistence, and provides high availability via Redis Sentinel and
automatic partitioning with Redis Cluster.</div></blockquote>
<p>During setup, you can choose to extend your master server storage using
separate storage nodes. When you choose this option, Logstash on the
master server outputs to redis. Storage nodes then consume from redis.</p>
<img alt="https://user-images.githubusercontent.com/16829864/37215984-91a348d4-2387-11e8-8c08-2e270b8fd986.png" src="https://user-images.githubusercontent.com/16829864/37215984-91a348d4-2387-11e8-8c08-2e270b8fd986.png" />
<div class="section" id="queue">
<h4>Queue<a class="headerlink" href="#queue" title="Permalink to this headline">¶</a></h4>
<p>To see how many logs are in the redis queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">redis</span><span class="o">-</span><span class="n">cli</span> <span class="n">LLEN</span> <span class="n">logstash</span><span class="p">:</span><span class="n">redis</span>
</pre></div>
</div>
<p>If the queue is backed up and doesn’t seem to be draining, try stopping
Logstash on the master server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">docker</span> <span class="n">stop</span> <span class="n">so</span><span class="o">-</span><span class="n">logstash</span>
</pre></div>
</div>
<p>Then monitor the queue to see if it drains:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">watch</span> <span class="s1">&#39;redis-cli llen logstash:redis&#39;</span>
</pre></div>
</div>
<p>If the Redis queue looks okay, but you are still having issues with logs
getting indexed into Elasticsearch, you will want to check the Logstash
statistics on the storage node(s).</p>
</div>
</div>
<span id="document-data-fields"></span><div class="section" id="data-fields">
<h3>Data Fields<a class="headerlink" href="#data-fields" title="Permalink to this headline">¶</a></h3>
<p>This page references the various types of data fields utilized by
Security Onion on the Elastic Stack.</p>
<p>The various fields types are described below.</p>
<div class="section" id="fields">
<h4>Fields<a class="headerlink" href="#fields" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><a class="reference external" href="Alert-Data-Fields">Alert Data</a></div>
<div class="line"><a class="reference external" href="Bro-Fields">Bro</a></div>
<div class="line"><a class="reference external" href="Elastalert-Fields">Elastalert</a></div>
</div>
</div>
<div class="section" id="template-files">
<h4>Template files<a class="headerlink" href="#template-files" title="Permalink to this headline">¶</a></h4>
<p>Fields are mapped to their proper type using template files, found in
<code class="docutils literal notranslate"><span class="pre">/etc/logstash/</span></code>. The current template files include:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">logstash-template.json</span></code> - mapping information for logs going into
<code class="docutils literal notranslate"><span class="pre">logstash-*</span></code> indices</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">beats-template.json</span></code> - mapping information for logs going into
<code class="docutils literal notranslate"><span class="pre">logstash-beats-*</span></code> indices.</div>
</div>
</div>
</div>
<span id="document-alert-data-fields"></span><div class="section" id="alert-data-fields">
<h3>Alert Data Fields<a class="headerlink" href="#alert-data-fields" title="Permalink to this headline">¶</a></h3>
<p>Below are the fields derived from IDS alerts (Snort/Suricata), after
being processed by Logstash:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:snort</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1033_preprocess_snort.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">alert</div>
<div class="line">category</div>
<div class="line">classification</div>
<div class="line">source_ip</div>
<div class="line">source_port</div>
<div class="line">destination_ip</div>
<div class="line">destination_port</div>
<div class="line">gid</div>
<div class="line">host</div>
<div class="line">priority</div>
<div class="line">protocol</div>
<div class="line">rev</div>
<div class="line">rule (<em>added through augmentation</em>)</div>
<div class="line">rule_type</div>
<div class="line">severity</div>
<div class="line">sid</div>
<div class="line">Signature_Info (<em>added through augmentation</em>)</div>
</div>
</div>
<span id="document-bro-fields"></span><div class="section" id="bro-fields">
<h3>Bro Fields<a class="headerlink" href="#bro-fields" title="Permalink to this headline">¶</a></h3>
<p>The following lists field names as they are formatted in Bro logs, then
processed by Logstash and ingested into Elasticsearch.</p>
<p>The original field name (from Bro) appears on the left, and if changed,
the updated name or formatting of the field (Elasticsearch) will appear
on the right.</p>
<p><strong>(Bro =&gt; Elastic)</strong></p>
<div class="section" id="conn-log">
<h4>conn.log<a class="headerlink" href="#conn-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_conn</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1100_preprocess_bro_conn.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">proto =&gt; protocol</div>
<div class="line">service</div>
<div class="line">duration</div>
<div class="line">orig_bytes =&gt; original_bytes</div>
<div class="line">resp_bytes =&gt; respond_bytes</div>
<div class="line">conn_state =&gt; connection_state =&gt; connection_state_description</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Dictionary</span>
<span class="n">S0</span> <span class="s2">&quot;Connection attempt seen, no reply&quot;</span>
<span class="n">S1</span> <span class="s2">&quot;Connection established, not terminated&quot;</span>
<span class="n">S2</span> <span class="s2">&quot;Connection established and close attempt by originator seen (but no reply from responder)&quot;</span>
<span class="n">S3</span> <span class="s2">&quot;Connection established and close attempt by responder seen (but no reply from originator)&quot;</span>
<span class="n">SF</span> <span class="s2">&quot;Normal SYN/FIN completion&quot;</span>
<span class="n">REJ</span> <span class="s2">&quot;Connection attempt rejected&quot;</span>
<span class="n">RSTO</span> <span class="s2">&quot;Connection established, originator aborted (sent a RST)&quot;</span>
<span class="n">RSTR</span> <span class="s2">&quot;Established, responder aborted&quot;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">local_orig</div>
<div class="line">local_resp =&gt; local_respond</div>
<div class="line">missed_bytes</div>
<div class="line">history</div>
<div class="line">orig_pkts =&gt; original_packets</div>
<div class="line">orig_ip_bytes =&gt; original_ipbytes</div>
<div class="line">resp_pkts =&gt; respond_packets</div>
<div class="line">resp_ip_bytes =&gt; respond_ipbytes</div>
<div class="line">tunnel_parents</div>
<div class="line">original_country_code</div>
<div class="line">respond_country_code</div>
<div class="line">sensor_name</div>
</div>
</div>
<div class="section" id="dhcp-log">
<h4>dhcp.log<a class="headerlink" href="#dhcp-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_dhcp</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1101_preprocess_bro_dhcp.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">mac</div>
<div class="line">assigned_ip</div>
<div class="line">lease_time</div>
<div class="line">trans_id =&gt; transaction_id</div>
</div>
</div>
<div class="section" id="dns-log">
<h4>dns.log<a class="headerlink" href="#dns-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_dns</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1102_preprocess_bro_dns.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts = &gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">proto =&gt; protocol</div>
<div class="line">trans_id =&gt; transaction_id</div>
<div class="line">rtt</div>
<div class="line">query</div>
<div class="line">qclass =&gt; query_class</div>
<div class="line">qclass_name =&gt; query_class_name</div>
<div class="line">qtype =&gt; query_type</div>
<div class="line">qtype_name =&gt; query_type_name</div>
<div class="line">rcode</div>
<div class="line">rcode_name</div>
<div class="line">AA =&gt; aa</div>
<div class="line">TC =&gt; tc</div>
<div class="line">RD =&gt; rd</div>
<div class="line">RA =&gt; ra</div>
<div class="line">Z =&gt; z</div>
<div class="line">answers</div>
<div class="line">TTLS =&gt; ttls (removed if not available)</div>
<div class="line">rejected</div>
</div>
</div>
<div class="section" id="dpd-log">
<h4>dpd.log<a class="headerlink" href="#dpd-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_dpd</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1103_preprocess_bro_dpd.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">proto =&gt; protocol</div>
<div class="line">analyzer</div>
<div class="line">failure_reason</div>
</div>
</div>
<div class="section" id="files-log">
<h4>files.log<a class="headerlink" href="#files-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_files</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1104_preprocess_bro_files.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">fuid</div>
<div class="line">tx_hosts =&gt; file_ip</div>
<div class="line">rx_hosts =&gt; destination_ip</div>
<div class="line">conn_uids =&gt; connection_uids</div>
<div class="line">source</div>
<div class="line">depth</div>
<div class="line">analyzers =&gt; analyzer</div>
<div class="line">mime_type =&gt; mimetype</div>
<div class="line">filename =&gt; file_name</div>
<div class="line">duration</div>
<div class="line">local_orig</div>
<div class="line">is_orig</div>
<div class="line">seen_bytes</div>
<div class="line">total_bytes</div>
<div class="line">missing_bytes</div>
<div class="line">overflow_bytes</div>
<div class="line">timedout =&gt; timed_out</div>
<div class="line">parent_fuid</div>
<div class="line">md5</div>
<div class="line">sha1</div>
<div class="line">sha256</div>
<div class="line">extracted</div>
<div class="line">extracted_cutoff</div>
<div class="line">extracted_size</div>
</div>
</div>
<div class="section" id="ftp-log">
<h4>ftp.log<a class="headerlink" href="#ftp-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_ftp</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1105_preprocess_bro_ftp.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">user =&gt; ftp_username</div>
<div class="line">password</div>
<div class="line">command =&gt; ftp_command</div>
<div class="line">arg =&gt; ftp_argument</div>
<div class="line">mime_type =&gt; mimetype</div>
<div class="line">file_size</div>
<div class="line">reply_code</div>
<div class="line">reply_msg =&gt; reply_message</div>
<div class="line">data_channel.passive =&gt; data_channel_passive</div>
<div class="line">data_channel.orig_h =&gt; data_channel_source_ip</div>
<div class="line">data_channel.resp_h =&gt; data_channel_destination_ip</div>
<div class="line">data_channel.resp_h =&gt; data_channel_destination_port</div>
<div class="line">fuid</div>
</div>
</div>
<div class="section" id="http-log">
<h4>http.log<a class="headerlink" href="#http-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_http</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1106_preprocess_bro_http.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">trans_depth</div>
<div class="line">method</div>
<div class="line">host =&gt; virtual_host</div>
<div class="line">uri</div>
<div class="line">referrer</div>
<div class="line">version</div>
<div class="line">user_agent =&gt; useragent</div>
<div class="line">request_body_len =&gt; request_body_length</div>
<div class="line">response_body_len =&gt; response_body_length</div>
<div class="line">status_code</div>
<div class="line">status_message</div>
<div class="line">info_code</div>
<div class="line">info_msg =&gt; info_message</div>
<div class="line">tags (removed)</div>
<div class="line">username =&gt; user</div>
<div class="line">password</div>
<div class="line">proxied</div>
<div class="line">orig_fuids</div>
<div class="line">orig_filenames</div>
<div class="line">orig_mime_types</div>
<div class="line">resp_fuids</div>
<div class="line">resp_filenames</div>
<div class="line">resp_mime_types</div>
</div>
</div>
<div class="section" id="intel-log">
<h4>intel.log<a class="headerlink" href="#intel-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_intel</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1124_preprocess_bro_intel.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">seen.indicator =&gt; indicator</div>
<div class="line">seen.indicator_type =&gt; indicator_type</div>
<div class="line">seen.where =&gt; seen_where</div>
<div class="line">seen.node =&gt; seen_node</div>
<div class="line">matched</div>
<div class="line">sources</div>
<div class="line">fuid</div>
<div class="line">file_mime_type =&gt; mimetype</div>
<div class="line">file_desc =&gt; file_description</div>
</div>
</div>
<div class="section" id="irc-log">
<h4>irc.log<a class="headerlink" href="#irc-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_irc</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1107_preprocess_bro_irc.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">nick</div>
<div class="line">user =&gt; irc_username</div>
<div class="line">command =&gt; irc_command</div>
<div class="line">value</div>
<div class="line">addl =&gt; additional_info</div>
<div class="line">dcc_file_name</div>
<div class="line">dcc_file_size</div>
<div class="line">dcc_mime_type</div>
<div class="line">fuid</div>
</div>
</div>
<div class="section" id="kerberos-log">
<h4>kerberos.log<a class="headerlink" href="#kerberos-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_kerberos</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1108_preprocess_bro_kerberos.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">request_type</div>
<div class="line">client</div>
<div class="line">service</div>
<div class="line">success =&gt; kerberos_success</div>
<div class="line">error_msg =&gt; error_message</div>
<div class="line">from =&gt; email_from</div>
<div class="line">till =&gt; valid_till</div>
<div class="line">cipher</div>
<div class="line">forwardable</div>
<div class="line">renewable</div>
<div class="line">client_cert =&gt; client_certificate_subject</div>
<div class="line">client_cert_fuid =&gt; client_certificate_uid</div>
<div class="line">server_cert_subject =&gt; server_certificate_subject</div>
<div class="line">server_cert_fuid =&gt; server_certificate_fuid</div>
</div>
</div>
<div class="section" id="modbus-log">
<h4>modbus.log<a class="headerlink" href="#modbus-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_modbus</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1125_preprocess_bro_modbus.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">func =&gt; function</div>
<div class="line">exception</div>
</div>
</div>
<div class="section" id="mysql-log">
<h4>mysql.log<a class="headerlink" href="#mysql-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_mysql</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1121_preprocess_bro_mysql.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">cmd =&gt; mysql_command</div>
<div class="line">arg =&gt; mysql_argument</div>
<div class="line">success =&gt; mysql_success</div>
<div class="line">rows</div>
<div class="line">response</div>
</div>
</div>
<div class="section" id="notice-log">
<h4>notice.log<a class="headerlink" href="#notice-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_notice</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1109_preprocess_bro_notice.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">fuid</div>
<div class="line">mime =&gt; file_mime_type</div>
<div class="line">desc =&gt; file_description</div>
<div class="line">proto =&gt; protocol</div>
<div class="line">note =&gt; note</div>
<div class="line">msg =&gt; msg</div>
<div class="line">sub =&gt; sub_msg</div>
<div class="line">src =&gt; source_ip</div>
<div class="line">dst =&gt; destination_ip</div>
<div class="line">p</div>
<div class="line">n</div>
<div class="line">peer_descr =&gt; peer_description</div>
<div class="line">actions =&gt; action</div>
<div class="line">suppress_for</div>
<div class="line">dropped</div>
<div class="line">destination_country_code</div>
<div class="line">destination_region</div>
<div class="line">destination_city</div>
<div class="line">destination_latitude</div>
<div class="line">destination_longitude</div>
</div>
</div>
<div class="section" id="pe-log">
<h4>pe.log<a class="headerlink" href="#pe-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_pe</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1128_preprocess_bro_pe.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">fuid</div>
<div class="line">machine</div>
<div class="line">compile_ts</div>
<div class="line">os</div>
<div class="line">subsystem</div>
<div class="line">is_exe</div>
<div class="line">is_64bit</div>
<div class="line">uses_aslr</div>
<div class="line">uses_dep</div>
<div class="line">uses_code_integrity</div>
<div class="line">uses_seh</div>
<div class="line">has_import_table</div>
<div class="line">has_export_table</div>
<div class="line">has_cert_table</div>
<div class="line">has_debug_data</div>
<div class="line">section_names</div>
</div>
</div>
<div class="section" id="radius-log">
<h4>radius.log<a class="headerlink" href="#radius-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_radius</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1127_preprocess_bro_radius.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">username =&gt; radius_username</div>
<div class="line">mac</div>
<div class="line">remote_ip</div>
<div class="line">connect_info</div>
<div class="line">result</div>
<div class="line">logged</div>
</div>
</div>
<div class="section" id="rdp-log">
<h4>rdp.log<a class="headerlink" href="#rdp-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_rdp</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1110_preprocess_bro_rdp.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">cookie</div>
<div class="line">result</div>
<div class="line">security_protocol</div>
<div class="line">keyboard_layout</div>
<div class="line">client_build</div>
<div class="line">client_name</div>
<div class="line">client_dig_product_id =&gt; client_digital_product_id</div>
<div class="line">desktop_width</div>
<div class="line">desktop_height</div>
<div class="line">requested_color_depth</div>
<div class="line">cert_type =&gt; certificate_type</div>
<div class="line">cert_count =&gt; certificate_count</div>
<div class="line">cert_permanent =&gt; certificate_permanent</div>
<div class="line">encryption_level</div>
<div class="line">encryption_method</div>
</div>
</div>
<div class="section" id="rfb-log">
<h4>rfb.log<a class="headerlink" href="#rfb-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_rfb</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1129_preprocess_bro_rfb.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">client_major_version</div>
<div class="line">client_minor_version</div>
<div class="line">server_major_version</div>
<div class="line">server_minor_version</div>
<div class="line">authentication_method</div>
<div class="line">auth</div>
<div class="line">share_flag</div>
<div class="line">desktop_name</div>
<div class="line">width</div>
<div class="line">height</div>
</div>
</div>
<div class="section" id="signatures-log">
<h4>signatures.log<a class="headerlink" href="#signatures-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_ssl</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1111_preprocess_bro_signatures.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">note</div>
<div class="line">sig_id =&gt; signature_id</div>
<div class="line">event_msg =&gt; event_message</div>
<div class="line">sub_msg =&gt; sub_message</div>
<div class="line">sig_count =&gt; signature_count</div>
<div class="line">host_count</div>
</div>
</div>
<div class="section" id="sip-log">
<h4>sip.log<a class="headerlink" href="#sip-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_sip</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1126_preprocess_bro_sip.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">trans_depth</div>
<div class="line">method</div>
<div class="line">uri</div>
<div class="line">date</div>
<div class="line">request_from</div>
<div class="line">request_to</div>
<div class="line">response_from</div>
<div class="line">response_to</div>
<div class="line">reply_to</div>
<div class="line">call_id</div>
<div class="line">seq</div>
<div class="line">subject</div>
<div class="line">request_path</div>
<div class="line">response_path</div>
<div class="line">user_agent</div>
<div class="line">status_code</div>
<div class="line">status_msg</div>
<div class="line">warning</div>
<div class="line">request_body_len</div>
<div class="line">response_body_len</div>
<div class="line">content_type</div>
</div>
</div>
<div class="section" id="smtp-log">
<h4>smtp.log<a class="headerlink" href="#smtp-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_smtp</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1112_preprocess_bro_smtp.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">trans_depth</div>
<div class="line">helo</div>
<div class="line">mailfrom =&gt; mail_from</div>
<div class="line">rcptto =&gt; recipient_to</div>
<div class="line">date =&gt; mail_date</div>
<div class="line">from</div>
<div class="line">to</div>
<div class="line">cc</div>
<div class="line">reply_to</div>
<div class="line">msg_id =&gt; message_id</div>
<div class="line">in_reply_to</div>
<div class="line">subject</div>
<div class="line">x_originating_ip</div>
<div class="line">first_received</div>
<div class="line">second_received</div>
<div class="line">last_reply</div>
<div class="line">path</div>
<div class="line">useragent =&gt; user_agent</div>
<div class="line">tls</div>
<div class="line">fuids</div>
<div class="line">is_webmail</div>
</div>
</div>
<div class="section" id="snmp-log">
<h4>snmp.log<a class="headerlink" href="#snmp-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_snmp</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1113_preprocess_bro_snmp.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">duration</div>
<div class="line">version</div>
<div class="line">community</div>
<div class="line">get_requests</div>
<div class="line">get_bulk_requests</div>
<div class="line">get_responses</div>
<div class="line">set_requests =&gt; set_responses</div>
<div class="line">display_string</div>
<div class="line">up_since</div>
</div>
</div>
<div class="section" id="socks-log">
<h4>socks.log<a class="headerlink" href="#socks-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_socks</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1122_preprocess_bro_socks.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">version</div>
<div class="line">user</div>
<div class="line">password</div>
<div class="line">status =&gt; server_status</div>
<div class="line">request</div>
</div>
<ul class="simple">
<li>=&gt; request_host</li>
<li>=&gt; request_name</li>
</ul>
<p>request_p =&gt; request_port</p>
<p>bound</p>
<ul class="simple">
<li>=&gt; bound_host</li>
<li>=&gt; bound_name</li>
</ul>
<p>bound_p =&gt; bound_port</p>
</div>
<div class="section" id="software-log">
<h4>software.log<a class="headerlink" href="#software-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_software</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1114_preprocess_bro_software.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">host =&gt; source_ip</div>
<div class="line">host_p =&gt; source_port</div>
<div class="line">software_type</div>
<div class="line">name</div>
<div class="line">major =&gt; version_major</div>
<div class="line">minor =&gt; version_minor</div>
<div class="line">minor2 =&gt; version_minor2</div>
<div class="line">minor3 =&gt; version_minor3</div>
<div class="line">addl =&gt; version_additional_info</div>
<div class="line">unparsed_version</div>
</div>
</div>
<div class="section" id="ssh-log">
<h4>ssh.log<a class="headerlink" href="#ssh-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_ssh</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1115_preprocess_bro_ssh.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">version</div>
<div class="line">auth_success =&gt; authentication_success</div>
<div class="line">auth_attempts =&gt; authentication_attempts</div>
<div class="line">direction</div>
<div class="line">client</div>
<div class="line">server</div>
<div class="line">cipher_alg =&gt; cipher_algorithm</div>
<div class="line">mac_alg =&gt; mac_algorithm</div>
<div class="line">compression_alg =&gt; compression_algorithm</div>
<div class="line">kex_alg =&gt; kex_algorithm</div>
<div class="line">host_key_alg =&gt; host_key_algorithm</div>
<div class="line">host_key</div>
<div class="line">destination_country_code</div>
<div class="line">destination_region</div>
<div class="line">destination_city</div>
<div class="line">destination_latitude</div>
<div class="line">destination_longitude</div>
</div>
</div>
<div class="section" id="ssl-log">
<h4>ssl.log<a class="headerlink" href="#ssl-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_ssl</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1116_preprocess_bro_ssl.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">version</div>
<div class="line">cipher</div>
<div class="line">curve</div>
<div class="line">server_name</div>
<div class="line">resumed</div>
<div class="line">last_alert</div>
<div class="line">next_protocol</div>
<div class="line">established</div>
<div class="line">cert_chain_fuids =&gt; certificate_chain_fuids</div>
<div class="line">client_cert_chain_fuids =&gt; client_certificate_chain_fuids</div>
<div class="line">subject =&gt; certificate_subject</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CN</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_common_name&quot;</span>
<span class="n">C</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_country_code&quot;</span>
<span class="n">O</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_organization&quot;</span>
<span class="n">OU</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_organization_unit&quot;</span>
<span class="n">ST</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_state&quot;</span>
<span class="n">SN</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_surname&quot;</span>
<span class="n">L</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_locality&quot;</span>
<span class="n">GN</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_given_name&quot;</span>
<span class="n">pseudonym</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_pseudonym&quot;</span>
<span class="n">serialNumber</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_serial_number&quot;</span>
<span class="n">title</span> <span class="o">=&gt;</span> <span class="s2">&quot;certificate_title&quot;</span>
<span class="n">initials</span><span class="s2">&quot; =&gt; &quot;</span><span class="n">certificate_initials</span><span class="s2">&quot;</span>
</pre></div>
</div>
<p>certificate_issuer</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">CN</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_common_name&quot;</span>
<span class="n">C</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_country_code&quot;</span>
<span class="n">O</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_organization&quot;</span>
<span class="n">OU</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_organization_unit&quot;</span>
<span class="n">ST</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_state&quot;</span>
<span class="n">SN</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_surname&quot;</span>
<span class="n">L</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_locality&quot;</span>
<span class="n">DC</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_distinguished_name&quot;</span>
<span class="n">GN</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_given_name&quot;</span>
<span class="n">pseudonym</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_pseudonym&quot;</span>
<span class="n">serialNumber</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_serial_number&quot;</span>
<span class="n">title</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_title&quot;</span>
<span class="n">initials</span> <span class="o">=&gt;</span> <span class="s2">&quot;issuer_initials&quot;</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">client_subject</div>
<div class="line">client_issuer</div>
<div class="line">validation_status</div>
<div class="line">ja3 (if JA3 enabled)</div>
</div>
</div>
<div class="section" id="syslog-log">
<h4>syslog.log<a class="headerlink" href="#syslog-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_syslog</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1117_preprocess_bro_syslog.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">proto =&gt; protocol</div>
<div class="line">facility</div>
<div class="line">severity</div>
<div class="line">message</div>
</div>
</div>
<div class="section" id="tunnel-log">
<h4>tunnel.log<a class="headerlink" href="#tunnel-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_tunnel</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1118_preprocess_bro_tunnel.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">id.orig_h =&gt; source_ip</div>
<div class="line">id.orig_p =&gt; source_port</div>
<div class="line">id.resp_h =&gt; destination_ip</div>
<div class="line">id.resp_p =&gt; destination_port</div>
<div class="line">tunnel_type</div>
<div class="line">action</div>
</div>
</div>
<div class="section" id="weird-log">
<h4>weird.log<a class="headerlink" href="#weird-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_weird</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1119_preprocess_bro_weird.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">uid</div>
<div class="line">name</div>
<div class="line">addl =&gt; additional_info</div>
<div class="line">notice</div>
<div class="line">peer</div>
</div>
</div>
<div class="section" id="x509-log">
<h4>x509.log<a class="headerlink" href="#x509-log" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">type:bro_x509</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/logstash/conf.d/1123_preprocess_bro_x509.conf</span></code></div>
</div>
<div class="line-block">
<div class="line">ts =&gt; timestamp</div>
<div class="line">id</div>
<div class="line">certificate =&gt;</div>
</div>
<ul class="simple">
<li>certificate_version</li>
<li>certificate_serial</li>
<li>certificate_subject</li>
<li>certificate_issuer</li>
<li>certificate_not_valid_before</li>
<li>certificate_not_valid_after</li>
<li>certificate_key_algorithm</li>
<li>certificate_signing_algorithm</li>
<li>certificate_key_type</li>
<li>certificate_key_length</li>
<li>certificate_exponent</li>
<li>certificate_curve</li>
</ul>
<p>san =&gt;</p>
<ul class="simple">
<li>san_dns</li>
<li>san_uri</li>
<li>san_email</li>
<li>san_ip</li>
</ul>
<p>basic_constraints =&gt;</p>
<ul class="simple">
<li>basic_constraints_ca</li>
<li>basic_constraints_path_length</li>
</ul>
</div>
<div class="section" id="pivot-fields">
<h4>Pivot Fields<a class="headerlink" href="#pivot-fields" title="Permalink to this headline">¶</a></h4>
<p>The following fields are formatted as a URL within Kibana, so we can
easily pivot from them to the Indicator dashboard by clicking on them:</p>
<div class="line-block">
<div class="line">destination_ip</div>
<div class="line">destination_port</div>
<div class="line">file_ip</div>
<div class="line">indicator</div>
<div class="line">orig_fuids</div>
<div class="line">query</div>
<div class="line">resp_fuids</div>
<div class="line">server_name</div>
<div class="line">source_ip</div>
<div class="line">source_port</div>
<div class="line">uid</div>
<div class="line">virtual_host</div>
</div>
</div>
</div>
<span id="document-elastalert-fields"></span><div class="section" id="elastalert-fields">
<h3>Elastalert Fields<a class="headerlink" href="#elastalert-fields" title="Permalink to this headline">¶</a></h3>
<p>The following lists field names as they are formatted in Elasticsearch.
Elastalert provides its own template to use for mapping into Elastalert,
so we do not current utilize a config file to parse data from
Elastalert.</p>
<p><code class="docutils literal notranslate"><span class="pre">index:*:elastalert_status</span></code></p>
<div class="line-block">
<div class="line">alert_info.type</div>
<div class="line">alert_sent</div>
<div class="line">alert_time</div>
<div class="line">endtime</div>
<div class="line">hist</div>
<div class="line">matches</div>
<div class="line">match_body.&#64;timestamp</div>
<div class="line">match_body.num_hits</div>
<div class="line">match_body.num_matches</div>
<div class="line">rule_name</div>
<div class="line">starttime</div>
<div class="line">time_taken</div>
</div>
</div>
<span id="document-re‐indexing"></span><div class="section" id="re-indexing">
<h3>Re-Indexing<a class="headerlink" href="#re-indexing" title="Permalink to this headline">¶</a></h3>
<p>When changing mappings or index settings, we may need to re-index the existing indices to ensure there are no mapping conflicts.</p>
<p>One way to do this by using the following <strong>experimental</strong> example script:</p>
<p><a class="reference external" href="https://raw.githubusercontent.com/weslambert/securityonion-elastic-misc/master/so-elastic-reindex">https://raw.githubusercontent.com/weslambert/securityonion-elastic-misc/master/so-elastic-reindex</a></p>
<p>Pull down the script to your Security Onion box:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">weslambert</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">misc</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">reindex</span>
</pre></div>
</div>
<p>Make the script executable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">reindex</span>
</pre></div>
</div>
<p>Re-index all indices matching <code class="docutils literal notranslate"><span class="pre">logstash-*</span></code>, pulling the appropriate <code class="docutils literal notranslate"><span class="pre">refresh_interval</span></code> from the template named <code class="docutils literal notranslate"><span class="pre">logstash</span></code> in Elasticsearch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">./</span><span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">reindex</span> <span class="o">-</span><span class="n">i</span> <span class="s2">&quot;logstash-*&quot;</span> <span class="o">-</span><span class="n">t</span> <span class="s2">&quot;logstash&quot;</span>
</pre></div>
</div>
<p>The script should then progress to re-index the matching indices, and inform you when it has completed.</p>
<p>Please note, abnormal execution of this script may result in data loss– there are <strong>NO GUARANTEES</strong> this process will work perfectly for you.</p>
</div>
</div>
</div>
<span id="document-updating"></span><div class="section" id="updating">
<h2>Updating<a class="headerlink" href="#updating" title="Permalink to this headline">¶</a></h2>
<p>In this section, we’ll review how to keep Security Onion up-to-date.</p>
<div class="toctree-wrapper compound">
<span id="document-upgrade"></span><div class="section" id="updating">
<h3>Updating<a class="headerlink" href="#updating" title="Permalink to this headline">¶</a></h3>
<div class="section" id="soup">
<h4>soup<a class="headerlink" href="#soup" title="Permalink to this headline">¶</a></h4>
<p>We recommend using our <code class="docutils literal notranslate"><span class="pre">soup</span></code> script to update. <code class="docutils literal notranslate"><span class="pre">Soup</span></code> will automatically install <strong>all</strong> available package updates (from both Ubuntu and Security Onion) and <strong>all</strong> updated Docker images.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">soup</span>
</pre></div>
</div>
<p>Please pay attention to the output of this command as it may request that you take specific action, such as manually restarting services. Also refer to the relevant blog entry for the update at <a class="reference external" href="https://blog.securityonion.net">https://blog.securityonion.net</a> as there may be additional information there.</p>
</div>
<div class="section" id="snort-suricata">
<h4>Snort/Suricata<a class="headerlink" href="#snort-suricata" title="Permalink to this headline">¶</a></h4>
<p>Snort package upgrades will back up each of your existing <code class="docutils literal notranslate"><span class="pre">snort.conf</span></code> files to <code class="docutils literal notranslate"><span class="pre">snort.conf.bak</span></code> and migrate your <code class="docutils literal notranslate"><span class="pre">HOME_NET</span></code> and <code class="docutils literal notranslate"><span class="pre">EXTERNAL_NET</span></code> variables.</p>
<p>Suricata package upgrades will back up each of your existing <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> files to <code class="docutils literal notranslate"><span class="pre">suricata.yaml.bak</span></code> and migrate your <code class="docutils literal notranslate"><span class="pre">HOME_NET</span></code> and <code class="docutils literal notranslate"><span class="pre">EXTERNAL_NET</span></code> variables.</p>
<p>You’ll then need to do the following:</p>
<ul>
<li><p class="first">re-apply any other local customizations to your <code class="docutils literal notranslate"><span class="pre">snort.conf</span></code>/<code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> file(s)</p>
</li>
<li><p class="first">update ruleset and restart Snort/Suricata as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="bro">
<h4>Bro<a class="headerlink" href="#bro" title="Permalink to this headline">¶</a></h4>
<p>Bro package upgrades will attempt to migrate your Bro config. You should double-check your config and see if there are any local customizations that you need to manually re-apply. Then restart Bro as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="wazuh">
<h4>Wazuh<a class="headerlink" href="#wazuh" title="Permalink to this headline">¶</a></h4>
<p>Wazuh package upgrades will back up your <code class="docutils literal notranslate"><span class="pre">ossec.conf</span></code> and put the new <code class="docutils literal notranslate"><span class="pre">ossec.conf</span></code> in place.  You’ll then need to do the following:</p>
<ul>
<li><p class="first">re-apply any other local customizations to your <code class="docutils literal notranslate"><span class="pre">ossec.conf</span></code> file</p>
</li>
<li><p class="first">restart Wazuh as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">ossec</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="mysql">
<h4>MySQL<a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h4>
<p>If you get any errors relating to MySQL, please see the <a class="reference external" href="MySQL-Upgrade-Errors">MySQL-Upgrade-Errors</a> section.</p>
</div>
<div class="section" id="initiating-an-update-over-ssh">
<h4>Initiating an update over SSH<a class="headerlink" href="#initiating-an-update-over-ssh" title="Permalink to this headline">¶</a></h4>
<p>If you’re updating your Security Onion box over an SSH connection and your connection drops, then your update process may be left in an inconsistent state. It is therefore recommended to run <code class="docutils literal notranslate"><span class="pre">byobu</span></code> so that your session will continue to run on the Security Onion box even if your connection drops. <code class="docutils literal notranslate"><span class="pre">Byobu</span></code> is very handy and we recommend running it all the time to avoid forgetting about it before an update.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># install byobu</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">byobu</span>

<span class="c1"># enable byobu</span>
<span class="n">byobu</span><span class="o">-</span><span class="n">enable</span>

<span class="c1"># you&#39;re now ready to update</span>
</pre></div>
</div>
<p>For more information about <code class="docutils literal notranslate"><span class="pre">byobu</span></code>, please see <a class="reference external" href="https://help.ubuntu.com/community/Byobu">https://help.ubuntu.com/community/Byobu</a>.</p>
</div>
<div class="section" id="distributed-deployments">
<h4>Distributed deployments<a class="headerlink" href="#distributed-deployments" title="Permalink to this headline">¶</a></h4>
<p>If you have a distributed deployment with a master server and separate sensor boxes and/or storage nodes, always update the master server first before updating other boxes. Then make sure to update the remaining boxes shortly thereafter. This will help to ensure that all boxes in your deployment are running the same code versions and help to avoid any incompatibilities.</p>
</div>
<div class="section" id="using-salt-and-soup-to-update-your-entire-deployment">
<h4>Using salt and soup to update your entire deployment<a class="headerlink" href="#using-salt-and-soup-to-update-your-entire-deployment" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="Salt#using-salt-to-install-updates-across-your-entire-deployment">salt and
soup</a></p>
</div>
<div class="section" id="standard-ubuntu-package-management-tools">
<h4>Standard Ubuntu package management tools<a class="headerlink" href="#standard-ubuntu-package-management-tools" title="Permalink to this headline">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">soup</span></code> command described above is the recommended method to install updates. If you instead choose to use standard Ubuntu package management tools to install updates, there are some caveats to be aware of:</p>
<ul>
<li><p class="first">Docker - Ubuntu package management tools don’t update our Docker images (used for the Elastic Stack currently)</p>
</li>
<li><p class="first">MySQL - if you’ve already run Setup, please see the <a class="reference external" href="MySQLUpdates">recommended procedure for updating the MySQL packages</a>.</p>
</li>
<li><div class="first line-block">
<div class="line">PF-RING and new kernel packages</div>
<div class="line">You may be prompted to update your kernel packages and PF-RING at the same time. If you do so, the PF-RING kernel module may get built for your current kernel and not for the newly installed kernel and upon reboot services will fail. To avoid this, you should install just the PF-RING kernel module by itself and then install the kernel and any other remaining package updates. Here’s a one-liner that will do that:</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="p">;</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">pfring</span><span class="o">-</span><span class="n">module</span> <span class="p">;</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">dist</span><span class="o">-</span><span class="n">upgrade</span>
</pre></div>
</div>
<p>If you accidentally install both the kernel and PF-RING packages at the same time and then reboot and find out that PF-RING services (Snort and Suricata) are failing, you can reinstall the <code class="docutils literal notranslate"><span class="pre">securityonion-pfring-module</span></code> package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">--</span><span class="n">reinstall</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">pfring</span><span class="o">-</span><span class="n">module</span>
</pre></div>
</div>
<p class="rubric" id="security-onion-14-04">Security Onion 14.04</p>
<p><strong>Please note</strong>: If you’re still running the old Security Onion
14.04, <code class="docutils literal notranslate"><span class="pre">soup</span></code> will continue to install Ubuntu updates until Ubuntu
stops releasing updates for 14.04. However, there won’t be any more
Security Onion updates for version 14.04 as all development will be
on version 16.04 moving forward.</p>
</li>
</ul>
</div>
<div class="section" id="upgrades">
<h4>Upgrades<a class="headerlink" href="#upgrades" title="Permalink to this headline">¶</a></h4>
<p>To upgrade from Security Onion 14.04 to Security Onion 16.04, please see the <a class="reference external" href="Upgrading-from-14.04-to-16.04">Upgrading-from-14.04-to-16.04</a> section.</p>
</div>
</div>
<span id="document-mysql-upgrade-errors"></span><div class="section" id="mysql-upgrade-errors">
<h3>MySQL Upgrade Errors<a class="headerlink" href="#mysql-upgrade-errors" title="Permalink to this headline">¶</a></h3>
<p>Ubuntu releases new MySQL packages periodically as needed. If you have a
Security Onion 16.04 installation and run <code class="docutils literal notranslate"><span class="pre">soup</span></code> to install these new
MySQL packages, you may see a few error messages as described below.</p>
<div class="section" id="error-messages-regarding-mysql-upgrade-process">
<h4>Error messages regarding MySQL upgrade process<a class="headerlink" href="#error-messages-regarding-mysql-upgrade-process" title="Permalink to this headline">¶</a></h4>
<p>If your installation has MySQL disabled (because you haven’t yet run
Setup or you’ve run Setup and chosen Forward Node or Storage Node), then
you may also see error messages like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql_upgrade</span><span class="p">:</span> <span class="n">Got</span> <span class="n">error</span><span class="p">:</span> <span class="mi">2002</span><span class="p">:</span> <span class="n">Can</span><span class="s1">&#39;t connect to local MySQL server through socket &#39;</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">mysqld</span><span class="o">/</span><span class="n">mysqld</span><span class="o">.</span><span class="n">sock</span><span class="s1">&#39; (2) while connecting to the MySQL server</span>
<span class="n">Upgrade</span> <span class="n">process</span> <span class="n">encountered</span> <span class="n">error</span> <span class="ow">and</span> <span class="n">will</span> <span class="ow">not</span> <span class="k">continue</span><span class="o">.</span>
<span class="n">mysql_upgrade</span> <span class="n">failed</span> <span class="k">with</span> <span class="n">exit</span> <span class="n">status</span> <span class="mi">11</span>
<span class="n">dpkg</span><span class="p">:</span> <span class="n">error</span> <span class="n">processing</span> <span class="n">package</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.7</span> <span class="p">(</span><span class="o">--</span><span class="n">configure</span><span class="p">):</span>
 <span class="n">subprocess</span> <span class="n">installed</span> <span class="n">post</span><span class="o">-</span><span class="n">installation</span> <span class="n">script</span> <span class="n">returned</span> <span class="n">error</span> <span class="n">exit</span> <span class="n">status</span> <span class="mi">1</span>

<span class="n">No</span> <span class="n">apport</span> <span class="n">report</span> <span class="n">written</span> <span class="n">because</span> <span class="n">the</span> <span class="n">error</span> <span class="n">message</span> <span class="n">indicates</span> <span class="n">its</span> <span class="n">a</span> <span class="n">followup</span> <span class="n">error</span> <span class="kn">from</span> <span class="nn">a</span> <span class="n">previous</span> <span class="n">failure</span><span class="o">.</span>
                                                                                                          <span class="n">dpkg</span><span class="p">:</span> <span class="n">dependency</span> <span class="n">problems</span> <span class="n">prevent</span> <span class="n">configuration</span> <span class="n">of</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="p">:</span>
 <span class="n">mysql</span><span class="o">-</span><span class="n">server</span> <span class="n">depends</span> <span class="n">on</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.7</span><span class="p">;</span> <span class="n">however</span><span class="p">:</span>
  <span class="n">Package</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.7</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">configured</span> <span class="n">yet</span><span class="o">.</span>

<span class="n">dpkg</span><span class="p">:</span> <span class="n">error</span> <span class="n">processing</span> <span class="n">package</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span> <span class="p">(</span><span class="o">--</span><span class="n">configure</span><span class="p">):</span>
 <span class="n">dependency</span> <span class="n">problems</span> <span class="o">-</span> <span class="n">leaving</span> <span class="n">unconfigured</span>

<span class="n">Errors</span> <span class="n">were</span> <span class="n">encountered</span> <span class="k">while</span> <span class="n">processing</span><span class="p">:</span>
 <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.7</span>
 <span class="n">mysql</span><span class="o">-</span><span class="n">server</span>
<span class="n">E</span><span class="p">:</span> <span class="n">Sub</span><span class="o">-</span><span class="n">process</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">dpkg</span> <span class="n">returned</span> <span class="n">an</span> <span class="n">error</span> <span class="n">code</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>You can resolve this issue using the following one-liner:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">mysql</span><span class="o">.</span><span class="n">service</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">apt</span> <span class="o">-</span><span class="n">f</span> <span class="n">install</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">mysql</span><span class="o">.</span><span class="n">service</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">disable</span> <span class="n">mysql</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</div>
<div class="section" id="error-message-regarding-mysql-5-5">
<h4>Error message regarding MySQL 5.5<a class="headerlink" href="#error-message-regarding-mysql-5-5" title="Permalink to this headline">¶</a></h4>
<p>Older versions of soup may result in error messages regarding MySQL 5.5.
Newer versions of soup have been updated to correct this. If you are
running an older version of soup and see error messages like this, they
can be ignored as Security Onion 16.04 uses MySQL 5.7:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Package</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">available</span><span class="p">,</span> <span class="n">but</span> <span class="ow">is</span> <span class="n">referred</span> <span class="n">to</span> <span class="n">by</span> <span class="n">another</span> <span class="n">package</span><span class="o">.</span>
<span class="n">This</span> <span class="n">may</span> <span class="n">mean</span> <span class="n">that</span> <span class="n">the</span> <span class="n">package</span> <span class="ow">is</span> <span class="n">missing</span><span class="p">,</span> <span class="n">has</span> <span class="n">been</span> <span class="n">obsoleted</span><span class="p">,</span> <span class="ow">or</span>
<span class="ow">is</span> <span class="n">only</span> <span class="n">available</span> <span class="kn">from</span> <span class="nn">another</span> <span class="n">source</span>
<span class="n">However</span> <span class="n">the</span> <span class="n">following</span> <span class="n">packages</span> <span class="n">replace</span> <span class="n">it</span><span class="p">:</span>
  <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.7</span> <span class="n">mysql</span><span class="o">-</span><span class="n">common</span> <span class="n">percona</span><span class="o">-</span><span class="n">xtradb</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.6</span><span class="p">:</span><span class="n">i386</span> <span class="n">percona</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.6</span><span class="p">:</span><span class="n">i386</span> <span class="n">mysql</span><span class="o">-</span><span class="n">testsuite</span><span class="o">-</span><span class="mf">5.7</span><span class="p">:</span><span class="n">i386</span> <span class="n">mariadb</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">10.0</span><span class="p">:</span><span class="n">i386</span> <span class="n">percona</span><span class="o">-</span><span class="n">xtradb</span><span class="o">-</span><span class="n">cluster</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.6</span>
  <span class="n">percona</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.6</span> <span class="n">mysql</span><span class="o">-</span><span class="n">testsuite</span><span class="o">-</span><span class="mf">5.7</span> <span class="n">mariadb</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.7</span><span class="p">:</span><span class="n">i386</span>

<span class="n">Package</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">5.5</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">available</span><span class="p">,</span> <span class="n">but</span> <span class="ow">is</span> <span class="n">referred</span> <span class="n">to</span> <span class="n">by</span> <span class="n">another</span> <span class="n">package</span><span class="o">.</span>
<span class="n">This</span> <span class="n">may</span> <span class="n">mean</span> <span class="n">that</span> <span class="n">the</span> <span class="n">package</span> <span class="ow">is</span> <span class="n">missing</span><span class="p">,</span> <span class="n">has</span> <span class="n">been</span> <span class="n">obsoleted</span><span class="p">,</span> <span class="ow">or</span>
<span class="ow">is</span> <span class="n">only</span> <span class="n">available</span> <span class="kn">from</span> <span class="nn">another</span> <span class="n">source</span>
<span class="n">However</span> <span class="n">the</span> <span class="n">following</span> <span class="n">packages</span> <span class="n">replace</span> <span class="n">it</span><span class="p">:</span>
  <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">5.7</span> <span class="n">percona</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.6</span><span class="p">:</span><span class="n">i386</span> <span class="n">mariadb</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">10.0</span><span class="p">:</span><span class="n">i386</span> <span class="n">percona</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="mf">5.6</span> <span class="n">mariadb</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">10.0</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">core</span><span class="o">-</span><span class="mf">5.7</span><span class="p">:</span><span class="n">i386</span>

<span class="n">E</span><span class="p">:</span> <span class="n">Package</span> <span class="s1">&#39;mysql-server-core-5.5&#39;</span> <span class="n">has</span> <span class="n">no</span> <span class="n">installation</span> <span class="n">candidate</span>
<span class="n">E</span><span class="p">:</span> <span class="n">Package</span> <span class="s1">&#39;mysql-server-5.5&#39;</span> <span class="n">has</span> <span class="n">no</span> <span class="n">installation</span> <span class="n">candidate</span>
</pre></div>
</div>
</div>
</div>
<span id="document-eol"></span><div class="section" id="end-of-life">
<h3>End Of Life<a class="headerlink" href="#end-of-life" title="Permalink to this headline">¶</a></h3>
<p>This page lists End Of Life (EOL) dates for older versions of Security
Onion and older components.</p>
<div class="line-block">
<div class="line">Security Onion 14.04 reached EOL on November 30, 2018:</div>
<div class="line"><a class="reference external" href="https://blog.securityonion.net/2018/06/6-month-eol-notice-for-security-onion.html">https://blog.securityonion.net/2018/06/6-month-eol-notice-for-security-onion.html</a></div>
</div>
<div class="line-block">
<div class="line">ELSA reached EOL on October 9, 2018:</div>
<div class="line"><a class="reference external" href="https://blog.securityonion.net/2018/04/6-month-eol-notice-for-elsa.html">https://blog.securityonion.net/2018/04/6-month-eol-notice-for-elsa.html</a></div>
</div>
<div class="line-block">
<div class="line">Xplico reached EOL on June 5, 2018:</div>
<div class="line"><a class="reference external" href="https://blog.securityonion.net/2017/12/6-month-eol-notice-for-security-onion.html">https://blog.securityonion.net/2017/12/6-month-eol-notice-for-security-onion.html</a></div>
</div>
</div>
</div>
</div>
<span id="document-customizing"></span><div class="section" id="customizing-for-your-environment">
<h2>Customizing for Your Environment<a class="headerlink" href="#customizing-for-your-environment" title="Permalink to this headline">¶</a></h2>
<p>This section covers how to customize Security Onion for your environment.</p>
<div class="toctree-wrapper compound">
<span id="document-network-configuration"></span><div class="section" id="network-configuration">
<h3>Network Configuration<a class="headerlink" href="#network-configuration" title="Permalink to this headline">¶</a></h3>
<p>All of this configuration will happen automatically if you choose <code class="docutils literal notranslate"><span class="pre">Yes,</span> <span class="pre">configure</span> <span class="pre">/etc/network/interfaces</span></code> in the Setup wizard.  If for some reason you need to configure <cite>/etc/network/interfaces</cite> manually, you can do the following.</p>
<p>NOTE! You may lose network connectivity during this process! Have a backup plan if attempting over SSH!</p>
<p>Stop Network Manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">network</span><span class="o">-</span><span class="n">manager</span> <span class="n">stop</span>
</pre></div>
</div>
<p>Prevent Network Manager from starting at next boot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mv</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">network</span><span class="o">-</span><span class="n">manager</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">network</span><span class="o">-</span><span class="n">manager</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">DISABLED</span>
</pre></div>
</div>
<p>Next, configure your network interfaces in <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code>.</p>
<div class="section" id="management-interface">
<h4>Management interface<a class="headerlink" href="#management-interface" title="Permalink to this headline">¶</a></h4>
<p>You’ll want a management interface (preferably connected to a dedicated management network) using either DHCP OR preferably static IP.</p>
</div>
<div class="section" id="sniffing-interface-s">
<h4>Sniffing interface(s)<a class="headerlink" href="#sniffing-interface-s" title="Permalink to this headline">¶</a></h4>
<p>You’ll want one or more interfaces dedicated to sniffing (no IP address). NIC offloading functions such as <code class="docutils literal notranslate"><span class="pre">tso</span></code>, <code class="docutils literal notranslate"><span class="pre">gso</span></code>, and <code class="docutils literal notranslate"><span class="pre">gro</span></code> should be disabled to ensure that Snort/Suricata get an accurate view of the traffic (see <a class="reference external" href="https://blog.securityonion.net/2011/10/when-is-full-packet-capture-not-full.html">https://blog.securityonion.net/2011/10/when-is-full-packet-capture-not-full.html</a>).</p>
</div>
<div class="section" id="sample-etc-network-interfaces">
<h4>Sample /etc/network/interfaces<a class="headerlink" href="#sample-etc-network-interfaces" title="Permalink to this headline">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>auto lo
iface lo inet loopback

# Management interface using DHCP
auto eth0
iface eth0 inet dhcp

# OR

# Management interface using STATIC IP (instead of DHCP)
auto eth0
iface eth0 inet static
  address 192.168.1.14
  gateway 192.168.1.1
  netmask 255.255.255.0
  network 192.168.1.0
  broadcast 192.168.1.255
  # If running Security Onion 14.04, you&#39;ll need to configure DNS here
  dns-nameservers 192.168.1.1 192.168.1.2

# AND one or more of the following

# Connected to TAP or SPAN port for traffic monitoring
auto eth1
iface eth1 inet manual
  up ifconfig $IFACE -arp up
  up ip link set $IFACE promisc on
  down ip link set $IFACE promisc off
  down ifconfig $IFACE down
  post-up for i in rx tx sg tso ufo gso gro lro; do ethtool -K $IFACE $i off; done
  # If running Security Onion 14.04, you should also disable IPv6 as follows:
  post-up echo 1 &gt; /proc/sys/net/ipv6/conf/$IFACE/disable_ipv6
</pre></div>
</div>
<p>You may also want to set the RX buffer size in the post-up command like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>post-up ethtool -G $IFACE rx 4096; for i in rx tx sg tso ufo gso gro lro; do ethtool -K $IFACE $i off; done
</pre></div>
</div>
<p>Note that 4096 is just an example and your NIC may have a different maximum rx size. To determine the maximum rx setting for your NIC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ethtool</span> <span class="o">-</span><span class="n">g</span> <span class="n">ethX</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">If necessary, configure DNS in <code class="docutils literal notranslate"><span class="pre">/etc/resolv.conf</span></code>:</div>
<div class="line"><a class="reference external" href="http://en.wikipedia.org/wiki/Resolv.conf">http://en.wikipedia.org/wiki/Resolv.conf</a></div>
<div class="line"><a class="reference external" href="http://www.cyberciti.biz/tips/howto-ubuntu-linux-convert-dhcp-network-configuration-to-static-ip-configuration.html">http://www.cyberciti.biz/tips/howto-ubuntu-linux-convert-dhcp-network-configuration-to-static-ip-configuration.html</a></div>
<div class="line"><a class="reference external" href="http://manpages.ubuntu.com/manpages/lucid/man5/resolver.5.html">http://manpages.ubuntu.com/manpages/lucid/man5/resolver.5.html</a></div>
<div class="line"><br /></div>
</div>
<p>Restart networking:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">networking</span> <span class="n">restart</span>
</pre></div>
</div>
<p>If you already had sensors running on these interfaces, you should restart them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>For more information on network configuration in Ubuntu, please see <a class="reference external" href="https://help.ubuntu.com/community/NetworkConfigurationCommandLine/Automatic">https://help.ubuntu.com/community/NetworkConfigurationCommandLine/Automatic</a>.</p>
</div>
</div>
<span id="document-proxy"></span><div class="section" id="proxy-configuration">
<h3>Proxy Configuration<a class="headerlink" href="#proxy-configuration" title="Permalink to this headline">¶</a></h3>
<p>If you need to force your Internet traffic through a proxy server, you can put your proxy server settings in <code class="docutils literal notranslate"><span class="pre">/etc/environment</span></code> like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">http_proxy</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">server</span><span class="p">:</span><span class="n">port</span>
<span class="n">export</span> <span class="n">https_proxy</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">server</span><span class="p">:</span><span class="n">port</span>
<span class="n">export</span> <span class="n">ftp_proxy</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">server</span><span class="p">:</span><span class="n">port</span>
<span class="n">export</span> <span class="n">PERL_LWP_ENV_PROXY</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">server</span><span class="p">:</span><span class="n">port</span>
<span class="n">export</span> <span class="n">no_proxy</span><span class="o">=</span><span class="s2">&quot;localhost,127.0.0.1&quot;</span>
</pre></div>
</div>
<div class="section" id="docker">
<h4>Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h4>
<p>To configure Docker proxy settings, perform the following steps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">-</span><span class="n">i</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">d</span>
<span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOT</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">docker</span><span class="o">.</span><span class="n">service</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">proxy</span><span class="o">.</span><span class="n">conf</span>
<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Environment</span><span class="o">=</span><span class="s2">&quot;HTTP_PROXY=http://proxy.someplace.com:8080/&quot;</span> <span class="s2">&quot;HTTPS_PROXY=http://proxy.someplace.com:8080/&quot;</span> <span class="s2">&quot;NO_PROXY=127.0.0.1,localhost,.someplace.com&quot;</span>
<span class="n">EOT</span>
<span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span> <span class="o">&amp;&amp;</span> <span class="n">systemctl</span> <span class="n">restart</span> <span class="n">docker</span> <span class="o">&amp;&amp;</span> <span class="n">exit</span>
<span class="n">sudo</span> <span class="n">soup</span>
</pre></div>
</div>
<p><strong>For older versions of Security Onion on the Elastic Stack, if the above did not work, you may want to try the following:</strong></p>
<p>Modify <code class="docutils literal notranslate"><span class="pre">/etc/default/docker</span></code> and add the appropriate proxy information, like so:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">http_proxy</span><span class="o">=</span><span class="s2">&quot;http://server:port/&quot;</span>
<span class="n">export</span> <span class="n">https_proxy</span><span class="o">=</span><span class="s2">&quot;https://server:port/&quot;</span>
</pre></div>
</div>
<p>Then restart Docker with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">stop</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">docker</span> <span class="n">restart</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="sudo">
<h4>sudo<a class="headerlink" href="#sudo" title="Permalink to this headline">¶</a></h4>
<p>If you’re going to run something using sudo, remember to use the <code class="docutils literal notranslate"><span class="pre">-i</span></code> option to force it to process the environment variables. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">-</span><span class="n">i</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
<p>Alternatively, see the <code class="docutils literal notranslate"><span class="pre">env_keep</span></code> option under the <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">caveat</span></code> section of <a class="reference external" href="https://help.ubuntu.com/community/EnvironmentVariables">https://help.ubuntu.com/community/EnvironmentVariables</a>.</p>
</div>
<div class="section" id="pulledpork">
<h4>PulledPork<a class="headerlink" href="#pulledpork" title="Permalink to this headline">¶</a></h4>
<p>As of <a class="reference external" href="https://blog.securityonion.net/2017/01/pulledpork-rule-update-and-several.html">PulledPork 0.7.2</a>,
you may need to pass the <code class="docutils literal notranslate"><span class="pre">-W</span></code> option to Pulledpork:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">W</span> <span class="n">Where</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">work</span> <span class="n">around</span> <span class="n">the</span> <span class="n">issue</span> <span class="n">where</span> <span class="n">some</span> <span class="n">implementations</span> <span class="n">of</span> <span class="n">LWP</span> <span class="n">do</span> <span class="ow">not</span> <span class="n">work</span> <span class="k">with</span> <span class="n">pulledpork</span><span class="s1">&#39;s proxy configuration.</span>
</pre></div>
</div>
<p>If you find that you need this option, you can add the following to <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PULLEDPORK_OPTIONS</span><span class="o">=</span><span class="s2">&quot;-W&quot;</span>
</pre></div>
</div>
<p>For older versions of PulledPork and certain proxies (Bluecoat in particular), you may need to change from <code class="docutils literal notranslate"><span class="pre">https</span></code> to <code class="docutils literal notranslate"><span class="pre">http</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/pulledpork/pulledpork.conf</span></code>. For more information, please see:</p>
<p><a class="reference external" href="https://code.google.com/archive/p/pulledpork/issues/154">PulledPork Issue 154</a></p>
<p><a class="reference external" href="https://groups.google.com/d/topic/security-onion/NQ-dLLPxR6A/discussion">https://groups.google.com/d/topic/security-onion/NQ-dLLPxR6A/discussion</a></p>
<p><a class="reference external" href="https://groups.google.com/d/topic/security-onion-testing/piRYj-7Ar8M/discussion">https://groups.google.com/d/topic/security-onion-testing/piRYj-7Ar8M/discussion</a></p>
</div>
</div>
<span id="document-firewall"></span><div class="section" id="firewall">
<h3>Firewall<a class="headerlink" href="#firewall" title="Permalink to this headline">¶</a></h3>
<div class="section" id="setup-defaults-to-only-allowing-port-22-ssh">
<h4>Setup defaults to only allowing port 22 (ssh)<a class="headerlink" href="#setup-defaults-to-only-allowing-port-22-ssh" title="Permalink to this headline">¶</a></h4>
<p>When you run Setup, it defaults to locking down the local <code class="docutils literal notranslate"><span class="pre">ufw</span></code> firewall to only allowing port 22 (ssh).  There is a note at the end of Setup that tells you this and lets you know that, if you need to allow connections on other ports, you can run the <a class="reference external" href="so-allow">so-allow</a> utility.</p>
</div>
<div class="section" id="sensors-automatically-add-their-own-firewall-rules-to-the-master-server">
<h4>Sensors automatically add their own firewall rules to the master server<a class="headerlink" href="#sensors-automatically-add-their-own-firewall-rules-to-the-master-server" title="Permalink to this headline">¶</a></h4>
<p>When you run Setup on a sensor-only installation, it will ssh to the master server and add new firewall rules to the master server to allow the sensor to connect on the following ports:</p>
<ul class="simple">
<li>22/tcp (ssh)</li>
<li>4505/tcp (salt)</li>
<li>4506/tcp (salt)</li>
<li>7736/tcp (sguil)</li>
</ul>
</div>
<div class="section" id="ufw">
<h4>UFW<a class="headerlink" href="#ufw" title="Permalink to this headline">¶</a></h4>
<p>For more information about <code class="docutils literal notranslate"><span class="pre">ufw</span></code>, please see <a class="reference external" href="https://help.ubuntu.com/community/UFW">https://help.ubuntu.com/community/UFW</a>.</p>
</div>
</div>
<span id="document-email"></span><div class="section" id="email-configuration">
<h3>Email Configuration<a class="headerlink" href="#email-configuration" title="Permalink to this headline">¶</a></h3>
<div class="section" id="so-email">
<h4>so-email<a class="headerlink" href="#so-email" title="Permalink to this headline">¶</a></h4>
<p>If you want to configure email, you can run <code class="docutils literal notranslate"><span class="pre">so-email</span></code> and it will automatically configure automated server-side email for you as described below. Simply run the following command and follow the prompts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">email</span>
</pre></div>
</div>
<p>To automate email setup, copy and modify the example file located at <code class="docutils literal notranslate"><span class="pre">/usr/share/securityonion/so-email.conf</span></code>, then run <code class="docutils literal notranslate"><span class="pre">so-email</span></code> with the <code class="docutils literal notranslate"><span class="pre">-f</span></code> flag:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">email</span> <span class="o">-</span><span class="n">f</span> <span class="o">~/</span><span class="n">so</span><span class="o">-</span><span class="n">email</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</div>
<div class="section" id="sguil-client">
<h4>Sguil client<a class="headerlink" href="#sguil-client" title="Permalink to this headline">¶</a></h4>
<p>Please note that the Sguil client has its own email configuration (separate from the Sguil server) which can be modified in
<code class="docutils literal notranslate"><span class="pre">/etc/sguil/sguil.conf</span></code>.</p>
</div>
<div class="section" id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h4>
<p>This page describes how to configure email for alerting and reporting. Applications such as Sguil and Wazuh have their own mail configuration and don’t rely on a mail server in the OS itself. However, you may still want to install a mail server in the OS so that you can get daily emails from the sostat script and from Bro.</p>
</div>
<div class="section" id="operating-system">
<h4>Operating System<a class="headerlink" href="#operating-system" title="Permalink to this headline">¶</a></h4>
<p>Install and configure your favorite mail server. Depending on your needs, this could be something simple like <code class="docutils literal notranslate"><span class="pre">nullmailer</span></code>  (recommended) or something more complex like <code class="docutils literal notranslate"><span class="pre">exim4</span></code>.</p>
<p>Here are some <code class="docutils literal notranslate"><span class="pre">nullmailer</span></code> instructions provided by Michael Iverson:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">nullmailer</span>

<span class="c1"># edit /etc/mailname to hold your &quot;from&quot; domain name. (If you were google, you&#39;d use &quot;gmail.com&quot;.)</span>

<span class="c1"># edit /etc/nullmailer/adminaddr to contain the address you want mail to root to be routed to.</span>

<span class="c1"># edit /etc/nullmailer/remotes to contain the mail server to forward email to.</span>
</pre></div>
</div>
<p>Alternatively, here are some instructions for the more complex <code class="docutils literal notranslate"><span class="pre">exim4</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">y</span> <span class="n">install</span> <span class="n">mailutils</span>
<span class="n">sudo</span> <span class="n">dpkg</span><span class="o">-</span><span class="n">reconfigure</span> <span class="n">exim4</span><span class="o">-</span><span class="n">config</span>
</pre></div>
</div>
<p>Once you’ve configured your mail server and verified that it can send email properly, you might want to create a daily cronjob to execute <code class="docutils literal notranslate"><span class="pre">/usr/sbin/sostat</span></code> and email you the output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># /etc/cron.d/sostat
crontab entry to run sostat and email its output
------------------------------------------------
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
EMAIL=YourUsername@YourDomain.com\
01 12 * * * root HOSTNAME=$(hostname); /usr/sbin/sostat 2&gt;&amp;1 | mail -s &quot;$HOSTNAME stats&quot; $EMAIL
</pre></div>
</div>
<p>If you don’t already have the <code class="docutils literal notranslate"><span class="pre">mail</span></code> utility, you can try installing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">mailutils</span>
</pre></div>
</div>
</div>
<div class="section" id="sguild">
<h4>Sguild<a class="headerlink" href="#sguild" title="Permalink to this headline">¶</a></h4>
<p>Modify <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion/sguild.email</span></code> (on the master server) as needed and restart sguild:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>You can then verify the email configuration by looking at the top of sguild’s log file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">head</span> <span class="o">-</span><span class="mi">20</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">securityonion</span><span class="o">/</span><span class="n">sguild</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>For more information, please see <a class="reference external" href="http://nsmwiki.org/Sguil_FAQ#Can_sguil_page_me_when_it_sees_a_particular_alert.3F">http://nsmwiki.org/Sguil_FAQ#Can_sguil_page_me_when_it_sees_a_particular_alert.3F</a>.</p>
<p>You may want to install a local mail relay on your master server, configure it to relay mail to your corporate mail server, and then configure Sguil to send email to the local mail relay.</p>
<p><strong>Please note</strong>: Sguil will only send email alerts for what is considers <em>new</em> events. Ensure you classify events within the Sguil console, or consider <a class="reference external" href="ManagingAlerts#autocategorize-events">creating an Autocat rule</a> to automatically classify them if you prefer to receive emails for all instances of an alert. Otherwise, you may not receive alerts as intended.</p>
</div>
<div class="section" id="wazuh">
<h4>Wazuh<a class="headerlink" href="#wazuh" title="Permalink to this headline">¶</a></h4>
<p>Modify <code class="docutils literal notranslate"><span class="pre">/var/ossec/etc/ossec.conf</span></code> as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="k">global</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">email_notification</span><span class="o">&gt;</span><span class="n">yes</span><span class="o">&lt;/</span><span class="n">email_notification</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">email_to</span><span class="o">&gt;</span><span class="n">YourUsername</span><span class="nd">@YourDomain</span><span class="o">.</span><span class="n">com</span><span class="o">&lt;/</span><span class="n">email_to</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">smtp_server</span><span class="o">&gt;</span><span class="n">YourMailRelay</span><span class="o">.</span><span class="n">YourDomain</span><span class="o">.</span><span class="n">com</span><span class="o">&lt;/</span><span class="n">smtp_server</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">email_from</span><span class="o">&gt;</span><span class="n">ossec</span><span class="nd">@YourDomain</span><span class="o">.</span><span class="n">com</span><span class="o">&lt;/</span><span class="n">email_from</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">email_maxperhour</span><span class="o">&gt;</span><span class="mi">100</span><span class="o">&lt;/</span><span class="n">email_maxperhour</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="k">global</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>Then restart Wazuh:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">ossec</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>You can specify the severity of an event for which Wazuh will send email alerts by specifying an appropriate value for <code class="docutils literal notranslate"><span class="pre">email_alert_level</span></code> in <code class="docutils literal notranslate"><span class="pre">/var/ossec/etc/ossec.conf</span></code>. If you notice <code class="docutils literal notranslate"><span class="pre">email_alert_level</span></code> is not being respected for a certain rule, it may be that the option is overridden by <code class="docutils literal notranslate"><span class="pre">&lt;options&gt;alert_by_email&lt;/options&gt;</span></code> being set for a rule. You can modify this behavior in <code class="docutils literal notranslate"><span class="pre">/var/ossec/rules/local.rules</span></code>.</p>
<p>You can also find an explanation of the alert levels at <a class="reference external" href="http://ossec-docs.readthedocs.io/en/latest/manual/rules-decoders/rule-levels.html">http://ossec-docs.readthedocs.io/en/latest/manual/rules-decoders/rule-levels.html</a>.</p>
</div>
<div class="section" id="bro">
<h4>Bro<a class="headerlink" href="#bro" title="Permalink to this headline">¶</a></h4>
<p>Edit <code class="docutils literal notranslate"><span class="pre">/opt/bro/etc/broctl.cfg</span></code> and set the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MailTo</span> <span class="o">=</span> <span class="n">YourUsername</span><span class="nd">@YourDomain</span><span class="o">.</span><span class="n">com</span>
<span class="n">sendmail</span> <span class="o">=</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">sendmail</span>
</pre></div>
</div>
<p>Then update and restart Bro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>You should then start receiving hourly connection summary emails. If you don’t want the connection summary emails, you can add the following to <code class="docutils literal notranslate"><span class="pre">broctl.cfg</span></code> and update and restart Bro as shown above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tracesummary</span><span class="o">=</span>
</pre></div>
</div>
<p>You may want to receive emails for Bro notices. To do that, add the following to <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/site/local.bro</span></code> and update/restart Bro as shown above:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>hook Notice::policy(n: Notice::Info)
{
add n$actions[Notice::ACTION\_ALARM];
}
</pre></div>
</div>
<p>Also see <a class="reference external" href="http://mailman.icsi.berkeley.edu/pipermail/bro/2013-December/006418.html">http://mailman.icsi.berkeley.edu/pipermail/bro/2013-December/006418.html</a>.</p>
</div>
<div class="section" id="elastalert">
<h4>Elastalert<a class="headerlink" href="#elastalert" title="Permalink to this headline">¶</a></h4>
<p>Follow the steps on the <a class="reference external" href="ElastAlert#email---internal">Elastalert</a> page.</p>
</div>
<div class="section" id="lack-of-network-traffic">
<h4>Lack of network traffic<a class="headerlink" href="#lack-of-network-traffic" title="Permalink to this headline">¶</a></h4>
<p>If you configured Wazuh or Bro as shown above, they should automatically email you if your network sensors stop seeing traffic.</p>
</div>
</div>
<span id="document-ip"></span><div class="section" id="changing-ip-addresses">
<h3>Changing IP Addresses<a class="headerlink" href="#changing-ip-addresses" title="Permalink to this headline">¶</a></h3>
<p>If you need to update the IP address of your server/sensor to move it to
a different area of your network, you need to do a few things:</p>
<ul class="simple">
<li>update the actual IP address of the management interface</li>
<li>update NSM config files to reflect the new IP address</li>
</ul>
<div class="section" id="update-the-actual-ip-address-of-the-management-interface">
<h4>Update the actual IP address of the management interface<a class="headerlink" href="#update-the-actual-ip-address-of-the-management-interface" title="Permalink to this headline">¶</a></h4>
<p>To update the actual IP address of the management interface, you have
two options:</p>
<ul class="simple">
<li>manually update <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code>OR</li>
<li>re-run the <code class="docutils literal notranslate"><span class="pre">FIRST</span></code> phase of Setup (select “Yes, configure
/etc/network/interfaces)</li>
</ul>
</div>
<div class="section" id="update-nsm-config-files-to-reflect-the-new-ip-address">
<h4>Update NSM config files to reflect the new IP address<a class="headerlink" href="#update-nsm-config-files-to-reflect-the-new-ip-address" title="Permalink to this headline">¶</a></h4>
<p>To update NSM config files to reflect the new IP address, you have two
options:</p>
<ul class="simple">
<li>re-run the <code class="docutils literal notranslate"><span class="pre">SECOND</span></code> phase of Setup on all server/sensors
<code class="docutils literal notranslate"><span class="pre">(wiping</span> <span class="pre">all</span> <span class="pre">data</span> <span class="pre">and</span> <span class="pre">config)</span></code>
OR</li>
<li>manually update the IP address as shown below</li>
</ul>
</div>
<div class="section" id="files-to-update-when-changing-the-ip-address">
<h4>Files to update when changing the IP address<a class="headerlink" href="#files-to-update-when-changing-the-ip-address" title="Permalink to this headline">¶</a></h4>
<div class="section" id="changing-server-ip">
<h5>Changing Server IP<a class="headerlink" href="#changing-server-ip" title="Permalink to this headline">¶</a></h5>
<ul>
<li><p class="first">/etc/nsm/HOSTNAME-INTERFACE/http_agent.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">SERVER_HOST</span> <span class="p">[</span><span class="n">SERVER</span><span class="o">-</span><span class="n">IP</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">/etc/nsm/HOSTNAME-INTERFACE/pads_agent.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">SERVER_HOST</span> <span class="p">[</span><span class="n">SERVER</span><span class="o">-</span><span class="n">IP</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">/etc/nsm/HOSTNAME-INTERFACE/pcap_agent.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">SERVER_HOST</span> <span class="p">[</span><span class="n">SERVER</span><span class="o">-</span><span class="n">IP</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">/etc/nsm/HOSTNAME-INTERFACE/sancp_agent.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">SERVER_HOST</span> <span class="p">[</span><span class="n">SERVER</span><span class="o">-</span><span class="n">IP</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">/etc/nsm/HOSTNAME-INTERFACE/sensor.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SENSOR_SERVER_HOST</span><span class="o">=</span><span class="s2">&quot;[SERVER-IP]&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">/etc/nsm/HOSTNAME-INTERFACE/snort_agent-N.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">SERVER_HOST</span> <span class="p">[</span><span class="n">SERVER</span><span class="o">-</span><span class="n">IP</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">/etc/nsm/ossec/ossec_agent.conf:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">set</span> <span class="n">SERVER_HOST</span> <span class="p">[</span><span class="n">SERVER</span><span class="o">-</span><span class="n">IP</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">/root/.ssh/securityonion_ssh.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SERVERNAME</span><span class="o">=</span><span class="p">[</span><span class="n">SERVER</span><span class="o">-</span><span class="n">IP</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">/etc/salt/minion.d/onionsalt.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">master</span><span class="p">:</span> <span class="p">[</span><span class="n">SERVER</span><span class="o">-</span><span class="n">IP</span><span class="p">]</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="automating-the-change-of-the-server-ip">
<h5>Automating the change of the server IP<a class="headerlink" href="#automating-the-change-of-the-server-ip" title="Permalink to this headline">¶</a></h5>
<p>You may be able to use sed to update all files at once using something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">stop</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|OLD.SERVER.IP.ADDR|NEW.SERVER.IP.ADDR|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/*/*</span><span class="n">agent</span><span class="o">*</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/*/</span><span class="n">sensor</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">root</span><span class="o">/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">securityonion_ssh</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">minion</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">onionsalt</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-ntp"></span><div class="section" id="ntp">
<h3>NTP<a class="headerlink" href="#ntp" title="Permalink to this headline">¶</a></h3>
<p>Ubuntu configures its NTP service to pull time updates from the NTP Pool
Project and from ntp.ubuntu.com. From <code class="docutils literal notranslate"><span class="pre">/etc/ntp.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use servers from the NTP Pool Project. Approved by Ubuntu Technical Board</span>
<span class="c1"># on 2011-02-08 (LP: #104525). See http://www.pool.ntp.org/join.html for</span>
<span class="c1"># more information.</span>
<span class="n">server</span> <span class="mf">0.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">ntp</span><span class="o">.</span><span class="n">org</span>
<span class="n">server</span> <span class="mf">1.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">ntp</span><span class="o">.</span><span class="n">org</span>
<span class="n">server</span> <span class="mf">2.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">ntp</span><span class="o">.</span><span class="n">org</span>
<span class="n">server</span> <span class="mf">3.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">ntp</span><span class="o">.</span><span class="n">org</span>

<span class="c1"># Use Ubuntu&#39;s ntp server as a fallback.</span>
<span class="n">server</span> <span class="n">ntp</span><span class="o">.</span><span class="n">ubuntu</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<div class="section" id="modifying">
<h4>Modifying<a class="headerlink" href="#modifying" title="Permalink to this headline">¶</a></h4>
<p>You may want to change this default NTP config to use your preferred NTP provider. For more information, please see <a class="reference external" href="https://help.ubuntu.com/lts/serverguide/NTP.html">https://help.ubuntu.com/lts/serverguide/NTP.html</a>.</p>
</div>
<div class="section" id="ids-alerts">
<h4>IDS Alerts<a class="headerlink" href="#ids-alerts" title="Permalink to this headline">¶</a></h4>
<p>Anybody can join the NTP Pool Project and provide NTP service.
Occasionally, somebody provides NTP service from a residential DHCP
address that at some point in time may have also been used for TOR. This
results in IDS alerts for TOR nodes where the port is 123 (NTP). This is
another good reason to modify the NTP configuration to pull time updates
from your preferred NTP provider.</p>
</div>
</div>
</div>
</div>
<span id="document-tuning"></span><div class="section" id="tuning">
<h2>Tuning<a class="headerlink" href="#tuning" title="Permalink to this headline">¶</a></h2>
<p>To get the best performance out of Security Onion, you’ll want to tune it for your environment.  Start by creating Berkeley Packet Filters (BPFs) to ignore any traffic that you don’t want your network sensors to process.  Then tune your rulesets using PulledPork’s <code class="docutils literal notranslate"><span class="pre">disablesid.conf</span></code> and <code class="docutils literal notranslate"><span class="pre">modifysid.conf</span></code>.  There may be entire categories of rules that you want to disable first and then look at the remaining enabled rules to see if there are individual rules that can be disabled.  Once your ruleset is a manageable size, then look at tuning your alerts via Sguil’s autocat feature.  Once your rules and alerts are under control, then look at sostat to see if you have packet loss.  If so, then tune using PF-RING or AF-PACKET.  If you are on a large network, you may need to do additional tuning like pinning processes to CPU cores.  More information on each of these topics can be found in this section.</p>
<div class="toctree-wrapper compound">
<span id="document-bpf"></span><div class="section" id="bpf">
<h3>BPF<a class="headerlink" href="#bpf" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">BPF stands for Berkeley Packet Filter:</div>
<div class="line"><a class="reference external" href="https://en.wikipedia.org/wiki/Berkeley_Packet_Filter">https://en.wikipedia.org/wiki/Berkeley_Packet_Filter</a></div>
<div class="line"><a class="reference external" href="http://biot.com/capstats/bpf.html">http://biot.com/capstats/bpf.html</a></div>
</div>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<div class="section" id="global-bpf-conf">
<h5>Global bpf.conf<a class="headerlink" href="#global-bpf-conf" title="Permalink to this headline">¶</a></h5>
<p>You can specify your BPF in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/rules/bpf.conf</span></code> on your master
server and, by default, it will apply to
Snort/Suricata/Bro/netsniff-ng/prads on all interfaces in your entire
deployment. If you have separate sensors reporting to that master
server, they will copy <code class="docutils literal notranslate"><span class="pre">/etc/nsm/rules/bpf.conf</span></code> as part of the daily
rule-update cron job (or you can run it manually) which will also
restart Snort/Suricata so that the BPF change will take effect. Bro
automatically monitors <code class="docutils literal notranslate"><span class="pre">bpf.conf</span></code> for changes and will update itself
as needed. Other services (such as prads and netsniff-ng) will need to
be restarted manually for the change to take effect.</p>
</div>
<div class="section" id="granular-bpf-conf">
<h5>Granular bpf.conf<a class="headerlink" href="#granular-bpf-conf" title="Permalink to this headline">¶</a></h5>
<p>Each process on each interface has its own bpf file, but by default the
per-process bpf files are symlinked to the interface bpf and the
interface bpf is then symlinked to the global <code class="docutils literal notranslate"><span class="pre">bpf.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span>  <span class="n">root</span>     <span class="mi">8</span> <span class="n">Jan</span> <span class="mi">13</span> <span class="mi">21</span><span class="p">:</span><span class="mi">47</span> <span class="n">bpf</span><span class="o">-</span><span class="n">bro</span><span class="o">.</span><span class="n">conf</span> <span class="o">-&gt;</span> <span class="n">bpf</span><span class="o">.</span><span class="n">conf</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span>  <span class="n">root</span>    <span class="mi">23</span> <span class="n">Jan</span> <span class="mi">13</span> <span class="mi">21</span><span class="p">:</span><span class="mi">47</span> <span class="n">bpf</span><span class="o">.</span><span class="n">conf</span> <span class="o">-&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="n">bpf</span><span class="o">.</span><span class="n">conf</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span>  <span class="n">root</span>     <span class="mi">8</span> <span class="n">Jan</span> <span class="mi">13</span> <span class="mi">21</span><span class="p">:</span><span class="mi">47</span> <span class="n">bpf</span><span class="o">-</span><span class="n">ids</span><span class="o">.</span><span class="n">conf</span> <span class="o">-&gt;</span> <span class="n">bpf</span><span class="o">.</span><span class="n">conf</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span>  <span class="n">root</span>     <span class="mi">8</span> <span class="n">Jan</span> <span class="mi">13</span> <span class="mi">21</span><span class="p">:</span><span class="mi">47</span> <span class="n">bpf</span><span class="o">-</span><span class="n">pcap</span><span class="o">.</span><span class="n">conf</span> <span class="o">-&gt;</span> <span class="n">bpf</span><span class="o">.</span><span class="n">conf</span>
<span class="n">lrwxrwxrwx</span> <span class="mi">1</span> <span class="n">root</span>  <span class="n">root</span>     <span class="mi">8</span> <span class="n">Jan</span> <span class="mi">13</span> <span class="mi">21</span><span class="p">:</span><span class="mi">47</span> <span class="n">bpf</span><span class="o">-</span><span class="n">prads</span><span class="o">.</span><span class="n">conf</span> <span class="o">-&gt;</span> <span class="n">bpf</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>If you don’t want your sensors to inherit <code class="docutils literal notranslate"><span class="pre">bpf.conf</span></code> from the master
server and/or you need to specify a bpf per-interface or per-process,
you can simply replace the default symlink(s) with the desired bpf
file(s) and restart service(s) as necessary. For example, suppose you
want to apply a BPF to NIDS (Snort/Suricata) only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Remove the default NIDS BPF symlink</span>
<span class="n">sudo</span> <span class="n">rm</span> <span class="n">bpf</span><span class="o">-</span><span class="n">ids</span><span class="o">.</span><span class="n">conf</span>
<span class="c1"># Create a new NIDS BPF file and add your custom BPF</span>
<span class="n">sudo</span> <span class="n">vi</span> <span class="n">bpf</span><span class="o">-</span><span class="n">ids</span><span class="o">.</span><span class="n">conf</span>
<span class="c1"># Restart NIDS</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">nids</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="bpf-examples">
<h5>BPF Examples<a class="headerlink" href="#bpf-examples" title="Permalink to this headline">¶</a></h5>
<p>From Phillip Wang:</p>
<p>Just to contribute, and for others to reference, here are some examples
of what I’ve got working</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#Nothing from src host to dst port
!(src host xxx.xxx.xxx.xxx &amp;&amp; dst port 161) &amp;&amp;

#Nothing from src host to dst host and dst port
!(src host xxx.xxx.xxx.xxx &amp;&amp; dst host xxx.xxx.xxx.xxx &amp;&amp; dst port 80) &amp;&amp;

#Nothing to or from:
!(host xxx.xxx.xxx.xxx) &amp;&amp;

#Last entry has no final &amp;&amp;
!(host xxx.xxx.xxx.xxx)
</pre></div>
</div>
</div>
<div class="section" id="vlan">
<h5>VLAN<a class="headerlink" href="#vlan" title="Permalink to this headline">¶</a></h5>
<p>From Seth Hall regarding VLAN tags:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">host</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">53.254</span> <span class="ow">or</span> <span class="n">host</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">53.60</span> <span class="ow">or</span> <span class="n">host</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">53.69</span> <span class="ow">or</span> <span class="n">host</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">53.234</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="n">vlan</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">host</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">53.254</span> <span class="ow">or</span> <span class="n">host</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">53.60</span> <span class="ow">or</span> <span class="n">host</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">53.69</span> <span class="ow">or</span> <span class="n">host</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">53.234</span><span class="p">)))</span>
</pre></div>
</div>
<p>This amazingly works if you are only using it to restrict the traffic
passing through the filter. The basic template is…</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">your</span> <span class="nb">filter</span><span class="o">&gt;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">vlan</span> <span class="ow">and</span> <span class="o">&lt;</span><span class="n">your</span> <span class="nb">filter</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>Once the <code class="docutils literal notranslate"><span class="pre">vlan</span></code> tag is included in the filter, all subsequent
expressions to the right are shifted by four bytes so you need to
duplicate the filter on both sides of the vlan keyword. There are edge
cases where this will no longer work and probably edge cases where a few
undesired packets will make it though, but it should work in the example
case that you’ve given.</p>
<p>Also, I’m assuming that any tools you are running will support vlan tags
and no tags simultaneously. Bro 2.0 should work fine at least.</p>
</div>
<div class="section" id="troubleshooting-bpf-using-tcpdump">
<h5>Troubleshooting BPF using tcpdump<a class="headerlink" href="#troubleshooting-bpf-using-tcpdump" title="Permalink to this headline">¶</a></h5>
<p>If you need to troubleshoot BPF, you can use <code class="docutils literal notranslate"><span class="pre">tcpdump</span></code> as shown in the following articles.</p>
<p><a class="reference external" href="http://taosecurity.blogspot.com/2004/09/understanding-tcpdumps-d-option-have.html">http://taosecurity.blogspot.com/2004/09/understanding-tcpdumps-d-option-have.html</a></p>
<p><a class="reference external" href="http://taosecurity.blogspot.com/2004/12/understanding-tcpdumps-d-option-part-2.html">http://taosecurity.blogspot.com/2004/12/understanding-tcpdumps-d-option-part-2.html</a></p>
<p><a class="reference external" href="http://taosecurity.blogspot.com/2008/12/bpf-for-ip-or-vlan-traffic.html">http://taosecurity.blogspot.com/2008/12/bpf-for-ip-or-vlan-traffic.html</a></p>
</div>
</div>
</div>
<span id="document-rules"></span><div class="section" id="managing-rules">
<h3>Managing Rules<a class="headerlink" href="#managing-rules" title="Permalink to this headline">¶</a></h3>
<p>Rulesets are chosen during setup and are specified in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/pulledpork/pulledpork.conf</span></code>. If you change the configuration in <code class="docutils literal notranslate"><span class="pre">pulledpork.conf</span></code>, then you will need to run <code class="docutils literal notranslate"><span class="pre">rule-update</span></code>.  If in a server/sensor deployment, run <code class="docutils literal notranslate"><span class="pre">rule-update</span></code> on the master first, then the sensor (or simply wait up to 15 minutes for it to be replicated).</p>
<p>Security Onion offers the following choices for rulesets to be used by Snort/Suricata.</p>
<div class="section" id="et-open">
<h4>ET Open<a class="headerlink" href="#et-open" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>optimized for Suricata, but available for Snort as well</li>
<li><strong>free</strong></li>
</ul>
<div class="line-block">
<div class="line">For more information, see:</div>
<div class="line"><a class="reference external" href="https://rules.emergingthreats.net/open/">https://rules.emergingthreats.net/open/</a></div>
</div>
</div>
<div class="section" id="et-pro-proofpoint">
<h4>ET Pro (Proofpoint)<a class="headerlink" href="#et-pro-proofpoint" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>optimized for Suricata, but available for Snort as well</li>
<li>rules retrievable as released</li>
<li>license fee per sensor</li>
</ul>
<div class="line-block">
<div class="line">For more information, see:</div>
<div class="line"><a class="reference external" href="https://www.proofpoint.com/us/threat-insight/et-pro-ruleset">https://www.proofpoint.com/us/threat-insight/et-pro-ruleset</a></div>
</div>
</div>
<div class="section" id="snort-community">
<h4>Snort Community<a class="headerlink" href="#snort-community" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>optimized for Snort</li>
<li>community-contributed rules</li>
<li><strong>free</strong></li>
</ul>
<div class="line-block">
<div class="line">For more information, see:</div>
<div class="line"><a class="reference external" href="https://www.snort.org/downloads/#rule-downloads">https://www.snort.org/downloads/#rule-downloads</a></div>
<div class="line"><a class="reference external" href="https://www.snort.org/faq/what-are-community-rules">https://www.snort.org/faq/what-are-community-rules</a></div>
</div>
</div>
<div class="section" id="snort-registered">
<h4>Snort Registered<a class="headerlink" href="#snort-registered" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>optimized for Snort</li>
<li>Snort SO (Shared Object) rules will only work with Snort</li>
<li>same rules as Snort Subscriber ruleset, except rules only retrievable after 30 days past release</li>
<li><strong>free</strong></li>
</ul>
<div class="line-block">
<div class="line">For more information, see:</div>
<div class="line"><a class="reference external" href="https://www.snort.org/downloads/#rule-downloads">https://www.snort.org/downloads/#rule-downloads</a></div>
<div class="line"><a class="reference external" href="https://snort.org/documents/registered-vs-subscriber">https://snort.org/documents/registered-vs-subscriber</a></div>
</div>
</div>
<div class="section" id="snort-subscriber-talos">
<h4>Snort Subscriber (Talos)<a class="headerlink" href="#snort-subscriber-talos" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>optimized for Snort</li>
<li>Snort SO (Shared Object) rules will only work with Snort</li>
<li>rules retrievable as released</li>
<li>license fee per sensor</li>
</ul>
<div class="line-block">
<div class="line">For more information, see:</div>
<div class="line"><a class="reference external" href="https://www.snort.org/downloads/#rule-downloads">https://www.snort.org/downloads/#rule-downloads</a></div>
<div class="line"><a class="reference external" href="https://snort.org/documents/registered-vs-subscriber">https://snort.org/documents/registered-vs-subscriber</a></div>
</div>
</div>
</div>
<span id="document-local-rules"></span><div class="section" id="adding-local-rules">
<h3>Adding Local Rules<a class="headerlink" href="#adding-local-rules" title="Permalink to this headline">¶</a></h3>
<p>Adding local rules in Security Onion is a rather straightforward process. However, generating custom traffic to test the alert can sometimes be a challenge. Here, we will show you how to add the local rule and then use the python library scapy to trigger the alert.</p>
<div class="section" id="ips-policy">
<h4>IPS Policy<a class="headerlink" href="#ips-policy" title="Permalink to this headline">¶</a></h4>
<p>Please note if you are using a ruleset that enables an IPS policy in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/pulledpork/pulledpork.conf</span></code>, your local rules will be disabled. To enabled them, either revert the policy by remarking the <code class="docutils literal notranslate"><span class="pre">ips_policy</span></code> line (and run <code class="docutils literal notranslate"><span class="pre">rule-update</span></code>), or add the policy type to the rules in local.rules.</p>
<p>For example, if <code class="docutils literal notranslate"><span class="pre">ips_policy</span></code> was set to <code class="docutils literal notranslate"><span class="pre">security</span></code>, you would add the following to each rule:</p>
<p><code class="docutils literal notranslate"><span class="pre">metadata:policy</span> <span class="pre">security-ips</span></code></p>
<p>The whole rule would then look something like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp any any -&gt; $HOME_NET 7789 (msg: &quot;Vote for Security Onion Toolsmith Tool of 2011!&quot;; reference: url,http://holisticinfosec.blogspot.com/2011/12/choose-2011-toolsmith-tool-of-year.html; content: &quot;toolsmith&quot;; flow:to_server; nocase; sid:9000547; metadata:policy security-ips; rev:1)
</pre></div>
</div>
<p>These policy types can be found in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/rules/downloaded.rules</span></code>.</p>
</div>
<div class="section" id="steps">
<h4>Steps<a class="headerlink" href="#steps" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Open <code class="docutils literal notranslate"><span class="pre">/etc/nsm/rules/local.rules</span></code> using your favorite text editor.  If this is a distributed deployment, edit local.rules on your master server and it will replicate to your sensors.</p>
</li>
<li><p class="first">Let’s add a simple rule that will alert on the detection of a string in a tcp session.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp any any -&gt; $HOME_NET 7789 (msg: &quot;Vote for Security Onion Toolsmith Tool of 2011!&quot;; reference: url,http://holisticinfosec.blogspot.com/2011/12/choose-2011-toolsmith-tool-of-year.html; content: &quot;toolsmith&quot;; flow:to_server; nocase; sid:9000547; rev:1)
</pre></div>
</div>
</li>
<li><p class="first">Run rule-update (this will merge local.rules into downloaded.rules, update <code class="docutils literal notranslate"><span class="pre">sid-msg.map</span></code>, and restart snort/suricata and barnyard):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
</li>
<li><p class="first">If you built the rule correctly, then snort should be back up and running.</p>
</li>
<li><p class="first">Generate some traffic to trigger the alert. To generate traffic we are going to use the python library scapy to craft packets with specific information to ensure we trigger the alert with the information we want.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">scapy</span>
</pre></div>
</div>
</li>
<li><p class="first">Craft the layer 2 information.  The ip addresses can be random, but I would suggest sticking to RFC1918:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ip</span> <span class="o">=</span> <span class="n">IP</span><span class="p">()</span>
<span class="n">ip</span><span class="o">.</span><span class="n">dst</span> <span class="o">=</span> <span class="s2">&quot;192.168.200.4&quot;</span>
<span class="n">ip</span><span class="o">.</span><span class="n">src</span> <span class="o">=</span> <span class="s2">&quot;192.168.100.3&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Craft the layer 3 information  Since we specified port 7789 in our snort rule:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tcp</span> <span class="o">=</span> <span class="n">TCP</span><span class="p">()</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">dport</span> <span class="o">=</span> <span class="mi">7789</span>
<span class="n">tcp</span><span class="o">.</span><span class="n">sport</span> <span class="o">=</span> <span class="mi">1234</span>
</pre></div>
</div>
</li>
<li><p class="first">Set the playload:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">payload</span> <span class="o">=</span> <span class="s2">&quot;Toolsmith&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Use the / operator to compose our packet and transfer it with the send() method:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">send</span><span class="p">(</span><span class="n">ip</span><span class="o">/</span><span class="n">tcp</span><span class="o">/</span><span class="n">payload</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Check Sguil for the corresponding alert.</p>
</li>
<li><p class="first">You can see that we have an alert with the IP addresses we specified and the TCP ports we specified. If you right click on the <strong>Alert ID</strong> column you can select “Transcript” and verify the payload we sent.</p>
</li>
<li><p class="first">You can learn more about snort and writing snort signatures from the <a class="reference external" href="http://manual.snort.org/node26.html">Snort Manual</a>.</p>
</li>
<li><p class="first">You can learn more about scapy at  <a class="reference external" href="http://www.secdev.org/projects/scapy/">secdev.org</a> and <a class="reference external" href="http://itgeekchronicles.co.uk/2012/05/31/scapy-guide-the-release/">itgeekchronicles.co.uk</a>.</p>
</li>
</ul>
</div>
<div class="section" id="misp">
<h4>MISP<a class="headerlink" href="#misp" title="Permalink to this headline">¶</a></h4>
<p>If you would like to pull in NIDS rules from a MISP instance, please see the <a class="reference external" href="MISP">MISP Rules</a> section.</p>
</div>
</div>
<span id="document-alerts"></span><div class="section" id="managing-alerts">
<h3>Managing Alerts<a class="headerlink" href="#managing-alerts" title="Permalink to this headline">¶</a></h3>
<p>Security Onion generates a lot of valuable information for you the
second you plug it into a TAP or SPAN port. Between Bro logs, alert data
from Snort/Suricata, and full packet capture from netsniff-ng, you have,
in a very short amount of time, enough information to begin making
identifying areas of interest and making positive changes to your
security stance.</p>
<p>However, Network Security Monitoring, as a practice, is not a solution
you can plug into your network, make sure you see blinking lights and
tell people you are “secure.” It requires active intervention from an
analyst to qualify the quantity of information presented. One of those
regular interventions is to ensure that you are tuning properly and
proactively attempting to reach an acceptable level of signal to noise.</p>
<div class="section" id="testing-to-make-sure-the-ids-is-working">
<h4>Testing to make sure the IDS is working<a class="headerlink" href="#testing-to-make-sure-the-ids-is-working" title="Permalink to this headline">¶</a></h4>
<p>Below, we’ll provide a few ways we can test our IDS (Snort/Suricata) to
make sure it is working as expected.</p>
<ol class="arabic">
<li><p class="first">The easiest way to test might be simply accessing <code class="docutils literal notranslate"><span class="pre">testmyids.com</span></code>
from a machine who’s traffic is being monitored:</p>
<p><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">testmyids.com</span></code></p>
<div class="line-block">
<div class="line">We should see a corresponding alert
(<code class="docutils literal notranslate"><span class="pre">GPL</span> <span class="pre">ATTACK_RESPONSE</span> <span class="pre">id</span> <span class="pre">check</span> <span class="pre">returned</span> <span class="pre">root</span></code>) pop up in Sguil if
everything is</div>
<div class="line">configured correctly. If you do not see this alert, try checking to
see if the rule is enabled in</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">/etc/nsm/rules/downloaded.rules</span></code>. If it is not enabled, try
enabling it via <code class="docutils literal notranslate"><span class="pre">/etc/nsm/pulledpork/enablesid.conf</span></code> and</div>
<div class="line">run <code class="docutils literal notranslate"><span class="pre">rule-update</span></code> (if this is a distributed deployment, update
the master first, run <code class="docutils literal notranslate"><span class="pre">rule-update</span></code>, then push the</div>
<div class="line">changes out to the other sensor(s)).</div>
</div>
</li>
<li><p class="first">If running a test or evaluation version of Security Onion, consider
replaying some of the example PCAP files present in
<code class="docutils literal notranslate"><span class="pre">/opt/examples/</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">tcpreplay</span> <span class="pre">-i</span> <span class="pre">ens34</span> <span class="pre">-M10</span> <span class="pre">/opt/samples/*.pcap</span></code></p>
<p>Hits for various signatures should appear in Sguil.</p>
</li>
<li><p class="first">If in a production environment where you might not want to replay the
example PCAPs, another way to test would be to use Scapy to craft a
test PCAP file, in conjunction with a custom Snort rule added to
<code class="docutils literal notranslate"><span class="pre">/etc/nsm/rules/local.rules</span></code>:</p>
</li>
</ol>
<ul class="simple">
<li><strong>Snort Rule</strong></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">alert</span> <span class="n">tcp</span> <span class="nb">any</span> <span class="nb">any</span> <span class="o">-&gt;</span> <span class="nb">any</span> <span class="nb">any</span> <span class="p">(</span><span class="n">msg</span><span class="p">:</span> <span class="s2">&quot;Security Onion - testing&quot;</span><span class="p">;</span> <span class="n">content</span><span class="p">:</span> <span class="s2">&quot;SecurityOnion&quot;</span><span class="p">;</span> <span class="n">nocase</span><span class="p">;</span> <span class="n">sid</span><span class="p">:</span><span class="mi">1234567</span><span class="p">;)</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>(Run ``sudo rule-update`` after adding)
</pre></div>
</div>
<ul>
<li><p class="first"><strong>Scapy</strong></p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">scapy</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">pkt</span> <span class="pre">=</span> <span class="pre">Ether()/IP(dst=&quot;192.168.1.30&quot;)/TCP()/&quot;SecurityOnion&quot;</span></code>
(Press ENTER)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">wrpcap(&quot;so-testing.pcap&quot;,</span> <span class="pre">pkt)</span></code> (Press ENTER)</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">CTRL+D</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">tcpreplay</span> <span class="pre">-i</span> <span class="pre">ens34</span> <span class="pre">-M10</span> <span class="pre">so-testing.pcap</span></code></div>
</div>
<p>If everything went as planned, an alert should pop up in Sguil with
the message <code class="docutils literal notranslate"><span class="pre">Security</span> <span class="pre">Onion</span> <span class="pre">-</span> <span class="pre">testing</span></code></p>
</li>
</ul>
</div>
<div class="section" id="identifying-overly-active-signatures">
<h4>Identifying overly active signatures<a class="headerlink" href="#identifying-overly-active-signatures" title="Permalink to this headline">¶</a></h4>
<p>Given the large number of analyst tools available in Security Onion by
default there are multiple ways to see signatures that are producing too
many alerts. We’ll take a look at identifying the alerts using Squert,
Sguil, and the command line.</p>
</div>
<div class="section" id="from-squert">
<h4>From Squert<a class="headerlink" href="#from-squert" title="Permalink to this headline">¶</a></h4>
<p>You can access the Squert interface from a web browser using the URL:
<a class="reference external" href="https://IP_ADDRESS/squert/">https://IP_ADDRESS/squert/</a>. You will need to log in using the username
and password you set for Sguil. Click the Summary tab and then look at
the TOP SIGNATURES section.</p>
</div>
<div class="section" id="from-sguil">
<h4>From Sguil<a class="headerlink" href="#from-sguil" title="Permalink to this headline">¶</a></h4>
<p>Sguil is a powerhouse of an interface for alerts and we since it allows
us a more direct interaction with the database holding our alerts, we
can gain a little bit more insight into the alerts, the associated IPs,
and the rules in general.</p>
<p>Here, I have logged into the sguil interface and clicked on the “CNT”
column to sort the alerts by the number of correlated alerts.</p>
<p><img alt="images/managing-rules/securityonion-sguil-02.png" src="_images/securityonion-sguil-02.png" /></p>
</div>
<div class="section" id="from-the-command-line">
<h4>From the Command Line<a class="headerlink" href="#from-the-command-line" title="Permalink to this headline">¶</a></h4>
<p>If there are a large number of uncategorized events in the
securityonion_db database, sguil can have a hard time of managing the
vast amount of data it needs to process to present a comprehensive
overview of the alerts.</p>
<p>At those times, it can be useful to query the database from the
commandline. Interacting with the mysql database directly demands
caution. Issuing SELECT queries should not have any adverse effect on
your database, but if you attempt to UPDATE while the various NSM
framework tools are also accessing the database it has the potential to
introduce corruption.</p>
<div class="line-block">
<div class="line">You can enter the mysql shell or issue mysql one-liner’s from the
command line.</div>
<div class="line">To enter the mysql shell, issue the following command</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">Dsecurityonion_db</span>
</pre></div>
</div>
<p>To issue commandline one-liners use the following template</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">Dsecurityonion_db</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;QUERY&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="listing-the-top-twenty-signatures">
<h4>Listing the top twenty signatures<a class="headerlink" href="#listing-the-top-twenty-signatures" title="Permalink to this headline">¶</a></h4>
<p>Giving the following query to mysql will return a table much like you
see below. Here, we are asking mysql to return the columns “signature
and signature_id” as well as a count of each row returned. We also want
the output grouped by the signature message and ordered by the count
(cnt) in descending order.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">AS</span> <span class="n">cnt</span><span class="p">,</span> <span class="n">signature</span><span class="p">,</span> <span class="n">signature_id</span> <span class="n">FROM</span> <span class="n">event</span> <span class="n">WHERE</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">signature</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">cnt</span> <span class="n">DESC</span> <span class="n">LIMIT</span> <span class="mi">20</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+--------+----------------------------------------------------------------------------------+--------------+</span>
<span class="o">|</span> <span class="n">cnt</span>    <span class="o">|</span> <span class="n">signature</span>                                                                        <span class="o">|</span> <span class="n">signature_id</span> <span class="o">|</span>
<span class="o">+--------+----------------------------------------------------------------------------------+--------------+</span>
<span class="o">|</span> <span class="mi">900286</span> <span class="o">|</span> <span class="n">GPL</span> <span class="n">SNMP</span> <span class="n">public</span> <span class="n">access</span> <span class="n">udp</span>                                                       <span class="o">|</span>      <span class="mi">2101411</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">4709</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">POLICY</span> <span class="n">Dropbox</span><span class="o">.</span><span class="n">com</span> <span class="n">Offsite</span> <span class="n">File</span> <span class="n">Backup</span> <span class="ow">in</span> <span class="n">Use</span>                                 <span class="o">|</span>      <span class="mi">2012647</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">2334</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">POLICY</span> <span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span> <span class="n">APT</span> <span class="n">User</span><span class="o">-</span><span class="n">Agent</span> <span class="n">Outbound</span> <span class="n">likely</span> <span class="n">related</span> <span class="n">to</span> <span class="n">package</span> <span class="n">management</span> <span class="o">|</span>      <span class="mi">2013504</span> <span class="o">|</span>
<span class="o">|</span>   <span class="mi">1169</span> <span class="o">|</span> <span class="n">GPL</span> <span class="n">SHELLCODE</span> <span class="n">x86</span> <span class="n">inc</span> <span class="n">ebx</span> <span class="n">NOOP</span>                                                   <span class="o">|</span>         <span class="mi">1390</span> <span class="o">|</span>
<span class="o">|</span>    <span class="mi">464</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">POLICY</span> <span class="n">Dropbox</span> <span class="n">Client</span> <span class="n">Broadcasting</span>                                            <span class="o">|</span>      <span class="mi">2012648</span> <span class="o">|</span>
<span class="o">|</span>    <span class="mi">343</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">POLICY</span> <span class="n">iTunes</span> <span class="n">User</span> <span class="n">Agent</span>                                                      <span class="o">|</span>      <span class="mi">2002878</span> <span class="o">|</span>
<span class="o">|</span>    <span class="mi">270</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">POLICY</span> <span class="n">Executable</span> <span class="n">served</span> <span class="kn">from</span> <span class="nn">Amazon</span> <span class="n">S3</span>                                       <span class="o">|</span>      <span class="mi">2013437</span> <span class="o">|</span>
<span class="o">|</span>    <span class="mi">216</span> <span class="o">|</span> <span class="p">[</span><span class="n">OSSEC</span><span class="p">]</span> <span class="n">New</span> <span class="n">dpkg</span> <span class="p">(</span><span class="n">Debian</span> <span class="n">Package</span><span class="p">)</span> <span class="n">installed</span><span class="o">.</span>                                     <span class="o">|</span>         <span class="mi">2902</span> <span class="o">|</span>
<span class="o">|</span>    <span class="mi">191</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">RBN</span> <span class="n">Known</span> <span class="n">Russian</span> <span class="n">Business</span> <span class="n">Network</span> <span class="n">IP</span> <span class="n">TCP</span> <span class="p">(</span><span class="mi">214</span><span class="p">)</span>                               <span class="o">|</span>      <span class="mi">2406426</span> <span class="o">|</span>
<span class="o">|</span>    <span class="mi">188</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">POLICY</span> <span class="n">curl</span> <span class="n">User</span><span class="o">-</span><span class="n">Agent</span> <span class="n">Outbound</span>                                               <span class="o">|</span>      <span class="mi">2013028</span> <span class="o">|</span>
<span class="o">|</span>    <span class="mi">119</span> <span class="o">|</span> <span class="p">[</span><span class="n">OSSEC</span><span class="p">]</span> <span class="n">Integrity</span> <span class="n">checksum</span> <span class="n">changed</span><span class="o">.</span>                                              <span class="o">|</span>          <span class="mi">550</span> <span class="o">|</span>
<span class="o">|</span>    <span class="mi">106</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">GAMES</span> <span class="n">STEAM</span> <span class="n">Connection</span> <span class="p">(</span><span class="n">v2</span><span class="p">)</span>                                                   <span class="o">|</span>      <span class="mi">2003089</span> <span class="o">|</span>
<span class="o">|</span>     <span class="mi">84</span> <span class="o">|</span> <span class="n">GPL</span> <span class="n">ICMP_INFO</span> <span class="n">PING</span> <span class="o">*</span><span class="n">NIX</span>                                                          <span class="o">|</span>      <span class="mi">2100366</span> <span class="o">|</span>
<span class="o">|</span>     <span class="mi">69</span> <span class="o">|</span> <span class="n">GPL</span> <span class="n">CHAT</span> <span class="n">MISC</span> <span class="n">Jabber</span><span class="o">/</span><span class="n">Google</span> <span class="n">Talk</span> <span class="n">Outgoing</span> <span class="n">Traffic</span>                                <span class="o">|</span>    <span class="mi">100000230</span> <span class="o">|</span>
<span class="o">|</span>     <span class="mi">65</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">CHAT</span> <span class="n">Google</span> <span class="n">IM</span> <span class="n">traffic</span> <span class="n">Jabber</span> <span class="n">client</span> <span class="n">sign</span><span class="o">-</span><span class="n">on</span>                                  <span class="o">|</span>      <span class="mi">2002334</span> <span class="o">|</span>
<span class="o">|</span>     <span class="mi">59</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">CHAT</span> <span class="n">Google</span> <span class="n">Talk</span> <span class="p">(</span><span class="n">Jabber</span><span class="p">)</span> <span class="n">Client</span> <span class="n">Login</span>                                        <span class="o">|</span>      <span class="mi">2002327</span> <span class="o">|</span>
<span class="o">|</span>     <span class="mi">56</span> <span class="o">|</span> <span class="p">[</span><span class="n">OSSEC</span><span class="p">]</span> <span class="n">Attempt</span> <span class="n">to</span> <span class="n">login</span> <span class="n">using</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">existent</span> <span class="n">user</span>                               <span class="o">|</span>         <span class="mi">5710</span> <span class="o">|</span>
<span class="o">|</span>     <span class="mi">47</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">SCAN</span> <span class="n">Potential</span> <span class="n">SSH</span> <span class="n">Scan</span> <span class="n">OUTBOUND</span>                                              <span class="o">|</span>      <span class="mi">2003068</span> <span class="o">|</span>
<span class="o">|</span>     <span class="mi">44</span> <span class="o">|</span> <span class="n">ET</span> <span class="n">SCAN</span> <span class="n">Potential</span> <span class="n">SSH</span> <span class="n">Scan</span>                                                       <span class="o">|</span>      <span class="mi">2001219</span> <span class="o">|</span>
<span class="o">|</span>     <span class="mi">38</span> <span class="o">|</span> <span class="n">GPL</span> <span class="n">ICMP_INFO</span> <span class="n">PING</span> <span class="n">BSDtype</span>                                                       <span class="o">|</span>      <span class="mi">2100368</span> <span class="o">|</span>
<span class="o">+--------+----------------------------------------------------------------------------------+--------------+</span>
<span class="mi">20</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">32.65</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<p>Again we can see that the top signature is the “GPL SNMP public access
udp” alert and here we can see there are over 900,000 uncategorized
events. Not only will the processing of these uncategorized events slow
our use of tools they will cost the analyst time which could be better
used in responding to alerts of greater significance.</p>
<p>If we’re going to take action on this alert, it’s best to ensure that
these alerts are benign as part of our tuning process. See which
machines generated these alerts can be helpful in making that decision.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">AS</span> <span class="n">ip_cnt</span><span class="p">,</span> <span class="n">INET_NTOA</span><span class="p">(</span><span class="n">src_ip</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">event</span> <span class="n">WHERE</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span> <span class="n">AND</span> <span class="n">signature_id</span><span class="o">=</span><span class="mi">2101411</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">src_ip</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">ip_cnt</span> <span class="n">DESC</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+--------+-------------------+</span>
<span class="o">|</span> <span class="n">ip_cnt</span> <span class="o">|</span> <span class="n">INET_NTOA</span><span class="p">(</span><span class="n">src_ip</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+--------+-------------------+</span>
<span class="o">|</span> <span class="mi">824459</span> <span class="o">|</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">42.109</span>     <span class="o">|</span>
<span class="o">|</span>  <span class="mi">41643</span> <span class="o">|</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">42.250</span>     <span class="o">|</span>
<span class="o">|</span>  <span class="mi">33732</span> <span class="o">|</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">42.140</span>     <span class="o">|</span>
<span class="o">|</span>    <span class="mi">452</span> <span class="o">|</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">42.137</span>     <span class="o">|</span>
<span class="o">+--------+-------------------+</span>
<span class="mi">4</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">9.60</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
<p>We can gather a little more information by using a query that also
returns the destination IP address as well.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">as</span> <span class="n">ip_cnt</span><span class="p">,</span> <span class="n">INET_NTOA</span><span class="p">(</span><span class="n">src_ip</span><span class="p">),</span> <span class="n">INET_NTOA</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">)</span> <span class="n">FROM</span> <span class="n">event</span> <span class="n">WHERE</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">signature_id</span><span class="o">=</span><span class="mi">2101411</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">dst_ip</span> <span class="n">ORDER</span> <span class="n">BY</span> <span class="n">ip_cnt</span> <span class="n">DESC</span><span class="p">;</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">+--------+-------------------+-------------------+</span>
<span class="o">|</span> <span class="n">ip_cnt</span> <span class="o">|</span> <span class="n">INET_NTOA</span><span class="p">(</span><span class="n">src_ip</span><span class="p">)</span> <span class="o">|</span> <span class="n">INET_NTOA</span><span class="p">(</span><span class="n">dst_ip</span><span class="p">)</span> <span class="o">|</span>
<span class="o">+--------+-------------------+-------------------+</span>
<span class="o">|</span> <span class="mi">858191</span> <span class="o">|</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">42.109</span>     <span class="o">|</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.33</span>      <span class="o">|</span>
<span class="o">|</span>  <span class="mi">41643</span> <span class="o">|</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">42.250</span>     <span class="o">|</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">0.31</span>      <span class="o">|</span>
<span class="o">|</span>    <span class="mi">226</span> <span class="o">|</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">42.137</span>     <span class="o">|</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">200.5</span>     <span class="o">|</span>
<span class="o">|</span>    <span class="mi">226</span> <span class="o">|</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">42.137</span>     <span class="o">|</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">200.51</span>    <span class="o">|</span>
<span class="o">+--------+-------------------+-------------------+</span>
<span class="mi">4</span> <span class="n">rows</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">9.65</span> <span class="n">sec</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="identifying-rule-categories">
<h4>Identifying rule categories<a class="headerlink" href="#identifying-rule-categories" title="Permalink to this headline">¶</a></h4>
<p>Both the Snort Subscriber (Talos) and the Emerging Threats rulesets come
with a large number of rules enabled (over 15,000 by default). You
should only run the rules necessary for your environment. So you may
want to disable entire categories of rules that don’t apply to you. Run
the following command to get a listing of categories and the number of
rules in each:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cut -d\&quot; -f2 /etc/nsm/rules/downloaded.rules | grep -v &quot;^$&quot; | grep -v &quot;^#&quot; | awk &#39;{print $1, $2}&#39;|sort |uniq -c |sort -nr
</pre></div>
</div>
<div class="line-block">
<div class="line">Also see:</div>
<div class="line"><a class="reference external" href="https://github.com/shirkdog/pulledpork/blob/master/doc/README.CATEGORIES">https://github.com/shirkdog/pulledpork/blob/master/doc/README.CATEGORIES</a></div>
</div>
</div>
<div class="section" id="recovering-from-too-many-alerts">
<h4>Recovering from too many alerts<a class="headerlink" href="#recovering-from-too-many-alerts" title="Permalink to this headline">¶</a></h4>
<p>Sometimes we may get flooded with a barrage of alerts that make it difficult or not possible to categorize within Sguil or Squert. When this happens, we can perform mass categorization of alerts using MySQL on the master server, where sguild (the Sguil server) runs. The steps below outline an example of this:</p>
<ul>
<li><div class="first line-block">
<div class="line">Stop the Sguil server:</div>
</div>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">List the top twenty signatures (descending) pertaining to
uncategorized alerts (with a status of <code class="docutils literal notranslate"><span class="pre">0</span></code>):</div>
</div>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">Dsecurityonion_db</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;SELECT COUNT(signature)as count, signature FROM event WHERE status=0 GROUP BY signature ORDER BY count DESC LIMIT 20;&#39;</span>
</pre></div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">Update any records (to have a status value of <code class="docutils literal notranslate"><span class="pre">1</span></code>) with a
signature that contains the text <code class="docutils literal notranslate"><span class="pre">ET</span> <span class="pre">INFO</span></code>:</div>
</div>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">Dsecurityonion_db</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;UPDATE event SET status=1, last_modified=&#39;2018-06-27 01:00:00&#39;, last_uid=&#39;sguil&#39; WHERE event.status=&#39;0&#39; and event.signature LIKE &#39;</span><span class="si">%E</span><span class="s2">T INFO%&#39;;&quot;</span>
</pre></div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">Check again to see if our alerts have been categorized as
<code class="docutils literal notranslate"><span class="pre">acknowledged</span></code> ( these should no longer be visible in the
output):</div>
</div>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">Dsecurityonion_db</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;SELECT COUNT(signature)as count, signature FROM event WHERE status=0 GROUP BY signature ORDER BY count DESC LIMIT 20;&#39;</span>
</pre></div>
</div>
<ul>
<li><div class="first line-block">
<div class="line">Bring the Sguil server back up:</div>
</div>
</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Adapted from:</div>
<div class="line"><a class="reference external" href="https://taosecurity.blogspot.com/2013/02/recovering-from-suricata-gone-wild.html">https://taosecurity.blogspot.com/2013/02/recovering-from-suricata-gone-wild.html</a></div>
</div>
</div>
<div class="section" id="so-what-s-next">
<h4>So what’s next?<a class="headerlink" href="#so-what-s-next" title="Permalink to this headline">¶</a></h4>
<p>Firstly, in tuning your sensor, you must understand whether or not taking corrective actions on this signature will lower your overall security stance. For some alerts, your understanding of your own network and the business being transacted across it will be the deciding factor. If you don’t care that users are accessing facebook, you can silence the policy-based signatures that will generate alerts.</p>
<p>This signature, sid:1411, /is/ a useful signature to have on hand. Attackers will often search for SNMP enabled devices with default community strings in their attempts to pivot to other parts of the network. In this case, I know the alerts are being generated by benign traffic but I cannot guarantee that further alerts will be.</p>
<p>Another consideration to take into mind is determine whether or not the traffic is being generated by a misconfigured piece of equipment. If so, the most expedient measure is to correctly configure said equipment and then reinvestigate tuning.</p>
<p>There are multiple ways to handle overly productive signatures and we’ll try to cover as many as we can without producing a full novel on the subject.</p>
</div>
<div class="section" id="disable-the-sid">
<h4>Disable the sid<a class="headerlink" href="#disable-the-sid" title="Permalink to this headline">¶</a></h4>
<p>Security Onion uses <a class="reference external" href="https://github.com/shirkdog/pulledpork">PulledPork</a> to download new signatures every night and process them against a set list of user generated configurations.</p>
<p>In a Server/Slave Security Onion environment, you only need to change the configuration file on the server and the rule-update script will sync with the signatures from the Server.</p>
<p>As mentioned before, take care in disabling signatures as it can be likely that a more appropriate response is warranted.</p>
<ul>
<li><p class="first">Edit the disablesid.conf configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">pulledpork</span><span class="o">/</span><span class="n">disablesid</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</li>
<li><p class="first">Append the signature you wish to disable in the format gid:sid. The
generator ID is most likely going to be a “1” in most cases. You can
check the generator ID by checking the exact signature. If a gid is
not listed, it is assumed to be “1”.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Disable the GPL SNMP public access udp signature</span>
<span class="mi">1</span><span class="p">:</span><span class="mi">2101411</span>
</pre></div>
</div>
</li>
<li><p class="first">Run the rule update on the master server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
</li>
<li><p class="first">If you’re running salt on your distributed deployment, then the
ruleset will replicate to your sensors automatically within 15
minutes. If you’re not running salt, then you can run rule-update on
the slave machines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="disable-the-category">
<h4>Disable the category<a class="headerlink" href="#disable-the-category" title="Permalink to this headline">¶</a></h4>
<p>In <code class="docutils literal notranslate"><span class="pre">/etc/nsm/pulledpork/disablesid.conf</span></code>, instead of providing a sid,
we can use a PCRE (Perl-compatible regular expression) or refer to the
rule category (found in the header above the rule grouping in
<code class="docutils literal notranslate"><span class="pre">/etc/nsm/rules/downloaded.rules</span></code>).</p>
<p>For example, if we wanted to disable the entire ET-emerging-misc
category, we could do so by putting the following in
<code class="docutils literal notranslate"><span class="pre">/etc/nsm/pulledpork/disablesid.conf</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">ET-emerging-misc</span></code></p>
<p>If we wanted to disable all rules with <code class="docutils literal notranslate"><span class="pre">ET</span> <span class="pre">MISC</span></code> in the rule
description, we could put the following in
<code class="docutils literal notranslate"><span class="pre">/etc/nsm/pulledpork/disablesid.conf</span></code>:</p>
<p><code class="docutils literal notranslate"><span class="pre">pcre:ET</span> <span class="pre">MISC</span></code></p>
<p>Of course, after making changes to the file, if we want our changes to
take effect immediately, we will need to run <code class="docutils literal notranslate"><span class="pre">rule-update</span></code> on the
master server, and then on all remaining sensors.</p>
</div>
<div class="section" id="modifysid-conf">
<h4>modifysid.conf<a class="headerlink" href="#modifysid-conf" title="Permalink to this headline">¶</a></h4>
<p>PulledPork’s modifysid.conf will allow you to write modifications to
rules that are applied every time PulledPork downloads the latest
ruleset. There are several examples in the modifysid.conf file, so we
won’t repeat them here. Edit the modifysid.conf configuration file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">pulledpork</span><span class="o">/</span><span class="n">modifysid</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Then run rule-update:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
</div>
<div class="section" id="rewrite-the-signature">
<h4>Rewrite the signature<a class="headerlink" href="#rewrite-the-signature" title="Permalink to this headline">¶</a></h4>
<p>In some cases, you may not want to use Pulledpork’s modifysid.conf, but
instead create a copy of the rule and disable the original. In Security
Onion, locally created rules are stored in /etc/nsm/rules/local.rules</p>
<ul>
<li><p class="first">Edit the /etc/nsm/rules/local.rules file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="n">local</span><span class="o">.</span><span class="n">rules</span>
</pre></div>
</div>
</li>
<li><p class="first">Snort rules are incredibly flexible, this is a bird’s eye view of the
rule format:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Action</span> <span class="n">Protocol</span> <span class="n">SrcIP</span> <span class="n">SrcPort</span> <span class="n">Direction</span> <span class="n">DestIP</span> <span class="n">DestPort</span> <span class="p">(</span><span class="n">rule</span> <span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p class="first">Here is the rule that has been generating so many alerts on our
sensor(s)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>macphisto@SecOnion-Dev:~$ grep -i &quot;GPL SNMP public access udp&quot; /etc/nsm/rules/downloaded.rules
 alert udp $EXTERNAL_NET any -&gt; $HOME_NET 161 (msg:&quot;GPL SNMP public access udp&quot;; content:&quot;public&quot;; fast_pattern:only; reference:bugtraq,2112; reference:bugtraq,4088; reference:bugtraq,4089; reference:cve,1999-0517; reference:cve,2002-0012; reference:cve,2002-0013; classtype:attempted-recon; sid:2101411; rev:11;)
</pre></div>
</div>
</li>
<li><p class="first">We can rewrite the rule so it’s a little less active. We will rewrite
the rule to ignore this kind of alert if the destination is any of
the hosts we’ve identified.</p>
</li>
<li><p class="first">For starters let’s create some variables in
/etc/nsm/rules/local.rules to define the traffic. First we’re going
to define a variable for our called overactive hosts called
OVERACTIVE</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">OVERACTIVE</span> <span class="p">[</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">0.31</span><span class="p">,</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">0.33</span><span class="p">,</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">0.51</span><span class="p">]</span>
</pre></div>
</div>
</li>
<li><p class="first">We can plug this information into our snort rule format,</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert udp $HOME_NET any -&gt; !$OVERACTIVE any (msg:&quot;GPL SNMP public access udp&quot;; content:&quot;public&quot;; fast_pattern:only; reference:bugtraq,2112; reference:bugtraq,4088; reference:bugtraq,4089; reference:cve,1999-0517; reference:cve,2002-0012; reference:cve,2002-0013; classtype:attempted-recon; sid:9001411; rev:1;)
</pre></div>
</div>
</li>
<li><p class="first">We also gave the alert a unique signature id (sid) by bumping it into
the 90,000,000 range and set the revision to 1.</p>
</li>
<li><p class="first">Now that we have a signature that will generate alerts a little more
selectively, we need to disable the original signature. Like above,
we edit the disablesid.conf file and add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">:</span><span class="mi">2101411</span>
</pre></div>
</div>
</li>
<li><p class="first">Run a rule update:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="threshold">
<h4>Threshold<a class="headerlink" href="#threshold" title="Permalink to this headline">¶</a></h4>
<p>See <code class="docutils literal notranslate"><span class="pre">/etc/nsm/rules/threshold.conf</span></code> for more information and examples.</p>
</div>
<div class="section" id="suppressions">
<h4>Suppressions<a class="headerlink" href="#suppressions" title="Permalink to this headline">¶</a></h4>
<p>A suppression rule allows you to make some finer grained decisions about certain rules without the onus of rewriting them. With this functionality we can suppress rules based on their signature, the source or destination address and even the IP or full CIDR network block. This way, you still have the basic ruleset, but the situations in which they fire are altered. It’s important to note that with this functionality, care should be given to the suppressions being written to make sure they do not suppress legitimate alerts.</p>
<p>Sticking with our current example of disabling the <code class="docutils literal notranslate"><span class="pre">GPL</span> <span class="pre">SNMP</span> <span class="pre">public</span> <span class="pre">access</span> <span class="pre">udp</span></code> alert we can build a suppression rule that limits this signature from firing for machines in which this behavior is deemed acceptable. For example, you would often see this rule firing rapidly for any service that queries SNMP on a regular basic. Services like Nagios produce a great many of these alerts. In this example, we will operate on the following known information:</p>
<table border="1" class="docutils">
<colgroup>
<col width="55%" />
<col width="45%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Source IP Address</th>
<th class="head">172.16.42.109</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Generator ID</td>
<td>1</td>
</tr>
<tr class="row-odd"><td>Signature ID</td>
<td>2101411</td>
</tr>
</tbody>
</table>
<p>The format for a suppression is very straight forward. Below is the basic format for a suppression with the configurable areas marked in bold text.</p>
<p>suppress gen_id <strong>gen-id</strong>, sig_id <strong>sid-id</strong>, track
<strong>[by_src|by_dst]</strong>, ip <strong>IP/MASK-BITS</strong></p>
<p>We can simply transplant the known information for the bold text above and place the following in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/rules/threshold.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">suppress</span> <span class="n">gen_id</span> <span class="mi">1</span><span class="p">,</span> <span class="n">sig_id</span> <span class="mi">2101411</span><span class="p">,</span> <span class="n">track</span> <span class="n">by_src</span><span class="p">,</span> <span class="n">ip</span> <span class="mf">172.16</span><span class="o">.</span><span class="mf">42.109</span>
</pre></div>
</div>
<p>Once the correct suppression has been placed in <code class="docutils literal notranslate"><span class="pre">threshold.conf</span></code>, restart the alert engine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">nids</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="autocategorize-events">
<h4>Autocategorize events<a class="headerlink" href="#autocategorize-events" title="Permalink to this headline">¶</a></h4>
<p>The sguild server can be set to autocategorize events as it processes them. This is a great way to have sguil process the events for us as it sees them, saving us from any laborious categorization. In the Sguil console, you can create an autocat by right-clicking the event status or by clicking File -&gt; Autocat.  In Squert, you can click the Autocat icon in the upper right corner.</p>
</div>
<div class="section" id="why-is-pulledpork-ignoring-disabled-rules-in-downloaded-rules">
<h4>Why is pulledpork ignoring disabled rules in downloaded.rules<a class="headerlink" href="#why-is-pulledpork-ignoring-disabled-rules-in-downloaded-rules" title="Permalink to this headline">¶</a></h4>
<p>If your syntax is correct, you are likely trying to disable a rule that has flowbits set. For a quick primer on flowbits see <a class="reference external" href="http://blog.snort.org/2011/05/resolving-flowbit-dependancies.html">http://blog.snort.org/2011/05/resolving-flowbit-dependancies.html</a> and section 3.6.10 of the Snort Manual (<a class="reference external" href="http://www.snort.org/docs">http://www.snort.org/docs</a>).</p>
<p>Let’s look at the following rules using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>alert tcp $HOME_NET any -&gt; $EXTERNAL_NET !1433 (msg:&quot;ET POLICY Outbound MSSQL Connection to Non-Standard Port - Likely Malware&quot;; flow:to_server,established; content:&quot;|12 01 00|&quot;; depth:3; content:&quot;|00 00 00 00 00 00 15 00 06 01 00 1b 00 01 02 00 1c 00|&quot;; distance:1; within:18; content:&quot;|03 00|&quot;; distance:1; within:2; content:&quot;|00 04 ff 08 00 01 55 00 00 00|&quot;; distance:1; within:10; flowbits:set,ET.MSSQL; classtype:bad-unknown; sid:2013409; rev:3;)

alert tcp $HOME_NET any -&gt; $EXTERNAL_NET 1433 (msg:&quot;ET POLICY Outbound MSSQL Connection to Standard port (1433)&quot;; flow:to_server,established; content:&quot;|12 01 00|&quot;; depth:3; content:&quot;|00 00 00 00 00 00 15 00 06 01 00 1b 00 01 02 00 1c 00|&quot;; distance:1; within:18; content:&quot;|03 00|&quot;; distance:1; within:2; content:&quot;|00 04 ff 08 00 01 55 00 00 00|&quot;; distance:1; within:10; flowbits:set,ET.MSSQL; classtype:bad-unknown; sid:2013410; rev:4;)

alert tcp $HOME_NET any -&gt; $EXTERNAL_NET !1433 (msg:&quot;ET TROJAN Bancos.DV MSSQL CnC Connection Outbound&quot;; flow:to_server,established; flowbits:isset,ET.MSSQL; content:&quot;|49 00 B4 00 4D 00 20 00 54 00 48 00 45 00 20 00 4D 00 41 00 53 00 54 00 45 00 52 00|&quot;; classtype:trojan-activity; sid:2013411; rev:1;)
</pre></div>
</div>
<p>If you try to disable the first two rules without disabling the third rule (which has “flowbits:isset…) the third rule could never fire due to one of the first two rules needing to fire first. Pulled Pork (helpfully) resolves all of your flowbit dependencies, and in this case, is “re-enabling” that rule for you on the fly. Disabling all three of those rules by adding the following to disablesid.conf has the obvious negative effect of disabling all three of the rules:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="p">:</span><span class="mi">2013409</span>
<span class="mi">1</span><span class="p">:</span><span class="mi">2013410</span>
<span class="mi">1</span><span class="p">:</span><span class="mi">2013411</span>
</pre></div>
</div>
<p>When you run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">rule-update</span></code>, watch the “Setting Flowbit State…” section and you can see that if you disable all three (or however many rules share that flowbit) that the “Enabled XX flowbits” line is decrimented and all three rules should then be disabled in your <code class="docutils literal notranslate"><span class="pre">downloaded.rules</span></code>.</p>
</div>
<div class="section" id="sguil-days-to-keep">
<h4>Sguil Days To Keep<a class="headerlink" href="#sguil-days-to-keep" title="Permalink to this headline">¶</a></h4>
<p>You can configure Sguil’s database retention by editing securityonion.conf and changing the <code class="docutils literal notranslate"><span class="pre">DAYSTOKEEP</span></code> setting (the default is 30 days):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">securityonion</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>You can also use this setting to perform a Sguil database purge by lowering the <code class="docutils literal notranslate"><span class="pre">DAYSTOKEEP</span></code> variable to a small number (like 7 or 1) and manually running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sguil</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">purge</span>
</pre></div>
</div>
</div>
</div>
<span id="document-pf-ring"></span><div class="section" id="pf-ring">
<h3>PF-RING<a class="headerlink" href="#pf-ring" title="Permalink to this headline">¶</a></h3>
<p>PF-RING acts as a flow-based load balancer to allow us to spin up multiple instances of Snort/Suricata/Bro to handle more traffic than a single instance.</p>
<p>Starting in <code class="docutils literal notranslate"><span class="pre">securityonion-setup</span> <span class="pre">-</span> <span class="pre">20120912-0ubuntu0securityonion285</span></code>, running Setup will configure Suricata and Bro to use <a class="reference external" href="AF-PACKET">AF-PACKET</a> instead of PF-RING.</p>
<div class="section" id="tuning">
<h4>Tuning<a class="headerlink" href="#tuning" title="Permalink to this headline">¶</a></h4>
<p>If you want to change the number of PF-RING instances after running Setup, you can do the following.</p>
</div>
<div class="section" id="snort-suricata">
<h4>Snort/Suricata<a class="headerlink" href="#snort-suricata" title="Permalink to this headline">¶</a></h4>
<p>To change the number of PF-RING instances for Snort or Suricata:</p>
<ul>
<li><p class="first">Stop sensor processes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
</li>
<li><p class="first">Edit <code class="docutils literal notranslate"><span class="pre">/etc/nsm/$HOSTNAME-$INTERFACE/sensor.conf</span></code> and change the <code class="docutils literal notranslate"><span class="pre">IDS_LB_PROCS</span></code> variable to desired number of cores.</p>
</li>
<li><p class="first">Start sensor processes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</li>
</ul>
<p>If running Snort, <code class="docutils literal notranslate"><span class="pre">so-sensor-start</span></code> automatically spawns <code class="docutils literal notranslate"><span class="pre">$IDS_LB_PROCS</span></code> instances of Snort (using PF-RING), barnyard2, and snort_agent.</p>
<p>If running Suricata, <code class="docutils literal notranslate"><span class="pre">so-sensor-start</span></code> automatically copies <code class="docutils literal notranslate"><span class="pre">$IDS_LB_PROCS</span></code> into <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> and then Suricata spins up the PF-RING instances itself.</p>
</div>
<div class="section" id="bro">
<h4>Bro<a class="headerlink" href="#bro" title="Permalink to this headline">¶</a></h4>
<p>To change the number of PF-RING instances for Bro:</p>
<ul>
<li><p class="first">Stop bro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
</li>
<li><p class="first">Edit <code class="docutils literal notranslate"><span class="pre">/opt/bro/etc/node.cfg</span></code> and change the <code class="docutils literal notranslate"><span class="pre">lb_procs</span></code> variable to the desired number of cores.</p>
</li>
<li><p class="first">Start bro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="slots">
<h4>Slots<a class="headerlink" href="#slots" title="Permalink to this headline">¶</a></h4>
<p>If you’ve already run Setup and want to modify <code class="docutils literal notranslate"><span class="pre">min_num_slots</span></code>, you can manually create/edit <code class="docutils literal notranslate"><span class="pre">/etc/modprobe.d/pf_ring.conf</span></code>.</p>
<p>For example, to increase <code class="docutils literal notranslate"><span class="pre">min_num_slots</span></code> to <code class="docutils literal notranslate"><span class="pre">65534</span></code>, do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s2">&quot;options pf_ring transparent_mode=0 min_num_slots=65534&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">modprobe</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">pf_ring</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>After creating/editing <code class="docutils literal notranslate"><span class="pre">/etc/modprobe.d/pf_ring.conf</span></code>, you’ll need to reload the PF-RING module as follows (or just reboot):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">stop</span>
<span class="n">sudo</span> <span class="n">rmmod</span> <span class="n">pf_ring</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="updating">
<h4>Updating<a class="headerlink" href="#updating" title="Permalink to this headline">¶</a></h4>
<p>Please see the <a class="reference external" href="Upgrade">Upgrade</a> section for notes on updating the PF-RING kernel module.</p>
</div>
</div>
<span id="document-af-packet"></span><div class="section" id="af-packet">
<h3>AF-PACKET<a class="headerlink" href="#af-packet" title="Permalink to this headline">¶</a></h3>
<p>Modern versions of Setup will configure <a class="reference external" href="Suricata">Suricata</a> and <a class="reference external" href="Bro">Bro</a> to use AF-PACKET instead of <a class="reference external" href="PF-RING">PF-RING</a>. (<a class="reference external" href="Snort">Snort</a> will continue to use <a class="reference external" href="PF-RING">PF-RING</a> for load balancing until Snort 3.0 is released.)</p>
<p>If you want to change the number of AF-PACKET workers after running Setup, you can do the following.</p>
<div class="section" id="id1">
<h4>Suricata<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>To change the number of AF-PACKET workers for <a class="reference external" href="Suricata">Suricata</a>:</p>
<ul>
<li><p class="first">Stop sensor processes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">suricata</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
</li>
<li><p class="first">Edit <code class="docutils literal notranslate"><span class="pre">/etc/nsm/$HOSTNAME-$INTERFACE/sensor.conf</span></code> and change the <code class="docutils literal notranslate"><span class="pre">IDS_LB_PROCS</span></code> variable to the desired number of workers.</p>
</li>
<li><p class="first">Start sensor processes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">suricata</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">so-suricata-start</span></code> automatically copies <code class="docutils literal notranslate"><span class="pre">$IDS_LB_PROCS</span></code> into <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> and then Suricata creates the appropriate number of AF-PACKET workers.</p>
</li>
</ul>
</div>
<div class="section" id="id3">
<h4>Bro<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>To change the number of AF-PACKET workers for <a class="reference external" href="Bro">Bro</a>:</p>
<ul>
<li><p class="first">Stop Bro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
</li>
<li><p class="first">Edit <code class="docutils literal notranslate"><span class="pre">/opt/bro/etc/node.cfg</span></code> and change the <code class="docutils literal notranslate"><span class="pre">lb_procs</span></code> variable to the desired number of cores.</p>
</li>
<li><p class="first">Start Bro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="tcpreplay">
<h4>tcpreplay<a class="headerlink" href="#tcpreplay" title="Permalink to this headline">¶</a></h4>
<p>If you try to test AF-PACKET load balancing using tcpreplay locally, please note that load balancing will not work properly and all (or most) traffic will be handled by the first worker in the AF-PACKET cluster.  If you need to test AF-PACKET load balancing properly, you can run tcpreplay on another machine connected to your AF-PACKET machine.</p>
</div>
</div>
<span id="document-performance"></span><div class="section" id="high-performance-tuning">
<h3>High Performance Tuning<a class="headerlink" href="#high-performance-tuning" title="Permalink to this headline">¶</a></h3>
<div class="section" id="ubuntu-server">
<h4>Ubuntu Server<a class="headerlink" href="#ubuntu-server" title="Permalink to this headline">¶</a></h4>
<p>For best performance, we recommend starting with Ubuntu Server (no GUI) and adding our Security Onion packages as described in our <a class="reference external" href="ProductionDeployment">ProductionDeployment</a> guide.</p>
</div>
<div class="section" id="best-practices">
<h4>Best Practices<a class="headerlink" href="#best-practices" title="Permalink to this headline">¶</a></h4>
<p>When you run Setup, make sure you choose <a class="reference external" href="Best-Practices">Best Practices</a>.</p>
</div>
<div class="section" id="disable-gui">
<h4>Disable GUI<a class="headerlink" href="#disable-gui" title="Permalink to this headline">¶</a></h4>
<p>If you’re unable to start with Ubuntu Server (no GUI) as recommended above, you can <a class="reference external" href="Desktop">disable the GUI</a> after the system is fully configured.</p>
</div>
<div class="section" id="disable-unnecessary-services">
<h4>Disable Unnecessary Services<a class="headerlink" href="#disable-unnecessary-services" title="Permalink to this headline">¶</a></h4>
<p>Disable any other unnecessary services.  For example, to disable bluetooth:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">stop</span> <span class="n">bluetooth</span><span class="o">.</span><span class="n">service</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">disable</span> <span class="n">bluetooth</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
</div>
<div class="section" id="cpu-affinity-pinning">
<h4>CPU Affinity/Pinning<a class="headerlink" href="#cpu-affinity-pinning" title="Permalink to this headline">¶</a></h4>
<p>For best performance, CPU intensive processes like Bro and Suricata should be pinned to specific CPUs.</p>
<div class="line-block">
<div class="line">For Bro, use the <code class="docutils literal notranslate"><span class="pre">pin_cpus</span></code> setting in <code class="docutils literal notranslate"><span class="pre">/opt/bro/etc/node.cfg</span></code>:</div>
<div class="line"><a class="reference external" href="https://docs.zeek.org/en/stable/configuration/#using-pf-ring">https://docs.zeek.org/en/stable/configuration/#using-pf-ring</a></div>
</div>
<div class="line-block">
<div class="line">For Suricata, use the affinity settings in <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code>:</div>
<div class="line"><a class="reference external" href="https://suricata.readthedocs.io/en/latest/configuration/suricata-yaml.html#threading">https://suricata.readthedocs.io/en/latest/configuration/suricata-yaml.html#threading</a></div>
</div>
</div>
<div class="section" id="rss">
<h4>RSS<a class="headerlink" href="#rss" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Check your sniffing interfaces to see if they have Receive Side Scaling (RSS) queues. If so, you may need to reduce to 1:</div>
<div class="line"><a class="reference external" href="https://suricata.readthedocs.io/en/latest/performance/packet-capture.html#rss">https://suricata.readthedocs.io/en/latest/performance/packet-capture.html#rss</a></div>
</div>
</div>
<div class="section" id="disk-memory">
<h4>Disk/Memory<a class="headerlink" href="#disk-memory" title="Permalink to this headline">¶</a></h4>
<p>If you have plenty of RAM, disable swap altogether.</p>
<div class="line-block">
<div class="line">Use <code class="docutils literal notranslate"><span class="pre">hdparm</span></code> to gather drive statistics and alter settings, as described here:</div>
<div class="line"><a class="reference external" href="http://www.linux-magazine.com/Online/Features/Tune-Your-Hard-Disk-with-hdparm">http://www.linux-magazine.com/Online/Features/Tune-Your-Hard-Disk-with-hdparm</a></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">vm.dirty_ratio</span></code> is the maximum amount of system memory that can be filled with dirty pages before everything must get committed to disk.</p>
<p><code class="docutils literal notranslate"><span class="pre">vm.dirty_background_ratio</span></code> is the percentage of system memory that can be filled with “dirty” pages, or memory pages that still need to be written to disk – before the pdflush/flush/kdmflush background processes kick in to write it to disk.</p>
<div class="line-block">
<div class="line">More information:</div>
<div class="line"><a class="reference external" href="https://lonesysadmin.net/2013/12/22/better-linux-disk-caching-performance-vm-dirty_ratio/">https://lonesysadmin.net/2013/12/22/better-linux-disk-caching-performance-vm-dirty_ratio/</a></div>
</div>
</div>
<div class="section" id="other">
<h4>Other<a class="headerlink" href="#other" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Consider adopting some of the suggestions from here:</div>
<div class="line"><a class="reference external" href="https://suricata.readthedocs.io/en/latest/performance/packet-capture.html">https://suricata.readthedocs.io/en/latest/performance/packet-capture.html</a></div>
<div class="line"><a class="reference external" href="https://github.com/pevma/SEPTun">https://github.com/pevma/SEPTun</a></div>
<div class="line"><a class="reference external" href="https://github.com/pevma/SEPTun-Mark-II">https://github.com/pevma/SEPTun-Mark-II</a></div>
</div>
</div>
</div>
<span id="document-mysql"></span><div class="section" id="mysql-tuning">
<h3>MySQL Tuning<a class="headerlink" href="#mysql-tuning" title="Permalink to this headline">¶</a></h3>
<p>As of Security Onion 16.04.4.1 MySQL (on the master server) should have a randomized root password set by default. You can still access MySQL using the following as an example of the syntax to run a command against securityonion_db (Sguil DB):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">Dsecurityonion_db</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;select * from event limit 10&#39;</span><span class="p">;</span>
</pre></div>
</div>
<div class="section" id="mysqltuner">
<h4>mysqltuner<a class="headerlink" href="#mysqltuner" title="Permalink to this headline">¶</a></h4>
<p>You can install and run <code class="docutils literal notranslate"><span class="pre">mysqltuner</span></code> to get some initial recommendations.</p>
<p>Install <code class="docutils literal notranslate"><span class="pre">mysqltuner</span></code> if you haven’t already:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">mysqltuner</span>
</pre></div>
</div>
<p>Run <code class="docutils literal notranslate"><span class="pre">mysqltuner</span></code> with privileges:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysqltuner</span>
</pre></div>
</div>
<p>You may also want to install <code class="docutils literal notranslate"><span class="pre">mysqltuner</span></code> via the following manner, given that Security Onion now uses <code class="docutils literal notranslate"><span class="pre">defaults-file</span></code> to handle MySQL database credentials:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">mysqltuner</span><span class="o">.</span><span class="n">pl</span><span class="o">/</span> <span class="o">-</span><span class="n">O</span> <span class="n">mysqltuner</span><span class="o">.</span><span class="n">pl</span> <span class="o">&amp;&amp;</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">mysqltuner</span><span class="o">.</span><span class="n">pl</span>
<span class="n">sudo</span> <span class="o">./</span><span class="n">mysqltuner</span><span class="o">.</span><span class="n">pl</span>
</pre></div>
</div>
</div>
<div class="section" id="etc-mysql-my-cnf-vs-etc-mysql-conf-d">
<h4>/etc/mysql/my.cnf vs /etc/mysql/conf.d/<a class="headerlink" href="#etc-mysql-my-cnf-vs-etc-mysql-conf-d" title="Permalink to this headline">¶</a></h4>
<p>Implement mysqltuner’s recommendations in <code class="docutils literal notranslate"><span class="pre">/etc/mysql/my.cnf</span></code> or create a new file in <code class="docutils literal notranslate"><span class="pre">/etc/mysql/conf.d/</span></code> with the changes. We recommend <code class="docutils literal notranslate"><span class="pre">/etc/mysql/conf.d/</span></code> so that your changes don’t get overwritten during MySQL package upgrades.</p>
</div>
<div class="section" id="restart-mysql">
<h4>Restart MySQL<a class="headerlink" href="#restart-mysql" title="Permalink to this headline">¶</a></h4>
<p>Changes don’t take effect until MySQL is restarted and you should ensure that Sguil and other services aren’t using MySQL before shutting it down.</p>
</div>
<div class="section" id="variables">
<h4>Variables<a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h4>
<p>Here are some common variables that may need to be tuned for your system:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">open-files-limit</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">table_cache</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">key_buffer</span></code></li>
<li><code class="docutils literal notranslate"><span class="pre">max_connections</span></code></li>
</ul>
</div>
<div class="section" id="mysql-slow-to-start-on-boot">
<h4>MySQL slow to start on boot<a class="headerlink" href="#mysql-slow-to-start-on-boot" title="Permalink to this headline">¶</a></h4>
<p>At boot time, MySQL checks all tables, which can take a long time. If you wish to disable this check, comment out <code class="docutils literal notranslate"><span class="pre">check_for_crashed_tables</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/mysql/debian-start</span></code>.</p>
</div>
<div class="section" id="table-definition-cache">
<h4>table_definition_cache<a class="headerlink" href="#table-definition-cache" title="Permalink to this headline">¶</a></h4>
<p>MySQL defaults <code class="docutils literal notranslate"><span class="pre">table_definition_cache</span></code> to <code class="docutils literal notranslate"><span class="pre">400</span></code>. You may want to increase this value if one or more of the following conditions applies to you:</p>
<ul class="simple">
<li>you have more than 400 MySQL <code class="docutils literal notranslate"><span class="pre">.frm</span></code> files</li>
<li>you’ve increased <code class="docutils literal notranslate"><span class="pre">DAYSTOKEEP</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code> above its default value of 30 (each day requires 5 <code class="docutils literal notranslate"><span class="pre">.frm</span></code> files for OSSEC and 5 <code class="docutils literal notranslate"><span class="pre">.frm</span></code> files for each sniffing interface)</li>
<li>you’re running prepared statements</li>
</ul>
<p>Check mysql <code class="docutils literal notranslate"><span class="pre">table_definition</span> <span class="pre">cache</span></code> (defaults to <code class="docutils literal notranslate"><span class="pre">400</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;show global variables like &#39;table_definition_cache&#39;&quot;</span>
</pre></div>
</div>
<p>Check current <code class="docutils literal notranslate"><span class="pre">open_table_definitions</span></code> (probably maxed out at <code class="docutils literal notranslate"><span class="pre">table_definition_cache</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span> <span class="o">-</span><span class="n">uroot</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;show global status like &#39;open_table_definitions&#39;&quot;</span>
</pre></div>
</div>
<p>Check number of <code class="docutils literal notranslate"><span class="pre">.frm</span></code> files:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">find</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span> <span class="o">-</span><span class="n">name</span> <span class="s2">&quot;*.frm&quot;</span> <span class="o">|</span><span class="n">wc</span> <span class="o">-</span><span class="n">l</span>
</pre></div>
</div>
<p>Increase table_definition_cache above number of <code class="docutils literal notranslate"><span class="pre">.frm</span></code> files by creating a file called <code class="docutils literal notranslate"><span class="pre">/etc/mysql/conf.d/securityonion-table_definition_cache.cnf</span></code> (please note <code class="docutils literal notranslate"><span class="pre">.cnf</span></code> extension NOT <code class="docutils literal notranslate"><span class="pre">.conf</span></code>) and adding the following (replacing <code class="docutils literal notranslate"><span class="pre">4000</span></code> with your desired setting):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">mysqld</span><span class="p">]</span>
<span class="n">table_definition_cache</span> <span class="o">=</span> <span class="mi">4000</span>
</pre></div>
</div>
<p>Reboot and then verify that <code class="docutils literal notranslate"><span class="pre">open_table_definitions</span></code> never gets limited by <code class="docutils literal notranslate"><span class="pre">table_definition_cache</span></code>.</p>
<p>For more information, please see:</p>
<p><a class="reference external" href="https://bugs.mysql.com/bug.php?id=42041">https://bugs.mysql.com/bug.php?id=42041</a></p>
<p><a class="reference external" href="https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_table_definition_cache">https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_table_definition_cache</a></p>
</div>
</div>
<span id="document-trimpcap"></span><div class="section" id="trimming-pcaps">
<h3>Trimming PCAPs<a class="headerlink" href="#trimming-pcaps" title="Permalink to this headline">¶</a></h3>
<p>PCAPs (as a data type) typically take up the most disk space on a
Security Onion sensor, and usually aren’t able to be kept for extended
periods of time. We can lessen the space consumed by PCAPs and extend
our retention time by trimming them, using a special tool called
<a class="reference external" href="https://www.netresec.com/?page=TrimPCAP">TrimPCAP</a> from
<a class="reference external" href="https://www.netresec.com/">NETRESEC</a>. Using this tool, we can trim
the flows within PCAPs to a desired size.</p>
<p><strong>Please be aware that it may take a while to process a large amount of PCAPs. With this in mind, you’ll want to consider running TrimPCAP at non-peak times (without high PCAP write volume, etc.).</strong></p>
<div class="line-block">
<div class="line">One retention schedule that could be used is as follows:</div>
<div class="line">(<a class="reference external" href="http://www.netresec.com/?page=Blog&amp;month=2017-12&amp;post=Don%27t-Delete-PCAP-Files---Trim-Them">http://www.netresec.com/?page=Blog&amp;month=2017-12&amp;post=Don%27t-Delete-PCAP-Files—Trim-Them</a>)</div>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="54%" />
<col width="46%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Age</th>
<th class="head">Size (per flow)</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Older than 3 days</td>
<td>1MB</td>
</tr>
<tr class="row-odd"><td>Older than 6 days</td>
<td>102KB</td>
</tr>
<tr class="row-even"><td>Older than 30 days</td>
<td>10KB</td>
</tr>
</tbody>
</table>
<div class="section" id="trimming">
<h4>Trimming<a class="headerlink" href="#trimming" title="Permalink to this headline">¶</a></h4>
<p>We can install TrimPCAP using the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo apt-get install python-pip
sudo pip install dpkt
sudo pip install repoze.lru
sudo wget -O /opt/trimpcap.py https://www.netresec.com/?download=trimpcap
</pre></div>
</div>
<p>Then we can run TrimPCAP, as follows (specifying a size of <code class="docutils literal notranslate"><span class="pre">102KB</span></code> per flow, iterating over all PCAPs of all ages, in all directories):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">find</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">sensor_data</span><span class="o">/</span> <span class="o">-</span><span class="n">name</span> <span class="s2">&quot;snort.log.??????????&quot;</span> <span class="o">-</span><span class="nb">type</span> <span class="n">f</span> <span class="o">-</span><span class="n">exec</span> <span class="n">sudo</span> <span class="n">python</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">trimpcap</span><span class="o">.</span><span class="n">py</span> <span class="mi">102400</span> <span class="p">{}</span> \<span class="p">;</span>
</pre></div>
</div>
<p>If we want to this for PCAPs older than 3 days, we can do something like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo /usr/bin/find /nsm/sensor_data/ -name &quot;snort.log.??????????&quot; -mmin +$((60*72)) -type f -exec sudo python /opt/trimpcap.py 102400 {} \;
</pre></div>
</div>
<p>We can then automate this using a cron job, so our PCAPs are checked daily.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#/etc/cron.d/trimpcap
#
#crontab entry for TrimPCAP

TRIMPCAP=&quot;/opt/trimpcap.py&quot;
LOG=&quot;/var/log/trimpcap.log&quot;
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# Trim after 3 days
0 1 * * * root echo $(date) &gt;&gt; $LOG; /usr/bin/find /nsm/sensor_data/ -name &quot;snort.log.??????????&quot; -mmin +$((60*72)) -type f -exec /usr/bin/python
$TRIMPCAP 1000000 {} \; &gt;&gt; $LOG 2&gt;&amp;1;
</pre></div>
</div>
<p>To automatically configure PCAPs to be trimmed at the above recommended
intervals, we can do the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">weslambert</span><span class="o">/</span><span class="n">misc</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">trimpcap_install</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">./</span><span class="n">trimpcap_install</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="o">./</span><span class="n">trimpcap_install</span>
</pre></div>
</div>
</div>
</div>
<span id="document-disabling"></span><div class="section" id="disabling-processes">
<h3>Disabling Processes<a class="headerlink" href="#disabling-processes" title="Permalink to this headline">¶</a></h3>
<p>If you’ve already run Setup and want to disable a certain sensor service, you can simply stop the running service and then change the corresponding config value from <code class="docutils literal notranslate"><span class="pre">yes</span></code> to <code class="docutils literal notranslate"><span class="pre">no</span></code> to prevent it from restarting the next time the NSM scripts are run.</p>
<p>For example, suppose you access Bro’s HTTP logs via Kibana, so you want to disable <code class="docutils literal notranslate"><span class="pre">http_agent</span></code> to prevent those HTTP logs from being duplicated into the <code class="docutils literal notranslate"><span class="pre">Sguil</span></code> database. You would first stop the running <code class="docutils literal notranslate"><span class="pre">http_agent</span></code> service:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nsm_sensor_ps</span><span class="o">-</span><span class="n">stop</span> <span class="o">--</span><span class="n">only</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">agent</span>
</pre></div>
</div>
<p>You would then edit <code class="docutils literal notranslate"><span class="pre">/etc/nsm/$HOSTNAME-$INTERFACE/sensor.conf</span></code> and change:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HTTP_AGENT_ENABLED</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
</pre></div>
</div>
<p>to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">HTTP_AGENT_ENABLED</span><span class="o">=</span><span class="s2">&quot;no&quot;</span>
</pre></div>
</div>
<p>to prevent <code class="docutils literal notranslate"><span class="pre">http_agent</span></code> from restarting the next time the NSM scripts are run. A quick way to do this for all <code class="docutils literal notranslate"><span class="pre">/etc/nsm/*/sensor.conf</span></code> files on one box is to use the <code class="docutils literal notranslate"><span class="pre">sed</span></code> command as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|HTTP_AGENT_ENABLED=&quot;yes&quot;|HTTP_AGENT_ENABLED=&quot;no&quot;|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/*/</span><span class="n">sensor</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<div class="section" id="sguil-agent">
<h4>Sguil Agent<a class="headerlink" href="#sguil-agent" title="Permalink to this headline">¶</a></h4>
<p>If you use the Sguil client and want to remove the disabled agent from Sguil’s <code class="docutils literal notranslate"><span class="pre">Agent</span> <span class="pre">Status</span></code> tab, then stop <code class="docutils literal notranslate"><span class="pre">sguild</span></code>, set the sensor’s <code class="docutils literal notranslate"><span class="pre">active</span></code> field to <code class="docutils literal notranslate"><span class="pre">N</span></code> in the database, and then restart <code class="docutils literal notranslate"><span class="pre">sguild</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Stop sguild</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">stop</span>

<span class="c1"># Set active=&quot;N&quot;, replacing HOSTNAME-INTERFACE-INSTANCE with your actual HOSTNAME, INTERFACE, and INSTANCE</span>
<span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">Dsecurityonion_db</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;update sensor set active=&quot;N&quot; where hostname=&quot;HOSTNAME-INTERFACE-INSTANCE&quot;;&#39;</span>

<span class="c1"># Restart sguild</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="wazuh">
<h4>Wazuh<a class="headerlink" href="#wazuh" title="Permalink to this headline">¶</a></h4>
<p>Occasionally, folks ask about disabling Wazuh.  Please keep in mind that in addition to providing endpoint visibility from Wazuh agents, the Wazuh server also monitors and protects the Security Onion box itself. For example, suppose that you have an active adversary who is trying to compromise your Security Onion box. Wazuh may see those attempts and engage <code class="docutils literal notranslate"><span class="pre">Active</span> <span class="pre">Response</span></code> to block the attacker’s IP address in the host-based firewall.</p>
<p>If you understand all of this and still want to disable Wazuh, you can do so as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Stop the running Wazuh processes</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">ossec</span><span class="o">-</span><span class="n">stop</span>

<span class="c1"># Disable Wazuh</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">rc</span><span class="o">.</span><span class="n">d</span> <span class="o">-</span><span class="n">f</span> <span class="n">ossec</span><span class="o">-</span><span class="n">hids</span><span class="o">-</span><span class="n">server</span> <span class="n">disable</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<span id="document-tricks"></span><div class="section" id="tricks-and-tips">
<h2>Tricks and Tips<a class="headerlink" href="#tricks-and-tips" title="Permalink to this headline">¶</a></h2>
<p>This section is a collection of miscellaneous tricks and tips for Security Onion.</p>
<div class="toctree-wrapper compound">
<span id="document-airgap"></span><div class="section" id="airgapped-networks">
<h3>Airgapped Networks<a class="headerlink" href="#airgapped-networks" title="Permalink to this headline">¶</a></h3>
<p>Some organizations have airgapped networks with no connection to the
Internet. Security Onion works fine on these airgapped networks,
although it may be missing some updates due to lack of Internet
connection.</p>
<div class="section" id="updating">
<h4>Updating<a class="headerlink" href="#updating" title="Permalink to this headline">¶</a></h4>
<p>You can transfer updates to airgapped networks via DVD, USB, or other
media.</p>
<div class="line-block">
<div class="line"><a class="reference external" href="https://github.com/SkiTheSlicer/">&#64;SkiTheSlicer</a> has created a set
of scripts to assist in updating airgapped Security Onion
installations:</div>
<div class="line"><a class="reference external" href="https://github.com/SkiTheSlicer/securityonion-airgap">https://github.com/SkiTheSlicer/securityonion-airgap</a></div>
</div>
</div>
<div class="section" id="docker">
<h4>Docker<a class="headerlink" href="#docker" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">For Docker containers, sneakernet updates can be performed by doing
something like the following:</div>
<div class="line"><a class="reference external" href="Docker#sneakernet-updates">Docker#sneakernet-updates</a></div>
</div>
</div>
</div>
<span id="document-analyst-vm"></span><div class="section" id="analyst-vm">
<h3>Analyst VM<a class="headerlink" href="#analyst-vm" title="Permalink to this headline">¶</a></h3>
<p>Full-time analysts should install Security Onion in a VM on their workstation. Run through the Ubuntu installer, but you do not need to run our Setup wizard since the analyst VM won’t be sniffing any live traffic. This gives you a local copy of <a class="reference external" href="wireshark">Wireshark</a>, <a class="reference external" href="networkminer">NetworkMiner</a>, and our customized <a class="reference external" href="Sguil">Sguil</a> client.</p>
<p>To connect from the Analyst VM to your production master server, you will need to run <a class="reference external" href="so-allow">so-allow</a> on the master server and choose the <code class="docutils literal notranslate"><span class="pre">analyst</span></code> option to allow the traffic through the host-based <a class="reference external" href="Firewall">firewall</a>.</p>
<p>Once you’ve allowed the traffic using so-allow, you can launch the Sguil client and connect to the IP address or hostname of your production master server and/or launch the web browser and connect to Squert or Kibana on your production master server.</p>
<p>This allows you to investigate pcaps without fear of impacting your production server/sensors.</p>
<div class="section" id="ultimate-forensics-vm">
<h4>Ultimate Forensics VM<a class="headerlink" href="#ultimate-forensics-vm" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Want an analyst VM that also includes forensics and reverse engineering tools from SANS SIFT and Remnux? See Brian Kellogg’s Ultimate Forensics VM:</div>
<div class="line"><a class="reference external" href="https://github.com/theflakes/Ultimate-Forensics-VM">https://github.com/theflakes/Ultimate-Forensics-VM</a></div>
</div>
</div>
</div>
<span id="document-best-practices"></span><div class="section" id="best-practices">
<h3>Best Practices<a class="headerlink" href="#best-practices" title="Permalink to this headline">¶</a></h3>
<p>Security Onion comes with the option to implement what is considered a set of <code class="docutils literal notranslate"><span class="pre">Best</span> <span class="pre">Practices</span></code> during Setup. For many users, this is a quick and easy way to ensure you are configuring your deployment to disable any services that you may not need, and that would otherwise duplicate work and data. The <code class="docutils literal notranslate"><span class="pre">Best</span> <span class="pre">Practices</span></code> option not only disables these unnecessary services, but (assuming the appropriate packages are installed) enables <a class="reference external" href="Salt">Salt</a> by default, to allow for ease of sensor management.</p>
<p><strong>The below sections assume that you already have these services installed, and provide advice on how to disable them in your deployment.</strong></p>
<p>Most folks will want to disable the following services:</p>
<ul class="simple">
<li>prads (prads creates session data and asset data, already provided by Bro)</li>
<li>pads_agent (not needed if prads is disabled)</li>
<li>sancp_agent (not needed if prads is disabled)</li>
<li>argus (argus creates session data, which is already provided by Bro)</li>
<li>http_agent (duplicates Bro http.log into Sguil database, which may cause performance issues)</li>
</ul>
<p>To do so, stop the required service/s:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nsm_sensor_ps</span><span class="o">-</span><span class="n">stop</span> <span class="o">--</span><span class="n">only</span><span class="o">-</span><span class="n">prads</span>
<span class="n">sudo</span> <span class="n">nsm_sensor_ps</span><span class="o">-</span><span class="n">stop</span> <span class="o">--</span><span class="n">only</span><span class="o">-</span><span class="n">pads</span><span class="o">-</span><span class="n">agent</span>
<span class="n">sudo</span> <span class="n">nsm_sensor_ps</span><span class="o">-</span><span class="n">stop</span> <span class="o">--</span><span class="n">only</span><span class="o">-</span><span class="n">sancp</span><span class="o">-</span><span class="n">agent</span>
<span class="n">sudo</span> <span class="n">nsm_sensor_ps</span><span class="o">-</span><span class="n">stop</span> <span class="o">--</span><span class="n">only</span><span class="o">-</span><span class="n">argus</span>
<span class="n">sudo</span> <span class="n">nsm_sensor_ps</span><span class="o">-</span><span class="n">stop</span> <span class="o">--</span><span class="n">only</span><span class="o">-</span><span class="n">http</span><span class="o">-</span><span class="n">agent</span>
</pre></div>
</div>
<p>And then disable them so they don’t start on reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|PRADS_ENABLED=&quot;yes&quot;|PRADS_ENABLED=&quot;no&quot;|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/*/</span><span class="n">sensor</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|PADS_AGENT_ENABLED=&quot;yes&quot;|PADS_AGENT_ENABLED=&quot;no&quot;|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/*/</span><span class="n">sensor</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|SANCP_AGENT_ENABLED=&quot;yes&quot;|SANCP_AGENT_ENABLED=&quot;no&quot;|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/*/</span><span class="n">sensor</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|ARGUS_ENABLED=&quot;yes&quot;|ARGUS_ENABLED=&quot;no&quot;|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/*/</span><span class="n">sensor</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|HTTP_AGENT_ENABLED=&quot;yes&quot;|HTTP_AGENT_ENABLED=&quot;no&quot;|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/*/</span><span class="n">sensor</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>For more information, please see the <a class="reference external" href="DisablingProcesses#disabling-a-process">Disabling Processes</a> section.</p>
</div>
<span id="document-cloud-client"></span><div class="section" id="cloud-client">
<h3>Cloud Client<a class="headerlink" href="#cloud-client" title="Permalink to this headline">¶</a></h3>
<p>Many folks ask how they can use Security Onion to monitor and defend
their cloud environments. Most cloud environments don’t provide anything
like a tap or span port, but we can use daemonlogger or netsniff-ng as a
virtual tap. This virtual tap will copy all traffic from our production
cloud box to an OpenVPN bridge that transports the traffic to our
Security Onion sensor where it is then analyzed.</p>
<p><strong>Warning! This cloud client is considered experimental! USE AT YOUR OWN RISK!</strong></p>
<p>This guide was originally written for Security Onion 12.04 and has been updated for Security Onion 14.04, but hasn’t been heavily tested yet.</p>
<div class="section" id="traffic-flow-and-nic-offloading-functions">
<h4>Traffic Flow and NIC offloading functions<a class="headerlink" href="#traffic-flow-and-nic-offloading-functions" title="Permalink to this headline">¶</a></h4>
<p>The cloud client uses <code class="docutils literal notranslate"><span class="pre">daemonlogger</span></code> or <code class="docutils literal notranslate"><span class="pre">netsniff-ng</span></code> to copy all
packets from eth0 to tap0 (OpenVPN). OpenVPN transports the packets to
the cloud sensor, where tap0 is a member of bridge br0. The standard
Security Onion stack sniffs br0. NIC offloading functions must be
disabled on all of these interfaces (eth0 and tap0 on cloud client, and
tap0 and br0 on cloud sensor) to ensure that Snort, Bro, etc. all see
traffic as it appeared on the wire. This guide will walk you through
disabling NIC offloading functions on eth0 and br0 via
<code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> and tap0 via <code class="docutils literal notranslate"><span class="pre">/etc/openvpn/up.sh</span></code>.</p>
</div>
<div class="section" id="daemonlogger-vs-netsniff-ng">
<h4>Daemonlogger vs netsniff-ng<a class="headerlink" href="#daemonlogger-vs-netsniff-ng" title="Permalink to this headline">¶</a></h4>
<p>This guide is written using <code class="docutils literal notranslate"><span class="pre">daemonlogger</span></code> because it is more likely
to be available on most cloud boxes. If <code class="docutils literal notranslate"><span class="pre">netsniff-ng</span></code> is available, it
can provide higher performance (less packet loss), and you would just
need to change the calls from daemonlogger to netsniff-ng and translate
the options to the equivalent netsniff-ng options.</p>
</div>
<div class="section" id="references-and-thanks">
<h4>References and Thanks<a class="headerlink" href="#references-and-thanks" title="Permalink to this headline">¶</a></h4>
<p>This is based on Josh Brower’s great work:</p>
<p><a class="reference external" href="http://www.slideshare.net/DefensiveDepth/so-conference-2014">http://www.slideshare.net/DefensiveDepth/so-conference-2014</a></p>
<p>The OpenVPN configuration shown below is based on the following guides:</p>
<p><a class="reference external" href="https://help.ubuntu.com/community/OpenVPN">https://help.ubuntu.com/community/OpenVPN</a></p>
<p><a class="reference external" href="https://help.ubuntu.com/lts/serverguide/openvpn.html">https://help.ubuntu.com/lts/serverguide/openvpn.html</a></p>
</div>
<div class="section" id="install-packages">
<h4>Install Packages<a class="headerlink" href="#install-packages" title="Permalink to this headline">¶</a></h4>
<p>If you are installing from Ubuntu 16.04, make sure you install our packages before continuing with this procedure.  For more information, please see the <a class="reference external" href="getting-started">Getting Started</a> section.</p>
</div>
<div class="section" id="security-onion-sensor">
<h4>Security Onion Sensor<a class="headerlink" href="#security-onion-sensor" title="Permalink to this headline">¶</a></h4>
<p>We start with our Security Onion sensor.</p>
<p>First, ensure that the bridge-utils package is installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">bridge</span><span class="o">-</span><span class="n">utils</span>
</pre></div>
</div>
<p>Run Security Onion Setup Phase 1 (Network Configuration), allow it to
write your <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> file, but DON’T reboot at the
end:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sosetup</span>
</pre></div>
</div>
<p>Add br0 to <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> and disable offloading functions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | sudo tee -a /etc/network/interfaces
# Bridge for OpenVPN tap0
auto br0
iface br0 inet manual
  bridge_ports none
  post-up for i in rx tx sg tso ufo gso gro lro; do ethtool -K \$IFACE \$i off; done
EOF
</pre></div>
</div>
<p>Reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
<p>Run Security Onion Setup Phase 2 and choose to monitor br0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sosetup</span>
</pre></div>
</div>
<p>Setup has locked down the UFW firewall, so let’s go ahead and allow
OpenVPN port 1194:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="mi">1194</span>
</pre></div>
</div>
<p>Install OpenVPN:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">openvpn</span> <span class="n">easy</span><span class="o">-</span><span class="n">rsa</span>
</pre></div>
</div>
<p>Next, copy files to the <code class="docutils literal notranslate"><span class="pre">/etc/openvpn/easy-rsa/</span></code> directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">r</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/*</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span>
</pre></div>
</div>
<p>Edit <code class="docutils literal notranslate"><span class="pre">/etc/openvpn/easy-rsa/vars</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="nb">vars</span>
</pre></div>
</div>
<p>Change these lines at the bottom so that they reflect the proper
settings for your new CA:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">KEY_COUNTRY</span>
<span class="n">export</span> <span class="n">KEY_PROVINCE</span>
<span class="n">export</span> <span class="n">KEY_CITY</span>
<span class="n">export</span> <span class="n">KEY_ORG</span>
<span class="n">export</span> <span class="n">KEY_EMAIL</span>
<span class="n">export</span> <span class="n">KEY_CN</span>
<span class="n">export</span> <span class="n">KEY_NAME</span>
<span class="n">export</span> <span class="n">KEY_OU</span>
</pre></div>
</div>
<p>Setup the CA and create the first server certificate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span> <span class="c1">## move to the easy-rsa directory</span>
<span class="n">sudo</span> <span class="n">chown</span> <span class="o">-</span><span class="n">R</span> <span class="n">root</span><span class="p">:</span><span class="n">sudo</span> <span class="o">.</span>  <span class="c1">## make this directory writable by the system administrators</span>
<span class="n">sudo</span> <span class="n">chmod</span> <span class="n">g</span><span class="o">+</span><span class="n">w</span> <span class="o">.</span> <span class="c1">## make this directory writable by the system administrators</span>
<span class="n">source</span> <span class="o">./</span><span class="nb">vars</span> <span class="c1">## execute your new vars file</span>
<span class="o">./</span><span class="n">clean</span><span class="o">-</span><span class="nb">all</span>  <span class="c1">## Setup the easy-rsa directory (Deletes all keys)</span>
<span class="o">./</span><span class="n">build</span><span class="o">-</span><span class="n">ca</span>  <span class="c1">## generate the master Certificate Authority (CA) certificate and key</span>
<span class="o">./</span><span class="n">build</span><span class="o">-</span><span class="n">key</span><span class="o">-</span><span class="n">server</span> <span class="n">server</span> <span class="c1">## creates a server cert and private key</span>
<span class="o">./</span><span class="n">build</span><span class="o">-</span><span class="n">dh</span>
<span class="n">cd</span> <span class="n">keys</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="n">server</span><span class="o">.</span><span class="n">crt</span> <span class="n">server</span><span class="o">.</span><span class="n">key</span> <span class="n">ca</span><span class="o">.</span><span class="n">crt</span> <span class="n">dh2048</span><span class="o">.</span><span class="n">pem</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span>
<span class="c1"># The Certificate Authority is now setup and the needed keys are in /etc/openvpn/</span>
</pre></div>
</div>
<p>Create a script that OpenVPN will call when the tunnel comes up to add
tap0 to br0 and disable offloading functions on tap0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | sudo tee -a /etc/openvpn/up.sh
#!/bin/sh

BR=\$1
DEV=\$2
/sbin/ip link set &quot;\$DEV&quot; up promisc on
/sbin/brctl addif \$BR \$DEV

for i in rx tx sg tso ufo gso gro lro; do ethtool -K \$DEV \$i off; done
EOF
</pre></div>
</div>
<p>Create a script that OpenVPN will call when the tunnel goes down:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | sudo tee -a /etc/openvpn/down.sh
#!/bin/sh

BR=\$1
DEV=\$2

/sbin/brctl delif \$BR \$DEV
/sbin/ip link set &quot;\$DEV&quot; down
EOF
</pre></div>
</div>
<p>Make both of these scripts executable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">up</span><span class="o">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">down</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Create OpenVPN <code class="docutils literal notranslate"><span class="pre">server.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">sample</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">gz</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span>
<span class="n">sudo</span> <span class="n">gzip</span> <span class="o">-</span><span class="n">d</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">conf</span><span class="o">.</span><span class="n">gz</span>
</pre></div>
</div>
<p>Modify <code class="docutils literal notranslate"><span class="pre">/etc/openvpn/server.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|^dev tun$|;dev tun|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|^;dev tap|dev tap|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|^comp-lzo|;comp-lzo|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|^dh dh1024.pem|dh dh2048.pem|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">conf</span>


<span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="n">EOF</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">server</span><span class="o">.</span><span class="n">conf</span>

<span class="n">up</span> <span class="s2">&quot;/etc/openvpn/up.sh br0&quot;</span>
<span class="n">down</span> <span class="s2">&quot;/etc/openvpn/down.sh br0&quot;</span>
<span class="n">EOF</span>
</pre></div>
</div>
<p>Restart OpenVPN server:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">openvpn</span> <span class="n">restart</span>
</pre></div>
</div>
<p>Check log for errors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">syslog</span>
</pre></div>
</div>
<p>Verify tap0 came up:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span>
</pre></div>
</div>
</div>
<div class="section" id="generate-client-certs">
<h4>Generate client certs<a class="headerlink" href="#generate-client-certs" title="Permalink to this headline">¶</a></h4>
<p>Perform the steps in this section for each cloud client you want to
monitor.</p>
<p>Generate client cert (replacing <code class="docutils literal notranslate"><span class="pre">client</span></code> with the name of the cloud
client you want to add):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span> <span class="c1">## move to the easy-rsa directory</span>
<span class="n">source</span> <span class="o">./</span><span class="nb">vars</span>             <span class="c1">## execute the vars file</span>
<span class="o">./</span><span class="n">build</span><span class="o">-</span><span class="n">key</span> <span class="n">client</span>
</pre></div>
</div>
<p>Copy generated files to cloud client (replacing <code class="docutils literal notranslate"><span class="pre">client</span></code> with the name
of the cloud client you want to add):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">scp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">client</span><span class="o">*</span> <span class="n">username</span><span class="nd">@hostname</span><span class="p">:</span><span class="o">~/</span>
<span class="n">scp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">rsa</span><span class="o">/</span><span class="n">keys</span><span class="o">/</span><span class="n">ca</span><span class="o">.</span><span class="n">crt</span> <span class="n">username</span><span class="nd">@hostname</span><span class="p">:</span><span class="o">~/</span>
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h4>Cloud client<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>Perform the steps in this section on each cloud client you want to
monitor.</p>
<p>Install <code class="docutils literal notranslate"><span class="pre">openvpn</span></code> and <code class="docutils literal notranslate"><span class="pre">daemonlogger</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">openvpn</span> <span class="n">daemonlogger</span>
</pre></div>
</div>
<p>Copy crt files to <code class="docutils literal notranslate"><span class="pre">/etc/openvpn/</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="n">client</span><span class="o">*</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="n">ca</span><span class="o">.</span><span class="n">crt</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span>
</pre></div>
</div>
<p>Create OpenVPN <code class="docutils literal notranslate"><span class="pre">client.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">doc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">examples</span><span class="o">/</span><span class="n">sample</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">files</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">conf</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span>
</pre></div>
</div>
<p>Modify <code class="docutils literal notranslate"><span class="pre">/etc/openvpn/client.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|^dev tun$|;dev tun|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|^;dev tap|dev tap|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|^comp-lzo|;comp-lzo|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">conf</span>

<span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="n">EOF</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">client</span><span class="o">.</span><span class="n">conf</span>

<span class="n">up</span> <span class="s2">&quot;/etc/openvpn/up.sh&quot;</span>
<span class="n">down</span> <span class="s2">&quot;/etc/openvpn/down.sh&quot;</span>
<span class="n">EOF</span>
</pre></div>
</div>
<p>Find the “remote my-server-1 1194” line in <code class="docutils literal notranslate"><span class="pre">/etc/openvpn/client.conf</span></code>
and replace my-server-1 with the hostname or IP address of your OpenVPN
server.</p>
<p>Create a script that OpenVPN will call when the tunnel comes up to
disable offloading functions on tap0 and start daemonlogger. The
daemonlogger BPF at minimum should exclude the OpenVPN traffic on port
1194 (‘not port 1194’). You may need to restrict this BPF even further
if there is other traffic you do not wish to send across the OpenVPN
tunnel.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>cat &lt;&lt; EOF | sudo tee -a /etc/openvpn/up.sh
#!/bin/sh

IN=eth0
OUT=\$1

daemonlogger -d -i \$IN -o \$OUT &#39;not port 1194&#39;

for i in rx tx sg tso ufo gso gro lro; do ethtool -K \$OUT \$i off; done
EOF
</pre></div>
</div>
<p>Create a script that OpenVPN will call when the tunnel goes down:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&lt;&lt;</span> <span class="n">EOF</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">down</span><span class="o">.</span><span class="n">sh</span>
<span class="c1">#!/bin/sh</span>

<span class="n">pkill</span> <span class="n">daemonlogger</span>
<span class="n">EOF</span>
</pre></div>
</div>
<p>Make both of these scripts executable:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">up</span><span class="o">.</span><span class="n">sh</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">openvpn</span><span class="o">/</span><span class="n">down</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Restart OpenVPN client:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">openvpn</span> <span class="n">restart</span>
</pre></div>
</div>
<p>Check log for errors:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tail</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">syslog</span>
</pre></div>
</div>
<p>Verify that tap0 came up:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ifconfig</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">Disable NIC offloading functions on main ethernet interface.</div>
<div class="line">Add the following to your eth stanza in <code class="docutils literal notranslate"><span class="pre">/etc/network/interfaces</span></code> OR
add to <code class="docutils literal notranslate"><span class="pre">/etc/openvpn/up.sh</span></code>:</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>post-up for i in rx tx sg tso ufo gso gro lro; do ethtool -K $IFACE $i off; done
</pre></div>
</div>
<p>Bounce the interface (you may lose access if connected remotely over
ssh) or reboot the box.</p>
</div>
<div class="section" id="check-traffic">
<h4>Check traffic<a class="headerlink" href="#check-traffic" title="Permalink to this headline">¶</a></h4>
<p>Your Security Onion sensor should now be seeing traffic from your Cloud
Client. Verify as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tcpdump</span> <span class="o">-</span><span class="n">nnvvAi</span> <span class="n">tap0</span>
</pre></div>
</div>
<p>tap0 should be a member of br0, so you should see the same traffic on
br0:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">tcpdump</span> <span class="o">-</span><span class="n">nnvvAi</span> <span class="n">br0</span>
</pre></div>
</div>
<p>When you ran Setup phase 2 you configured Security Onion to monitor br0,
so you should be getting IDS alerts and Bro logs.</p>
</div>
<div class="section" id="hardening">
<h4>Hardening<a class="headerlink" href="#hardening" title="Permalink to this headline">¶</a></h4>
<p>Once you get everything working properly, you should configure OpenVPN
(server and client) and daemonlogger to run as a limited user.</p>
</div>
<div class="section" id="tuning">
<h4>Tuning<a class="headerlink" href="#tuning" title="Permalink to this headline">¶</a></h4>
<p>If your cloud box is seeing lots of traffic, daemonlogger may not be
able to keep up, resulting in packet loss. You may need to switch to
netsniff-ng for higher performance. Don’t forget to run netsniff-ng as a
limited user!</p>
</div>
</div>
<span id="document-connecting-to-sguil"></span><div class="section" id="connecting-to-sguild">
<h3>Connecting to Sguild<a class="headerlink" href="#connecting-to-sguild" title="Permalink to this headline">¶</a></h3>
<p>This article will show how to connect to the Sguil server to view security alerts in real-time.</p>
<div class="section" id="connecting-to-sguild-from-an-analyst-machine">
<h4>Connecting to Sguild from an Analyst Machine<a class="headerlink" href="#connecting-to-sguild-from-an-analyst-machine" title="Permalink to this headline">¶</a></h4>
<p>To directly connect to a Sguild server one must possess a working Sguil client. Sguil may not be easy or available for install on certain operating systems. Because of this we recommend installing Security Onion in a virtual machine on your workstation and use that to connect to sguild on your production Security Onion instance.  For more information, please see the <a class="reference external" href="Analyst-VM">Analyst-VM</a> section.</p>
</div>
<div class="section" id="connect-to-sguild-locally-not-recommended">
<h4>Connect to Sguild Locally (not recommended)<a class="headerlink" href="#connect-to-sguild-locally-not-recommended" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Double-click the Sguil icon on the desktop of your Security Onion server.</li>
<li>Set the Sguil Host to localhost, enter your credentials, and then click OK.</li>
<li>After, choose which sensors you would like to monitor for this sguil session and then click Start Sguil.</li>
</ul>
</div>
<div class="section" id="connect-remotely-via-ssh-w-x11-forwarding">
<h4>Connect Remotely via SSH w/ X11 Forwarding<a class="headerlink" href="#connect-remotely-via-ssh-w-x11-forwarding" title="Permalink to this headline">¶</a></h4>
<p>This method requires SSH and an X11 server installed on the machine from which you will be connecting from.</p>
<p>If you’re using OSX install the XQuartz package, Windows try ciXwin, Linux and BSD family use Xorg.</p>
<p>Connect to the Security Onion server via SSH while passing the X11 forwarding option ( <code class="docutils literal notranslate"><span class="pre">-X</span></code> ).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">X</span> <span class="n">user</span><span class="nd">@nsm</span>
</pre></div>
</div>
<p>Once logged in as the normal user open the sguil client application. The display will be sent to your machine using the X11 protocol over SSH.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sguil</span><span class="o">.</span><span class="n">tk</span>
</pre></div>
</div>
<p>Since we’re only forwarding the application window, we’re connected locally i.e. as if we were sitting at the server’s console. Because of this we can use <code class="docutils literal notranslate"><span class="pre">localhost</span></code> as the Sguild Host.</p>
<p>Once logged in we will be able to select which sensors we would like to monitor.</p>
<p>Finally, select Start Sguil. Now you can view the alerts in real-time, perform advanced SQL queries, and pivot into a number of applications like Wireshark, Kibana, and NetworkMiner.</p>
</div>
</div>
<span id="document-desktop"></span><div class="section" id="disabling-desktop">
<h3>Disabling Desktop<a class="headerlink" href="#disabling-desktop" title="Permalink to this headline">¶</a></h3>
<p>You can disable the GUI after the system is fully configured:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span><span class="o">.</span><span class="n">bak</span> <span class="s1">&#39;s|GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet splash&quot;|GRUB_CMDLINE_LINUX_DEFAULT=&quot;text&quot;|g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">default</span><span class="o">/</span><span class="n">grub</span>
<span class="n">sudo</span> <span class="n">update</span><span class="o">-</span><span class="n">grub</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span> <span class="o">--</span><span class="n">force</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="nb">set</span><span class="o">-</span><span class="n">default</span> <span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
<span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">For more information, please see:</div>
<div class="line"><a class="reference external" href="http://askubuntu.com/questions/16371/how-do-i-disable-x-at-boot-time-so-that-the-system-boots-in-text-mode">http://askubuntu.com/questions/16371/how-do-i-disable-x-at-boot-time-so-that-the-system-boots-in-text-mode</a>.</div>
</div>
</div>
<span id="document-dns-anomaly-detection"></span><div class="section" id="dns-anomaly-detection">
<h3>DNS Anomaly Detection<a class="headerlink" href="#dns-anomaly-detection" title="Permalink to this headline">¶</a></h3>
<p>Dr. Johannes Ullrich of the SANS Internet Storm Center posted a great
DNS Anomaly Detection script based on the query logs coming from his DNS
server. We can do the same thing with Bro’s dns.log (where Bro captures
all the DNS queries it sees on the network).</p>
<p>Please note that this script is only intended for standalone machines
and will not work properly on distributed deployments.</p>
<p>This version of the script works on older installations using Bro TSV
output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

export PATH=/opt/bro/bin:$PATH
BRO_LOGS=&quot;/nsm/bro/logs&quot;
TODAY=`date +%Y-%m-%d`
YESTERDAY=`date -d yesterday +%Y-%m-%d`
OLD_DIRS=`ls $BRO_LOGS |egrep -v &quot;current|stats|$TODAY|$YESTERDAY&quot;`
TMPDIR=/tmp
OLDLOG=$TMPDIR/oldlog
NEWLOG=$TMPDIR/newlog
SUSPECTS=$TMPDIR/suspects

for DIR in $OLD_DIRS; do zcat $BRO_LOGS/$DIR/dns* |bro-cut id.resp_p query; done | grep -v &quot;^5353&quot; | awk &#39;{print $2}&#39; | sort | uniq -c | sort -k2 &gt; $OLDLOG
zcat $BRO_LOGS/$YESTERDAY/dns* |bro-cut id.resp_p query | grep -v &quot;^5353&quot; | awk &#39;{print $2}&#39; | sort | uniq -c | sort -k2 &gt; $NEWLOG
join -1 2 -2 2  -a 2 $OLDLOG $NEWLOG | egrep -v &#39;.* [0-9]+ [0-9]+$&#39; | sort -nr -k2 | head -50 &gt; $SUSPECTS

echo
echo &quot;====================================&quot;
echo &quot;Top 50 First Time Seen DNS queries:&quot;
echo &quot;====================================&quot;
cat $SUSPECTS
</pre></div>
</div>
<p>We’ve since changed Bro’s default output to json (for faster Logstash
parsing), so <code class="docutils literal notranslate"><span class="pre">senatorhotchkiss</span></code> on our mailing list updated the
script, replacing <code class="docutils literal notranslate"><span class="pre">bro-cut</span></code> with <code class="docutils literal notranslate"><span class="pre">jq</span></code> as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>#!/bin/bash

export PATH=/opt/bro/bin:$PATH
BRO_LOGS=&quot;/nsm/bro/logs&quot;
TODAY=`date +%Y-%m-%d`
YESTERDAY=`date -d yesterday +%Y-%m-%d`
OLD_DIRS=`ls $BRO_LOGS |egrep -v &quot;current|stats|$TODAY|$YESTERDAY&quot;`
TMPDIR=/tmp
OLDLOG=$TMPDIR/oldlog
NEWLOG=$TMPDIR/newlog
SUSPECTS=$TMPDIR/suspects

for DIR in $OLD_DIRS; do zcat $BRO_LOGS/$DIR/dns* | jq &#39;{&quot;id.resp_p&quot;},{&quot;query&quot;}&#39; ; done  | grep -v &quot;^5353&quot; | awk &#39;{print $2}&#39; | sort | uniq -c | sort -k2 &gt; $OLDLOG
zcat $BRO_LOGS/$YESTERDAY/dns* | jq &#39;{&quot;id.resp_p&quot;},{&quot;query&quot;}&#39; | grep -v &quot;^5353&quot; | awk &#39;{print $2}&#39; | sort | uniq -c | sort -k2 &gt; $NEWLOG
join -1 2 -2 2  -a 2 $OLDLOG $NEWLOG | egrep -v &#39;.* [0-9]+ [0-9]+$&#39; | sort -nr -k2 | head -50 &gt; $SUSPECTS

echo
echo &quot;====================================&quot;
echo &quot;Top 50 First Time Seen DNS queries:&quot;
echo &quot;====================================&quot;
cat $SUSPECTS
</pre></div>
</div>
</div>
<span id="document-icmp-anomaly-detection"></span><div class="section" id="icmp-anomaly-detection">
<h3>ICMP Anomaly Detection<a class="headerlink" href="#icmp-anomaly-detection" title="Permalink to this headline">¶</a></h3>
<p>At Security Onion Conference 2016, Eric Conrad shared some IDS rules for
detecting unusual ICMP echo requests/replies and identifying C2 channels
that may utilize ICMP tunneling for covert communication.</p>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>We can add the rules to <code class="docutils literal notranslate"><span class="pre">/etc/nsm/rules/local.rules</span></code> and the variables
to <code class="docutils literal notranslate"><span class="pre">snort.conf</span></code> and/or <code class="docutils literal notranslate"><span class="pre">suricata.yaml</span></code> so that we can gain better
insight into ICMP echoes or replies over a certain size, containing
particularly suspicious content, etc.</p>
</div>
<div class="section" id="presentation">
<h4>Presentation<a class="headerlink" href="#presentation" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">You can find Eric’s presentation here:</div>
<div class="line"><a class="reference external" href="http://www.ericconrad.com/2016/09/c2-phone-home-leveraging-securityonion.html">http://www.ericconrad.com/2016/09/c2-phone-home-leveraging-securityonion.html</a></div>
</div>
</div>
<div class="section" id="download">
<h4>Download<a class="headerlink" href="#download" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">You can download the rules here:</div>
<div class="line"><a class="reference external" href="https://drive.google.com/file/d/0ByeHgv6rpa3gUDNuMUdobFBCNkk">https://drive.google.com/file/d/0ByeHgv6rpa3gUDNuMUdobFBCNkk</a></div>
</div>
</div>
</div>
<span id="document-metapackages"></span><div class="section" id="metapackages">
<h3>MetaPackages<a class="headerlink" href="#metapackages" title="Permalink to this headline">¶</a></h3>
<p>Security Onion consists of over 50 packages in a Launchpad PPA. You can install these packages individually or you can install one or more metapackages (groups of packages) depending on what functionality you need.</p>
<ul>
<li><div class="first line-block">
<div class="line">securityonion-client (about 525MB)</div>
<div class="line">Sguil client, Wireshark, NetworkMiner, etc.</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">client</span>
</pre></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">securityonion-sensor (about 135MB)</div>
<div class="line">Snort, Suricata, Bro, netsniff-ng, Sguil agents, etc.</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">sensor</span>
</pre></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">securityonion-server (about 265MB)</div>
<div class="line">Sguil server, Squert, CapMe, etc.</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">securityonion-elastic (about 5MB)</div>
<div class="line">Scripts and configuration files for the Elastic Stack (Elasticsearch, Logstash, and Kibana) and its associated log pipeline including syslog-ng. This package includes <code class="docutils literal notranslate"><span class="pre">so-elastic-download</span></code> which downloads the Docker images for the Elastic stack. You’ll probably want to install syslog-ng-core explicitly to replace rsyslog.</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">elastic</span> <span class="n">syslog</span><span class="o">-</span><span class="n">ng</span><span class="o">-</span><span class="n">core</span>
</pre></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">securityonion-all (about 930MB)</div>
<div class="line">all of the above plus syslog-ng</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="nb">all</span>
</pre></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">securityonion-iso</div>
<div class="line">all of the above plus bridge-utils, byobu, foremost, pinguybuilder, securityonion-desktop-gnome, securityonion-onionsalt, securityonion-samples-bro, securityonion-samples-markofu, securityonion-samples-mta, securityonion-samples-shellshock, xfsprogs</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">iso</span>
</pre></div>
</div>
</li>
</ul>
</div>
<span id="document-new-disk"></span><div class="section" id="adding-a-new-disk">
<h3>Adding a new disk<a class="headerlink" href="#adding-a-new-disk" title="Permalink to this headline">¶</a></h3>
<p>Before doing this in production, make sure you practice this on a
non-production system!</p>
<p>There are at least 3 different ways to do this:</p>
<div class="section" id="method-1-lvm-logical-volume-management">
<h4>Method 1: LVM (Logical Volume Management)<a class="headerlink" href="#method-1-lvm-logical-volume-management" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">If you chose the LVM option in the Ubuntu installer, then this should be the easiest way of adding disk space:</div>
<div class="line"><a class="reference external" href="https://wiki.ubuntu.com/Lvm">https://wiki.ubuntu.com/Lvm</a></div>
</div>
</div>
<div class="section" id="method-2-mount-a-separate-drive-to-nsm">
<h4>Method 2: Mount a separate drive to /nsm<a class="headerlink" href="#method-2-mount-a-separate-drive-to-nsm" title="Permalink to this headline">¶</a></h4>
<p>This can be done in the Ubuntu installer, or after installation is complete. If doing this after running Setup, then you’ll need to copy the existing data in <code class="docutils literal notranslate"><span class="pre">/nsm</span></code> to the new drive using something like this:</p>
<ol class="arabic">
<li><p class="first">Comment out the cron job in <code class="docutils literal notranslate"><span class="pre">/etc/cron.d/nsm-watchdog</span></code></p>
</li>
<li><p class="first">Restart cron:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">cron</span> <span class="n">restart</span>
</pre></div>
</div>
</li>
<li><p class="first">Stop all services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">nsm</span> <span class="n">stop</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">syslog</span><span class="o">-</span><span class="n">ng</span> <span class="n">stop</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">apache2</span> <span class="n">stop</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">mysql</span> <span class="n">stop</span>
</pre></div>
</div>
</li>
<li><p class="first">Check for any ELSA perl processes which may need to be killed manually:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ps</span> <span class="n">aux</span> <span class="o">|</span><span class="n">grep</span> <span class="n">perl</span>
</pre></div>
</div>
</li>
<li><p class="first">Determine your new drive’s path:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">fdisk</span> <span class="o">-</span><span class="n">l</span>
</pre></div>
</div>
</li>
<li><p class="first">Partition the new drive using <code class="docutils literal notranslate"><span class="pre">fdisk</span></code> or <code class="docutils literal notranslate"><span class="pre">parted</span></code></p>
</li>
<li><p class="first">Format the new partition using <code class="docutils literal notranslate"><span class="pre">mkfs</span></code></p>
</li>
<li><p class="first">Mount the new drive to a temporary location in the filesystem:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb2</span> <span class="o">/</span><span class="n">mnt</span>
</pre></div>
</div>
</li>
<li><p class="first">Copy the existing data from <code class="docutils literal notranslate"><span class="pre">/nsm</span></code> to the temporary location:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">av</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/*</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span>
</pre></div>
</div>
</li>
<li><p class="first">Unmount the new drive from the temporary location:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">umount</span> <span class="o">/</span><span class="n">mnt</span>
</pre></div>
</div>
</li>
<li><p class="first">Rename the existing <code class="docutils literal notranslate"><span class="pre">/nsm</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mv</span> <span class="o">/</span><span class="n">nsm</span> <span class="o">/</span><span class="n">nsm</span><span class="o">-</span><span class="n">backup</span>
</pre></div>
</div>
</li>
<li><p class="first">Update <code class="docutils literal notranslate"><span class="pre">/etc/fstab</span></code> to mount the new drive to <code class="docutils literal notranslate"><span class="pre">/nsm</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">fstab</span>
</pre></div>
</div>
<p>(You can use blkid to find your drive’s UUID to write in /etc/fstab)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">blkid</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">sdb2</span>
</pre></div>
</div>
</li>
<li><p class="first">Re-create nsm directory after it was renamed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">nsm</span>
</pre></div>
</div>
</li>
<li><p class="first">Mount the new <code class="docutils literal notranslate"><span class="pre">/nsm</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mount</span> <span class="o">/</span><span class="n">nsm</span>
</pre></div>
</div>
</li>
<li><p class="first">Start all services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">mysql</span> <span class="n">start</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">apache2</span> <span class="n">start</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">syslog</span><span class="o">-</span><span class="n">ng</span> <span class="n">start</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">nsm</span> <span class="n">start</span>
</pre></div>
</div>
</li>
<li><p class="first">Uncomment the cron job in <code class="docutils literal notranslate"><span class="pre">/etc/cron.d/nsm-watchdog</span></code></p>
</li>
<li><p class="first">Restart cron:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">cron</span> <span class="n">restart</span>
</pre></div>
</div>
</li>
<li><p class="first">Test and verify that everything works</p>
</li>
<li><p class="first">Reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
</li>
<li><p class="first">Test and verify that everything works</p>
</li>
</ol>
</div>
<div class="section" id="method-3-make-nsm-a-symlink-to-the-new-logging-location">
<h4>Method 3: Make /nsm a symlink to the new logging location<a class="headerlink" href="#method-3-make-nsm-a-symlink-to-the-new-logging-location" title="Permalink to this headline">¶</a></h4>
<p>If you do this, you’ll need to do something like the following to avoid AppArmor issues:</p>
<p>Stop all services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">nsm</span> <span class="n">stop</span>
</pre></div>
</div>
<p>Copy existing data from <code class="docutils literal notranslate"><span class="pre">/nsm</span></code> to new mount point:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">av</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/*</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">nsm</span>
</pre></div>
</div>
<p>Rename existing <code class="docutils literal notranslate"><span class="pre">/nsm</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mv</span> <span class="o">/</span><span class="n">nsm</span> <span class="o">/</span><span class="n">nsm</span><span class="o">-</span><span class="n">backup</span>
</pre></div>
</div>
<p>Make <code class="docutils literal notranslate"><span class="pre">/nsm</span></code> a symlink to the new logging location:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">nsm</span> <span class="o">/</span><span class="n">nsm</span>
</pre></div>
</div>
<p>Go to <code class="docutils literal notranslate"><span class="pre">/etc/apparmor.d/local/</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apparmor</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">local</span><span class="o">/</span>
</pre></div>
</div>
<p>Edit <code class="docutils literal notranslate"><span class="pre">usr.sbin.mysqld</span></code>, copy the <code class="docutils literal notranslate"><span class="pre">/nsm</span></code> line(s), and change <code class="docutils literal notranslate"><span class="pre">/nsm</span></code> to the new location:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="n">usr</span><span class="o">.</span><span class="n">sbin</span><span class="o">.</span><span class="n">mysqld</span>
</pre></div>
</div>
<p>Edit <code class="docutils literal notranslate"><span class="pre">usr.sbin.tcpdump</span></code>, copy the <code class="docutils literal notranslate"><span class="pre">/nsm</span></code> line(s), and change <code class="docutils literal notranslate"><span class="pre">/nsm</span></code> to the new location:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="n">usr</span><span class="o">.</span><span class="n">sbin</span><span class="o">.</span><span class="n">tcpdump</span>
</pre></div>
</div>
<p>Restart apparmor:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">apparmor</span> <span class="n">restart</span>
</pre></div>
</div>
<p>Start all services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">nsm</span> <span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="moving-the-mysql-databases">
<h4>Moving the MySQL Databases<a class="headerlink" href="#moving-the-mysql-databases" title="Permalink to this headline">¶</a></h4>
<p>In this section, we’ll cover how to move the MySQL databases containing all of your important alert and event data to another place.  This section assumes we’ll be moving the databases to <code class="docutils literal notranslate"><span class="pre">/nsm</span></code>, though, any other location will do.</p>
<p>The MySQL databases are stored under <code class="docutils literal notranslate"><span class="pre">/var/lib/mysql</span></code>. We will need to move this folder and its sub-contents to the destination location. First, we must stop all processes that may be writing or using the databases.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">nsm</span> <span class="n">stop</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">mysql</span> <span class="n">stop</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">sphinxsearch</span> <span class="n">stop</span>
</pre></div>
</div>
<p>Now, we need to make sure all other nsm-related processes are stopped. To double-check, run <code class="docutils literal notranslate"><span class="pre">lsof</span></code> on the nsm mount point to list any processes that have open file descriptors. Kill everything, or nearly everything, that comes up in the list.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lsof</span> <span class="o">/</span><span class="n">nsm</span>
</pre></div>
</div>
<p>Next, let’s copy the data over to the new location leaving the original intact. You can use <code class="docutils literal notranslate"><span class="pre">cp</span></code> or <code class="docutils literal notranslate"><span class="pre">rsync</span></code> or another similar tool but be sure to preserve permissions ( -p ) and copy recursively ( -r ). Both examples are listed below, choose one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cp</span> <span class="o">-</span><span class="n">rp</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span> <span class="o">/</span><span class="n">nsm</span>
<span class="n">sudo</span> <span class="n">rsync</span> <span class="o">-</span><span class="n">avpr</span> <span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span> <span class="o">/</span><span class="n">nsm</span>
</pre></div>
</div>
<p>Once that’s finished, rename or backup the original just in case something goes wrong.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mv</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="o">.</span><span class="n">bak</span>
</pre></div>
</div>
<p>Next, create a symbolic link from <code class="docutils literal notranslate"><span class="pre">/var/lib/mysql</span></code> to the new location:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ln</span> <span class="o">-</span><span class="n">s</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">mysql</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span>
</pre></div>
</div>
<p>Ubuntu uses AppArmor to add an additional layer of security to running applications. We must tell apparmor about the new mysql database locations otherwise it will prevent the system from using it.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">apparmor</span> <span class="n">stop</span>
</pre></div>
</div>
<p>Edit <code class="docutils literal notranslate"><span class="pre">/etc/apparmor.d/usr.sbin.mysqld</span></code> to reflect the following patch which adds the new location:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vim</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apparmor</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">usr</span><span class="o">.</span><span class="n">sbin</span><span class="o">.</span><span class="n">mysqld</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">apparmor</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">usr</span><span class="o">.</span><span class="n">sbin</span><span class="o">.</span><span class="n">mysqld</span>
<span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">apparmor</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">usr</span><span class="o">.</span><span class="n">sbin</span><span class="o">.</span><span class="n">mysqld</span>
<span class="o">@@</span> <span class="o">-</span><span class="mi">19</span><span class="p">,</span><span class="mi">8</span> <span class="o">+</span><span class="mi">19</span><span class="p">,</span><span class="mi">8</span> <span class="o">@@</span>

<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span><span class="o">.</span><span class="n">allow</span> <span class="n">r</span><span class="p">,</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">hosts</span><span class="o">.</span><span class="n">deny</span> <span class="n">r</span><span class="p">,</span>

<span class="o">+</span>  <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span> <span class="n">r</span><span class="p">,</span>
<span class="o">+</span>  <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">mysql</span><span class="o">/**</span> <span class="n">rwk</span><span class="p">,</span>
<span class="o">+</span>  <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">elsa</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span> <span class="n">r</span><span class="p">,</span>
<span class="o">+</span>  <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">elsa</span><span class="o">/</span><span class="n">data</span><span class="o">/</span><span class="n">mysql</span><span class="o">/**</span> <span class="n">rwk</span><span class="p">,</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/*.</span><span class="n">pem</span> <span class="n">r</span><span class="p">,</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/</span> <span class="n">r</span><span class="p">,</span>
<span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/*</span> <span class="n">r</span><span class="p">,</span>
</pre></div>
</div>
<p>Finally, start all the processes back up:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">apparmor</span> <span class="n">start</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">mysql</span> <span class="n">start</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">sphinxsearch</span> <span class="n">start</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">nsm</span> <span class="n">start</span>
</pre></div>
</div>
</div>
</div>
<span id="document-pcaps"></span><div class="section" id="pcaps-for-testing">
<h3>PCAPs for Testing<a class="headerlink" href="#pcaps-for-testing" title="Permalink to this headline">¶</a></h3>
<p>Security Onion 16.04 comes with several pcap samples in
<code class="docutils literal notranslate"><span class="pre">/opt/samples/</span></code>.</p>
<div class="section" id="links">
<h4>Links<a class="headerlink" href="#links" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><a class="reference external" href="http://www.malware-traffic-analysis.net/">http://www.malware-traffic-analysis.net/</a></li>
<li><a class="reference external" href="http://digitalcorpora.org/corpora/network-packet-dumps">http://digitalcorpora.org/corpora/network-packet-dumps</a></li>
<li><a class="reference external" href="http://www.netresec.com/?page=PcapFiles">http://www.netresec.com/?page=PcapFiles</a></li>
<li><a class="reference external" href="http://www.netresec.com/?page=MACCDC">http://www.netresec.com/?page=MACCDC</a></li>
<li><a class="reference external" href="https://github.com/bro/bro/tree/master/testing/btest/Traces">https://github.com/bro/bro/tree/master/testing/btest/Traces</a></li>
<li><a class="reference external" href="http://www.ll.mit.edu/mission/communications/cyber/CSTcorpora/ideval/data/">http://www.ll.mit.edu/mission/communications/cyber/CSTcorpora/ideval/data/</a></li>
<li><a class="reference external" href="https://wiki.wireshark.org/SampleCaptures">https://wiki.wireshark.org/SampleCaptures</a></li>
<li><a class="reference external" href="https://stratosphereips.org/category/dataset.html">https://stratosphereips.org/category/dataset.html</a></li>
<li><a class="reference external" href="http://old.honeynet.org/scans/">http://old.honeynet.org/scans/</a></li>
<li><a class="reference external" href="http://cctf.shmoo.com/">http://cctf.shmoo.com/</a></li>
<li><a class="reference external" href="http://ee.lbl.gov/anonymized-traces.html">http://ee.lbl.gov/anonymized-traces.html</a></li>
<li><a class="reference external" href="https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Public_Data_Sets">https://redmine.openinfosecfoundation.org/projects/suricata/wiki/Public_Data_Sets</a></li>
<li><a class="reference external" href="http://forensicscontest.com/puzzles">http://forensicscontest.com/puzzles</a></li>
<li><a class="reference external" href="https://www.evilfingers.com/repository/pcaps.php">https://www.evilfingers.com/repository/pcaps.php</a></li>
<li><a class="reference external" href="http://www.honeynet.org/node/504">http://www.honeynet.org/node/504</a></li>
<li><a class="reference external" href="https://github.com/markofu/hackeire/tree/master/2011/pcap">https://github.com/markofu/hackeire/tree/master/2011/pcap</a></li>
<li><a class="reference external" href="http://www.defcon.org/html/links/dc-ctf.html">http://www.defcon.org/html/links/dc-ctf.html</a></li>
<li><a class="reference external" href="https://archive.wrccdc.org/">https://archive.wrccdc.org/</a></li>
<li><a class="reference external" href="https://github.com/chrissanders/packets">https://github.com/chrissanders/packets</a></li>
</ul>
</div>
<div class="section" id="tcpreplay">
<h4>tcpreplay<a class="headerlink" href="#tcpreplay" title="Permalink to this headline">¶</a></h4>
<p>You can use <code class="docutils literal notranslate"><span class="pre">tcpreplay</span></code> to replay any of these pcaps on your Security Onion sensor. For example, please see <a class="reference external" href="https://blog.securityonion.net/2011/01/introduction-to-sguil-and-squert-part-3.html">https://blog.securityonion.net/2011/01/introduction-to-sguil-and-squert-part-3.html</a> for a quick, easy use-case and what you should see in the Sguil console.</p>
</div>
<div class="section" id="so-replay">
<h4>so-replay<a class="headerlink" href="#so-replay" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">so-replay</span></code> will use <code class="docutils literal notranslate"><span class="pre">tcpreplay</span></code> to replay <strong>all</strong> pcap samples in
<code class="docutils literal notranslate"><span class="pre">/opt/samples</span></code> to your sniffing interface.</p>
</div>
<div class="section" id="so-import-pcap">
<h4>so-import-pcap<a class="headerlink" href="#so-import-pcap" title="Permalink to this headline">¶</a></h4>
<p>A drawback to using tcpreplay is that it’s replaying the pcap as new
traffic and thus the timestamps that you see in Kibana, Squert, and
Sguil do not reflect the original timestamps from the pcap. To avoid
this, a new tool was developed called
<a class="reference external" href="so-import-pcap">so-import-pcap</a>.</p>
</div>
</div>
<span id="document-removing-a-sensor"></span><div class="section" id="removing-a-sensor">
<h3>Removing a Sensor<a class="headerlink" href="#removing-a-sensor" title="Permalink to this headline">¶</a></h3>
<p>There may come a time when you need to disable a sensor interface, delete a sensor’s configuration, or get rid of an entire sensor and its data altogether. The steps below outline what is required to accomplish each objective.</p>
<div class="section" id="disable-sensor-interface">
<h4>Disable sensor interface<a class="headerlink" href="#disable-sensor-interface" title="Permalink to this headline">¶</a></h4>
<p>To disable a sensor interface:</p>
<ul class="simple">
<li>stop all sensor processes:</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
<ul class="simple">
<li>edit <code class="docutils literal notranslate"><span class="pre">/etc/nsm/sensortab</span></code> and comment out the sensor interface line</li>
<li>edit <code class="docutils literal notranslate"><span class="pre">/opt/bro/etc/node.cfg</span></code> and comment out the sensor interface stanza</li>
<li>start all sensor processes:</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="delete-sensor-configuration">
<h4>Delete sensor configuration<a class="headerlink" href="#delete-sensor-configuration" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>To delete the configuration for a sensor, run <code class="docutils literal notranslate"><span class="pre">/usr/sbin/nsm_sensor_del</span></code> on the sensor box for which you wish to delete the configuration.</li>
</ul>
</div>
<div class="section" id="wipe-sensor-configuration-and-data">
<h4>Wipe sensor configuration and data<a class="headerlink" href="#wipe-sensor-configuration-and-data" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>To completely wipe sensor configuration and data, run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">sosetup</span></code> on the sensor box for which you wish to wipe the
data and configuration.</li>
</ul>
</div>
<div class="section" id="remove-sensor-reference-from-master-server">
<h4>Remove sensor reference from master server<a class="headerlink" href="#remove-sensor-reference-from-master-server" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>In MySQL database <code class="docutils literal notranslate"><span class="pre">securityonion_db</span></code>, edit <code class="docutils literal notranslate"><span class="pre">sensor</span></code> table (you can simply set active=’N’), then restart sguild.</li>
<li>Stop sguild <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">so-sensor-stop</span></code></li>
<li>Show sensor entries:</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">Dsecurityonion_db</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;select * from sensor&#39;</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li>Set sensor as inactive:</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">Dsecurityonion_db</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;update sensor set active=&#39;N&#39; where sid in (&lt;SID1&gt;,&lt;SID2&gt;)&quot;</span><span class="p">;</span>
</pre></div>
</div>
<ul class="simple">
<li>Start sguild:</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
<ul class="simple">
<li>If running salt, remove the sensor from <code class="docutils literal notranslate"><span class="pre">/opt/onionsalt/salt/top.sls</span></code> and then delete the key from salt:</li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">salt</span><span class="o">-</span><span class="n">key</span> <span class="o">-</span><span class="n">d</span> <span class="n">sensor_key_name</span>
</pre></div>
</div>
<ul class="simple">
<li>PLEASE NOTE: This step is only required if you are still running ELSA. ELSA reached EOL on October 9, 2018.  On the master server, edit <code class="docutils literal notranslate"><span class="pre">/etc/elsa_web.conf</span></code>, remove the sensor from the <code class="docutils literal notranslate"><span class="pre">peers</span></code> section, then restart Apache (<code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">apache2</span> <span class="pre">restart</span></code>).</li>
</ul>
</div>
<div class="section" id="remove-storage-node-reference-from-master-server-elasticsearch-cluster-settings">
<h4>Remove storage node reference from Master server Elasticsearch _cluster/settings<a class="headerlink" href="#remove-storage-node-reference-from-master-server-elasticsearch-cluster-settings" title="Permalink to this headline">¶</a></h4>
<p>From Kibana, navigate to <code class="docutils literal notranslate"><span class="pre">Dev</span> <span class="pre">Tools</span></code> and paste the following text into
the window (modifying <code class="docutils literal notranslate"><span class="pre">nodename</span></code> to match the name of your node):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PUT</span> <span class="n">_cluster</span><span class="o">/</span><span class="n">settings</span>
<span class="p">{</span>
  <span class="s2">&quot;persistent&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;search&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;nodename&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;skip_unavailable&quot;</span><span class="p">:</span> <span class="n">null</span><span class="p">,</span>
          <span class="s2">&quot;seeds&quot;</span><span class="p">:</span><span class="n">null</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Click the play button to send the request to Elasticsearch.</p>
</div>
</div>
<span id="document-salt"></span><div class="section" id="salt">
<h3>Salt<a class="headerlink" href="#salt" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://docs.saltstack.com/en/latest/">https://docs.saltstack.com/en/latest/</a>:</p>
<blockquote>
<div>Salt is a new approach to infrastructure management built on a dynamic communication bus. Salt can be used for data-driven orchestration, remote execution for any infrastructure, configuration management for any app stack, and much more.</div></blockquote>
<div class="section" id="onionsalt">
<h4>OnionSalt<a class="headerlink" href="#onionsalt" title="Permalink to this headline">¶</a></h4>
<p>OnionSalt is a set of Salt scripts created to manage multiple Security Onion sensors.</p>
<p><a class="reference external" href="https://github.com/TOoSmOotH/onionsalt">https://github.com/TOoSmOotH/onionsalt</a></p>
</div>
<div class="section" id="best-practices">
<h4>Best Practices<a class="headerlink" href="#best-practices" title="Permalink to this headline">¶</a></h4>
<p>If you’re using our ISO image, <code class="docutils literal notranslate"><span class="pre">securityonion-onionsalt</span></code> is pre-installed, and Salt is configured by default when choosing <code class="docutils literal notranslate"><span class="pre">Production</span> <span class="pre">Mode</span></code> and then <a class="reference external" href="Best-Practices">Best Practices</a> during Setup.</p>
</div>
<div class="section" id="salt-and-onionsalt-are-optional-packages">
<h4>Salt and OnionSalt are optional packages<a class="headerlink" href="#salt-and-onionsalt-are-optional-packages" title="Permalink to this headline">¶</a></h4>
<p>If you choose to install Security Onion via PPA without installing <code class="docutils literal notranslate"><span class="pre">securityonion-iso</span> <span class="pre">syslog-ng-core</span></code>, please note that Salt is totally optional. If you’re happy with your current method of sensor management, then you don’t have to install <code class="docutils literal notranslate"><span class="pre">securityonion-onionsalt</span></code>, and nothing will change for you. Otherwise, install <code class="docutils literal notranslate"><span class="pre">securityonion-onionsalt</span></code> before running setup to enable Salt for your deployment.</p>
</div>
<div class="section" id="firewall-requirements">
<h4>Firewall Requirements<a class="headerlink" href="#firewall-requirements" title="Permalink to this headline">¶</a></h4>
<p>Sensors need to be able to connect to the master server on ports <code class="docutils literal notranslate"><span class="pre">4505/tcp</span></code> and <code class="docutils literal notranslate"><span class="pre">4506/tcp</span></code>:</p>
<p><a class="reference external" href="http://docs.saltstack.com/topics/tutorials/firewall.html">http://docs.saltstack.com/topics/tutorials/firewall.html</a></p>
</div>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>For new deployments, <a class="reference external" href="Best-Practices">Best Practices</a> (Production Mode) checks to see if the <code class="docutils literal notranslate"><span class="pre">securityonion-onionsalt</span></code> package is installed and, if so, enables Salt by default. If choosing the “Custom” configuration option (Production Mode), simply answer “Yes” at the prompt (where applicable), and setup will configure salt-master and/or salt-minion services and open firewall ports as necessary.</p>
<p>For existing deployments, please see the <a class="reference external" href="Salt#salting-an-existing-deployment">Existing Deployment</a> section.</p>
</div>
<div class="section" id="checking-status">
<h4>Checking Status<a class="headerlink" href="#checking-status" title="Permalink to this headline">¶</a></h4>
<p>Want to verify all your sensors are up?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">test</span><span class="o">.</span><span class="n">ping</span>
</pre></div>
</div>
</div>
<div class="section" id="remote-execution">
<h4>Remote Execution<a class="headerlink" href="#remote-execution" title="Permalink to this headline">¶</a></h4>
<p>Want to execute a command on all your sensors at once?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">cmd</span><span class="o">.</span><span class="n">run</span> <span class="s1">&#39;InsertYourCommandHere&#39;</span>
</pre></div>
</div>
</div>
<div class="section" id="features">
<h4>Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h4>
<p>When you install and enable securityonion-onionsalt, the following data will replicate from the master server out to the sensors every 15 minutes:</p>
<ul>
<li><p class="first">NIDS rules in /etc/nsm/rules/ (Snort/Suricata/barnyard will automatically restart as necessary)</p>
</li>
<li><p class="first">HIDS rules in /var/ossec/rules/local_rules.xml (Wazuh will automatically restart as necessary)</p>
</li>
<li><p class="first">Bro scripts in /opt/bro/share/bro/policy/</p>
<ul>
<li><p class="first">Bro does not restart automatically, but you can easily use salt on your master server to tell all your Bro instances to update and restart:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Force all Salt minions to update Bro scripts</span>
<span class="n">sudo</span> <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">state</span><span class="o">.</span><span class="n">highstate</span>
<span class="c1"># Restart Bro</span>
<span class="n">sudo</span> <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">cmd</span><span class="o">.</span><span class="n">run</span> <span class="s1">&#39;so-bro-restart&#39;</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p class="first">Bro intel in /opt/bro/share/bro/intel/</p>
<ul class="simple">
<li>You’ll need to restart Bro as shown above if you add any intel files to the default intel.dat. After that initial Bro restart, Bro should be watching the intel files with the Input framework which should automatically notice if the files ever change (new intel is added). In many cases, you won’t need to restart Bro if you’re just adding intel to the existing intel file(s).</li>
</ul>
</li>
<li><p class="first">user accounts and sudoers in /opt/onionsalt/pillar/users/init.sls</p>
</li>
<li><p class="first">user ssh keys in /opt/onionsalt/salt/users/keys/</p>
<ul class="simple">
<li>For each user account in /opt/onionsalt/pillar/users/init.sls, you can add an SSH Public Key to <code class="docutils literal notranslate"><span class="pre">/opt/onionsalt/salt/users/keys/USERNAME.id_rsa.pub</span></code> (replacing <code class="docutils literal notranslate"><span class="pre">USERNAME</span></code> with the user’s actual username)</li>
</ul>
</li>
</ul>
<p>In addition, Salt is a full configuration management system, so you can script anything that you want to deploy across your army of sensors.</p>
</div>
<div class="section" id="using-salt-to-install-updates-across-your-entire-deployment">
<h4>Using Salt to Install Updates Across Your Entire Deployment<a class="headerlink" href="#using-salt-to-install-updates-across-your-entire-deployment" title="Permalink to this headline">¶</a></h4>
<p>You can use Salt and Soup to install updates across your entire deployment, but please remember to always update your master server first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Update Master first</span>
<span class="c1"># If MySQL and/or kernel updates are installed, it will reboot</span>
<span class="n">sudo</span> <span class="n">soup</span> <span class="o">-</span><span class="n">y</span>

<span class="c1"># After Master server is fully updated, now update the rest of the deployment</span>
<span class="c1"># If MySQL and/or kernel updates are installed, the sensors will reboot</span>
<span class="n">sudo</span> <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">cmd</span><span class="o">.</span><span class="n">run</span> <span class="s1">&#39;soup -y&#39;</span>
</pre></div>
</div>
<p>Also, please keep in mind that occasionally Ubuntu will release updates that prompt for user input which would cause that last command to hang. If you experience this, you should be able to ssh to each sensor and run <code class="docutils literal notranslate"><span class="pre">soup</span></code> interactively. For more information, please see <a class="reference external" href="https://github.com/Security-Onion-Solutions/security-onion/issues/1108">https://github.com/Security-Onion-Solutions/security-onion/issues/1108</a>.</p>
</div>
<div class="section" id="modifying-salt-config-files">
<h4>Modifying Salt config files<a class="headerlink" href="#modifying-salt-config-files" title="Permalink to this headline">¶</a></h4>
<p>If you need to modify the values in <code class="docutils literal notranslate"><span class="pre">/etc/salt/master</span></code> or <code class="docutils literal notranslate"><span class="pre">/etc/salt/minion</span></code>, please pay attention to this note at the top of each file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/salt/master</span>
<span class="c1"># Per default, the master will automatically include all config files</span>
<span class="c1"># from master.d/*.conf (master.d is a directory in the same directory</span>
<span class="c1"># as the main master config file)</span>
<span class="c1">#default_include: master.d/*.conf</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># /etc/salt/minion</span>
<span class="c1"># Per default the minion will automatically include all config files</span>
<span class="c1"># from minion.d/*.conf (minion.d is a directory in the same directory</span>
<span class="c1"># as the main minion config file).</span>
<span class="c1">#default_include: minion.d/*.conf</span>
</pre></div>
</div>
<p>Instead of modifying /etc/salt/master or /etc/salt/minion directly, please add your custom settings in <code class="docutils literal notranslate"><span class="pre">/etc/salt/master.d/*.conf</span></code> or <code class="docutils literal notranslate"><span class="pre">/etc/salt/minion.d/*.conf</span></code>, respectively.</p>
</div>
<div class="section" id="changing-minion-id">
<h4>Changing Minion ID<a class="headerlink" href="#changing-minion-id" title="Permalink to this headline">¶</a></h4>
<p>If you need to change the ID for a minion, do the following.</p>
<p>On the minion machine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Stop salt-minion</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">salt</span><span class="o">-</span><span class="n">minion</span> <span class="n">stop</span>

<span class="c1"># Edit /etc/salt/minion_id, modifying the ID as necessary.</span>

<span class="c1"># Start salt-minion</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">salt</span><span class="o">-</span><span class="n">minion</span> <span class="n">start</span>
</pre></div>
</div>
<p>On the master machine:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Restart salt-master</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="n">restart</span>

<span class="c1"># List the salt keys</span>
<span class="n">sudo</span> <span class="n">salt</span><span class="o">-</span><span class="n">key</span> <span class="o">-</span><span class="n">L</span>

<span class="c1"># Accept the new key for the modified minion</span>
<span class="n">sudo</span> <span class="n">salt</span><span class="o">-</span><span class="n">key</span> <span class="o">-</span><span class="n">A</span>

<span class="c1"># Delete the old minion key</span>
<span class="n">sudo</span> <span class="n">salt</span><span class="o">-</span><span class="n">key</span> <span class="o">-</span><span class="n">d</span> <span class="n">OLD_MINION_NAME</span>

<span class="c1"># Test the configuration -- minion should return &quot;TRUE&quot;</span>
<span class="n">sudo</span> <span class="n">salt</span> <span class="s2">&quot;MINION_NAME&quot;</span> <span class="n">test</span><span class="o">.</span><span class="n">ping</span>
</pre></div>
</div>
</div>
<div class="section" id="salting-an-existing-deployment">
<h4>Salting an Existing Deployment<a class="headerlink" href="#salting-an-existing-deployment" title="Permalink to this headline">¶</a></h4>
<div class="section" id="configure-the-master-server-first">
<h5>Configure the Master Server first<a class="headerlink" href="#configure-the-master-server-first" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Make sure the necessary packages are installed and updated</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">onionsalt</span>

<span class="c1"># Create a starting /opt/onionsalt/pillar/users/init.sls and /opt/onionsalt/salt/top.sls file from the template.</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">onionsalt</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">top</span><span class="o">.</span><span class="n">sls</span><span class="o">.</span><span class="n">template</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">onionsalt</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">top</span><span class="o">.</span><span class="n">sls</span>
<span class="n">sudo</span> <span class="n">cp</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">onionsalt</span><span class="o">/</span><span class="n">pillar</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">sls</span><span class="o">.</span><span class="n">template</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">onionsalt</span><span class="o">/</span><span class="n">pillar</span><span class="o">/</span><span class="n">users</span><span class="o">/</span><span class="n">init</span><span class="o">.</span><span class="n">sls</span>

<span class="c1"># Edit /opt/onionsalt/salt/top.sls and add your master as a &quot;backend&quot;.</span>
<span class="c1"># For example, if your SO master server&#39;s hostname is so-master, then replace:</span>
   <span class="c1"># My Onion Backend:</span>
      <span class="s1">&#39;C*&#39;</span><span class="p">:</span>
         <span class="o">-</span> <span class="n">backend</span>
<span class="k">with</span><span class="p">:</span>
   <span class="c1"># My Onion Backend:</span>
      <span class="s1">&#39;so-master&#39;</span><span class="p">:</span>
         <span class="o">-</span> <span class="n">backend</span>

<span class="c1"># Open salt ports in firewall:</span>
<span class="c1"># sudo ufw allow salt</span>
<span class="c1"># OR preferably just allow from your sensor IP addresses like this:</span>
<span class="c1"># sudo ufw allow proto tcp from a.b.c.d to any port 4505,4506</span>
<span class="c1"># Also see our Firewall page:</span>
<span class="c1"># https://securityonion.net/docs/Firewall</span>

<span class="c1"># Configure minion</span>
<span class="n">echo</span> <span class="s2">&quot;master: localhost&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span><span class="n">minion</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">onionsalt</span><span class="o">.</span><span class="n">conf</span>

<span class="c1"># Allow salt-master and salt-minion to start on boot if they had previously been disabled</span>
<span class="p">[</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span><span class="o">.</span><span class="n">DISABLED</span> <span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">mv</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span><span class="o">.</span><span class="n">DISABLED</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span><span class="o">.</span><span class="n">conf</span>
<span class="p">[</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span><span class="o">.</span><span class="n">override</span> <span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">master</span><span class="o">.</span><span class="n">override</span>
<span class="p">[</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">minion</span><span class="o">.</span><span class="n">DISABLED</span> <span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">mv</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">minion</span><span class="o">.</span><span class="n">DISABLED</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">minion</span><span class="o">.</span><span class="n">conf</span>
<span class="p">[</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">minion</span><span class="o">.</span><span class="n">override</span> <span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">init</span><span class="o">/</span><span class="n">salt</span><span class="o">-</span><span class="n">minion</span><span class="o">.</span><span class="n">override</span>

<span class="c1"># Restart minion</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">salt</span><span class="o">-</span><span class="n">minion</span> <span class="n">restart</span>

<span class="c1"># list the salt keys:</span>
<span class="n">sudo</span> <span class="n">salt</span><span class="o">-</span><span class="n">key</span> <span class="o">-</span><span class="n">L</span>

<span class="c1"># You should see an unaccepted salt key for the minion, add it:</span>
<span class="n">sudo</span> <span class="n">salt</span><span class="o">-</span><span class="n">key</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;*&#39;</span>

<span class="c1"># Verify that the master can communicate with the minion:</span>
<span class="n">sudo</span> <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">test</span><span class="o">.</span><span class="n">ping</span>

<span class="c1"># Tell salt to do an update</span>
<span class="n">sudo</span> <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">state</span><span class="o">.</span><span class="n">highstate</span>
</pre></div>
</div>
</div>
<div class="section" id="now-configure-salt-minion-on-a-sensor">
<h5>Now configure salt-minion on a Sensor<a class="headerlink" href="#now-configure-salt-minion-on-a-sensor" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Make sure the necessary packages are installed and updated
sudo apt-get update &amp;&amp; sudo apt-get install securityonion-onionsalt

# Stop the running salt-master
sudo service salt-master stop

# Disable salt-master
[ -f /etc/init/salt-master.conf ] &amp;&amp; echo &quot;manual&quot; | sudo tee /etc/init/salt-master.override

# Allow salt-minion to start on boot if it had previously been disabled
[ -f /etc/init/salt-minion.DISABLED ] &amp;&amp; sudo mv /etc/init/salt-minion.DISABLED /etc/init/salt-minion.conf
[ -f /etc/init/salt-minion.override ] &amp;&amp; sudo rm -f /etc/init/salt-minion.override

# Configure minion
MASTER=`grep SENSOR_SERVER_HOST /etc/nsm/*/sensor.conf |head -1 |cut -d\&quot; -f2`
echo &quot;master: $MASTER&quot; | sudo tee -a /etc/salt/minion.d/onionsalt.conf

# Restart minion
sudo service salt-minion restart
</pre></div>
</div>
</div>
<div class="section" id="now-return-to-the-master-and-accept-the-new-minion">
<h5>Now return to the Master and accept the new minion<a class="headerlink" href="#now-return-to-the-master-and-accept-the-new-minion" title="Permalink to this headline">¶</a></h5>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Edit /opt/onionsalt/salt/top.sls and add the new minion as a &quot;sensor&quot;</span>

<span class="c1"># list the salt keys:</span>
<span class="n">sudo</span> <span class="n">salt</span><span class="o">-</span><span class="n">key</span> <span class="o">-</span><span class="n">L</span>

<span class="c1"># You should see an unaccepted salt key for the sensor, add it:</span>
<span class="n">sudo</span> <span class="n">salt</span><span class="o">-</span><span class="n">key</span> <span class="o">-</span><span class="n">a</span> <span class="s1">&#39;*&#39;</span>

<span class="c1"># Verify that the master can communicate with all minions:</span>
<span class="n">sudo</span> <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">test</span><span class="o">.</span><span class="n">ping</span>

<span class="c1"># Tell all minions to do an update</span>
<span class="n">sudo</span> <span class="n">salt</span> <span class="s1">&#39;*&#39;</span> <span class="n">state</span><span class="o">.</span><span class="n">highstate</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="maximum-event-size">
<h4>Maximum Event Size<a class="headerlink" href="#maximum-event-size" title="Permalink to this headline">¶</a></h4>
<p>Salt-master uses a default <code class="docutils literal notranslate"><span class="pre">max_event_size</span></code> of <strong>1048576</strong> bytes (1 <a class="reference external" href="https://en.wikipedia.org/wiki/Mebibyte">Mebibyte</a>). For some Security Onion deployments, this may need to be change to a larger value to avoid receiving a <code class="docutils literal notranslate"><span class="pre">VALUE_TRIMMED</span></code> error (if the output of a command run on a minion is too large to be passed back to the master).</p>
<p>See:
<a class="reference external" href="https://docs.saltstack.com/en/latest/ref/configuration/master.html#max-event-size">https://docs.saltstack.com/en/latest/ref/configuration/master.html#max-event-size</a></p>
<p>This setting should be changed in <code class="docutils literal notranslate"><span class="pre">/etc/salt/master.d/onionsalt.conf</span></code>, as opposed to directly in <code class="docutils literal notranslate"><span class="pre">/etc/salt/master</span></code>.</p>
<p>On a distributed Security Onion deployment <code class="docutils literal notranslate"><span class="pre">/etc/salt/master.d/onionsalt.conf</span></code> (on the master) should look like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">file_roots</span><span class="p">:</span>
  <span class="n">base</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">onionsalt</span><span class="o">/</span><span class="n">salt</span>

<span class="n">pillar_roots</span><span class="p">:</span>
  <span class="n">base</span><span class="p">:</span>
    <span class="o">-</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">onionsalt</span><span class="o">/</span><span class="n">pillar</span>

<span class="n">max_event_size</span><span class="p">:</span> <span class="n">YOUR_NEW_VALUE</span>
</pre></div>
</div>
<p>After making changes, ensure salt-master has been started/restarted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">salt</span><span class="o">-</span><span class="n">master</span> <span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="additional-reading">
<h4>Additional Reading<a class="headerlink" href="#additional-reading" title="Permalink to this headline">¶</a></h4>
<p><a class="reference external" href="http://www.geekempire.com/2014/09/onionsalt-saltstack-cheat-sheer.html">http://www.geekempire.com/2014/09/onionsalt-saltstack-cheat-sheer.html</a></p>
</div>
</div>
<span id="document-sensor-stops-seeing-traffic"></span><div class="section" id="sensor-stops-seeing-traffic">
<h3>Sensor Stops Seeing Traffic<a class="headerlink" href="#sensor-stops-seeing-traffic" title="Permalink to this headline">¶</a></h3>
<p>If you want an alert when your sensor stops seeing traffic, there are a few options:</p>
<div class="section" id="wazuh">
<h4>Wazuh<a class="headerlink" href="#wazuh" title="Permalink to this headline">¶</a></h4>
<p>Wazuh checks your sniffing interfaces every 10 minutes. If no packets have been received within that 10 minute window, then Wazuh will generate an alert. This alert can be found in Sguil, Squert, and Kibana. If you’d like Wazuh to email you, then configure it for email as shown in the <a class="reference external" href="Email">Email</a> section.</p>
</div>
<div class="section" id="bro">
<h4>Bro<a class="headerlink" href="#bro" title="Permalink to this headline">¶</a></h4>
<p>Bro will automatically email you when it stops seeing traffic on an interface. All you have to do is configure Bro per the <a class="reference external" href="Email">Email</a> section.</p>
</div>
</div>
<span id="document-ssh"></span><div class="section" id="ssh">
<h3>SSH<a class="headerlink" href="#ssh" title="Permalink to this headline">¶</a></h3>
<div class="section" id="changing-the-default-ssh-listening-port">
<h4>Changing the default ssh listening port<a class="headerlink" href="#changing-the-default-ssh-listening-port" title="Permalink to this headline">¶</a></h4>
<p>By default secure shell (ssh) listens on <code class="docutils literal notranslate"><span class="pre">tcp</span> <span class="pre">port</span> <span class="pre">22</span></code>. If you want to obfuscate it by changing the listening port from <code class="docutils literal notranslate"><span class="pre">port</span> <span class="pre">22</span></code> to something else like <code class="docutils literal notranslate"><span class="pre">port</span> <span class="pre">31337</span></code>, you can do so in <code class="docutils literal notranslate"><span class="pre">/etc/ssh/sshd_config</span></code>.</p>
<p>You can use your favorite text editor (e.g., <code class="docutils literal notranslate"><span class="pre">vi</span></code>, <code class="docutils literal notranslate"><span class="pre">gedit</span></code>, <code class="docutils literal notranslate"><span class="pre">nano</span></code>, <code class="docutils literal notranslate"><span class="pre">emacs</span></code>) to edit <code class="docutils literal notranslate"><span class="pre">/etc/ssh/sshd_config</span></code>, but for the purpose of this example <code class="docutils literal notranslate"><span class="pre">vi</span></code> will be used.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">ssh</span><span class="o">/</span><span class="n">sshd_config</span>
</pre></div>
</div>
<p>Change the <code class="docutils literal notranslate"><span class="pre">Port</span></code> setting from <code class="docutils literal notranslate"><span class="pre">22</span></code> to <code class="docutils literal notranslate"><span class="pre">31337</span></code>.  Then restart the ssh daemon so that it will now start listening on port <code class="docutils literal notranslate"><span class="pre">31337</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">killall</span> <span class="o">-</span><span class="n">HUP</span> <span class="n">sshd</span>
</pre></div>
</div>
<p>Verify that ssh is listening on the new port:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">netstat</span> <span class="o">-</span><span class="n">nltp</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">sshd</span>
</pre></div>
</div>
<p>Allow the new ssh port in the firewall:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="mi">31337</span><span class="o">/</span><span class="n">tcp</span>
</pre></div>
</div>
</div>
</div>
<span id="document-timezones"></span><div class="section" id="utc-and-time-zones">
<h3>UTC and Time Zones<a class="headerlink" href="#utc-and-time-zones" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">When you run Security Onion Setup, it sets the timezone to UTC/GMT
because that is the recommended/required setting for Sguil:</div>
<div class="line"><a class="reference external" href="http://osdir.com/ml/security.sguil.general/2008-09/msg00003.html">http://osdir.com/ml/security.sguil.general/2008-09/msg00003.html</a></div>
<div class="line"><a class="reference external" href="https://forums.snort.org/forums/linux/topics/barnyard-sguil-time-problem">https://forums.snort.org/forums/linux/topics/barnyard-sguil-time-problem</a></div>
<div class="line"><br /></div>
<div class="line">Trying to use a non-UTC timezone can result in the following:</div>
</div>
<ul class="simple">
<li>Time zones that have daylight saving time have a one-hour time warp twice a year. This manifests itself in Sguil not being able to pull transcripts for events within that one-hour time period. This is avoided by using UTC, since there is no daylight saving time.</li>
<li>Something similar can happen on a daily basis under certain conditions. If there is a discrepancy between the OS timezone and the Sguil UTC settings, then Sguil will be unable to pull transcripts for events in a window of time around midnight coinciding with the timezone’s offset from UTC.</li>
</ul>
<p>Additionally, UTC comes in quite handy when you have sensors in different time zones and/or are trying to correlate events with other systems or teams.</p>
<p>Kibana by default will render timestamps in the timezone of your local browser and Squert allows you to set your timezone.</p>
<div class="section" id="how-do-i-change-the-timezone-for-ubuntu">
<h4>How do I change the timezone for Ubuntu?<a class="headerlink" href="#how-do-i-change-the-timezone-for-ubuntu" title="Permalink to this headline">¶</a></h4>
<p>When you run our Setup wizard, it should automatically set your OS timezone to UTC. If you’ve already run Setup and then manually changed your timezone to non-UTC and would like to switch back to UTC, you can execute <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">dpkg-reconfigure</span> <span class="pre">tzdata</span></code>. Scroll to the bottom of the Continents list and select <code class="docutils literal notranslate"><span class="pre">None</span> <span class="pre">of</span> <span class="pre">the</span> <span class="pre">above</span></code>. In the second list, select <code class="docutils literal notranslate"><span class="pre">UTC</span></code>.
(<a class="reference external" href="http://askubuntu.com/questions/138423/how-do-i-change-my-timezone-to-utc-gmt">http://askubuntu.com/questions/138423/how-do-i-change-my-timezone-to-utc-gmt</a>)</p>
</div>
</div>
</div>
</div>
<span id="document-services"></span><div class="section" id="services">
<h2>Services<a class="headerlink" href="#services" title="Permalink to this headline">¶</a></h2>
<p>Services are controlled by the use of Security Onion scripts (<code class="docutils literal notranslate"><span class="pre">so-&lt;noun&gt;-&lt;verb&gt;</span></code>) which act as wrappers to other lower-level scripts. You can see a list of all of these scripts with the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">sbin</span><span class="o">/</span><span class="n">so</span><span class="o">-*</span>
</pre></div>
</div>
<p>These scripts are detailed below.</p>
<div class="section" id="all-services">
<h3>All services<a class="headerlink" href="#all-services" title="Permalink to this headline">¶</a></h3>
<p>You can control all services with the <code class="docutils literal notranslate"><span class="pre">so-&lt;verb&gt;</span></code> scripts as follows.</p>
<p>Check status of all services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">status</span>
</pre></div>
</div>
<p>Start all services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
<p>Stop all services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
<p>Restart all services:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>The three main categories of services are server, sensor, and elastic.</p>
</div>
<div class="section" id="server-services">
<h3>Server services<a class="headerlink" href="#server-services" title="Permalink to this headline">¶</a></h3>
<p>Check status of sguild (Sguil server):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">status</span>
</pre></div>
</div>
<p>Start sguild:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
<p>Stop sguild:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
<p>Restart sguild:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="sensor-services">
<h3>Sensor services<a class="headerlink" href="#sensor-services" title="Permalink to this headline">¶</a></h3>
<p>Sensor services are controlled with <code class="docutils literal notranslate"><span class="pre">so-sensor-*</span></code>.</p>
<p>The following examples are for Bro, but you could substitute whatever sensor service you’re trying to control (nids, pcap, etc.).</p>
<p>Check status of Bro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">status</span>
</pre></div>
</div>
<p>Start Bro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
<p>Stop Bro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
<p>Restart Bro:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">bro</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="elastic-services">
<h3>Elastic services<a class="headerlink" href="#elastic-services" title="Permalink to this headline">¶</a></h3>
<p>Elastic services are controlled with <code class="docutils literal notranslate"><span class="pre">so-elastic-*</span></code>.</p>
<p>Check status of the Elastic stack:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">status</span>
</pre></div>
</div>
<p>Start the Elastic stack:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">start</span>
</pre></div>
</div>
<p>Stop the Elastic stack:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
<p>Restart the Elastic stack:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</div>
</div>
<span id="document-utilities"></span><div class="section" id="utilities">
<h2>Utilities<a class="headerlink" href="#utilities" title="Permalink to this headline">¶</a></h2>
<p>This section covers some of the main utilities in Security Onion.</p>
<div class="toctree-wrapper compound">
<span id="document-jq"></span><div class="section" id="jq">
<h3>jq<a class="headerlink" href="#jq" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://stedolan.github.io/jq/">https://stedolan.github.io/jq/</a>:</p>
<blockquote>
<div>jq is like sed for JSON data - you can use it to slice and filter and map and transform structured data with the same ease that sed, awk, grep and friends let you play with text.</div></blockquote>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>If you have <a class="reference external" href="Bro">Bro</a> configured to write logs in JSON format and you want to parse those logs from the command line, then you can use <code class="docutils literal notranslate"><span class="pre">jq</span></code>.  Here’s a basic example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jq</span> <span class="s1">&#39;.&#39;</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">current</span><span class="o">/</span><span class="n">conn</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>This command will parse all of the records in <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs/current/conn.log</span></code>.  For each of the records, it will then output every field and its value.</p>
</div>
<div class="section" id="more-information">
<h4>More Information<a class="headerlink" href="#more-information" title="Permalink to this headline">¶</a></h4>
<p>For more information about <code class="docutils literal notranslate"><span class="pre">jq</span></code>, please see <a class="reference external" href="https://stedolan.github.io/jq/">https://stedolan.github.io/jq/</a>.</p>
</div>
</div>
<span id="document-setup"></span><div class="section" id="setup">
<h3>Setup<a class="headerlink" href="#setup" title="Permalink to this headline">¶</a></h3>
<p>After installing Security Onion, double-click the <code class="docutils literal notranslate"><span class="pre">Setup</span></code> icon on the desktop (or run <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">sosetup</span></code> from a terminal) to configure your system.  In most cases, you’ll run Setup to do network configuration, reboot, and then run Setup again for service configuration.</p>
<div class="section" id="automating-setup">
<h4>Automating Setup<a class="headerlink" href="#automating-setup" title="Permalink to this headline">¶</a></h4>
<p>You can automate the Setup process using <code class="docutils literal notranslate"><span class="pre">sosetup.conf</span></code>.</p>
</div>
<div class="section" id="starting-from-scratch">
<h4>Starting from scratch<a class="headerlink" href="#starting-from-scratch" title="Permalink to this headline">¶</a></h4>
<p>There are a few example files in <code class="docutils literal notranslate"><span class="pre">/usr/share/securityonion/</span></code>.  Copy one of these example files to your home directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cp</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">securityonion</span><span class="o">/</span><span class="n">sosetup</span><span class="o">.</span><span class="n">conf</span> <span class="o">~</span>
</pre></div>
</div>
<p>Edit your new <code class="docutils literal notranslate"><span class="pre">sosetup.conf</span></code> using <code class="docutils literal notranslate"><span class="pre">nano</span></code> or your favorite text editor:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nano</span> <span class="o">~/</span><span class="n">sosetup</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Then run Setup with the <code class="docutils literal notranslate"><span class="pre">-f</span></code> switch and the path to this file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sosetup</span> <span class="o">-</span><span class="n">f</span> <span class="o">~/</span><span class="n">sosetup</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</div>
<div class="section" id="sosetup-w">
<h4>sosetup -w<a class="headerlink" href="#sosetup-w" title="Permalink to this headline">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">sosetup</span></code> also supports a <code class="docutils literal notranslate"><span class="pre">-w</span></code> switch that allows you to answer the standard Setup questions and have it write out your custom <code class="docutils literal notranslate"><span class="pre">sosetup.conf</span></code>.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure sosetup to write out a new configuration file called sosetup.conf</span>
<span class="n">sosetup</span> <span class="o">-</span><span class="n">w</span> <span class="o">~/</span><span class="n">sosetup</span><span class="o">.</span><span class="n">conf</span>

<span class="c1"># Answer all questions in Setup</span>

<span class="c1"># Run sosetup with the new configuration file</span>
<span class="n">sudo</span> <span class="n">sosetup</span> <span class="o">-</span><span class="n">f</span> <span class="o">~/</span><span class="n">sosetup</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
</div>
</div>
<span id="document-so-allow"></span><div class="section" id="so-allow">
<h3>so-allow<a class="headerlink" href="#so-allow" title="Permalink to this headline">¶</a></h3>
<p>Setup locks down the <a class="reference external" href="Firewall">firewall</a> by default.  If you need to open ports for OSSEC agents, syslog devices, or analyst VMs, you can run <code class="docutils literal notranslate"><span class="pre">so-allow</span></code> and it will walk you through this process. <code class="docutils literal notranslate"><span class="pre">so-allow</span></code> also provides an option to add firewall rules for sensors although you shouldn’t need this under normal circumstances since they should automatically add their own rules.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>This program allows you to add a firewall rule to allow connections from a new IP address.

What kind of device do you want to allow?

[a] - Analyst - ports 22/tcp, 443/tcp, and 7734/tcp
[b] - Logstash Beat - port 5044/tcp
[c] - apt-cacher-ng client - port 3142/tcp
[e] - Elasticsearch REST endpoint - port 9200
[f] - Logstash forwarder - standard - port 6050/tcp
[j] - Logstash forwarder - JSON - port 6051/tcp
[l] - Syslog device - port 514
[n] - Elasticsearch node-to-node communication - port 9300
[o] - OSSEC agent - port 1514
[s] - Security Onion sensor - 22/tcp, 4505/tcp, 4506/tcp, and 7736/tcp

If you need to add any ports other than those listed above,
you can do so using the standard &#39;ufw&#39; utility.

For more information, please see:
https://securityonion.net/docs/Firewall

Please enter your selection (a - analyst, c - apt-cacher-ng client, l - syslog, o - ossec, or s - Security Onion sensor, etc.):
</pre></div>
</div>
<div class="section" id="so-allow-view">
<h4>so-allow-view<a class="headerlink" href="#so-allow-view" title="Permalink to this headline">¶</a></h4>
<p>To view existing rules granted through the use of <code class="docutils literal notranslate"><span class="pre">so-allow</span></code>, use the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">so</span><span class="o">-</span><span class="n">allow</span><span class="o">-</span><span class="n">view</span>
</pre></div>
</div>
</div>
<div class="section" id="wazuh-whitelist">
<h4>Wazuh Whitelist<a class="headerlink" href="#wazuh-whitelist" title="Permalink to this headline">¶</a></h4>
<p>If you choose the <code class="docutils literal notranslate"><span class="pre">analyst</span></code> option, <code class="docutils literal notranslate"><span class="pre">so-allow</span></code> will also add the <code class="docutils literal notranslate"><span class="pre">analyst</span></code> IP address to the Wazuh Whitelist.  This will prevent Wazuh Active Response from blocking the <code class="docutils literal notranslate"><span class="pre">analyst</span></code> IP address.</p>
</div>
</div>
<span id="document-so-import-pcap"></span><div class="section" id="so-import-pcap">
<h3>so-import-pcap<a class="headerlink" href="#so-import-pcap" title="Permalink to this headline">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">so-import-pcap</span></code> is a quick and dirty EXPERIMENTAL script that will import one or more pcaps into Security Onion and preserve original timestamps.</p>
<p>It will do the following:</p>
<ul class="simple">
<li>stop and disable Curator to avoid closing old indices</li>
<li>stop and disable all active sniffing processes (Bro, Snort, Suricata, and netsniff-ng)</li>
<li>stop and disable ossec_agent</li>
<li>reconfigure and restart sguild, syslog-ng, and Logstash where necessary</li>
<li>generate IDS alerts using Snort or Suricata</li>
<li>generate Bro logs</li>
<li>store IDS alerts and Bro logs with original timestamps</li>
<li>split traffic into separate daily pcaps and store them where sguil’s pcap_agent can find them</li>
</ul>
<p>Requirements:</p>
<ul class="simple">
<li>You must be running at least Security Onion 16.04.</li>
</ul>
<p>Warnings:</p>
<ul class="simple">
<li>Do NOT run this on a production deployment. It is designed for standalone systems designated for so-import-pcap.</li>
<li>If you’re running in a VM with snapshot capability, you might want to take a snapshot before this program makes changes.</li>
</ul>
<p>Reverting System Changes:</p>
<ul class="simple">
<li>If you take a VM snapshot before this program makes changes, then just revert to snapshot.</li>
<li>Otherwise, you can re-run Setup and it should overwrite all modified files to revert the system to normal operation.</li>
</ul>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>Please supply at least one pcap file.</p>
<p>For example, to import a single pcap named <code class="docutils literal notranslate"><span class="pre">import.pcap</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">so</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">pcap</span> <span class="n">import</span><span class="o">.</span><span class="n">pcap</span>
</pre></div>
</div>
<p>To import multiple pcaps:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">so</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">pcap</span> <span class="n">import1</span><span class="o">.</span><span class="n">pcap</span> <span class="n">import2</span><span class="o">.</span><span class="n">pcap</span>
</pre></div>
</div>
</div>
<div class="section" id="example">
<h4>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h4>
<p>For a detailed walk-through with screenshots, please see <a class="reference external" href="https://taosecurity.blogspot.com/2018/02/importing-pcap-into-security-onion.html">https://taosecurity.blogspot.com/2018/02/importing-pcap-into-security-onion.html</a>.</p>
</div>
<div class="section" id="warning">
<h4>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h4>
<p>Please note that so-import-pcap will make changes to your system! It will warn you before doing so and will prompt you to press Enter to continue or Ctrl-c to cancel.</p>
<p>If you want to bypass the “Press Enter to continue” prompt, you can do something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">import</span><span class="o">-</span><span class="n">pcap</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">samples</span><span class="o">/</span><span class="n">markofu</span><span class="o">/</span><span class="n">ie</span><span class="o">*</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<span id="document-help"></span><div class="section" id="help">
<h2>Help<a class="headerlink" href="#help" title="Permalink to this headline">¶</a></h2>
<p>Having problems? Try the suggestions below.</p>
<ul>
<li><p class="first">Are you running the <a class="reference external" href="Upgrade">latest version of Security Onion</a>?</p>
</li>
<li><p class="first">Check the <a class="reference external" href="FAQ">FAQ</a>.</p>
</li>
<li><p class="first">Search the <a class="reference external" href="MailingLists">Security Onion Mailing List</a>.</p>
</li>
<li><p class="first">Search the documentation and mailing lists of the tools contained
within Security Onion: <a class="reference external" href="Tools">Tools</a></p>
</li>
<li><p class="first">Run <code class="docutils literal notranslate"><span class="pre">sostat</span></code> for some diagnostics:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sostat</span> <span class="o">|</span> <span class="n">less</span>
</pre></div>
</div>
</li>
<li><p class="first">If any of the NSM processes show up as failed, try restarting them:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">nsm</span> <span class="n">restart</span>
</pre></div>
</div>
</li>
<li><p class="first">Check log files in <code class="docutils literal notranslate"><span class="pre">/var/log/nsm/</span></code> or other locations for any
errors or possible clues:</p>
<ul class="simple">
<li>Setup <code class="docutils literal notranslate"><span class="pre">/var/log/nsm/sosetup.log</span></code></li>
<li>Daily Log / PCAPs
<code class="docutils literal notranslate"><span class="pre">/nsm/sensor_data/{</span> <span class="pre">HOSTNAME-INTERFACE</span> <span class="pre">}/dailylogs</span></code></li>
<li>sguil <code class="docutils literal notranslate"><span class="pre">/var/log/nsm/securityonion/sguild.log</span></code></li>
<li>Suricata <code class="docutils literal notranslate"><span class="pre">/var/log/nsm/{</span> <span class="pre">HOSTNAME-INTERFACE</span> <span class="pre">}/suricata.log</span></code></li>
<li>barnyard2 <code class="docutils literal notranslate"><span class="pre">/var/log/nsm/</span> <span class="pre">{</span> <span class="pre">HOSTNAME-INTERFACE</span> <span class="pre">}/barnyard2.log</span></code></li>
<li>netsniff-ng
<code class="docutils literal notranslate"><span class="pre">/var/log/nsm/{</span> <span class="pre">HOSTNAME-INTERFACE</span> <span class="pre">}/netsniff-ng.log</span></code></li>
<li>Bro <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs/current</span></code></li>
<li>snort_agent
<code class="docutils literal notranslate"><span class="pre">/var/log/nsm/{</span> <span class="pre">HOSTNAME-INTERFACE</span> <span class="pre">}/snort_agent.log</span></code></li>
<li>Elasticsearch <code class="docutils literal notranslate"><span class="pre">/var/log/elasticsearch/&lt;hostname&gt;.log</span></code></li>
<li>Kibana <code class="docutils literal notranslate"><span class="pre">/var/log/kibana/kibana.log</span></code></li>
<li>Logstash <code class="docutils literal notranslate"><span class="pre">/var/log/logstash/logstash.log</span></code></li>
<li>Elastalert <code class="docutils literal notranslate"><span class="pre">/var/log/elastalert/elastalert_stderr.log</span></code></li>
</ul>
</li>
<li><p class="first">If this is a sensor sending alerts to master server, is autossh
running?</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">autossh</span><span class="o">-</span><span class="n">status</span>
</pre></div>
</div>
</li>
<li><p class="first">Having trouble with MySQL? Check all databases to see if any tables
are are marked as crashed or corrupt.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysqlcheck</span> <span class="o">-</span><span class="n">A</span>
</pre></div>
</div>
</li>
<li><p class="first">Check specific MySQL databases by running something similar to the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysqlcheck</span> <span class="o">-</span><span class="n">c</span> <span class="n">securityonion_db</span>
</pre></div>
</div>
</li>
<li><p class="first">Are you able to duplicate the problem on a fresh Security Onion installation?</p>
</li>
<li><p class="first">Check the <a class="reference external" href="https://github.com/Security-Onion-Solutions/security-onion/issues">Known Issues</a> to see if this is a known issue that we are working on.</p>
</li>
<li><p class="first">If all else fails, please send an email to our <a class="reference external" href="MailingLists">security-onion mailing list</a>.</p>
</li>
<li><p class="first">Need training or commercial support?
<a class="reference external" href="https://www.securityonionsolutions.com">https://www.securityonionsolutions.com</a></p>
</li>
</ul>
<div class="toctree-wrapper compound">
<span id="document-faq"></span><div class="section" id="faq">
<h3>FAQ<a class="headerlink" href="#faq" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line"><a class="reference external" href="#install-update-upgrade">Install / Update / Upgrade</a></div>
<div class="line"><a class="reference external" href="#users-passwords">Users / Passwords</a></div>
<div class="line"><a class="reference external" href="#support-help">Support / Help</a></div>
<div class="line"><a class="reference external" href="#error-messages">Error messages</a></div>
<div class="line"><a class="reference external" href="#ids-engines">IDS engines</a></div>
<div class="line"><a class="reference external" href="#security-onion-internals">Security Onion internals</a></div>
<div class="line"><a class="reference external" href="#tuning">Tuning</a></div>
<div class="line"><a class="reference external" href="#sostat-output">sostat output</a></div>
<div class="line"><a class="reference external" href="#miscellaneous">Miscellaneous</a></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
<div class="section" id="install-update-upgrade">
<h4>Install / Update / Upgrade<a class="headerlink" href="#install-update-upgrade" title="Permalink to this headline">¶</a></h4>
<div class="section" id="why-won-t-the-iso-image-boot-on-my-machine">
<h5>Why won’t the ISO image boot on my machine?<a class="headerlink" href="#why-won-t-the-iso-image-boot-on-my-machine" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="TroubleBooting">TroubleBooting</a> section.</p>
</div>
<div class="section" id="what-s-the-recommended-procedure-for-installing-security-onion">
<h5>What’s the recommended procedure for installing Security Onion?<a class="headerlink" href="#what-s-the-recommended-procedure-for-installing-security-onion" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Installation">Installation Procedure</a> section.</p>
</div>
<div class="section" id="why-does-the-installer-crash-when-selecting-a-non-english-language">
<h5>Why does the installer crash when selecting a non-English language?<a class="headerlink" href="#why-does-the-installer-crash-when-selecting-a-non-english-language" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">We only support the English language at this time:</div>
<div class="line"><a class="reference external" href="Installation#language">Installation#language</a></div>
</div>
</div>
<div class="section" id="why-can-t-i-see-the-continue-button-on-the-keyboard-layout-screen-of-the-installer">
<h5>Why can’t I see the Continue button on the Keyboard Layout screen of the installer?<a class="headerlink" href="#why-can-t-i-see-the-continue-button-on-the-keyboard-layout-screen-of-the-installer" title="Permalink to this headline">¶</a></h5>
<p>The Keyboard Layout screen may be larger than your screen resolution and so the Continue button may be off the screen to the right( as shown in <a class="reference external" href="https://launchpadlibrarian.net/207213663/Screenshot_wilyi386deskmanual_2015-05-22_13%3A05%3A41.png">https://launchpadlibrarian.net/207213663/Screenshot_wilyi386deskmanual_2015-05-22_13%3A05%3A41.png</a>).  You can simply slide the window over until you see the Continue button. For more information, please see <a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/ubiquity/+bug/1458039">https://bugs.launchpad.net/ubuntu/+source/ubiquity/+bug/1458039</a>.</p>
</div>
<div class="section" id="how-do-i-install-security-onion-updates">
<h5>How do I install Security Onion updates?<a class="headerlink" href="#how-do-i-install-security-onion-updates" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Upgrade">Upgrade Procedure</a> section.</p>
</div>
<div class="section" id="why-do-i-get-snort-suricata-bro-errors-after-upgrading-the-kernel-and-pfring-packages">
<h5>Why do I get <code class="docutils literal notranslate"><span class="pre">Snort/Suricata/Bro</span></code> errors after upgrading the <code class="docutils literal notranslate"><span class="pre">kernel</span></code> and <code class="docutils literal notranslate"><span class="pre">pfring</span></code> packages?<a class="headerlink" href="#why-do-i-get-snort-suricata-bro-errors-after-upgrading-the-kernel-and-pfring-packages" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Upgrade">Updating</a> section.</p>
</div>
<div class="section" id="what-do-i-need-to-do-if-i-m-behind-a-proxy">
<h5>What do I need to do if I’m behind a proxy?<a class="headerlink" href="#what-do-i-need-to-do-if-i-m-behind-a-proxy" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Proxy">Proxy Configuration</a> section.</p>
</div>
<div class="section" id="ubuntu-is-saying-that-my-kernel-has-reached-eol-end-of-life-should-i-update-to-the-newer-hwe-stack">
<h5>Ubuntu is saying that my kernel has reached EOL (End Of Life). Should I update to the newer HWE stack?<a class="headerlink" href="#ubuntu-is-saying-that-my-kernel-has-reached-eol-end-of-life-should-i-update-to-the-newer-hwe-stack" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="HWE">HWE</a> section.</p>
</div>
<div class="section" id="why-does-my-vmware-image-rename-eth0-to-eth1">
<h5>Why does my VMware image rename <code class="docutils literal notranslate"><span class="pre">eth0</span></code> to <code class="docutils literal notranslate"><span class="pre">eth1</span></code>?<a class="headerlink" href="#why-does-my-vmware-image-rename-eth0-to-eth1" title="Permalink to this headline">¶</a></h5>
<p>Usually this happens when you clone a VM. VMware asks if you moved it or copied it. If you select “copied”, it will change the MAC address to avoid duplication. At the next boot, Ubuntu’s udev will see a new MAC address and create a new network interface (eth1). To fix this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rm</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">udev</span><span class="o">/</span><span class="n">rules</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="mi">70</span><span class="o">-</span><span class="n">persistent</span><span class="o">-</span><span class="n">net</span><span class="o">.</span><span class="n">rules</span>
<span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
</div>
<div class="section" id="can-i-run-security-onion-on-raspberry-pi-or-some-other-non-x86-box">
<h5>Can I run Security Onion on Raspberry Pi or some other non-x86 box?<a class="headerlink" href="#can-i-run-security-onion-on-raspberry-pi-or-some-other-non-x86-box" title="Permalink to this headline">¶</a></h5>
<p>No, we only support 64-bit Intel/AMD architectures. Please see the <a class="reference external" href="Hardware#32-bit-vs-64-bit">hardware</a> section.</p>
</div>
<div class="section" id="what-s-the-difference-between-a-server-and-a-sensor">
<h5>What’s the difference between a <code class="docutils literal notranslate"><span class="pre">server</span></code> and a <code class="docutils literal notranslate"><span class="pre">sensor</span></code>?<a class="headerlink" href="#what-s-the-difference-between-a-server-and-a-sensor" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line"><strong>box</strong></div>
<div class="line">Definition: A physical or virtual machine running the Security Onion
operating system.</div>
<div class="line"><br /></div>
<div class="line"><strong>server</strong></div>
<div class="line">Definition: A set of processes that receive data from sensors and
allow analysts to see and investigate that data. The set of processes
includes sguild, mysql, and optionally the Elastic stack
(Elasticsearch, Logstash, Kibana) and Curator. The server is also
responsible for ruleset management.</div>
<div class="line">Naming convention: The collection of server processes has a server
name separate from the hostname of the box. Security Onion always sets
the server name to <code class="docutils literal notranslate"><span class="pre">securityonion</span></code>.</div>
<div class="line">Configuration files: <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion/</span></code></div>
<div class="line">Controlled by: <code class="docutils literal notranslate"><span class="pre">/usr/sbin/nsm_server</span></code></div>
<div class="line"><br /></div>
<div class="line"><strong>server box</strong></div>
<div class="line">Definition: A machine running the server processes. May optionally be
running sensor processes.</div>
<div class="line">Example 1: User runs Quick Setup on machine with hostname
securityonion and two ethernet interfaces. Setup creates a server and
two sensors (<code class="docutils literal notranslate"><span class="pre">securityonion-eth0</span></code> and <code class="docutils literal notranslate"><span class="pre">securityonion-eth1</span></code>).</div>
<div class="line">Example 2: User runs Advanced Setup and chooses Server. Setup creates
a server only (no sensor processes).</div>
<div class="line"><br /></div>
<div class="line"><strong>sensor</strong></div>
<div class="line">Definition: A set of processes listening on a network interface. The
set of processes currently includes Snort/Suricata, netsniff-ng, and
bro (although this is in constant flux as we add new capabilities and
find better tools for existing capabilities).</div>
<div class="line">Naming convention: <code class="docutils literal notranslate"><span class="pre">$HOSTNAME-$INTERFACE</span></code></div>
<div class="line">Configuration files: <code class="docutils literal notranslate"><span class="pre">/etc/nsm/$HOSTNAME-$INTERFACE/</span></code></div>
<div class="line">Example: <code class="docutils literal notranslate"><span class="pre">sensor1-eth0</span></code></div>
<div class="line">Controlled by: <code class="docutils literal notranslate"><span class="pre">/usr/sbin/nsm_sensor</span></code></div>
<div class="line"><br /></div>
<div class="line"><strong>sensor box</strong></div>
<div class="line">Definition: A machine having one or more sensors that transmit to a
central server. Does not run server processes. Pulls ruleset from
server box. (In some contexts, I refer to this a slave pulling rules
from the master.)</div>
<div class="line">Example: A machine named <code class="docutils literal notranslate"><span class="pre">sensor1</span></code> having sensors <code class="docutils literal notranslate"><span class="pre">sensor1-eth0</span></code>
and <code class="docutils literal notranslate"><span class="pre">sensor1-eth1</span></code>.</div>
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line"><a class="reference external" href="#top">back to top</a></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="users-passwords">
<h4>Users / Passwords<a class="headerlink" href="#users-passwords" title="Permalink to this headline">¶</a></h4>
<div class="section" id="what-is-the-password-for-root-mysql-sguil-squert-kibana">
<h5>What is the password for <code class="docutils literal notranslate"><span class="pre">root/mysql/Sguil/Squert/Kibana</span></code>?<a class="headerlink" href="#what-is-the-password-for-root-mysql-sguil-squert-kibana" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Passwords">Passwords</a> section.</p>
</div>
<div class="section" id="how-do-i-add-a-new-user-account-for-logging-into-sguil-squert-kibana">
<h5>How do I add a new user account for logging into Sguil/Squert/Kibana?<a class="headerlink" href="#how-do-i-add-a-new-user-account-for-logging-into-sguil-squert-kibana" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">Please see the <a class="reference external" href="Passwords#sguil">Adding Sguil accounts</a> section.</div>
<div class="line"><br /></div>
<div class="line"><a class="reference external" href="#top">back to top</a></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="support-help">
<h4>Support / Help<a class="headerlink" href="#support-help" title="Permalink to this headline">¶</a></h4>
<div class="section" id="where-do-i-send-questions-problems-suggestions">
<h5>Where do I send questions/problems/suggestions?<a class="headerlink" href="#where-do-i-send-questions-problems-suggestions" title="Permalink to this headline">¶</a></h5>
<p><a class="reference external" href="MailingLists">security-onion Google Group</a></p>
</div>
<div class="section" id="i-submitted-a-message-to-the-security-onion-google-group-why-isn-t-it-showing-up">
<h5>I submitted a message to the security-onion Google Group. Why isn’t it showing up?<a class="headerlink" href="#i-submitted-a-message-to-the-security-onion-google-group-why-isn-t-it-showing-up" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="MailingLists#moderation">Moderation</a> section.</p>
</div>
<div class="section" id="is-commercial-support-available-for-security-onion">
<h5>Is commercial support available for Security Onion?<a class="headerlink" href="#is-commercial-support-available-for-security-onion" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">Yes!  Please see <a class="reference external" href="https://securityonionsolutions.com">https://securityonionsolutions.com</a>.</div>
<div class="line"><br /></div>
<div class="line"><br /></div>
<div class="line"><a class="reference external" href="#top">back to top</a></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="error-messages">
<h4>Error messages<a class="headerlink" href="#error-messages" title="Permalink to this headline">¶</a></h4>
<div class="section" id="why-does-rule-update-fail-with-error-400-when-running-behind-a-proxy">
<h5>Why does rule-update fail with Error 400 when running behind a proxy?<a class="headerlink" href="#why-does-rule-update-fail-with-error-400-when-running-behind-a-proxy" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Proxy#pulledpork">Proxy#pulledpork</a> section.</p>
</div>
<div class="section" id="why-does-rule-update-fail-with-an-error-like-error-404-when-fetching-s3-amazonaws-com-snort-org-www-rules-community-community-rules-tar-gz-md5">
<h5>Why does rule-update fail with an error like “Error 404 when fetching s3.amazonaws.com/snort-org/www/rules/community/community-rules.tar.gz.md5”?<a class="headerlink" href="#why-does-rule-update-fail-with-an-error-like-error-404-when-fetching-s3-amazonaws-com-snort-org-www-rules-community-community-rules-tar-gz-md5" title="Permalink to this headline">¶</a></h5>
<p>The Snort Community ruleset has moved to a different URL. You can run the following command to update the Snort Community URL in <code class="docutils literal notranslate"><span class="pre">pulledpork.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s</span><span class="se">\r</span><span class="s1">ule_url=https://s3.amazonaws.com/snort-org/www/rules/community/|community-rules.tar.gz|Community</span><span class="se">\r</span><span class="s1">ule_url=https://snort.org/downloads/community/|community-rules.tar.gz|Community\g&#39;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">pulledpork</span><span class="o">/</span><span class="n">pulledpork</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">For more information, please see:</div>
<div class="line"><a class="reference external" href="https://blog.snort.org/2015/10/are-you-getting-404-errors-attempting.html">https://blog.snort.org/2015/10/are-you-getting-404-errors-attempting.html</a></div>
</div>
</div>
<div class="section" id="why-does-soup-fail-with-an-error-message-like-find-usr-lib-python2-7-dist-packages-salt-no-such-file-or-directory">
<h5>Why does <code class="docutils literal notranslate"><span class="pre">soup</span></code> fail with an error message like “find: `/usr/lib/python2.7/dist-packages/salt/’: No such file or directory”?<a class="headerlink" href="#why-does-soup-fail-with-an-error-message-like-find-usr-lib-python2-7-dist-packages-salt-no-such-file-or-directory" title="Permalink to this headline">¶</a></h5>
<p>This is a bug in the salt packages that can manifest when skipping salt versions. Resolve with the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">python2</span><span class="o">.</span><span class="mi">7</span><span class="o">/</span><span class="n">dist</span><span class="o">-</span><span class="n">packages</span><span class="o">/</span><span class="n">salt</span><span class="o">/</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="o">-</span><span class="n">f</span> <span class="n">install</span>
<span class="n">sudo</span> <span class="n">soup</span>
</pre></div>
</div>
</div>
<div class="section" id="why-does-barnyard2-keep-failing-with-errors-like-returned-signature-id-is-not-equal-to-updated-signature-id">
<h5>Why does barnyard2 keep failing with errors like “Returned signature_id is not equal to updated signature_id”?<a class="headerlink" href="#why-does-barnyard2-keep-failing-with-errors-like-returned-signature-id-is-not-equal-to-updated-signature-id" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">Please see:</div>
<div class="line"><a class="reference external" href="https://blog.securityonion.net/2014/06/new-securityonion-rule-update-package.html">https://blog.securityonion.net/2014/06/new-securityonion-rule-update-package.html</a></div>
</div>
</div>
<div class="section" id="i-just-updated-snort-and-it-s-now-saying-error-the-dynamic-detection-library-usr-local-lib-snort-dynamicrules-chat-so-version-1-0-compiled-with-dynamic-engine-library-version-2-1-isn-t-compatible-with-the-current-dynamic-engine-library-usr-lib-snort-dynamicengine-libsf-engine-so-version-2-4">
<h5>I just updated Snort and it’s now saying ‘ERROR: The dynamic detection library “/usr/local/lib/snort_dynamicrules/chat.so” version 1.0 compiled with dynamic engine library version 2.1 isn’t compatible with the current dynamic engine library “/usr/lib/snort_dynamicengine/libsf_engine.so” version 2.4.’<a class="headerlink" href="#i-just-updated-snort-and-it-s-now-saying-error-the-dynamic-detection-library-usr-local-lib-snort-dynamicrules-chat-so-version-1-0-compiled-with-dynamic-engine-library-version-2-1-isn-t-compatible-with-the-current-dynamic-engine-library-usr-lib-snort-dynamicengine-libsf-engine-so-version-2-4" title="Permalink to this headline">¶</a></h5>
<p>Run the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
<p>For more information, please see:</p>
<p><a class="reference external" href="https://blog.securityonion.net/2014/12/new-version-of-securityonion-rule.html">https://blog.securityonion.net/2014/12/new-version-of-securityonion-rule.html</a></p>
</div>
<div class="section" id="i-get-periodic-mysql-crashes-and-or-error-code-24-out-of-resources-when-searching-in-sguil-how-do-i-fix-that">
<h5>I get periodic MySQL crashes and/or error code 24 “out of resources” when searching in Sguil. How do I fix that?<a class="headerlink" href="#i-get-periodic-mysql-crashes-and-or-error-code-24-out-of-resources-when-searching-in-sguil-how-do-i-fix-that" title="Permalink to this headline">¶</a></h5>
<p>Modern versions of Setup should set MySQL’s <code class="docutils literal notranslate"><span class="pre">open-files-limit</span></code> to 90000 to avoid this problem.</p>
<div class="line-block">
<div class="line">For more information, please see:</div>
<div class="line"><a class="reference external" href="http://nsmwiki.org/Sguil_FAQ#I.27m_seeing_error_code_24_from_MySQL._How_do_I_fix_that.3F">http://nsmwiki.org/Sguil_FAQ#I.27m_seeing_error_code_24_from_MySQL._How_do_I_fix_that.3F</a></div>
</div>
</div>
<div class="section" id="barnyard2-is-failing-with-an-error-like-error-sguil-expected-confirm-13324-and-got-failed-to-insert-13324-mysqlexec-db-server-duplicate-entry-9-13324-for-key-primary-how-do-i-fix-this">
<h5>Barnyard2 is failing with an error like “ERROR: sguil: Expected Confirm 13324 and got: Failed to insert 13324: mysqlexec/db server: Duplicate entry ‘9-13324’ for key ‘PRIMARY’”. How do I fix this?<a class="headerlink" href="#barnyard2-is-failing-with-an-error-like-error-sguil-expected-confirm-13324-and-got-failed-to-insert-13324-mysqlexec-db-server-duplicate-entry-9-13324-for-key-primary-how-do-i-fix-this" title="Permalink to this headline">¶</a></h5>
<p>Sometimes, just restarting Barnyard will clear this up:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">barnyard</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>Other times, restarting Sguild and then restarting Barnyard will clear it up:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">restart</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">restart</span> <span class="o">--</span><span class="n">only</span><span class="o">-</span><span class="n">barnyard2</span>
</pre></div>
</div>
<p>If that doesn’t work, then try also restarting mysql:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">mysql</span> <span class="n">restart</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">restart</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sensor</span><span class="o">-</span><span class="n">restart</span> <span class="o">--</span><span class="n">only</span><span class="o">-</span><span class="n">barnyard2</span>
</pre></div>
</div>
<p>If that still doesn’t fix it, you may have to perform MySQL surgery on the database <code class="docutils literal notranslate"><span class="pre">securityonion_db</span></code> as described in the Sguil FAQ:
<a class="reference external" href="http://nsmwiki.org/Sguil_FAQ#Barnyard_dies_at_startup.2C_with_.22Duplicate_Entry.22_error">http://nsmwiki.org/Sguil_FAQ#Barnyard_dies_at_startup.2C_with_.22Duplicate_Entry.22_error</a></p>
</div>
<div class="section" id="why-does-snort-segfault-every-day-at-7-01-am">
<h5>Why does Snort segfault every day at 7:01 AM?<a class="headerlink" href="#why-does-snort-segfault-every-day-at-7-01-am" title="Permalink to this headline">¶</a></h5>
<p>7:01 AM is the time of the daily PulledPork rules update. If you’re running Snort with the Snort Subscriber (Talos) ruleset, this includes updating the SO rules. There is a known issue when running Snort with the Snort Subscriber (Talos) ruleset and updating the SO rules:
<a class="reference external" href="https://groups.google.com/d/topic/pulledpork-users/1bQDkh3AhNs/discussion">https://groups.google.com/d/topic/pulledpork-users/1bQDkh3AhNs/discussion</a></p>
<p>After updating the rules, Snort is restarted, and the segfault occurs in the OLD instance of Snort (not the NEW instance). Therefore, the segfault is merely a nuisance log entry and can safely be ignored.</p>
</div>
<div class="section" id="why-does-the-pcap-agent-log-show-error-can-t-read-logfile-no-such-variable">
<h5>Why does the pcap_agent log show “Error: can’t read logFile: no such variable”?<a class="headerlink" href="#why-does-the-pcap-agent-log-show-error-can-t-read-logfile-no-such-variable" title="Permalink to this headline">¶</a></h5>
<p>This usually means that there is an unexpected file in the dailylogs
directory. Run the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ls</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">sensor_data</span><span class="o">/*/</span><span class="n">dailylogs</span><span class="o">/</span>
</pre></div>
</div>
<p>You should see a bunch of date stamped directories and you may see some
extraneous files. Remove any extraneous files and restart pcap_agent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">pcap</span><span class="o">-</span><span class="n">agent</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="why-does-chromium-display-a-black-screen-and-or-crash">
<h5>Why does Chromium display a black screen and/or crash?<a class="headerlink" href="#why-does-chromium-display-a-black-screen-and-or-crash" title="Permalink to this headline">¶</a></h5>
<p>This is a known issue with certain versions of VMware. You can either:</p>
<ul class="simple">
<li>go into the VM configuration and disable 3D in the video adapter
OR</li>
<li>upgrade the VM hardware level (may require upgrading to a new version of VMware)</li>
</ul>
</div>
<div class="section" id="why-does-bro-log-failed-to-open-geoip-database-and-fell-back-to-geoip-country-database">
<h5>Why does Bro log <code class="docutils literal notranslate"><span class="pre">Failed</span> <span class="pre">to</span> <span class="pre">open</span> <span class="pre">GeoIP</span> <span class="pre">database</span></code> and <code class="docutils literal notranslate"><span class="pre">Fell</span> <span class="pre">back</span> <span class="pre">to</span> <span class="pre">GeoIP</span> <span class="pre">Country</span> <span class="pre">database</span></code>?<a class="headerlink" href="#why-does-bro-log-failed-to-open-geoip-database-and-fell-back-to-geoip-country-database" title="Permalink to this headline">¶</a></h5>
<p>The GeoIP CITY database is <code class="docutils literal notranslate"><span class="pre">not</span> <span class="pre">free</span></code> and thus we cannot include it in the distro. Bro fails to find it and falls back to the GeoIP COUNTRY database (which is free). As long as you are seeing some country codes in your conn.log, then everything should be fine. If you really need the CITY database, see this thread for some options: <a class="reference external" href="https://groups.google.com/d/topic/security-onion-testing/gtc-8ZTuCi4/discussion">https://groups.google.com/d/topic/security-onion-testing/gtc-8ZTuCi4/discussion</a></p>
</div>
<div class="section" id="why-does-soup-tell-me-i-need-a-secure-boot-key">
<h5>Why does soup tell me I need a Secure Boot key?<a class="headerlink" href="#why-does-soup-tell-me-i-need-a-secure-boot-key" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Secure-Boot">Secure Boot</a> section.
|
|
| <a class="reference external" href="#top">back to top</a>
|
|</p>
</div>
</div>
<div class="section" id="ids-engines">
<h4>IDS engines<a class="headerlink" href="#ids-engines" title="Permalink to this headline">¶</a></h4>
<div class="section" id="i-m-currently-running-snort-how-do-i-switch-to-suricata">
<h5>I’m currently running <code class="docutils literal notranslate"><span class="pre">Snort</span></code>. How do I switch to <code class="docutils literal notranslate"><span class="pre">Suricata</span></code>?<a class="headerlink" href="#i-m-currently-running-snort-how-do-i-switch-to-suricata" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="NIDS#switching-from-snort-to-suricata">NIDS#switching-from-snort-to-suricata</a> section.</p>
</div>
<div class="section" id="i-m-currently-running-suricata-how-do-i-switch-to-snort">
<h5>I’m currently running <code class="docutils literal notranslate"><span class="pre">Suricata</span></code>. How do I switch to <code class="docutils literal notranslate"><span class="pre">Snort</span></code>?<a class="headerlink" href="#i-m-currently-running-suricata-how-do-i-switch-to-snort" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="NIDS#switching-from-suricata-to-snort">NIDS#switching-from-suricata-to-snort</a> section.</p>
</div>
<div class="section" id="can-security-onion-run-in-ips-mode">
<h5>Can Security Onion run in <code class="docutils literal notranslate"><span class="pre">IPS</span></code> mode?<a class="headerlink" href="#can-security-onion-run-in-ips-mode" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="NIDS#NIPS">NIDS#NIPS</a> section.</p>
<p><a class="reference external" href="#top">back to top</a></p>
</div>
</div>
<div class="section" id="security-onion-internals">
<h4>Security Onion internals<a class="headerlink" href="#security-onion-internals" title="Permalink to this headline">¶</a></h4>
<div class="section" id="where-can-i-read-more-about-the-tools-contained-within-security-onion">
<h5>Where can I read more about the tools contained within Security Onion?<a class="headerlink" href="#where-can-i-read-more-about-the-tools-contained-within-security-onion" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Tools">Tools</a> section.</p>
</div>
<div class="section" id="what-s-the-directory-structure-of-nsm">
<h5>What’s the directory structure of <code class="docutils literal notranslate"><span class="pre">/nsm</span></code>?<a class="headerlink" href="#what-s-the-directory-structure-of-nsm" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="DirectoryStructure">/nsm Directory Structure</a> section.</p>
</div>
<div class="section" id="why-does-security-onion-use-utc">
<h5>Why does Security Onion use <code class="docutils literal notranslate"><span class="pre">UTC</span></code>?<a class="headerlink" href="#why-does-security-onion-use-utc" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="TimeZones">UTC and Time Zones</a> section.</p>
</div>
<div class="section" id="why-are-the-timestamps-in-kibana-not-in-utc">
<h5>Why are the <code class="docutils literal notranslate"><span class="pre">timestamps</span></code> in Kibana not in UTC?<a class="headerlink" href="#why-are-the-timestamps-in-kibana-not-in-utc" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="TimeZones">UTC and Time Zones</a> section.</p>
</div>
<div class="section" id="why-is-my-disk-filling-up">
<h5>Why is my disk filling up?<a class="headerlink" href="#why-is-my-disk-filling-up" title="Permalink to this headline">¶</a></h5>
<p>Sguil uses netsniff-ng to record full packet captures to disk. These pcaps are stored in <code class="docutils literal notranslate"><span class="pre">nsm/sensor_data/$HOSTNAME-$INTERFACE/dailylogs/</span></code>. <code class="docutils literal notranslate"><span class="pre">/etc/cron.d/sensor-clean</span></code> is a cronjob that runs every minute that should delete old pcaps when the disk reaches your defined disk usage threshold (90% by default). It’s important to properly size your disk storage so that you avoid filling the disk to 100% between purges.</p>
</div>
<div class="section" id="i-just-rebooted-and-it-looks-like-the-services-aren-t-starting-automatically">
<h5>I just rebooted and it looks like the services aren’t starting automatically.<a class="headerlink" href="#i-just-rebooted-and-it-looks-like-the-services-aren-t-starting-automatically" title="Permalink to this headline">¶</a></h5>
<p>Older versions of Security Onion waited 60 seconds after boot to ensure network interfaces are fully initialized before starting services.  Starting in 16.04, services should start automatically as soon as network interfaces are initialized.</p>
</div>
<div class="section" id="why-do-apt-get-and-the-update-manager-show-tcl8-5-as-held-back">
<h5>Why do apt-get and the Update Manager show <code class="docutils literal notranslate"><span class="pre">tcl8.5</span> <span class="pre">as</span> <span class="pre">held</span> <span class="pre">back</span></code>?<a class="headerlink" href="#why-do-apt-get-and-the-update-manager-show-tcl8-5-as-held-back" title="Permalink to this headline">¶</a></h5>
<p>Please see the  <a class="reference external" href="tcl">tcl</a> section.
|
|
| <a class="reference external" href="#top">back to top</a>
|
|</p>
</div>
</div>
<div class="section" id="tuning">
<h4>Tuning<a class="headerlink" href="#tuning" title="Permalink to this headline">¶</a></h4>
<div class="section" id="what-do-i-need-to-tune-if-i-m-monitoring-vlan-tagged-traffic">
<h5>What do I need to tune if I’m monitoring VLAN tagged traffic?<a class="headerlink" href="#what-do-i-need-to-tune-if-i-m-monitoring-vlan-tagged-traffic" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="VLAN-Traffic">VLAN Traffic</a> section.</p>
</div>
<div class="section" id="how-do-i-configure-email-for-alerting-and-reporting">
<h5>How do I configure email for alerting and reporting?<a class="headerlink" href="#how-do-i-configure-email-for-alerting-and-reporting" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Email">Email</a> section.</p>
</div>
<div class="section" id="how-do-i-configure-a-bpf-for-snort-suricata-bro-netsniff-ng-prads">
<h5>How do I configure a <code class="docutils literal notranslate"><span class="pre">BPF</span></code> for <code class="docutils literal notranslate"><span class="pre">Snort/Suricata/Bro/netsniff-ng/prads</span></code>?<a class="headerlink" href="#how-do-i-configure-a-bpf-for-snort-suricata-bro-netsniff-ng-prads" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="BPF">BPF</a> section.</p>
</div>
<div class="section" id="how-do-i-filter-traffic">
<h5>How do I filter traffic?<a class="headerlink" href="#how-do-i-filter-traffic" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="BPF">BPF</a> section.</p>
</div>
<div class="section" id="how-do-i-exclude-traffic">
<h5>How do I exclude traffic?<a class="headerlink" href="#how-do-i-exclude-traffic" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="BPF">BPF</a> section.</p>
</div>
<div class="section" id="what-are-the-default-firewall-settings-and-how-do-i-change-them">
<h5>What are the default firewall settings and how do I change them?<a class="headerlink" href="#what-are-the-default-firewall-settings-and-how-do-i-change-them" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Firewall">Firewall</a> section.</p>
</div>
<div class="section" id="what-do-i-need-to-modify-in-order-to-have-the-log-files-stored-on-a-different-mount-point">
<h5>What do I need to modify in order to have the log files stored on a different mount point?<a class="headerlink" href="#what-do-i-need-to-modify-in-order-to-have-the-log-files-stored-on-a-different-mount-point" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="NewDisk">Adding a New Disk for /nsm</a> section.</p>
</div>
<div class="section" id="how-do-i-disable-the-graphical-network-manager-and-configuring-networking-from-the-command-line">
<h5>How do I disable the graphical <code class="docutils literal notranslate"><span class="pre">Network</span> <span class="pre">Manager</span></code> and configuring networking from the command line?<a class="headerlink" href="#how-do-i-disable-the-graphical-network-manager-and-configuring-networking-from-the-command-line" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="NetworkConfiguration">Network Configuration</a> section.</p>
</div>
<div class="section" id="how-do-i-enable-disable-processes">
<h5>How do I enable/disable processes?<a class="headerlink" href="#how-do-i-enable-disable-processes" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="DisablingProcesses">Disabling Processes</a> section.</p>
</div>
<div class="section" id="i-disabled-some-sguil-agents-but-they-still-appear-in-sguil-s-agent-status-tab">
<h5>I disabled some Sguil agents but they still appear in Sguil’s <code class="docutils literal notranslate"><span class="pre">Agent</span> <span class="pre">Status</span></code> tab.<a class="headerlink" href="#i-disabled-some-sguil-agents-but-they-still-appear-in-sguil-s-agent-status-tab" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="DisablingProcesses#Sguil_Agent">Disabling Processes</a> section.</p>
</div>
<div class="section" id="what-can-i-do-to-decrease-the-size-of-my-securityonion-db-sguild-mysql-database">
<h5>What can I do to decrease the size of my <code class="docutils literal notranslate"><span class="pre">securityonion_db</span></code> (sguild) MySQL database?<a class="headerlink" href="#what-can-i-do-to-decrease-the-size-of-my-securityonion-db-sguild-mysql-database" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">You can lower the <code class="docutils literal notranslate"><span class="pre">DAYSTOKEEP</span></code> setting in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code>.</div>
<div class="line">Also see <code class="docutils literal notranslate"><span class="pre">UNCAT_MAX</span></code>:</div>
<div class="line"><a class="reference external" href="https://blog.securityonion.net/2015/01/new-version-of-sguil-db-purge-helps.html">https://blog.securityonion.net/2015/01/new-version-of-sguil-db-purge-helps.html</a></div>
</div>
</div>
<div class="section" id="how-do-i-change-the-fonts-in-the-sguil-client">
<h5>How do I change the fonts in the Sguil client?<a class="headerlink" href="#how-do-i-change-the-fonts-in-the-sguil-client" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Sguil#customize-sguil-client">Sguil#customize-sguil-client</a> section.</p>
</div>
<div class="section" id="can-i-be-alerted-when-an-interface-stops-receiving-traffic">
<h5>Can I be alerted when an interface stops receiving traffic?<a class="headerlink" href="#can-i-be-alerted-when-an-interface-stops-receiving-traffic" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="SensorStopsSeeingTraffic">Interface stops receiving traffic</a> section.</p>
</div>
<div class="section" id="how-do-i-boot-security-onion-to-text-mode-cli-instead-of-gui">
<h5>How do I boot Security Onion to text mode (CLI instead of GUI)?<a class="headerlink" href="#how-do-i-boot-security-onion-to-text-mode-cli-instead-of-gui" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Desktop">Disabling Desktop</a> section.</p>
</div>
<div class="section" id="i-m-running-security-onion-in-a-vm-and-the-screensaver-is-using-lots-of-cpu-how-do-i-change-disable-the-screensaver">
<h5>I’m running Security Onion in a VM and the screensaver is using lots of CPU. How do I change/disable the screensaver?<a class="headerlink" href="#i-m-running-security-onion-in-a-vm-and-the-screensaver-is-using-lots-of-cpu-how-do-i-change-disable-the-screensaver" title="Permalink to this headline">¶</a></h5>
<ol><li>Click Applications.<br>
</li><li>Click Settings.<br>
</li><li>Click Screensaver.<br>
</li><li>Screensaver Preferences window appears.  Click the Mode dropdown and select "Disable Screen Saver" or "Blank Screen Only".<br>
</li><li>Close the Screensaver Preferences window.<br></li></ol><div class="line-block">
<div class="line"><a class="reference external" href="#top">back to top</a></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="sostat-output">
<h4>sostat output<a class="headerlink" href="#sostat-output" title="Permalink to this headline">¶</a></h4>
<div class="section" id="what-does-it-mean-if-sostat-show-a-high-number-of-sguil-uncategorized-events">
<h5>What does it mean if <code class="docutils literal notranslate"><span class="pre">sostat</span></code> show a high number of <code class="docutils literal notranslate"><span class="pre">Sguil</span> <span class="pre">Uncategorized</span> <span class="pre">Events</span></code>?<a class="headerlink" href="#what-does-it-mean-if-sostat-show-a-high-number-of-sguil-uncategorized-events" title="Permalink to this headline">¶</a></h5>
<p><code class="docutils literal notranslate"><span class="pre">Sguild</span></code> has to load uncategorized events into memory when it starts and it won’t accept connections until that’s complete. You can either:</p>
<ul>
<li><p class="first">wait for sguild to start up (may take a LONG time), then log into  Sguil, and <code class="docutils literal notranslate"><span class="pre">F8</span></code> LOTS of events
OR</p>
</li>
<li><p class="first">stop sguild</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">sguild</span><span class="o">-</span><span class="n">stop</span>
</pre></div>
</div>
<div class="line-block">
<div class="line">and manually categorize events using <code class="docutils literal notranslate"><span class="pre">mysql</span></code></div>
<div class="line">(see <a class="reference external" href="http://taosecurity.blogspot.com/2013/02/recovering-from-suricata-gone-wild.html">http://taosecurity.blogspot.com/2013/02/recovering-from-suricata-gone-wild.html</a>)</div>
<div class="line">OR</div>
<div class="line">lower your <code class="docutils literal notranslate"><span class="pre">DAYSTOKEEP</span></code> setting in <code class="docutils literal notranslate"><span class="pre">/etc/nsm/securityonion.conf</span></code> and run</div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sguil</span><span class="o">-</span><span class="n">db</span><span class="o">-</span><span class="n">purge</span>
</pre></div>
</div>
<p>To keep <code class="docutils literal notranslate"><span class="pre">Uncategorized</span> <span class="pre">Events</span></code> from getting too high, you should log into Sguil/Squert on a daily/weekly basis and categorize events.</p>
</li>
</ul>
<div class="line-block">
<div class="line"><br /></div>
<div class="line"><a class="reference external" href="#top">back to top</a></div>
<div class="line"><br /></div>
<div class="line"><br /></div>
</div>
</div>
</div>
<div class="section" id="miscellaneous">
<h4>Miscellaneous<a class="headerlink" href="#miscellaneous" title="Permalink to this headline">¶</a></h4>
<div class="section" id="where-can-i-find-the-version-information-for-security-onion">
<h5>Where can I find the version information for Security Onion?<a class="headerlink" href="#where-can-i-find-the-version-information-for-security-onion" title="Permalink to this headline">¶</a></h5>
<p>If the machine was built with the Security Onion 16.04 ISO image, version information can be found in <code class="docutils literal notranslate"><span class="pre">/etc/PinguyBuilder.conf</span></code>.</p>
</div>
<div class="section" id="where-can-i-find-interesting-pcaps-to-replay">
<h5>Where can I find interesting pcaps to replay?<a class="headerlink" href="#where-can-i-find-interesting-pcaps-to-replay" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="Pcaps">Pcaps</a> section.</p>
</div>
<div class="section" id="why-is-security-onion-connecting-to-an-ip-address-on-the-internet-over-port-123">
<h5>Why is Security Onion connecting to an IP address on the Internet over port 123?<a class="headerlink" href="#why-is-security-onion-connecting-to-an-ip-address-on-the-internet-over-port-123" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="NTP">NTP</a> section.</p>
</div>
<div class="section" id="should-i-backup-my-security-onion-box">
<h5>Should I backup my Security Onion box?<a class="headerlink" href="#should-i-backup-my-security-onion-box" title="Permalink to this headline">¶</a></h5>
<p>Network Security Monitoring as a whole is considered “best effort”. It is not a “mission critical” resource like a file server or web server. Since we’re dealing with “big data” (potentially terabytes of full packet capture), backups would be prohibitively expensive. Most organizations don’t do any backups and instead just rebuild boxes when necessary.</p>
</div>
<div class="section" id="how-can-i-add-and-test-local-rules">
<h5>How can I add and test local rules?<a class="headerlink" href="#how-can-i-add-and-test-local-rules" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="AddingLocalRules">Adding local rules and testing them with scapy</a> section.</p>
</div>
<div class="section" id="where-can-i-get-the-source-code">
<h5>Where can I get the source code?<a class="headerlink" href="#where-can-i-get-the-source-code" title="Permalink to this headline">¶</a></h5>
<p>You can download the full source code for any of our packages like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">source</span> <span class="n">PACKAGE</span><span class="o">-</span><span class="n">NAME</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">PACKAGE-NAME</span></code> is usually something like <code class="docutils literal notranslate"><span class="pre">securityonion-snort</span></code>. Here’s a list of all of our packages:
| <a class="reference external" href="https://launchpad.net/~securityonion/+archive/stable">https://launchpad.net/~securityonion/+archive/stable</a></p>
</div>
<div class="section" id="how-can-i-remote-control-my-security-onion-box">
<h5>How can I remote control my Security Onion box?<a class="headerlink" href="#how-can-i-remote-control-my-security-onion-box" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">A few options:</div>
<div class="line">“ssh -X” - any program started in the SSH session will be displayed on your local desktop (requires a local X server)</div>
<div class="line">xrdp - sudo apt-get install xrdp - requires an rdp client</div>
</div>
</div>
<div class="section" id="why-isn-t-squert-showing-geoip-data-properly">
<h5>Why isn’t Squert showing GeoIP data properly?<a class="headerlink" href="#why-isn-t-squert-showing-geoip-data-properly" title="Permalink to this headline">¶</a></h5>
<p>If the Squert map is not showing the country for IPs, try running the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">php</span> <span class="o">-</span><span class="n">e</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">www</span><span class="o">/</span><span class="n">so</span><span class="o">/</span><span class="n">squert</span><span class="o">/.</span><span class="n">inc</span><span class="o">/</span><span class="n">ip2c</span><span class="o">.</span><span class="n">php</span> <span class="mi">0</span><span class="s1">&#39;/</span>
</pre></div>
</div>
</div>
<div class="section" id="why-do-i-get-segfaults-when-booting-on-vmware-esx">
<h5>Why do I get segfaults when booting on VMware ESX?<a class="headerlink" href="#why-do-i-get-segfaults-when-booting-on-vmware-esx" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">This is a known issue with Ubuntu 10.04 and ESXi 4.1 and is unrelated to Security Onion. Please see:</div>
<div class="line"><a class="reference external" href="http://ubuntuforums.org/showthread.php?t=1674759">http://ubuntuforums.org/showthread.php?t=1674759</a></div>
<div class="line"><a class="reference external" href="https://bugs.launchpad.net/ubuntu/+source/linux/+bug/659422">https://bugs.launchpad.net/ubuntu/+source/linux/+bug/659422</a></div>
</div>
</div>
<div class="section" id="how-do-i-run-ntopng-on-security-onion">
<h5>How do I run <code class="docutils literal notranslate"><span class="pre">ntopng</span></code> on Security Onion?<a class="headerlink" href="#how-do-i-run-ntopng-on-security-onion" title="Permalink to this headline">¶</a></h5>
<p>Please see the <a class="reference external" href="DeployingNtopng">Deploying NtopNG</a> section.</p>
</div>
<div class="section" id="how-do-i-open-rar-files">
<h5>How do I open rar files?<a class="headerlink" href="#how-do-i-open-rar-files" title="Permalink to this headline">¶</a></h5>
<p>We’re not allowed to redistribute the unrar plugin, so you’ll need to install it manually:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">unrar</span>
</pre></div>
</div>
</div>
<div class="section" id="how-do-i-perform-x-in-ubuntu">
<h5>How do I perform “X” in Ubuntu?<a class="headerlink" href="#how-do-i-perform-x-in-ubuntu" title="Permalink to this headline">¶</a></h5>
<p>Security Onion is based on Ubuntu, but we don’t provide community support for the Ubuntu OS itself. If you have questions about Ubuntu, you should check the Ubuntu website, forums, and Google.</p>
<p><a class="reference external" href="#top">back to top</a></p>
</div>
</div>
</div>
<span id="document-directory"></span><div class="section" id="directory-structure">
<h3>Directory Structure<a class="headerlink" href="#directory-structure" title="Permalink to this headline">¶</a></h3>
<div class="section" id="nsm-directory-structure">
<h4>/nsm Directory Structure<a class="headerlink" href="#nsm-directory-structure" title="Permalink to this headline">¶</a></h4>
</div>
<div class="section" id="nsm">
<h4>/nsm<a class="headerlink" href="#nsm" title="Permalink to this headline">¶</a></h4>
<p>Backup, Bro, sensor (if configured as sensor), and server (if configured
as server) data.</p>
</div>
<div class="section" id="nsm-bro">
<h4>/nsm/bro<a class="headerlink" href="#nsm-bro" title="Permalink to this headline">¶</a></h4>
<p>Bro IDS logs.</p>
</div>
<div class="section" id="nsm-elasticsearch">
<h4>/nsm/elasticsearch<a class="headerlink" href="#nsm-elasticsearch" title="Permalink to this headline">¶</a></h4>
<p>Elasticsearch data.</p>
</div>
<div class="section" id="nsm-sensor-data">
<h4>/nsm/sensor_data<a class="headerlink" href="#nsm-sensor-data" title="Permalink to this headline">¶</a></h4>
<p>Sensor data including IDS alerts and full pcap organized by sensor name ($HOSTNAME-$INTERFACE).</p>
</div>
<div class="section" id="nsm-server-data">
<h4>/nsm/server_data<a class="headerlink" href="#nsm-server-data" title="Permalink to this headline">¶</a></h4>
<p>Server data including IDS rulesets.</p>
</div>
</div>
<span id="document-tools"></span><div class="section" id="tools">
<h3>Tools<a class="headerlink" href="#tools" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Security Onion would like to thank the following open-source projects
for their contribution to our community!</div>
<div class="line"><br /></div>
<div class="line">barnyard2</div>
<div class="line"><a class="reference external" href="http://www.securixlive.com/barnyard2/">http://www.securixlive.com/barnyard2/</a></div>
<div class="line">“Barnyard2 is an open source interpreter for Snort unified2 binary output files. Its primary use is allowing Snort to write to disk in an efficient manner and leaving the task of parsing binary data into various formats to a separate process that will not cause Snort to miss network traffic.”</div>
<div class="line"><br /></div>
<div class="line">Bro (Zeek)</div>
<div class="line"><a class="reference external" href="https://zeek.org/">https://zeek.org/</a></div>
<div class="line">“Bro is a powerful network analysis framework that is much different from the typical IDS you may know.”</div>
<div class="line"><br /></div>
<div class="line">chaosreader</div>
<div class="line"><a class="reference external" href="http://chaosreader.sourceforge.net/">http://chaosreader.sourceforge.net/</a></div>
<div class="line">“Chaosreader is a freeware tool to fetch application data from snoop or tcpdump logs. Supported protocols include TCP, UDP, IPv4, IPv6, ICMP, telnet, FTP, HTTP, SMTP, IRC, X11, and VNC.”</div>
<div class="line"><br /></div>
<div class="line">Daemonlogger</div>
<div class="line"><a class="reference external" href="http://www.snort.org/snort-downloads/additional-downloads#daemonlogger">http://www.snort.org/snort-downloads/additional-downloads#daemonlogger</a></div>
<div class="line">“Daemonlogger™ is a packet logger and soft tap developed by Martin Roesch.”</div>
<div class="line"><br /></div>
<div class="line">driftnet</div>
<div class="line"><a class="reference external" href="http://www.ex-parrot.com/~chris/driftnet/">http://www.ex-parrot.com/~chris/driftnet/</a></div>
<div class="line">“Driftnet is a program which listens to network traffic and picks out images from TCP streams it observes.”</div>
<div class="line"><br /></div>
<div class="line">dsniff</div>
<div class="line"><a class="reference external" href="http://www.monkey.org/~dugsong/dsniff/">http://www.monkey.org/~dugsong/dsniff/</a></div>
<div class="line">“dsniff is a collection of tools for network auditing and penetration testing. dsniff, filesnarf, mailsnarf, msgsnarf, urlsnarf, and webspy passively monitor a network for interesting data (passwords, e-mail, files, etc.). arpspoof, dnsspoof, and macof facilitate the interception of network traffic normally unavailable to an attacker (e.g, due to layer-2 switching). sshmitm and webmitm implement active monkey-in-the-middle attacks against redirected SSH and HTTPS sessions by exploiting weak bindings in ad-hoc PKI.”</div>
<div class="line"><br /></div>
<div class="line">Elastic Stack</div>
<div class="line"><a class="reference external" href="https://www.elastic.co/">https://www.elastic.co/</a></div>
<div class="line">The Elastic Stack consists of Elasticsearch, Logstash, and Kibana and replaces ELSA.</div>
<div class="line"><br /></div>
<div class="line">hping</div>
<div class="line"><a class="reference external" href="http://www.hping.org/">http://www.hping.org/</a></div>
<div class="line">“hping is a command-line oriented TCP/IP packet assembler/analyzer. The interface is inspired to the ping(8) unix command, but hping isn’t only able to send ICMP echo requests. It supports TCP, UDP, ICMP and RAW-IP protocols, has a traceroute mode, the ability to send files between a covered channel, and many other features.”</div>
<div class="line"><br /></div>
<div class="line">hunt</div>
<div class="line">“Advanced packet sniffer and connection intrusion. Hunt is a program for intruding into a connection, watching it and resetting it. Note that hunt is operating on Ethernet and is best used for connections which can be watched through it. However, it is possible to do something even for hosts on another segments or hosts that are on switched ports.”</div>
<div class="line"><br /></div>
<div class="line">labrea</div>
<div class="line"><a class="reference external" href="http://labrea.sourceforge.net/labrea-info.html">http://labrea.sourceforge.net/labrea-info.html</a></div>
<div class="line">“LaBrea takes over unused IP addresses, and creates virtual servers that are attractive to worms, hackers, and other denizens of the Internet. The program answers connection attempts in such a way that the machine at the other end gets “stuck”, sometimes for a very long time.”</div>
<div class="line"><br /></div>
<div class="line">mergecap</div>
<div class="line"><a class="reference external" href="http://www.wireshark.org/docs/man-pages/mergecap.html">http://www.wireshark.org/docs/man-pages/mergecap.html</a></div>
<div class="line">“Mergecap is a program that combines multiple saved capture files into a single output file specified by the -w argument. Mergecap knows how to read libpcap capture files, including those of tcpdump, Wireshark, and other tools that write captures in that format.”</div>
<div class="line"><br /></div>
<div class="line">netsed</div>
<div class="line">“The network packet altering stream editor NetSED is small and handful utility designed to alter the contents of packets forwarded thru your network in real time. It is really useful for network hackers in following applications: black-box protocol auditing - whenever there are two or more proprietary boxes communicating over undocumented protocol (by enforcing changes in ongoing transmissions, you will be able to test if tested application is secure), fuzz-alike experiments, integrity tests - whenever you want to test stability of the application and see how it ensures data integrity, other common applications - fooling other people, content filtering, etc etc - choose whatever you want to. It perfectly fits ngrep, netcat and tcpdump tools suite.”</div>
<div class="line"><br /></div>
<div class="line">netsniff-ng</div>
<div class="line"><a class="reference external" href="http://netsniff-ng.org/">http://netsniff-ng.org/</a></div>
<div class="line">“netsniff-ng is a free, performant Linux networking toolkit.”</div>
<div class="line"><br /></div>
<div class="line">NetworkMiner</div>
<div class="line"><a class="reference external" href="http://www.netresec.com/?page=NetworkMiner">http://www.netresec.com/?page=NetworkMiner</a></div>
<div class="line">“NetworkMiner is a Network Forensic Analysis Tool (NFAT) for Windows. NetworkMiner can be used as a passive network sniffer/packet capturing tool in order to detect operating systems, sessions, hostnames, open ports etc. without putting any traffic on the network. NetworkMiner can also parse PCAP files for off-line analysis and to regenerate/reassemble transmitted files and certificates from PCAP files.”</div>
<div class="line"><br /></div>
<div class="line">ngrep</div>
<div class="line"><a class="reference external" href="http://ngrep.sourceforge.net/">http://ngrep.sourceforge.net/</a></div>
<div class="line">“ngrep strives to provide most of GNU grep’s common features, applying them to the network layer. ngrep is a pcap-aware tool that will allow you to specify extended regular or hexadecimal expressions to match against data payloads of packets. It currently recognizes IPv4/6, TCP, UDP, ICMPv4/6, IGMP and Raw across Ethernet, PPP, SLIP, FDDI, Token Ring and null interfaces, and understands BPF filter logic in the same fashion as more common packet sniffing tools, such as tcpdump and snoop.”</div>
<div class="line"><br /></div>
<div class="line">p0f</div>
<div class="line"><a class="reference external" href="http://lcamtuf.coredump.cx/p0f3/">http://lcamtuf.coredump.cx/p0f3/</a></div>
<div class="line">“P0f is a tool that utilizes an array of sophisticated, purely passive traffic fingerprinting mechanisms to identify the players behind any incidental TCP/IP communications (often as little as a single normal SYN) without interfering in any way. Version 3 is a complete rewrite of the original codebase, incorporating a significant number of improvements to network-level fingerprinting, and introducing the ability to reason about application-level payloads (e.g., HTTP).”</div>
<div class="line"><br /></div>
<div class="line">Reassembler</div>
<div class="line"><a class="reference external" href="http://isc.sans.edu/diary.html?storyid=13282">http://isc.sans.edu/diary.html?storyid=13282</a></div>
<div class="line">“If you provide reassembler.py with a pcap that contains fragments, it will reassemble the packets using each of the 5 reassembly engines and show you the result.”</div>
<div class="line"><br /></div>
<div class="line">scapy</div>
<div class="line"><a class="reference external" href="http://www.secdev.org/projects/scapy/">http://www.secdev.org/projects/scapy/</a></div>
<div class="line">“Scapy is a powerful interactive packet manipulation program. It is able to forge or decode packets of a wide number of protocols, send them on the wire, capture them, match requests and replies, and much more. It can easily handle most classical tasks like scanning, tracerouting, probing, unit tests, attacks or network discovery (it can replace hping, 85% of nmap, arpspoof, arp-sk, arping, tcpdump, tethereal, p0f, etc.). It also performs very well at a lot of other specific tasks that most other tools can’t handle, like sending invalid frames, injecting your own 802.11 frames, combining technics (VLAN hopping+ARP cache poisoning, VOIP decoding on WEP encrypted channel, …), etc.”</div>
<div class="line"><br /></div>
<div class="line">sguil</div>
<div class="line"><a class="reference external" href="http://sguil.sourceforge.net/">http://sguil.sourceforge.net/</a></div>
<div class="line">“Sguil (pronounced sgweel) is built by network security analysts for network security analysts. Sguil’s main component is an intuitive GUI that provides access to realtime events, session data, and raw packet captures. Sguil facilitates the practice of Network Security Monitoring and event driven analysis. The Sguil client is written in tcl/tk and can be run on any operating system that supports tcl/tk (including Linux, BSD, Solaris, MacOS, and Win32).”</div>
<div class="line"><br /></div>
<div class="line">Sniffit</div>
<div class="line"><a class="reference external" href="http://sniffit.sourceforge.net/">http://sniffit.sourceforge.net/</a></div>
<div class="line">“SniffIt is a Distribted Sniffer System, which allows users to capture network traffic from an unique machine using a graphical client application. This feature is very useful in switched networks, where traditional sniffers only allow users to sniff their own network traffic.”</div>
<div class="line"><br /></div>
<div class="line">Snort</div>
<div class="line"><a class="reference external" href="http://www.snort.org/">http://www.snort.org/</a></div>
<div class="line">“Snort® is an open source network intrusion prevention and detection system (IDS/IPS) developed by Sourcefire. Combining the benefits of signature, protocol, and anomaly-based inspection, Snort is the most widely deployed IDS/IPS technology worldwide. With millions of downloads and nearly 400,000 registered users, Snort has become the de facto standard for IPS.”</div>
<div class="line"><br /></div>
<div class="line">Squert</div>
<div class="line"><a class="reference external" href="http://www.squertproject.org/">http://www.squertproject.org/</a></div>
<div class="line">“Squert is a web application that is used to query and view event data stored in a Sguil database (typically IDS alert data). Squert is a visual tool that attempts to provide additional context to events through the use of metadata, time series representations and weighted and logically grouped result sets. The hope is that these views will prompt questions that otherwise may not have been asked.”</div>
<div class="line"><br /></div>
<div class="line">ssldump</div>
<div class="line"><a class="reference external" href="http://www.rtfm.com/ssldump/">http://www.rtfm.com/ssldump/</a></div>
<div class="line">“ssldump is an SSLv3/TLS network protocol analyzer. It identifies TCP connections on the chosen network interface and attempts to interpret them as SSLv3/TLS traffic. When it identifies SSLv3/TLS traffic, it decodes the records and displays them in a textual form to stdout. If provided with the appropriate keying material, it will also decrypt the connections and display the application data traffic.”</div>
<div class="line"><br /></div>
<div class="line">sslsniff</div>
<div class="line"><a class="reference external" href="http://www.thoughtcrime.org/software/sslsniff/">http://www.thoughtcrime.org/software/sslsniff/</a></div>
<div class="line">“sslsniff is designed to create man-in-the-middle (MITM) attacks for SSL/TLS connections, and dynamically generates certs for the domains that are being accessed on the fly. The new certificates are constructed in a certificate chain that is signed by any certificate that is provided. sslsniff also supports other attacks like null-prefix or OCSP attacks to achieve silent interceptions of connections when possible.”</div>
<div class="line"><br /></div>
<div class="line">Suricata</div>
<div class="line"><a class="reference external" href="http://www.openinfosecfoundation.org/index.php/download-suricata">http://www.openinfosecfoundation.org/index.php/download-suricata</a></div>
<div class="line">“The Suricata Engine is an Open Source Next Generation Intrusion Detection and Prevention Engine. This engine is not intended to just replace or emulate the existing tools in the industry, but will bring new ideas and technologies to the field.”</div>
<div class="line"><br /></div>
<div class="line">tcpdump</div>
<div class="line"><a class="reference external" href="http://www.tcpdump.org/">http://www.tcpdump.org/</a></div>
<div class="line">“Tcpdump prints out a description of the contents of packets on a network interface that match the boolean expression. It can also be run with the -w flag, which causes it to save the packet data to a file for later analysis, and/or with the -r flag, which causes it to read from a saved packet file rather than to read packets from a network interface. In all cases, only packets that match expression will be processed by tcpdump.”</div>
<div class="line"><br /></div>
<div class="line">tcpick</div>
<div class="line"><a class="reference external" href="http://tcpick.sourceforge.net/">http://tcpick.sourceforge.net/</a></div>
<div class="line">“tcpick is a textmode sniffer libpcap-based that can track, reassemble and reorder tcp streams. Tcpick is able to save the captured flows in different files or displays them in the terminal, and so it is useful to sniff files that are transmitted via ftp or http. It can display all the stream on the terminal, when the connection is closed in different display modes like hexdump, hexdump + ascii, only printable charachters, raw mode and so on. Available a color mode too, helpful to read and understand better the output of the program. Actually it can handle several interfaces, including ethernet cards and ppp. It is useful to keep track of what users of a network are doing, and is usable with textmode tools like grep, sed, awk.”</div>
<div class="line"><br /></div>
<div class="line">tcpreplay</div>
<div class="line"><a class="reference external" href="http://tcpreplay.synfin.net/">http://tcpreplay.synfin.net/</a></div>
<div class="line">“Tcpreplay is a suite of GPLv3 licensed tools written by Aaron Turner for UNIX (and Win32 under Cygwin) operating systems which gives you the ability to use previously captured traffic in libpcap format to test a variety of network devices. It allows you to classify traffic as client or server, rewrite Layer 2, 3 and 4 headers and finally replay the traffic back onto the network and through other devices such as switches, routers, firewalls, NIDS and IPS’s. Tcpreplay supports both single and dual NIC modes for testing both sniffing and inline devices.”</div>
<div class="line"><br /></div>
<div class="line">tcpslice</div>
<div class="line"><a class="reference external" href="http://sourceforge.net/projects/tcpslice/">http://sourceforge.net/projects/tcpslice/</a></div>
<div class="line">“tcpslice is a tool for extracting portions of packet trace files generated using tcpdump’s -w flag. It can combine multiple trace files, and/or extract portions of one or more traces based on time.”</div>
<div class="line"><br /></div>
<div class="line">tcpstat</div>
<div class="line"><a class="reference external" href="http://www.frenchfries.net/paul/tcpstat/">http://www.frenchfries.net/paul/tcpstat/</a></div>
<div class="line">“tcpstat reports certain network interface statistics much like vmstat does for system statistics. tcpstat gets its information by either monitoring a specific interface, or by reading previously saved tcpdump data from a file.”</div>
<div class="line"><br /></div>
<div class="line">tcpxtract</div>
<div class="line"><a class="reference external" href="http://tcpxtract.sourceforge.net/">http://tcpxtract.sourceforge.net/</a></div>
<div class="line">“tcpxtract is a tool for extracting files from network traffic based on file signatures.”</div>
<div class="line"><br /></div>
<div class="line">tshark</div>
<div class="line"><a class="reference external" href="http://www.wireshark.org/docs/man-pages/tshark.html">http://www.wireshark.org/docs/man-pages/tshark.html</a></div>
<div class="line">“TShark is a network protocol analyzer. It lets you capture packet data from a live network, or read packets from a previously saved capture file, either printing a decoded form of those packets to the standard output or writing the packets to a file. TShark’s native capture file format is libpcap format, which is also the format used by tcpdump and various other tools.”</div>
<div class="line"><br /></div>
<div class="line">u2boat</div>
<div class="line"><a class="reference external" href="http://www.snort.org/">http://www.snort.org/</a></div>
<div class="line">Part of Snort, u2boat converts unified2 files to pcaps.</div>
<div class="line"><br /></div>
<div class="line">u2spewfoo</div>
<div class="line"><a class="reference external" href="http://www.snort.org/">http://www.snort.org/</a></div>
<div class="line">Part of Snort, u2spewfoo converts unified2 files to text.</div>
<div class="line"><br /></div>
<div class="line">Wazuh</div>
<div class="line"><a class="reference external" href="https://wazuh.com/">https://wazuh.com/</a></div>
<div class="line">“Wazuh is a free, open source and enterprise-ready security monitoring solution for threat detection, integrity monitoring, incident response and compliance.”</div>
<div class="line"><br /></div>
<div class="line">Wireshark</div>
<div class="line"><a class="reference external" href="http://www.wireshark.org/">http://www.wireshark.org/</a></div>
<div class="line">“Wireshark is a GUI network protocol analyzer. It lets you interactively browse packet data from a live network or from a previously saved capture file. Wireshark’s native capture file format is libpcap format, which is also the format used by tcpdump and various other tools.”</div>
</div>
</div>
<span id="document-passwords"></span><div class="section" id="passwords">
<h3>Passwords<a class="headerlink" href="#passwords" title="Permalink to this headline">¶</a></h3>
<div class="section" id="os-root-account">
<h4>OS root account<a class="headerlink" href="#os-root-account" title="Permalink to this headline">¶</a></h4>
<p>Like other Ubuntu-based distributions, there is no root password. Your default user account has been given sudo permissions. Graphical utilities requesting administrative access should prompt for password; enter your user password. Command-line utilities that require administrative access can be prefixed with <code class="docutils literal notranslate"><span class="pre">sudo</span></code>. For example, to add an OS user account:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">adduser</span> <span class="n">mynewuseraccount</span>
</pre></div>
</div>
</div>
<div class="section" id="sguil">
<h4>Sguil<a class="headerlink" href="#sguil" title="Permalink to this headline">¶</a></h4>
<p>Log into Sguil using the username and password you created in the Setup wizard.</p>
<p>You can add accounts as follows (please note that Sguil usernames must be alphanumeric):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">add</span>
</pre></div>
</div>
<p>You can change passwords using the Sguil client (<code class="docutils literal notranslate"><span class="pre">File</span></code> –&gt; <code class="docutils literal notranslate"><span class="pre">Change</span> <span class="pre">Password</span></code>) or as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">passwd</span>
</pre></div>
</div>
<p>You can disable accounts as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">disable</span>
</pre></div>
</div>
</div>
<div class="section" id="squert">
<h4>Squert<a class="headerlink" href="#squert" title="Permalink to this headline">¶</a></h4>
<p>Squert authenticates against the Sguil user database, so you should be able to login to Squert using the same username and password you use to login to Sguil.</p>
</div>
<div class="section" id="kibana">
<h4>Kibana<a class="headerlink" href="#kibana" title="Permalink to this headline">¶</a></h4>
<p>When you access Kibana, you are prompted to login using Apache Single Sign On (SSO). This SSO authenticates against the Sguil user database, so you should be able to login to Kibana using the same username and password you use to login to Sguil.</p>
</div>
<div class="section" id="mysql">
<h4>MySQL<a class="headerlink" href="#mysql" title="Permalink to this headline">¶</a></h4>
<p>The MySQL root password is randomized. MySQL only allows connections from localhost. If you need to look at the database manually, you can do so like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span>
</pre></div>
</div>
</div>
</div>
<span id="document-support"></span><div class="section" id="support">
<h3>Support<a class="headerlink" href="#support" title="Permalink to this headline">¶</a></h3>
<div class="section" id="commercial-support">
<h4>Commercial Support<a class="headerlink" href="#commercial-support" title="Permalink to this headline">¶</a></h4>
<p>If you need private and/or priority support, please consider purchasing
commercial support:</p>
<p><a class="reference external" href="https://securityonionsolutions.com">https://securityonionsolutions.com</a></p>
</div>
<div class="section" id="free-support">
<h4>Free Support<a class="headerlink" href="#free-support" title="Permalink to this headline">¶</a></h4>
<p>If you need free support, please use our public security-onion mailing
list:</p>
<p><a class="reference external" href="MailingLists">MailingLists</a></p>
</div>
</div>
<span id="document-mailing-lists"></span><div class="section" id="mailing-lists">
<h3>Mailing Lists<a class="headerlink" href="#mailing-lists" title="Permalink to this headline">¶</a></h3>
<div class="section" id="check-documentation-first">
<h4>Check Documentation First<a class="headerlink" href="#check-documentation-first" title="Permalink to this headline">¶</a></h4>
<p>Before sending an email to our mailing list, check to see if your question has already been answered by one of the following:</p>
<p><a class="reference external" href="Help">Help</a></p>
<p><a class="reference external" href="FAQ">FAQ</a></p>
</div>
<div class="section" id="moderation">
<h4>Moderation<a class="headerlink" href="#moderation" title="Permalink to this headline">¶</a></h4>
<p>Please keep in mind that our Google Groups are moderated, so your email will have to be approved before it is published to the list. If at first you don’t see your email appear in the mailing list, there is no need to re-send your email. It has been queued and will be approved if appropriate.</p>
</div>
<div class="section" id="etiquette">
<h4>Etiquette<a class="headerlink" href="#etiquette" title="Permalink to this headline">¶</a></h4>
<p>Please be courteous and respectful. Disrespectful emails can result in being banned from the Google Group.</p>
</div>
<div class="section" id="questions-problems">
<h4>Questions/Problems<a class="headerlink" href="#questions-problems" title="Permalink to this headline">¶</a></h4>
<div class="section" id="start-a-new-thread-instead-of-replying-to-an-old-one">
<h5>Start a new thread instead of replying to an old one<a class="headerlink" href="#start-a-new-thread-instead-of-replying-to-an-old-one" title="Permalink to this headline">¶</a></h5>
<p>Please search the mailing list to see if you can find similar issues that may help you. However, please do not reply to old threads with your new issue. Instead, please start a new thread and provide a hyperlink to the related discussion at <a class="reference external" href="https://groups.google.com/forum/#!forum/security-onion">https://groups.google.com/forum/#!forum/security-onion</a>.</p>
</div>
<div class="section" id="avoid-generic-ubuntu-questions">
<h5>Avoid generic Ubuntu questions<a class="headerlink" href="#avoid-generic-ubuntu-questions" title="Permalink to this headline">¶</a></h5>
<p>Security Onion is based on Ubuntu. Quite often, folks ask the Security Onion mailing list for help with Ubuntu issues not strictly related to Security Onion. In order to keep the signal-to-noise ratio as high as possible, the Security Onion mailing list should only be used for questions directly relating to Security Onion itself. If you have questions about Ubuntu, you should check the Ubuntu website, forums, and Google.</p>
</div>
<div class="section" id="provide-sufficient-technical-info">
<h5>Provide sufficient technical info<a class="headerlink" href="#provide-sufficient-technical-info" title="Permalink to this headline">¶</a></h5>
<div class="line-block">
<div class="line">In order to be as effective and efficient as possible, please consider the following when posing your question/problem to the group:</div>
<div class="line"><a class="reference external" href="http://www.chiark.greenend.org.uk/~sgtatham/bugs.html">http://www.chiark.greenend.org.uk/~sgtatham/bugs.html</a></div>
</div>
</div>
<div class="section" id="include-sostat-redacted-output">
<h5>Include sostat-redacted output<a class="headerlink" href="#include-sostat-redacted-output" title="Permalink to this headline">¶</a></h5>
<p>Please run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sostat</span><span class="o">-</span><span class="n">redacted</span>
</pre></div>
</div>
<p>There will be a lot of output, so you may need to increase your terminal’s scroll buffer OR redirect the output of the command to a file:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sostat</span><span class="o">-</span><span class="n">redacted</span> <span class="o">&gt;</span> <span class="n">sostat</span><span class="o">-</span><span class="n">redacted</span><span class="o">.</span><span class="n">txt</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">sostat-redacted</span></code> will automatically redact any IPv4/IPv6/MAC addresses, but there may be additional sensitive info that you still need to redact manually.</p>
<p>Attach the output to your email in plain text format (.txt) OR use a service like <a class="reference external" href="http://pastebin.com">http://pastebin.com</a>.</p>
</div>
</div>
<div class="section" id="security-onion-mailing-list">
<h4>Security-Onion mailing list<a class="headerlink" href="#security-onion-mailing-list" title="Permalink to this headline">¶</a></h4>
<p>Once you’ve read and understand all of the above, you can send your question to our security-onion mailing list.  It is hosted by Google Groups, so you can send via email or by posting in the web interface:</p>
<p><a class="reference external" href="http://groups.google.com/group/security-onion">http://groups.google.com/group/security-onion</a></p>
</div>
</div>
<span id="document-help-wanted"></span><div class="section" id="help-wanted">
<h3>Help Wanted<a class="headerlink" href="#help-wanted" title="Permalink to this headline">¶</a></h3>
<p>Folks frequently ask how they can give back to the Security Onion community. Here are a few of our community teams that you can help with.</p>
<div class="section" id="marketing-team">
<h4>Marketing Team<a class="headerlink" href="#marketing-team" title="Permalink to this headline">¶</a></h4>
<p>We need more folks to help spread the word about Security Onion by blogging, tweeting, and other social media.</p>
</div>
<div class="section" id="support-team">
<h4>Support Team<a class="headerlink" href="#support-team" title="Permalink to this headline">¶</a></h4>
<p>If you’d like help out other Security Onion users, please join the security-onion mailing list and/or IRC channel and start answering questions!</p>
<p><a class="reference external" href="https://groups.google.com/forum/#!forum/security-onion">https://groups.google.com/forum/#!forum/security-onion</a></p>
</div>
<div class="section" id="testing-qa-team">
<h4>Testing/QA Team<a class="headerlink" href="#testing-qa-team" title="Permalink to this headline">¶</a></h4>
<p>If you’d like to do testing/QA, please join the security-onion-testing mailing list.</p>
<p><a class="reference external" href="https://groups.google.com/forum/#!forum/security-onion-testing">https://groups.google.com/forum/#!forum/security-onion-testing</a></p>
</div>
<div class="section" id="documentation-team">
<h4>Documentation Team<a class="headerlink" href="#documentation-team" title="Permalink to this headline">¶</a></h4>
<p>If you find that some information in our Documentation is incorrect or lacking, please feel free to submit Pull Requests via GitHub!</p>
<p><a class="reference external" href="https://github.com/Security-Onion-Solutions/securityonion-docs">https://github.com/Security-Onion-Solutions/securityonion-docs</a></p>
</div>
<div class="section" id="core-development">
<h4>Core Development<a class="headerlink" href="#core-development" title="Permalink to this headline">¶</a></h4>
<p>Most of our code is on GitHub. Please feel free to submit pull requests!</p>
<p><a class="reference external" href="https://github.com/Security-Onion-Solutions">https://github.com/Security-Onion-Solutions</a></p>
</div>
<div class="section" id="thanks">
<h4>Thanks<a class="headerlink" href="#thanks" title="Permalink to this headline">¶</a></h4>
<p>The following folks have made significant contributions to Security Onion over the years. Thanks!</p>
<ul class="simple">
<li>Wes Lambert</li>
<li>Mike Reeves</li>
<li>Phil Plantamura</li>
<li>Dustin Lee</li>
<li>Josh Brower</li>
<li>Kevin Branch</li>
<li>Scott Runnels</li>
<li>Brad Shoop</li>
<li>Liam Randall</li>
<li>Paul Halliday</li>
<li>Eric Ooi</li>
<li>Lawrence Abrams</li>
<li>Mark Hillick</li>
<li>Joe Hargis</li>
<li>Dennis Distler</li>
<li>Jon Schipp</li>
<li>Josh More</li>
<li>Jack Blanchard</li>
</ul>
</div>
</div>
</div>
</div>
<span id="document-integrations"></span><div class="section" id="integrations">
<h2>Integrations<a class="headerlink" href="#integrations" title="Permalink to this headline">¶</a></h2>
<p>There are many different ways that we can integrate Security Onion into other systems.  However, please note that we don’t provide free support for third party systems, so this section will be just a brief introduction to how you would accomplish this. If you need commercial support, please see <a class="reference external" href="https://www.securityonionsolutions.com">https://www.securityonionsolutions.com</a>.</p>
<div class="toctree-wrapper compound">
<span id="document-alienvault-otx"></span><div class="section" id="alienvault-otx">
<h3>AlienVault-OTX<a class="headerlink" href="#alienvault-otx" title="Permalink to this headline">¶</a></h3>
<p>We can easily pull in <a class="reference external" href="https://otx.alienvault.com">Alienvault OTX</a> pulses into Security Onion and have Bro utilize them for the <a class="reference external" href="https://www.bro.org/sphinx-git/frameworks/intel.html">Intel Framework</a> by leveraging <a class="reference external" href="https://github.com/hosom/bro-otx">Stephen Hosom</a>’s work with Alienvault OTX integration.</p>
<div class="section" id="warning">
<h4>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h4>
<p>Please keep in mind we do not officially support use of this script, so installation is at your own risk.</p>
</div>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>In order to do begin, we will need to make sure we satisfy a few prerequisites:</p>
<div class="line-block">
<div class="line"><strong>Alienvault OTX API key</strong> - can be obtained for free at:
<a class="reference external" href="https://otx.alienvault.com">https://otx.alienvault.com</a></div>
<div class="line"><strong>Security Onion standalone/sensor</strong> (running Bro)</div>
<div class="line"><strong>External internet access</strong> - to retrieve updated pulses
(<a class="reference external" href="https://otx.alienvault.com/api/v1/pulses/subscribed">https://otx.alienvault.com/api/v1/pulses/subscribed</a>)</div>
</div>
<p>Download the installation script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">weslambert</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">otx</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">otx</span>
</pre></div>
</div>
<p>Run the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">bash</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">otx</span>
</pre></div>
</div>
<p>After using the above script, <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/policy/bro-otx</span></code> will house all necessary files, etc (including <code class="docutils literal notranslate"><span class="pre">otx.dat</span></code>, the intel file where all pulses will be fed).</p>
<p>We can test our configuration by adding another piece of intel to the end of <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/policy/bro-otx/otx.dat</span></code>.  For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">[</span><span class="n">literal</span> <span class="n">tab</span><span class="p">]</span><span class="n">Intel</span><span class="p">::</span><span class="n">DOMAIN</span><span class="p">[</span><span class="n">literal</span> <span class="n">tab</span><span class="p">]</span><span class="n">Test</span><span class="o">-</span><span class="n">Google</span><span class="o">-</span><span class="n">Intel</span><span class="p">[</span><span class="n">literal</span> <span class="n">tab</span><span class="p">]</span><span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">google</span><span class="o">.</span><span class="n">com</span><span class="p">[</span><span class="n">literal</span> <span class="n">tab</span><span class="p">]</span><span class="n">T</span>
</pre></div>
</div>
<p>As long as our syntax is correct, we should not need to restart Bro. We can check for errors in <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs/current/reporter.log</span></code>.</p>
<p>Let’s see if we can get an intel hit by doing the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="n">google</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<p>Next, we need to check <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs/current/intel.log</span></code> for entries in regard to our indicator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grep</span> <span class="n">google</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">current</span><span class="o">/</span><span class="n">intel</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>We should have received a Bro Notice as well, so lets check that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grep</span> <span class="n">google</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">current</span><span class="o">/</span><span class="n">notice</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>After successful testing, we can remove our addition from <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/policy/bro-otx/otx.dat</span></code> or just run <code class="docutils literal notranslate"><span class="pre">/opt/bro/share/bro/policy/bro-otx/bro-otx.py</span></code> again.</p>
<dl class="docutils">
<dt>By default, pulses will be retrieved on an hourly basis. To change this to a different value, simply alter the interval in</dt>
<dd><code class="docutils literal notranslate"><span class="pre">/etc/cron.d/bro-otx</span></code>.</dd>
</dl>
</div>
</div>
<span id="document-etherpad"></span><div class="section" id="etherpad">
<h3>Etherpad<a class="headerlink" href="#etherpad" title="Permalink to this headline">¶</a></h3>
<p>We can add Etherpad to Security Onion to allow us to take notes during investigations and share those with our team.</p>
<p>Simply run the following commands from a fresh Security Onion install (master server/or standalone):</p>
<p>Download:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">weslambert</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">etherpad</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">install_etherpad</span>
</pre></div>
</div>
<p>Execute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">bash</span> <span class="o">./</span><span class="n">install_etherpad</span>
</pre></div>
</div>
<p>Follow the prompts.</p>
<p>You should then be able to access Etherpad at the destination defined in the setup script.</p>
<p>Be sure to configure DNS or client hosts file(s) with the appropriate information and then run <a class="reference external" href="so-allow">so-allow</a> and allow port 443 for analysts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">allow</span>
</pre></div>
</div>
</div>
<span id="document-fir"></span><div class="section" id="fir">
<h3>FIR<a class="headerlink" href="#fir" title="Permalink to this headline">¶</a></h3>
<p>From: <a class="reference external" href="https://github.com/certsocietegenerale/FIR">https://github.com/certsocietegenerale/FIR</a>:</p>
<blockquote>
<div><p>FIR (Fast Incident Response) is an cybersecurity incident management
platform designed with agility and speed in mind. It &gt;allows for
easy creation, tracking, and reporting of cybersecurity incidents.</p>
<p>FIR is for anyone needing to track cybersecurity incidents (CSIRTs,
CERTs, SOCs, etc.). It’s was tailored to suit our &gt;needs &gt;and our
team’s habits, but we put a great deal of effort into making it as
generic as possible before releasing it &gt;so that &gt;other teams around
the world may also use it and customize it as they see fit.</p>
</div></blockquote>
<p>We can add FIR to Security Onion as a Docker container to enhance its current capabilities and leverage the great work from the folks at <a class="reference external" href="https://github.com/certsocietegenerale">CERT Societe Generale</a>.</p>
<div class="section" id="warning">
<h4>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h4>
<p>Please keep in mind we do not officially support FIR, so installation is at your own risk.</p>
</div>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>To install FIR on Security Onion, use the following steps.</p>
<p>Get the install script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">weslambert</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">fir</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">install_fir</span>
</pre></div>
</div>
<p>Run the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">bash</span> <span class="o">./</span><span class="n">install_fir</span>
</pre></div>
</div>
<p>Follow the prompts, and once finished, you should be able to navigate to FIR via <code class="docutils literal notranslate"><span class="pre">https://domain.you.specified</span></code>. (Note this address in also referenced in <code class="docutils literal notranslate"><span class="pre">/etc/apache2/sites-available/fir.conf</span></code>.)</p>
<p>Keep in mind, FIR is still accessible at <code class="docutils literal notranslate"><span class="pre">http://localhost:8001</span></code>, so you will want to make sure only port 443 is allowed externally, or alter your web server settings appropriately.</p>
<p>Also note, to access FIR by the above name you will need to:</p>
<ul class="simple">
<li>configure a hosts file on your local host
or</li>
<li>create a DNS record pointing to it.</li>
</ul>
<div class="line-block">
<div class="line">For more information on the FIR, see here:</div>
<div class="line"><a class="reference external" href="https://github.com/certsocietegenerale/FIR">https://github.com/certsocietegenerale/FIR</a></div>
</div>
</div>
</div>
<span id="document-grr"></span><div class="section" id="grr">
<h3>GRR<a class="headerlink" href="#grr" title="Permalink to this headline">¶</a></h3>
<p>From: <a class="reference external" href="https://github.com/google/grr">https://github.com/google/grr</a>:</p>
<blockquote>
<div>GRR Rapid Response: remote live forensics for incident response</div></blockquote>
<p>We can add GRR to Security Onion as a Docker container to enhance its current capabilities and leverage the great work from the folks at <a class="reference external" href="https://github.com/google/grr">Google</a>.</p>
<div class="section" id="warning">
<h4>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h4>
<p>Please keep in mind we do not officially support GRR, so installation is at your own risk.</p>
</div>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>To install GRR on Security Onion:</p>
<p>Get the install script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">weslambert</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">grr</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">install_grr</span>
</pre></div>
</div>
<p>Run the script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">bash</span> <span class="o">./</span><span class="n">install_grr</span>
</pre></div>
</div>
<p>Follow the prompts, and once finished, you should be able to navigate to GRR via <code class="docutils literal notranslate"><span class="pre">https://domain.you.specified</span></code>.  (Note this address in also referenced in <code class="docutils literal notranslate"><span class="pre">/etc/apache2/sites-available/grr.conf</span></code>.)</p>
<p>Keep in mind, GRR is still accessible at <code class="docutils literal notranslate"><span class="pre">http://localhost:8000</span></code>, so you will want to make sure only port 443 is allowed externally, or alter your web server settings appropriately.</p>
<p>Also note, to access GRR by the above name you will need to:</p>
<ul class="simple">
<li>configure a hosts file on your local host
OR</li>
<li>create a DNS record pointing to it.</li>
</ul>
</div>
<div class="section" id="firewall-rules">
<h4>Firewall Rules<a class="headerlink" href="#firewall-rules" title="Permalink to this headline">¶</a></h4>
<p>You can add firewall rules using <a class="reference external" href="so-allow">so-allow</a> and choosing the <code class="docutils literal notranslate"><span class="pre">Analyst</span></code> option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">allow</span>
</pre></div>
</div>
<p>OR</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="n">proto</span> <span class="n">tcp</span> <span class="kn">from</span> <span class="nn">REMOTE_IP</span> <span class="n">to</span> <span class="nb">any</span> <span class="n">port</span> <span class="mi">443</span>
</pre></div>
</div>
<p>GRR Client IP:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>sudo iptables -I DOCKER-USER ! -i docker0 -o docker0 -s ClIENT_IP -p tcp --dport 8080 -j ACCEPT
</pre></div>
</div>
</div>
<div class="section" id="management">
<h4>Management<a class="headerlink" href="#management" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">If you would like to add another user, aside from the default, you can follow the instructions here:</div>
<div class="line"><a class="reference external" href="https://grr-doc.readthedocs.io/en/latest/maintaining-and-tuning/user-management/index.html">https://grr-doc.readthedocs.io/en/latest/maintaining-and-tuning/user-management/index.html</a></div>
<div class="line"><br /></div>
<div class="line">For more information on the GRR Docker image, see here:</div>
<div class="line"><a class="reference external" href="https://grr-doc.readthedocs.io/en/latest/">https://grr-doc.readthedocs.io/en/latest/</a></div>
</div>
</div>
</div>
<span id="document-hive"></span><div class="section" id="thehive">
<h3>TheHive<a class="headerlink" href="#thehive" title="Permalink to this headline">¶</a></h3>
<div class="section" id="elastalert-rules">
<h4>Elastalert Rules<a class="headerlink" href="#elastalert-rules" title="Permalink to this headline">¶</a></h4>
<p>We can send events to an instance of the TheHive, as Elastalert includes the TheHive alerter (<a class="reference external" href="https://github.com/Nclose-ZA/elastalert_hive_alerter">Nclose-ZA</a>).</p>
<p>Simply modify the following rule as desired, and place the rule in <code class="docutils literal notranslate"><span class="pre">/etc/elastalert/rules</span></code>, on your Security Onion box (master server if running Distributed Deployment).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># hive.yaml
# Elastalert rule to forward IDS alerts from Security Onion to a specified TheHive instance.
#
es_host: elasticsearch
es_port: 9200
name: TheHive - New IDS Alert!
type: frequency
index: &quot;*:logstash-ids*&quot;
num_events: 1
timeframe:
    minutes: 10
buffer_time:
    minutes: 10
allow_buffer_time_overlap: true

filter:
- term:
    event_type: &quot;snort&quot;

alert: hivealerter

hive_connection:
  hive_host: http(s)://YOUR_HIVE_INSTANCE
  hive_port: YOUR_HIVE_INSTANCE_PORT
  hive_apikey: APIKEY

hive_proxies:
  http: &#39;&#39;
  https: &#39;&#39;

hive_alert_config:
  title: &#39;{rule[name]} -- {match[alert]}&#39;
  type: &#39;external&#39;
  source: &#39;SecurityOnion&#39;
  description: &#39;{match[message]}&#39;
  severity: 2
  tags: [&#39;elastalert, SecurityOnion&#39;]
  tlp: 3
  status: &#39;New&#39;
  follow: True

hive_observable_data_mapping:
  - ip: &#39;{match[source_ip]}&#39;
  - ip: &#39;{match[destination_ip]}&#39;
</pre></div>
</div>
</div>
</div>
<span id="document-misp"></span><div class="section" id="misp">
<h3>MISP<a class="headerlink" href="#misp" title="Permalink to this headline">¶</a></h3>
<div class="section" id="nids-rules">
<h4>NIDS Rules<a class="headerlink" href="#nids-rules" title="Permalink to this headline">¶</a></h4>
<div class="line-block">
<div class="line">Not long ago, the MISP project announced the ability to export NIDS rules created from events/indicators:</div>
<div class="line"><a class="reference external" href="https://www.circl.lu/doc/misp/automation/#get-eventsnids-nids-rules-export">https://www.circl.lu/doc/misp/automation/#get-eventsnids-nids-rules-export</a></div>
</div>
<p>We can leverage this functionality by quickly and easily setting up an automated mechanism to pull NIDS rules from a MISP instance and add them to our local rules for Security Onion. To do so, we just need to follow the simple steps below.</p>
</div>
<div class="section" id="warning">
<h4>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h4>
<p>Please keep in mind we do not officially support this integration, so installation is at your own risk.
Additionally, the current version of MISP seems to have an issue with Bro Intel export, therefore, this particular functionailty may not work as intended ( depending on the version of MISP you are using).</p>
<p>See: <a class="reference external" href="https://github.com/MISP/MISP/issues/4050">https://github.com/MISP/MISP/issues/4050</a> for more details.</p>
</div>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>Clone the repo:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">weslambert</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">misp</span>
</pre></div>
</div>
<p>Run the setup script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">misp</span><span class="o">/</span><span class="n">so</span><span class="o">-</span><span class="n">misp</span><span class="o">-</span><span class="n">setup</span>
</pre></div>
</div>
<p>Update rules (if desired):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rule</span><span class="o">-</span><span class="n">update</span>
</pre></div>
</div>
<p>Confirm rules in place:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="n">misp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">rules</span><span class="o">/</span><span class="n">downloaded</span><span class="o">.</span><span class="n">rules</span>
</pre></div>
</div>
<p>You should now be up and running!</p>
<p>MISP rules will be downloaded via cron-job at the interval specified in <code class="docutils literal notranslate"><span class="pre">/etc/cron.d/download-misp</span></code>.</p>
</div>
<div class="section" id="elastalert">
<h4>Elastalert<a class="headerlink" href="#elastalert" title="Permalink to this headline">¶</a></h4>
<p>If we want to send events to TheHive based on the MISP NIDS rules we’ve pulled into Security Onion, we can implement an Elastalert rule like the following, filtering on the <code class="docutils literal notranslate"><span class="pre">alert</span></code> field for NIDS alerts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># misp-nids-hive.yaml</span>
<span class="c1"># Elastalert rule to forward IDS alerts generated by MISP NIDS rules from Security Onion</span>
<span class="c1"># to a specified TheHive instance.</span>
<span class="c1">#</span>
<span class="n">es_host</span><span class="p">:</span> <span class="n">elasticsearch</span>
<span class="n">es_port</span><span class="p">:</span> <span class="mi">9200</span>
<span class="n">name</span><span class="p">:</span> <span class="n">MISP</span> <span class="n">NIDS</span> <span class="n">Rule</span> <span class="n">Match</span>
<span class="nb">type</span><span class="p">:</span> <span class="n">frequency</span>
<span class="n">index</span><span class="p">:</span> <span class="s2">&quot;*:logstash-ids*&quot;</span>
<span class="n">num_events</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">timeframe</span><span class="p">:</span>
     <span class="n">minutes</span><span class="p">:</span> <span class="mi">1</span>
<span class="nb">filter</span><span class="p">:</span>
 <span class="o">-</span> <span class="n">query</span><span class="p">:</span>
    <span class="n">query_string</span><span class="p">:</span>
      <span class="n">query</span><span class="p">:</span> <span class="s2">&quot;alert: MISP&quot;</span>

<span class="n">alert</span><span class="p">:</span>
<span class="o">-</span> <span class="s2">&quot;hivealerter&quot;</span>

<span class="n">hive_connection</span><span class="p">:</span>
    <span class="n">hive_host</span><span class="p">:</span>  <span class="n">http</span><span class="p">(</span><span class="n">s</span><span class="p">):</span><span class="o">//</span><span class="n">YOUR_HIVE_INSTANCE</span>
    <span class="n">hive_port</span><span class="p">:</span> <span class="n">YOUR_HIVE_INSTANCE_PORT</span>
    <span class="n">hive_apikey</span><span class="p">:</span> <span class="n">APIKEY</span>

<span class="n">hive_proxies</span><span class="p">:</span>
  <span class="n">http</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>
  <span class="n">https</span><span class="p">:</span> <span class="s1">&#39;&#39;</span>

<span class="n">hive_alert_config</span><span class="p">:</span>
    <span class="n">title</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{match[alert]}</span><span class="s1">&#39;</span>
    <span class="nb">type</span><span class="p">:</span> <span class="s1">&#39;external&#39;</span>
    <span class="n">source</span><span class="p">:</span> <span class="s1">&#39;SecurityOnion&#39;</span>
    <span class="n">description</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{match[message]}</span><span class="s1">&#39;</span>
    <span class="n">severity</span><span class="p">:</span> <span class="mi">2</span>
    <span class="n">tags</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;elastalert, SecurityOnion, MISP, NIDS&#39;</span><span class="p">]</span>
    <span class="n">tlp</span><span class="p">:</span> <span class="mi">3</span>
    <span class="n">status</span><span class="p">:</span> <span class="s1">&#39;New&#39;</span>
    <span class="n">follow</span><span class="p">:</span> <span class="kc">True</span>

<span class="n">hive_observable_data_mapping</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">ip</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{match[source_ip]}</span><span class="s1">&#39;</span>
    <span class="o">-</span> <span class="n">ip</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{match[destination_ip]}</span><span class="s1">&#39;</span>
    <span class="o">-</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{match[interface]}</span><span class="s1">&#39;</span>
    <span class="o">-</span> <span class="n">other</span><span class="p">:</span> <span class="s1">&#39;</span><span class="si">{match[sid]}</span><span class="s1">&#39;</span>
</pre></div>
</div>
<p>Simply fill in the pertinent TheHive instance connection details above, and place this rule in <code class="docutils literal notranslate"><span class="pre">/etc/elastalert/rules</span></code> as <code class="docutils literal notranslate"><span class="pre">misp-nids-hive.yaml</span></code>.</p>
<p>As a result, you will receive alerts in TheHive for any matching events in the <code class="docutils literal notranslate"><span class="pre">logstash-ids-*</span></code> index.  The following observables will be generated for the alert:</p>
<ul class="simple">
<li>Source/Destination IP from alert</li>
<li>Sensor interface from IDS alert</li>
<li>Signature ID (sid) from alert</li>
</ul>
</div>
</div>
<span id="document-ntopng"></span><div class="section" id="ntopng">
<h3>NtopNG<a class="headerlink" href="#ntopng" title="Permalink to this headline">¶</a></h3>
<p>The latest-stable version of ntopng can now be installed on the latest-stable version of Security Onion.</p>
<div class="line-block">
<div class="line">Installer script maintained here:</div>
<div class="line"><a class="reference external" href="https://github.com/branchnetconsulting/so-ntopng-installer">https://github.com/branchnetconsulting/so-ntopng-installer</a></div>
</div>
</div>
<span id="document-rita"></span><div class="section" id="rita">
<h3>RITA<a class="headerlink" href="#rita" title="Permalink to this headline">¶</a></h3>
<p>From: <a class="reference external" href="https://github.com/activecm/rita">https://github.com/activecm/rita</a></p>
<blockquote>
<div><p>RITA is an open source framework for network traffic analysis.</p>
<p>The framework ingests Bro Logs, and currently supports the following
analysis features:</p>
<div class="line-block">
<div class="line">Beaconing: Search for signs of beaconing behavior in and out of
your network</div>
<div class="line">DNS Tunneling Search for signs of DNS based covert channels</div>
<div class="line">Blacklisted: Query blacklists to search for suspicious domains and
hosts</div>
<div class="line">URL Length Analysis: Search for lengthy URLs indicative of malware</div>
<div class="line">Scanning: Search for signs of port scans in your network</div>
</div>
</div></blockquote>
<p>We can add RITA to Security Onion to enhance its current capabilities and leverage the great work from the folks at <a class="reference external" href="https://activecountermeasures.com/">Active Countermeasures</a>. They’ve done a fantastic job of allowing RITA to be easy to integrate with Security Onion.</p>
<div class="section" id="warning">
<h4>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h4>
<p>Please keep in mind we do not officially support RITA, so installation is at your own risk.</p>
<p>Additionally, RITA currently only supports use of Bro logs in <code class="docutils literal notranslate"><span class="pre">TSV</span></code> format. If you are running the latest version of Security Onion, you will need to switch from <code class="docutils literal notranslate"><span class="pre">JSON</span></code> to <code class="docutils literal notranslate"><span class="pre">TSV</span></code> format by following the steps here:</p>
<p><a class="reference external" href="Bro#tsv">Bro#tsv</a></p>
</div>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>To install RITA on Security Onion:</p>
<p>Download the install script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">raw</span><span class="o">.</span><span class="n">githubusercontent</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">activecm</span><span class="o">/</span><span class="n">rita</span><span class="o">/</span><span class="n">master</span><span class="o">/</span><span class="n">install</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Run the installer:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">bash</span> <span class="o">./</span><span class="n">install</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>Start MongoDB:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">mongod</span> <span class="n">start</span>
</pre></div>
</div>
</div>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>You can then import logs with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rita</span> <span class="kn">import</span> <span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">bro</span><span class="o">/</span><span class="n">logs</span> <span class="n">dataset1</span>
</pre></div>
</div>
<p>Then have RITA analyze the imported data:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rita</span> <span class="n">analyze</span>
</pre></div>
</div>
<p>To see the most visited URLs:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rita</span> <span class="n">show</span><span class="o">-</span><span class="n">most</span><span class="o">-</span><span class="n">visited</span><span class="o">-</span><span class="n">urls</span> <span class="n">dataset1</span>
</pre></div>
</div>
<p>To see long connections, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rita</span> <span class="n">show</span><span class="o">-</span><span class="n">long</span><span class="o">-</span><span class="n">connections</span> <span class="n">dataset1</span>
</pre></div>
</div>
<p>To see beacons, type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rita</span> <span class="n">show</span><span class="o">-</span><span class="n">beacons</span> <span class="n">dataset1</span>
</pre></div>
</div>
<p>Finally, you can issue an HTML report (viewable in browser) by typing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rita</span> <span class="n">html</span><span class="o">-</span><span class="n">report</span>
</pre></div>
</div>
<p>See other available commands with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rita</span> <span class="o">--</span><span class="n">help</span>
</pre></div>
</div>
</div>
<div class="section" id="configuration">
<h4>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h4>
<p>If you don’t want to specify your the path for your Bro logs, you’ll want to change the value for <code class="docutils literal notranslate"><span class="pre">ImportDirectory</span></code> in
<code class="docutils literal notranslate"><span class="pre">/etc/rita/config.yaml</span></code> to <code class="docutils literal notranslate"><span class="pre">/nsm/bro/logs</span></code>.</p>
<div class="line-block">
<div class="line">For additional information, see:</div>
<div class="line"><a class="reference external" href="https://github.com/activecm/rita">https://github.com/activecm/rita</a></div>
</div>
</div>
</div>
<span id="document-strelka"></span><div class="section" id="strelka">
<h3>Strelka<a class="headerlink" href="#strelka" title="Permalink to this headline">¶</a></h3>
<p>From <a class="reference external" href="https://github.com/target/strelka">https://github.com/target/strelka</a>:</p>
<blockquote>
<div>Strelka is a real-time file scanning system used for threat hunting, threat detection, and incident response. Based on the design established by Lockheed Martin’s Laika BOSS and similar projects (see: related projects), Strelka’s purpose is to perform file extraction and metadata collection at huge scale.</div></blockquote>
<div class="section" id="warning">
<h4>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h4>
<p>Please keep in mind we do not officially support Strelka, so installation is at your own risk.</p>
</div>
<div class="section" id="installation">
<h4>Installation<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h4>
<p>For installation instructions, please see <a class="reference external" href="https://github.com/weslambert/securityonion-strelka">https://github.com/weslambert/securityonion-strelka</a>.</p>
</div>
</div>
<span id="document-syslog-output"></span><div class="section" id="syslog-output">
<h3>Syslog Output<a class="headerlink" href="#syslog-output" title="Permalink to this headline">¶</a></h3>
<p>Please keep in mind that we don’t provide free support for third party systems, so this section will be just a brief introduction to how you would send syslog to external syslog collectors. If you need commercial support, please see <a class="reference external" href="https://www.securityonionsolutions.com">https://www.securityonionsolutions.com</a>.</p>
<div class="section" id="how-do-i-send-bro-and-wazuh-logs-to-an-external-syslog-collector">
<h4>How do I send Bro and Wazuh logs to an external syslog collector?<a class="headerlink" href="#how-do-i-send-bro-and-wazuh-logs-to-an-external-syslog-collector" title="Permalink to this headline">¶</a></h4>
<p>Configure <code class="docutils literal notranslate"><span class="pre">/etc/syslog-ng/syslog-ng.conf</span></code> with a new <code class="docutils literal notranslate"><span class="pre">destination</span></code> to forward to your external syslog collector and then restart <code class="docutils literal notranslate"><span class="pre">syslog-ng</span></code>.</p>
</div>
<div class="section" id="how-do-i-send-ids-alerts-to-an-external-system">
<h4>How do I send IDS alerts to an external system?<a class="headerlink" href="#how-do-i-send-ids-alerts-to-an-external-system" title="Permalink to this headline">¶</a></h4>
<p>2 options:</p>
<ul>
<li><p class="first">Edit ALL <code class="docutils literal notranslate"><span class="pre">/etc/nsm/HOSTNAME-INTERFACE/barnyard2*.conf</span></code> files on ALL sensors with a new <code class="docutils literal notranslate"><span class="pre">output</span></code> to send IDS alerts to your external systems and then restart all barnyard2 instances:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">barnyard</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
</li>
</ul>
<p>OR</p>
<ul class="simple">
<li>On your master server (running sguild), configure <code class="docutils literal notranslate"><span class="pre">/etc/syslog-ng/syslog-ng.conf</span></code> with a new <code class="docutils literal notranslate"><span class="pre">source</span></code> to monitor <code class="docutils literal notranslate"><span class="pre">/var/log/nsm/securityonion/sguild.log</span></code> for <code class="docutils literal notranslate"><span class="pre">Alert</span> <span class="pre">Received</span></code> lines and a new <code class="docutils literal notranslate"><span class="pre">destination</span></code> to send to your external system, and then restart <code class="docutils literal notranslate"><span class="pre">syslog-ng</span></code>. To do this modify <code class="docutils literal notranslate"><span class="pre">/etc/syslog-ng/syslog-ng.conf</span></code> and add the following lines:</li>
</ul>
<p>This line specifies where the sguild.log file is located, and informs syslog-ng to tail the file, the program_override inserts the string sguil_alert into the string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">s_sguil</span> <span class="p">{</span> <span class="n">file</span><span class="p">(</span><span class="s2">&quot;/var/log/nsm/securityonion/sguild.log&quot;</span>
<span class="n">program_override</span><span class="p">(</span><span class="s2">&quot;sguil_alert&quot;</span><span class="p">));</span> <span class="p">};</span>
</pre></div>
</div>
<p>This line filters on the string “Alert Received”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">filter</span> <span class="n">f_sguil</span> <span class="p">{</span> <span class="n">match</span><span class="p">(</span><span class="s2">&quot;Alert Received&quot;</span><span class="p">);</span> <span class="p">};</span>
</pre></div>
</div>
<p>This line tells syslog-ng to send the data read to the IP address of 10.80.4.37, via UDP to port 514:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">destination</span> <span class="n">d_sguil_udp</span> <span class="p">{</span> <span class="n">udp</span><span class="p">(</span><span class="s2">&quot;10.80.4.37&quot;</span> <span class="n">port</span><span class="p">(</span><span class="mi">514</span><span class="p">));</span> <span class="p">};</span>
</pre></div>
</div>
<p>This log section tells syslog-ng how to structure the previous ‘source / filter / destination’ and is what actually puts them into play:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">log</span> <span class="p">{</span>
<span class="n">source</span><span class="p">(</span><span class="n">s_sguil</span><span class="p">);</span>
<span class="nb">filter</span><span class="p">(</span><span class="n">f_sguil</span><span class="p">);</span>
<span class="n">destination</span><span class="p">(</span><span class="n">d_sguil_udp</span><span class="p">);</span>
<span class="p">};</span>
</pre></div>
</div>
<p>Please note that this option requires <code class="docutils literal notranslate"><span class="pre">set</span> <span class="pre">DEBUG</span> <span class="pre">2</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/sguild/sguild.conf</span></code>.</p>
</div>
</div>
</div>
</div>
<span id="document-security"></span><div class="section" id="security">
<h2>Security<a class="headerlink" href="#security" title="Permalink to this headline">¶</a></h2>
<p>If you have any security concerns regarding Security Onion or believe
you have uncovered a vulnerability, please follow these steps:</p>
<ul class="simple">
<li>send an email to <a class="reference external" href="mailto:security&#37;&#52;&#48;securityonion&#46;net">security<span>&#64;</span>securityonion<span>&#46;</span>net</a></li>
<li>include a description of the issue and steps to reproduce</li>
<li>please use plain text format (no Word documents or PDF files)</li>
<li>please do not disclose publicly until we have had sufficient time to
resolve the issue</li>
</ul>
<p>Note that this security address should be used only for undisclosed
vulnerabilities. Dealing with fixed issues or general questions on how
to use Security Onion should be handled regularly via the
<a class="reference external" href="MailingLists">security-onion Google Group</a>.</p>
</div>
<span id="document-appendix"></span><div class="section" id="appendix">
<h2>Appendix<a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h2>
<p>This appendix covers the process of upgrading older 14.04/ELSA boxes.</p>
<div class="toctree-wrapper compound">
<span id="document-elsa-to-elastic"></span><div class="section" id="elsa-to-elastic">
<h3>ELSA to Elastic<a class="headerlink" href="#elsa-to-elastic" title="Permalink to this headline">¶</a></h3>
<p>The Elastic Stack typically requires more CPU and more RAM than ELSA. In
addition, you will most likely want SSD storage for Elastic data if at
all possible. For best results, we recommend performing a fresh
installation on new hardware designed to meet these requirements. If
your ELSA hardware already meets these requirements and you really need
to perform an in-place upgrade from ELSA to Elastic, this page will
provide an overview of steps necessary.</p>
<div class="section" id="warning">
<h4>Warning<a class="headerlink" href="#warning" title="Permalink to this headline">¶</a></h4>
<p>The in-place upgrade process is still considered EXPERIMENTAL and so the
usual warnings and disclaimers apply:</p>
<ul class="simple">
<li>This is BLEEDING EDGE and TOTALLY UNSUPPORTED!</li>
<li>If this breaks your system, you get to keep both pieces!</li>
<li>This may result in nausea, vomiting, or a burning sensation.</li>
</ul>
</div>
<div class="section" id="exporting-data-from-elsa">
<h4>Exporting Data from ELSA<a class="headerlink" href="#exporting-data-from-elsa" title="Permalink to this headline">¶</a></h4>
<p>By default, this process does NOT export data from ELSA. If you need the
data that is in ELSA, there is an experimental script called
<code class="docutils literal notranslate"><span class="pre">so-elsa-export</span></code> that can export data from ELSA to raw logs in the
filesystem. Before running this script, please check your disk space as
this will duplicate all your logs. Once exported, you may want to move
these logs off to a separate system for archival. They are standard
cleartext logs so you can use standard command line tools such as
<code class="docutils literal notranslate"><span class="pre">grep</span></code>, <code class="docutils literal notranslate"><span class="pre">awk</span></code>, and <code class="docutils literal notranslate"><span class="pre">sed</span></code> to search through them if necessary.</p>
</div>
<div class="section" id="importing-data-to-elastic">
<h4>Importing Data to Elastic<a class="headerlink" href="#importing-data-to-elastic" title="Permalink to this headline">¶</a></h4>
<p>The export script provides information on how to import the data into
Elastic. However, please note the following caveats:</p>
<ul class="simple">
<li>this creates yet another copy of the data and so it is essential that
you have plenty of free space</li>
<li>Logstash only has parsers for the current version of Bro, so older
Bro logs may not parse correctly</li>
</ul>
</div>
<div class="section" id="upgrade-process">
<h4>Upgrade Process<a class="headerlink" href="#upgrade-process" title="Permalink to this headline">¶</a></h4>
<div class="section" id="standalone">
<h5>Standalone<a class="headerlink" href="#standalone" title="Permalink to this headline">¶</a></h5>
<p>For a single standalone box that doesn’t have any separate sensor boxes
connected to it:</p>
<p>Install all updates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">soup</span>
</pre></div>
</div>
<p>Reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
<p>Install and configure Elastic:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">elastic</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">download</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">configure</span>
</pre></div>
</div>
</div>
<div class="section" id="distributed-deployment">
<h5>Distributed Deployment<a class="headerlink" href="#distributed-deployment" title="Permalink to this headline">¶</a></h5>
<p>For distributed deployments consisting of a master server and one or
more sensor boxes, start the upgrade process with the master server.
Once the master server has been fully converted to the Elastic Stack,
then start updating sensors one at a time.</p>
</div>
<div class="section" id="master-server">
<h5>Master Server<a class="headerlink" href="#master-server" title="Permalink to this headline">¶</a></h5>
<p>Before initiating the upgrade process on the master server, run sostat:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sostat</span>
</pre></div>
</div>
<p>At the very end of the sostat output, look for the section entitled
“ELSA Log Node SSH Tunnels”. Save the information in this section as you
will need it later in this procedure.</p>
<p>Install all updates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">soup</span>
</pre></div>
</div>
<p>Reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
<p>Install and configure Elastic:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">elastic</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">download</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">configure</span>
</pre></div>
</div>
<p>For each sensor ssh account, add lines to <code class="docutils literal notranslate"><span class="pre">/etc/ssh/sshd_config</span></code> like
the following (replacing <code class="docutils literal notranslate"><span class="pre">$SSH_USERNAME</span></code> with the actual sensor ssh
account):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Match User $SSH_USERNAME
   GatewayPorts clientspecified
</pre></div>
</div>
<p>Restart <code class="docutils literal notranslate"><span class="pre">sshd</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">ssh</span> <span class="n">restart</span>
</pre></div>
</div>
</div>
<div class="section" id="sensors">
<h5>Sensors<a class="headerlink" href="#sensors" title="Permalink to this headline">¶</a></h5>
<p>Perform the following steps on each sensor box, one at a time (finish
the first sensor before starting the second sensor, etc.).</p>
<p>Install all updates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">soup</span>
</pre></div>
</div>
<p>Reboot:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
<p>Install and configure Elastic:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span> <span class="n">update</span>
<span class="n">sudo</span> <span class="n">apt</span> <span class="n">install</span> <span class="n">securityonion</span><span class="o">-</span><span class="n">elastic</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">download</span>
<span class="n">echo</span> <span class="s2">&quot;KIBANA_ENABLED=no&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">securityonion</span><span class="o">.</span><span class="n">conf</span>
<span class="n">echo</span> <span class="s2">&quot;ELASTALERT_ENABLED=no&quot;</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">tee</span> <span class="o">-</span><span class="n">a</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nsm</span><span class="o">/</span><span class="n">securityonion</span><span class="o">.</span><span class="n">conf</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">elastic</span><span class="o">-</span><span class="n">configure</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">autossh</span><span class="o">-</span><span class="n">restart</span>
</pre></div>
</div>
<p>Check to make sure the old ELSA autossh tunnel is not still running –
if it is, it could cause problems starting our new one for
Elasticsearch:</p>
<p><code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">aux</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">autossh</span></code></p>
<p>If you see something like the following, you’ll need to kill it and run
<code class="docutils literal notranslate"><span class="pre">so-autossh-start</span></code> again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>4356  0.0  0.0   4356    92 ?        Ss   18:26   0:00 /usr/lib/autossh/autossh -M 0    -q -N -o ServerAliveInterval 60 -o ServerAliveCountMax 3 -i /root/.ssh/securityonion -L 3306:127.0.0.1:3306 -R 50000:localhost:3154 sensor@192.168.1.3

sudo kill -9 4356
ps aux | grep autossh (verify no process)
sudo so-autossh-start
</pre></div>
</div>
<p>Checking again with <code class="docutils literal notranslate"><span class="pre">ps</span> <span class="pre">aux</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">autossh</span></code>, we see the correct
connection information:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>17707  0.0  0.0   4356    92 ?        Ss   18:50   0:00 /usr/lib/autossh/autossh -M 0    -q -N -o ServerAliveInterval 60 -o ServerAliveCountMax 3 -i /root/.ssh/securityonion -R 172.18.0.1:50000:localhost:9300 sensor@192.168.1.3
</pre></div>
</div>
<p>Next we’ll want to check to make sure <code class="docutils literal notranslate"><span class="pre">$REVERSE_PORT</span></code> was correctly
set in <code class="docutils literal notranslate"><span class="pre">/root/.ssh/securityonion_ssh.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">cat</span> <span class="o">/</span><span class="n">root</span><span class="o">/.</span><span class="n">ssh</span><span class="o">/</span><span class="n">securityonion_ssh</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>We should get something like the following:</p>
<p><code class="docutils literal notranslate"><span class="pre">SSH_USERNAME=sensor</span> <span class="pre">SERVERNAME=192.168.1.3</span> <span class="pre">REVERSE_PORT=50000</span></code></p>
<p>Next, we’ll manually add transport settings to
<code class="docutils literal notranslate"><span class="pre">/etc/elasticsearch/elasticsearch.yml</span></code> (replacing <code class="docutils literal notranslate"><span class="pre">$REVERSE_PORT</span></code>
with the actual reverse port):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>transport.bind_host: 0.0.0.0
transport.publish_host: 172.18.0.1
transport.publish_port: $REVERSE_PORT.
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">transport.publish_host</span></code> should ALWAYS be set to <code class="docutils literal notranslate"><span class="pre">172.18.0.1</span></code></p>
<p>Restart Elasticsearch:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">docker</span> <span class="n">restart</span> <span class="n">so</span><span class="o">-</span><span class="n">elasticsearch</span>
</pre></div>
</div>
</div>
<div class="section" id="back-to-the-master-server">
<h5>Back to the master server<a class="headerlink" href="#back-to-the-master-server" title="Permalink to this headline">¶</a></h5>
<p>Next, we’ll need to add the correct information for UFW and
Elasticsearch so that we can query the sensor’s Elasticsearch instance
via Cross Cluster Search:</p>
<p>For each sensor, add a firewall rule (replacing <code class="docutils literal notranslate"><span class="pre">5000X</span></code> with the
actual reverse port):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">ufw</span> <span class="n">allow</span> <span class="n">proto</span> <span class="n">tcp</span> <span class="kn">from</span> <span class="mf">172.18</span><span class="o">.</span><span class="mf">0.0</span><span class="o">/</span><span class="mi">24</span> <span class="n">to</span> <span class="mf">172.18</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">port</span> <span class="mi">5000</span><span class="n">X</span>
</pre></div>
</div>
<p>Log into Kibana, click Dev Tools, paste the following, and then click
the green triangle to send the request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="n">_cluster</span><span class="o">/</span><span class="n">settings</span>
</pre></div>
</div>
<p>The output pane on the right will then display <code class="docutils literal notranslate"><span class="pre">_cluster/settings</span></code>
which will list the master server and any remote nodes.</p>
<p>If any of your hostnames have capital letters, you’ll want to lowercase
those letters when adding these settings, given that our new standard is
to use lowercase. Paste the following into Dev Tools with the actual
node name and $REVERSE_PORT you’d like to add:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PUT</span> <span class="n">_cluster</span><span class="o">/</span><span class="n">settings</span>
<span class="p">{</span>
  <span class="s2">&quot;persistent&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">&quot;search&quot;</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">&quot;remote&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;sensorname&quot;</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">&quot;seeds&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s2">&quot;172.18.0.1:5000X&quot;</span> <span class="p">],</span>
          <span class="s2">&quot;skip_unavailable&quot;</span><span class="p">:</span> <span class="n">true</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Next, we can do the following from within Kibana Dev Tools to check our
configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GET</span> <span class="n">_cluster</span><span class="o">/</span><span class="n">settings</span>
</pre></div>
</div>
<p>If everything worked, then you should see the new sensor listed in the
output.</p>
<p>Last, check the Kibana Overview Dashboard or Discover and search for
logs from the new sensor.</p>
</div>
</div>
</div>
<span id="document-upgrading-from-14.04-to-16.04"></span><div class="section" id="upgrading-from-14-04-to-16-04">
<h3>Upgrading from 14.04 to 16.04<a class="headerlink" href="#upgrading-from-14-04-to-16-04" title="Permalink to this headline">¶</a></h3>
<p>Please read through this entire page before beginning!</p>
<div class="section" id="disclaimers">
<h4>Disclaimers<a class="headerlink" href="#disclaimers" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>We offer no guarantees that this upgrade process will work perfectly.</li>
</ul>
</div>
<div class="section" id="warnings">
<h4>Warnings<a class="headerlink" href="#warnings" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Before upgrading production sensors, you should fully test this
upgrade process on test sensors in a test environment that closely
matches your production environment.</li>
<li>Argus, Pads, Prads, and ELSA are no longer supported – these
software packages will be removed upon upgrade and will not be
supported in future releases.</li>
<li>If you were previously running ELSA, please ensure your system has
been converted to
<a class="reference external" href="ELSA-to-Elastic">Elastic</a>
before upgrading.</li>
</ul>
</div>
<div class="section" id="pre-upgrade-notes">
<h4>Pre-upgrade Notes<a class="headerlink" href="#pre-upgrade-notes" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">If you are behind a proxy, make sure that you’ve <a class="reference external" href="Proxy">configured your
proxy settings</a>. In the commands below that use sudo, you
may need to use <code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">-i</span></code> so that your proxy settings are applied
to the sudo environment.</p>
</li>
<li><p class="first">The upgrade process will take at <strong>least</strong> 1-2 hours (per
server/sensor), depending on the speed of your server hardware and
Internet connection. Please plan accordingly.</p>
</li>
<li><p class="first">If you’re upgrading a distributed deployment, you’ll need to perform
the steps below on the master server and all sensors, but make sure
you <strong>start with the master server first!</strong></p>
</li>
<li><p class="first">If you’re upgrading a master server and you have a large ip2c table,
you may want to truncate it and populate fresh data before initiating
the 16.04 upgrade:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">mysql</span> <span class="o">--</span><span class="n">defaults</span><span class="o">-</span><span class="n">file</span><span class="o">=/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="o">/</span><span class="n">debian</span><span class="o">.</span><span class="n">cnf</span> <span class="o">-</span><span class="n">Dsecurityonion_db</span> <span class="o">-</span><span class="n">e</span> <span class="s1">&#39;truncate table ip2c;&#39;</span>
<span class="n">sudo</span> <span class="n">so</span><span class="o">-</span><span class="n">squert</span><span class="o">-</span><span class="n">ip2c</span>
</pre></div>
</div>
</li>
<li><p class="first">After upgrading the master server, ensure all sensors are upgraded as
soon as possible to minimize disruption and/or incompatibility
issues. Mixed-release (14.04 + 16.04) environments are currently
untested and unsupported.</p>
</li>
</ul>
</div>
<div class="section" id="preparation">
<h4>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Start with a fully configured Security Onion 14.04 (Elastic Stack)
installation.</p>
</li>
<li><p class="first">If running in a VM, create a snapshot so that you can revert if
necessary.</p>
</li>
<li><p class="first">You may want to record a transcript of the full upgrade so you can
refer back to it in case of any errors. For more information, please
see
<a class="reference external" href="https://www.debian.org/releases/stable/i386/release-notes/ch-upgrading.en.html#record-session">https://www.debian.org/releases/stable/i386/release-notes/ch-upgrading.en.html#record-session</a>.</p>
</li>
<li><p class="first">NON-MASTER MACHINES ONLY - If the master server has already been
upgraded, on each forward node, heavy node, or storage node, do the
following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rm</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="n">stable</span><span class="o">-</span><span class="n">xenial</span><span class="o">.</span><span class="n">list</span>
<span class="n">sudo</span> <span class="n">service</span> <span class="n">salt</span><span class="o">-</span><span class="n">minion</span> <span class="n">stop</span>
</pre></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Ensure all 14.04 updates are installed:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">soup</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">If soup prompted to reboot, go ahead and do that. If it didn’t, go</div>
<div class="line">ahead and reboot anyway:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">reboot</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Review sostat output to make sure system is healthy before
continuing:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">sostat</span></code></div>
</div>
</li>
<li><p class="first"><strong>IMPORTANT!</strong> Backup Bro config since it will be removed when Ubuntu
removes the package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">sed</span> <span class="o">-</span><span class="n">i</span> <span class="s1">&#39;s|PREV=&quot;pre-.*$|PREV=&quot;pre-upgrade-to-16.04&quot;|g&#39;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">dpkg</span><span class="o">/</span><span class="n">info</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">bro</span><span class="o">.</span><span class="n">preinst</span>
<span class="n">sudo</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">dpkg</span><span class="o">/</span><span class="n">info</span><span class="o">/</span><span class="n">securityonion</span><span class="o">-</span><span class="n">bro</span><span class="o">.</span><span class="n">preinst</span> <span class="n">install</span>
</pre></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Verify that Bro config was backed up to
/opt/bro/etc_pre-upgrade-to-16.04/ (you should have files in this
directory):</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">ls</span> <span class="pre">-alh</span> <span class="pre">/opt/bro/etc_pre-upgrade-to-16.04/</span></code></div>
</div>
</li>
<li><p class="first">You may want to backup any other files that you’ve manually modified.</p>
</li>
</ul>
</div>
<div class="section" id="upgrade-from-ubuntu-14-04-to-ubuntu-16-04">
<h4>Upgrade from Ubuntu 14.04 to Ubuntu 16.04<a class="headerlink" href="#upgrade-from-ubuntu-14-04-to-ubuntu-16-04" title="Permalink to this headline">¶</a></h4>
<ul>
<li><div class="first line-block">
<div class="line">Configure Ubuntu to look for the 16.04 upgrade:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">sed</span> <span class="pre">-i</span> <span class="pre">'s|Prompt=never|Prompt=lts|g'</span> <span class="pre">/etc/update-manager/release-upgrades</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Kill xscreensaver (otherwise, do-release-upgrade in the next step
will prompt you to do so):</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">pkill</span> <span class="pre">xscreensaver</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Initiate upgrade to Ubuntu 16.04:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">do-release-upgrade</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">If you receive a message like <code class="docutils literal notranslate"><span class="pre">No</span> <span class="pre">new</span> <span class="pre">release</span> <span class="pre">found.</span></code>, then
you’ll need to ensure you can reach the Ubuntu changelogs site:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">curl</span> <span class="pre">http://changelogs.ubuntu.com/meta-release-lts</span></code></div>
</div>
<p>If you can’t reach the site, try checking for connectivity, or your
firewall to see if it is being blocked.</p>
</li>
<li><p class="first">If you receive a prompt to restart services during the upgrade,
choose <code class="docutils literal notranslate"><span class="pre">Yes</span></code>.</p>
</li>
<li><p class="first">If you receive a prompt to allow non-superusers to capture packets
(Wireshark), choose <code class="docutils literal notranslate"><span class="pre">No</span></code>.</p>
</li>
<li><p class="first">If you receive a prompt in regard to grub configuration, choose
<code class="docutils literal notranslate"><span class="pre">keep</span> <span class="pre">local</span> <span class="pre">GRUB</span> <span class="pre">configuration</span></code>.</p>
</li>
<li><p class="first">Follow the prompts. If you receive a prompt regarding xscreensaver,
select OK. You may receive prompts regarding files that have changed
like the following:</p>
<table border="1" class="docutils">
<colgroup>
<col width="84%" />
<col width="16%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">file</th>
<th class="head">answer</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>/etc/sudoers</td>
<td><code class="docutils literal notranslate"><span class="pre">Y</span></code></td>
</tr>
<tr class="row-odd"><td>/etc/default/grub</td>
<td><code class="docutils literal notranslate"><span class="pre">N</span></code></td>
</tr>
<tr class="row-even"><td>/etc/apt/apt.conf.d/01autoremove</td>
<td><code class="docutils literal notranslate"><span class="pre">N</span></code></td>
</tr>
<tr class="row-odd"><td>/etc/apt/apt.conf.d/99update-notifier</td>
<td><code class="docutils literal notranslate"><span class="pre">N</span></code></td>
</tr>
<tr class="row-even"><td>/etc/apache2/mods-available/ssl.conf</td>
<td><code class="docutils literal notranslate"><span class="pre">Y</span></code></td>
</tr>
<tr class="row-odd"><td>/etc/apache2/apache2.conf</td>
<td><code class="docutils literal notranslate"><span class="pre">Y</span></code></td>
</tr>
<tr class="row-even"><td>/etc/apache2/ports.conf</td>
<td><code class="docutils literal notranslate"><span class="pre">Y</span></code></td>
</tr>
<tr class="row-odd"><td>/etc/syslog-ng/syslog-ng.conf</td>
<td><code class="docutils literal notranslate"><span class="pre">N</span></code></td>
</tr>
<tr class="row-even"><td>/etc/php5/apache2/php.ini</td>
<td><code class="docutils literal notranslate"><span class="pre">Y</span></code></td>
</tr>
<tr class="row-odd"><td>/etc/xdg/menus/gnome-flashback-applications.menu</td>
<td><code class="docutils literal notranslate"><span class="pre">N</span></code></td>
</tr>
<tr class="row-even"><td>/etc/redis/redis.conf</td>
<td><code class="docutils literal notranslate"><span class="pre">N</span></code></td>
</tr>
<tr class="row-odd"><td>/etc/pulse/default.pa</td>
<td><code class="docutils literal notranslate"><span class="pre">N</span></code></td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">These are files that Security Onion modifies, and you may receive
prompts for additional files that you have modified. The safest
option for each of these is to choose to install the package
maintainer’s version (<code class="docutils literal notranslate"><span class="pre">Y</span></code>, where applicable), with the exception of
the prompt in regard to syslog-ng.conf. Choosing the installation of
the package maintainer’s version will back up the existing file in
case you need to review it later for any custom modifications you had
made.</p>
</li>
<li><p class="first"><strong>IMPORTANT!</strong> If you receive a prompt regarding syslog-ng.conf,
press <code class="docutils literal notranslate"><span class="pre">N</span></code> to keep your currently-installed version.</p>
</li>
<li><p class="first">If you receive an error message in regard to mysql-server, please
disregard and continue with the upgrade.</p>
</li>
<li><p class="first">When prompted to restart, press <code class="docutils literal notranslate"><span class="pre">Y</span></code> to continue.</p>
</li>
</ul>
</div>
<div class="section" id="add-back-security-onion-packages">
<h4>Add back Security Onion packages<a class="headerlink" href="#add-back-security-onion-packages" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">After rebooting, log back in.</p>
</li>
<li><p class="first">If running in a VM, perform a snapshot.</p>
</li>
<li><p class="first">Open a terminal, remove the old PPA, and add our stable PPA:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">rm</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">apt</span><span class="o">/</span><span class="n">sources</span><span class="o">.</span><span class="n">list</span><span class="o">.</span><span class="n">d</span><span class="o">/*</span>
<span class="n">sudo</span> <span class="n">add</span><span class="o">-</span><span class="n">apt</span><span class="o">-</span><span class="n">repository</span> <span class="o">-</span><span class="n">y</span> <span class="n">ppa</span><span class="p">:</span><span class="n">securityonion</span><span class="o">/</span><span class="n">stable</span>
<span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
</pre></div>
</div>
</li>
<li><p class="first">Add back any missing Security Onion packages by installing the
<code class="docutils literal notranslate"><span class="pre">securityonion-iso</span></code> metapackage. If you didn’t install from our ISO
and instead installed from your preferred flavor of Ubuntu and added
our PPA and packages, then you may not necessarily need to install
the <code class="docutils literal notranslate"><span class="pre">securityonion-iso</span></code> metapackage. In the command below, you can
replace <code class="docutils literal notranslate"><span class="pre">securityonion-iso</span></code> with the same Security Onion
metapackage(s) you originally installed (<code class="docutils literal notranslate"><span class="pre">securityonion-server</span></code>,
<code class="docutils literal notranslate"><span class="pre">securityonion-sensor</span></code>, <code class="docutils literal notranslate"><span class="pre">securityonion-all</span></code>, etc).:</p>
<p><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">securityonion-iso</span> <span class="pre">syslog-ng-core</span></code></p>
</li>
<li><p class="first"><strong>IMPORTANT!</strong> If you receive a prompt regarding <code class="docutils literal notranslate"><span class="pre">syslog-ng.conf</span></code>,
press <code class="docutils literal notranslate"><span class="pre">N</span></code> to keep your currently-installed version.</p>
</li>
<li><div class="first line-block">
<div class="line">If you encounter an error in regard to <code class="docutils literal notranslate"><span class="pre">mod_passenger.so</span></code>, try
disabling the module as follows:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">a2dismod</span> <span class="pre">passenger</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Copy backed up Bro config back to <code class="docutils literal notranslate"><span class="pre">/opt/bro/etc</span></code>:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cp</span> <span class="pre">/opt/bro/etc_pre-upgrade-to-16.04/*</span> <span class="pre">/opt/bro/etc</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Copy OSSEC config back in place:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">cp</span> <span class="pre">/var/ossec/etc/ossec.conf-2.8</span> <span class="pre">/var/ossec/etc/ossec.conf</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">/var/ossec/bin/ossec-control</span> <span class="pre">enable</span> <span class="pre">client-syslog</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Stop salt-minion and salt-master before running soup:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">salt-minion</span> <span class="pre">stop</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">service</span> <span class="pre">salt-master</span> <span class="pre">stop</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Update all packages that are currently installed:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">soup</span> <span class="pre">-y</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Soup should prompt for a reboot. After reboot, run the following to
enable <code class="docutils literal notranslate"><span class="pre">securityonion.service</span></code>:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">enable</span> <span class="pre">securityonion.service</span></code></div>
</div>
</li>
<li><p class="first">NON-MASTER MACHINES ONLY:</p>
<div class="line-block">
<div class="line">run the following to disable MySQL:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">disable</span> <span class="pre">mysql</span></code></div>
</div>
<div class="line-block">
<div class="line">run the following to disable salt-master:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">disable</span> <span class="pre">salt-master</span></code></div>
</div>
<div class="line-block">
<div class="line">run the following to disable Redis:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">systemctl</span> <span class="pre">disable</span> <span class="pre">redis</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Reboot again:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">reboot</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">MASTER ONLY - If sguild does not start after reboot, try running
<code class="docutils literal notranslate"><span class="pre">sguil-db-purge</span></code>:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">sguil-db-purge</span></code></div>
</div>
</li>
</ul>
</div>
<div class="section" id="clean-up">
<h4>Clean Up<a class="headerlink" href="#clean-up" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Review your Snort/Suricata/Bro/other configuration for any local
customizations that you may need to re-apply.</p>
</li>
<li><div class="first line-block">
<div class="line">Clean up old UFW file:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">rm</span> <span class="pre">/etc/ufw/applications.d/apache2.2-common</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Remove old Security Onion init file:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">rm</span> <span class="pre">/etc/init/securityonion.conf</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Remove any unnecessary packages:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">autoremove</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Reboot:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">reboot</span></code></div>
</div>
</li>
</ul>
</div>
<div class="section" id="verify">
<h4>Verify<a class="headerlink" href="#verify" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">After rebooting, log back in.</p>
</li>
<li><p class="first">Verify that <code class="docutils literal notranslate"><span class="pre">/etc/update-manager/release-upgrades</span></code> has
<code class="docutils literal notranslate"><span class="pre">Prompt=never</span></code> to avoid prompts to upgrade to 18.04 (not supported
right now).</p>
</li>
<li><p class="first">Keep in mind, Logstash may take a few minutes to initialize, so you
may want to wait a few minutes before continuing.</p>
</li>
<li><div class="first line-block">
<div class="line">Verify services are running:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">so-status</span></code></div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Run sostat and look for anything out of the ordinary:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">sostat</span></code></div>
</div>
</li>
<li><p class="first">Check log files for anything out of the ordinary.</p>
</li>
</ul>
</div>
<div class="section" id="mysql-root-password">
<h4>MySQL root password<a class="headerlink" href="#mysql-root-password" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">We will need to set a randomized root password for MySQL. We can do
so by doing the following:</p>
<p class="rubric" id="reset-debian-cnf">Reset debian.cnf:</p>
<div class="line-block">
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">rm</span> <span class="pre">/etc/mysql/debian.cnf</span></code></div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">dpkg-reconfigure</span> <span class="pre">--frontend</span> <span class="pre">noninteractive</span> <span class="pre">mysql-server-5.7</span></code></div>
</div>
</li>
</ul>
<p>If root password is blank, set random password:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>if echo &quot;quit&quot; | sudo mysql -uroot 2&gt;/dev/null; then
     PASSWORD=$(LC_ALL=C &lt;/dev/urandom tr -dc &#39;[:alnum:]&#39; | head -c 32)
     sudo mysql --defaults-file=/etc/mysql/debian.cnf -e &quot;ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED WITH mysql_native_password BY
    &#39;$PASSWORD&#39;;&quot;
fi
</pre></div>
</div>
</div>
<div class="section" id="optional">
<h4>Optional<a class="headerlink" href="#optional" title="Permalink to this headline">¶</a></h4>
<ul>
<li><div class="first line-block">
<div class="line">Switch to pure GNOME desktop:</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">sudo</span> <span class="pre">so-desktop-gnome</span></code></div>
</div>
</li>
<li><p class="first">If you disabled the GUI previously, you’ll need to re-apply similar
configuration to boot into text mode:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">enable</span> <span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span> <span class="o">--</span><span class="n">force</span>
<span class="n">sudo</span> <span class="n">systemctl</span> <span class="nb">set</span><span class="o">-</span><span class="n">default</span> <span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
<span class="n">sudo</span> <span class="n">reboot</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<span id="document-cheat-sheet"></span><div class="section" id="cheat-sheet">
<h2>Cheat Sheet<a class="headerlink" href="#cheat-sheet" title="Permalink to this headline">¶</a></h2>
<p>If you are viewing the online version of this documentation, you can click on the image below to view a larger version or <a class="reference external" href="https://github.com/Security-Onion-Solutions/securityonion-docs/raw/master/images/cheat-sheet/Security-Onion-Cheat-Sheet.pdf">click here for the PDF version</a>.</p>
<div class="line-block">
<div class="line">This was based on a cheat sheet originally created by <a class="reference external" href="http://chrissanders.org/">Chris Sanders</a> which can be found here:</div>
<div class="line"><a class="reference external" href="http://chrissanders.org/2017/06/security-onion-cheat-sheet/">http://chrissanders.org/2017/06/security-onion-cheat-sheet/</a></div>
</div>
<a class="reference external image-reference" href="https://github.com/Security-Onion-Solutions/securityonion-docs/raw/master/images/cheat-sheet/Security-Onion-Cheat-Sheet.jpg"><img alt="_images/Security-Onion-Cheat-Sheet.jpg" src="_images/Security-Onion-Cheat-Sheet.jpg" /></a>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019
      
        <span class="commit">
          Revision <code>5c62b547</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: latest
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="/en/latest/">latest</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="//readthedocs.org/projects/securityonion/downloads/pdf/latest/">pdf</a></dd>
        
          <dd><a href="//readthedocs.org/projects/securityonion/downloads/htmlzip/latest/">html</a></dd>
        
          <dd><a href="//readthedocs.org/projects/securityonion/downloads/epub/latest/">epub</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="//readthedocs.org/projects/securityonion/?fromdocs=securityonion">Project Home</a>
          </dd>
          <dd>
            <a href="//readthedocs.org/builds/securityonion/?fromdocs=securityonion">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>